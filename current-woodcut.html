<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª©ì¬ ì¬ë‹¨ ê²¬ì  ê³„ì‚°ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    /* --- ê¸°ë³¸ (PC) ìŠ¤íƒ€ì¼ --- */
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    h2 { font-size: 1.4em; margin-bottom: 10px; }
    h4 { margin: 0 0 10px 0; font-size: 1.2em; color: #007bff; }
    .group-box { border: 2px dashed #ccc; border-radius: 10px; padding: 20px; margin-top: 30px; position: relative; }
    .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .group-title { background-color: #f0f0f0; padding: 10px 15px; font-weight: bold; font-size: 1.1em; border-radius: 8px; white-space: nowrap; }
    .action-btn-group { display: flex; gap: 10px; }
    .reset-btn, .load-btn { padding: 6px 12px; font-size: 0.9em; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .load-btn { background-color: #17a2b8; } .load-btn:hover { background-color: #138496; }
    .input-row { display: flex; gap: 10px; justify-content: space-between; margin-top: 10px; }
    .input-row label { flex: 1; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; font-size: 0.95em; }
    input:invalid { border-color: red; }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    .wood-image { position: relative; margin-top: 10px; text-align: center; }
    .wood-image img {
      width: 100%;
      object-fit: cover;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .wood-image canvas { width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 8px; }
    .total { margin-top: 30px; font-weight: bold; font-size: 1.2em; color: green; }
    #finalInfo { display: none; margin-top: 30px; }
    .info-notice {
        text-align: left;
        margin: 15px 0 5px 0;
        padding: 15px;
        background-color: #f0f8ff;
        border: 1px solid #cce5ff;
        border-radius: 8px;
        line-height: 1.6;
    }
    .notice-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .notice-item:not(:last-child) {
        margin-bottom: 10px;
    }
    .notice-item .icon {
        font-size: 1.4em;
        flex-shrink: 0;
    }
    .notice-item .text {
        display: flex;
        flex-direction: column;
        font-size: 0.9em;
        color: #333;
    }
    .notice-item .text strong {
        font-weight: bold;
        color: #0056b3;
    }
    .notice-item .text span {
        font-size: 0.95em;
        color: #555;
    }
    .submit-btn, .action-btn { padding: 12px 20px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; }
    .submit-btn { display: block; margin: 30px auto 0; }
    .submit-btn:hover { background-color: #0056b3; }
    .processing-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px; }
    .processing-item { display: flex; flex-direction: column; align-items: center; border: 2px solid #ccc; padding: 8px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .processing-item img { width: 100%; max-width: 100px; height: auto; border-radius: 4px; }
    .processing-item.selected { border: 3px solid #007bff; box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
    #orderTable { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; word-break: keep-all; }
    #orderTable th, #orderTable td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
    #orderTable th { background-color: #f2f2f2; font-weight: bold; }
    #orderTable td:nth-child(2) { text-align: left; vertical-align: top; }
    #orderTable .shipping-row { background-color: #f8f9fa; }
    #orderTable .shipping-row td { font-weight: bold; color: #333; }
    .shipping-notice { text-align: center; font-size: 0.9em; color: #666; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 8px; }
    #orderTable .total-summary-row td {
      background-color: #e9f5ff;
      font-weight: bold;
      font-size: 1.1em;
      color: #0056b3;
      text-align: right;
      padding-right: 15px;
    }
    #orderTable .total-summary-row td:first-child {
      text-align: center;
    }
    .action-btn { padding: 4px 8px; font-size: 0.85em; margin: 0 2px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; }
    .edit-btn { background-color: #4CAF50; color: white; }
    .delete-btn { background-color: #f44336; color: white; }
    .detail-item-container { position: relative; display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .detail-item-container:last-child { border-bottom: none; }
    .detail-image-panel { flex: 1; min-width: 300px; }
    .detail-image-panel img { width: 100%; max-width: 500px; height: auto; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9; }
    .detail-input-panel { flex: 1.5; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-weight: bold; }
    .corner-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .corner-selection label { font-weight: normal; display: flex; align-items: center; gap: 5px; }
    .detail-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .detail-table th, .detail-table td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    .detail-table th { background-color: #f8f8f8; }
    .detail-table input { margin-top: 0; }
    .detail-table .number-input { width: 60px; }
    .detail-table .memo-input { width: 100%; }
    .detail-table .delete-btn-short { padding: 4px 10px; min-width: 30px; font-weight: bold; }
    .remove-detail-btn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background-color: #f44336; color: white; border: none; border-radius: 50%; font-size: 16px; font-weight: bold; line-height: 28px; text-align: center; cursor: pointer; transition: background-color 0.2s; padding: 0; }
    .remove-detail-btn:hover { background-color: #d32f2f; }
    .accessory-category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
    .accessory-category { border: 2px solid #ccc; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease; font-weight: bold; }
    .accessory-category:hover, .accessory-category.active { border-color: #007bff; box-shadow: 0 0 8px rgba(0, 123, 255, 0.3); background-color: #f0f8ff; }
    .accessory-category img { width: 100%; max-width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
    .accessory-details {
      margin-top: 20px;
      border-top: 2px dashed #ccc;
      padding-top: 20px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    .accessory-item {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      text-align: center;
      gap: 10px;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 0;
    }
    .accessory-item img {
      width: 200px;
      height: 200px;
      max-width: 100%;
      object-fit: cover;
      border-radius: 4px;
      margin: 0 auto 10px;
    }
    .accessory-info { flex-grow: 1; }
    .accessory-name { font-weight: bold; }
    .accessory-price { color: #555; font-size: 0.9em; }
    .accessory-controls { display: flex; justify-content: center; align-items: center; gap: 8px; }
    .accessory-quantity { width: 60px; text-align: center; margin-top: 0; }
    .add-accessory-btn { background-color: #28a745; padding: 8px 15px; }
    .accessory-description {
      grid-column: 1 / -1; 
      text-align: center;
      padding: 12px 15px;
      margin-bottom: 15px;
      background-color: #f0f8ff;
      border-radius: 8px;
      font-size: 0.9em;
      color: #333;
      border-left: 4px solid #007bff;
      line-height: 1.5;
    }
    .accessory-description a {
        color: #0056b3;
        font-weight: bold;
        text-decoration: underline;
        cursor: pointer;
    }
    .event-promo {
      color: #e11d78;
      background-color: #fff0f6;
      padding: 3px 8px;
      border-radius: 5px;
      font-weight: bold;
      border: 1px solid #ffc2d8;
    }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; position: relative; }
    .modal-content h3 { margin-top: 0; margin-bottom: 20px; text-align: center; }
    .modal-content .input-group { margin-bottom: 15px; }
    .modal-actions { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
    .modal-actions button { flex: 1; padding: 10px; }
    .video-modal-content {
        background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 800px; position: relative;
    }
    .video-modal-content h3 { margin-top: 0; }
    .modal-close-btn {
        position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; color: #aaa; background: none; border: none; cursor: pointer; line-height: 1; padding: 0;
    }
    .modal-close-btn:hover { color: #000; }
    .video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
    }
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    #progressModalOverlay {
        z-index: 2000; /* ë‹¤ë¥¸ ëª¨ë‹¬ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
    }
    @media (max-width: 768px) {
        body { padding: 10px; font-size: 16px; }
        h2 { font-size: 1.5em; }
        h4 { font-size: 1.3em; }
        .group-box { padding: 15px; }
        .input-row, #finalInfo .input-row { flex-direction: column; gap: 15px; }
        .processing-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .detail-item-container { flex-direction: column; }
        .total { font-size: 1.1em; word-break: keep-all; }
        .submit-btn-group { flex-wrap: nowrap !important; }
        #finalInfo .submit-btn { width: 100%; margin-left: 0; margin-right: 0; }
        #finalInfo .input-row + .total { margin-top: 20px; }
        .detail-item-container { overflow-x: auto; }
        .detail-item-container .detail-image-panel, .detail-item-container .detail-input-panel { min-width: 0; }
        .detail-item-container img { max-width: 100%; height: auto; }
        .detail-item-container table { width: 100%; table-layout: fixed; }
        .detail-item-container th, .detail-item-container td { word-break: break-word; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .accessory-category-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .accessory-details {
            grid-template-columns: 1fr;
        }
    }
#orderInstructionsModal .modal-content {
  max-height: 90vh; /* í™”ë©´ ë†’ì´ì˜ ìµœëŒ€ 90%ê¹Œì§€ë§Œ ì»¤ì§€ë„ë¡ ì œí•œ */
  max-width: 500px; /* PCì—ì„œëŠ” ìµœëŒ€ ë„ˆë¹„ ìœ ì§€ */
}


  </style>
</head>
<body>
  <h2>ëª©ì¬ ì¬ë‹¨ ê²¬ì  ê³„ì‚°ê¸°</h2>

  <div class="group-box">
    <div class="group-header">
      <div class="group-title">1. ëª©ì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      <div class="action-btn-group">
        <button class="load-btn" onclick="openLoadModal()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="reset-btn" onclick="resetForm()">ì´ˆê¸°í™”</button>
      </div>
    </div>
       <label>ëª©ì¬ ì¢…ë¥˜:
      <select id="woodType">
        <option value="mdf18T" data-image="https://gi.esmplus.com/irn2011/click/texture/mdf.png">MDF 18T</option>
        <option value="pvc18T" data-image="https://gi.esmplus.com/irn2011/click/texture/pvc.png">PVCë³´ë“œ 18T+PET (ì™„ì „ë°©ìˆ˜)</option>
        <option value="misong18T" data-image="https://gi.esmplus.com/irn2011/click/texture/misong.png">ë¯¸ì†¡ì§‘ì„±ëª© 18T</option>
        <option value="pyeonbaek18T" data-image="https://gi.esmplus.com/irn2011/click/texture/pyenon.png">í¸ë°±ì§‘ì„±ëª© 18T (ë§ˆì‚¬/ë¬´ì ˆ)</option>
        <option value="mulbau18T" data-image="https://gi.esmplus.com/irn2011/click/texture/mulbau.png">ë©€ë°”ìš° ì§‘ì„±ëª© 18T</option>
      </select>
    </label>
    <div class="wood-image">
      <img id="woodImg" src="https://gi.esmplus.com/irn2011/click/texture/mdf.png" alt="ëª©ì¬ ì´ë¯¸ì§€" />
    </div>
    <div class="input-row">
      <label>í­ (mm) - ìµœëŒ€ 600mm:<input type="tel" id="width" placeholder="ì˜ˆ: 300" pattern="[0-9]*" /></label>
      <label>ê¸¸ì´ (mm) - ìµœëŒ€ 1800mm:<input type="tel" id="length" placeholder="ì˜ˆ: 1200" pattern="[0-9]*" /></label>
      <label>ìˆ˜ëŸ‰:<input type="tel" id="quantity" value="1" min="1" pattern="[0-9]*" /></label>
    </div>
  </div>

  <div class="group-box">
    <div class="group-title">2. ì¶”ê°€ ê°€ê³µì„ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="processing-grid">
      <div class="processing-item selected"><input type="checkbox" class="option" value="none" id="noOption" checked hidden /><label for="noOption"><img src="https://gi.esmplus.com/irn2011/click/texture/null.png" alt="ê°€ê³µì—†ìŒ" /><div>ê°€ê³µì—†ìŒ</div></label></div>
      <div class="processing-item"><input type="checkbox" class="option" value="sanding" id="sanding" hidden /><label for="sanding"><img src="https://gi.esmplus.com/irn2011/click/texture/sanding.png" alt="ìƒŒë”©" /><div>ìƒŒë”©</div></label></div>
      <div class="processing-item"><input type="checkbox" class="option" value="coating" id="coating" hidden /><label for="coating"><img src="https://gi.esmplus.com/irn2011/click/texture/coating.png" alt="íˆ¬ëª…ì½”íŒ…" /><div>íˆ¬ëª…ì½”íŒ…</div></label></div>
      <div class="processing-item"><input type="checkbox" class="option" value="angled" id="angled" hidden /><label for="angled"><img src="https://gi.esmplus.com/irn2011/click/texture/45dgree.png" alt="ì‚¬ì„ ê°€ê³µ" /><div>ì‚¬ì„ ê°€ê³µ</div></label></div>
      <div class="processing-item"><input type="checkbox" class="option" value="round" id="round" hidden /><label for="round"><img src="https://gi.esmplus.com/irn2011/click/texture/round.png" alt="ëª¨ì„œë¦¬ ë¼ìš´ë“œ" /><div>ëª¨ì„œë¦¬ ë¼ìš´ë“œ</div></label></div>
      <div class="processing-item"><input type="checkbox" class="option" value="circlecut" id="circlecut" hidden /><label for="circlecut"><img src="https://gi.esmplus.com/irn2011/click/texture/circle.png" alt="ì›í˜•íƒ€ê³µ" /><div>ì›í˜•íƒ€ê³µ</div></label></div>
      <div class="processing-item"><input type="checkbox" class="option" value="squarecut" id="squarecut" hidden /><label for="squarecut"><img src="https://gi.esmplus.com/irn2011/click/texture/sagak.png" alt="ì‚¬ê°íƒ€ê³µ" /><div>ì‚¬ê°íƒ€ê³µ</div></label></div>
      <div class="processing-item"><input type="checkbox" class="option" value="hinge" id="hinge" hidden /><label for="hinge"><img src="https://gi.esmplus.com/irn2011/click/texture/hinge.png" alt="ì‹±í¬ê²½ì²©" /><div>ì‹±í¬ê²½ì²©</div></label></div>
    </div>
  </div>

  <div class="group-box" id="detailGroup" style="display:none">
    <div class="group-title">3. ê°€ê³µ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
    <div id="detailsContainer"></div>
  </div>

  <div class="group-box">
    <div class="group-title">3D ëª¨ë¸ ë¯¸ë¦¬ë³´ê¸°</div>
    <div class="wood-image">
      <canvas id="previewCanvas"></canvas>
      <div id="labels-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden;"></div>
    </div>
  </div>

  <div class="total" id="totalPrice">í˜„ì¬ ê²¬ì : 0ì›</div>
  <div class="submit-btn-group" style="display: flex; justify-content: center; gap: 10px; margin-top: 30px;">
    <button class="submit-btn" id="submitBtn">ê²¬ì  ë‹´ê¸°</button>
    <a href="https://talk.naver.com/profile/wc80z0" target="_blank" style="text-decoration: none;"><button type="button" class="submit-btn" style="background-color: #03c75a;">ë„¤ì´ë²„ í†¡í†¡</button></a>
    <a href="http://pf.kakao.com/_NKxaxcl/chat" target="_blank" style="text-decoration: none;"><button type="button" class="submit-btn" style="background-color: #fae100; color: #3c1e1e;">ì¹´ì¹´ì˜¤í†¡</button></a>
  </div>

  <div class="group-box">
    <div class="group-title">ë¶€ìì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div class="accessory-category-grid">
      <div class="accessory-category" data-target="accessory-screws"><img src="https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png" alt="í”¼ìŠ¤"><div>í”¼ìŠ¤</div></div>
      <div class="accessory-category" data-target="accessory-hinges"><img src="https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png" alt="ê²½ì²©"><div>ê²½ì²©</div></div>
      <div class="accessory-category" data-target="accessory-sandpaper"><img src="https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png" alt="ì‚¬í¬"><div>ì‚¬í¬</div></div>
      <div class="accessory-category" data-target="accessory-tape"><img src="https://gi.esmplus.com/irn2011/click/texture/sub_edge.png" alt="ì—£ì§€í…Œì´í”„"><div>ì—£ì§€í…Œì´í”„<br>(ì ˆë‹¨ë©´ ë§ˆê°ì²˜ë¦¬)</div></div>
    </div>
    <div id="accessory-details-container">
      <div id="accessory-screws" class="accessory-details" style="display:none;">
        <p class="accessory-description">êµ¬ë¦¬ ì²œì—° ëª©ê³µìš© í”¼ìŠ¤ë¡œ, ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” í”¼ìŠ¤ ì…ë‹ˆë‹¤.</p>
        <div class="accessory-item" data-name="ëª©ê³µìš© í”¼ìŠ¤ (20ê°œ)" data-price="1000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_bolt2.png" alt="ëª©ê³µìš© í”¼ìŠ¤">
          <div class="accessory-info">
            <div class="accessory-name">ëª©ê³µìš© í”¼ìŠ¤ (20ê°œ)</div>
            <div class="accessory-price">1,000ì›</div>
          </div>
          <div class="accessory-controls">
            <input type="number" class="accessory-quantity" value="1" min="1">
            <button class="action-btn add-accessory-btn">ë‹´ê¸°</button>
          </div>
        </div>
      </div>
      <div id="accessory-hinges" class="accessory-details" style="display:none;">
        <p class="accessory-description">ê°€êµ¬ ë¬¸ì§ ë“±ì— ì‚¬ìš©í•˜ëŠ” ê¸°ë³¸ ê²½ì²©ê³¼, ë¬¸ì´ ë¶€ë“œëŸ½ê²Œ ë‹«íˆë„ë¡ ë„ì™€ì£¼ëŠ” ìŠ¤ë¬´ë¸Œ ì˜µì…˜ì…ë‹ˆë‹¤.</p>
        <div class="accessory-item" data-name="110ë„ ì‹±í¬ ê²½ì²© (1ì„¸íŠ¸=2ea)" data-price="2000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_hinge2.png" alt="110ë„ ì‹±í¬ ê²½ì²©">
          <div class="accessory-info"><div class="accessory-name">110ë„ ì‹±í¬ ê²½ì²© (1ì„¸íŠ¸=2ea)</div><div class="accessory-price">2,000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
        <div class="accessory-item" data-name="ê²½ì²© ìŠ¤ë¬´ë¸Œ" data-price="1000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_hinge3.png" alt="ê²½ì²© ìŠ¤ë¬´ë¸Œ">
          <div class="accessory-info"><div class="accessory-name">ê²½ì²© ìŠ¤ë¬´ë¸Œ(1ì„¸íŠ¸=2ea)</div><div class="accessory-price">1000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
      </div>
      <div id="accessory-sandpaper" class="accessory-details" style="display:none;">
        <p class="accessory-description">ìˆ«ìê°€ ë‚®ì„ìˆ˜ë¡ ê±°ì¹ ê³ , ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ½ìŠµë‹ˆë‹¤. ê±°ì¹œ ì‚¬í¬ë¡œ ì‹œì‘í•˜ì—¬ ê³ ìš´ ì‚¬í¬ë¡œ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”.</p>
        <div class="accessory-item" data-name="ì‚¬í¬ #80 (2ì¥)" data-price="1000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_sapo_80.png" alt="ì‚¬í¬ #80">
          <div class="accessory-info"><div class="accessory-name">ì‚¬í¬ #80 (2ì¥)</div><div class="accessory-price">1,000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
        <div class="accessory-item" data-name="ì‚¬í¬ #150 (2ì¥)" data-price="1000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_sapo_150.png" alt="ì‚¬í¬ #150">
          <div class="accessory-info"><div class="accessory-name">ì‚¬í¬ #150 (2ì¥)</div><div class="accessory-price">1,000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
        <div class="accessory-item" data-name="ì‚¬í¬ #220 (2ì¥)" data-price="1000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_sapo_220.png" alt="ì‚¬í¬ #220">
          <div class="accessory-info"><div class="accessory-name">ì‚¬í¬ #220 (2ì¥)</div><div class="accessory-price">1,000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
        <div class="accessory-item" data-name="ì‚¬í¬ #320 (2ì¥)" data-price="1000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_sapo_320.png" alt="ì‚¬í¬ #320">
          <div class="accessory-info"><div class="accessory-name">ì‚¬í¬ #320 (2ì¥)</div><div class="accessory-price">1,000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
      </div>
      <div id="accessory-tape" class="accessory-details" style="display:none;">
        <p class="accessory-description">
            ëª©ì¬ì˜ ì ˆë‹¨ë©´ì„ ë§ˆê°í•˜ì—¬ ê¹”ë”í•˜ê²Œ ë§Œë“¤ê³  ìŠµê¸°ë¡œë¶€í„° ë³´í˜¸í•˜ëŠ” ë§ˆê°ì¬ì…ë‹ˆë‹¤.
            <br>ì¢€ë” ìì„¸í•œ ì„¤ëª…ì„ ì›í•œë‹¤ë©´ <a href="#" onclick="openVideoModal('https://www.youtube.com/embed/goC8S1Enjcg?si=7B93_Wk53lxoeqEj'); return false;">ì—¬ê¸°ë¥¼</a> í´ë¦­í•˜ì„¸ìš”.
        </p>
        <div class="accessory-item" data-name="PVC ì—£ì§€ í…Œì´í”„ (10m)" data-price="8000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_edge_2.png" alt="PVC ì—£ì§€ í…Œì´í”„">
          <div class="accessory-info"><div class="accessory-name">PVC ì—£ì§€ í…Œì´í”„ (10m)</div><div class="accessory-price">8,000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
        <div class="accessory-item" data-name="ì¢…ì´ ì—£ì§€ í…Œì´í”„ (10m)" data-price="12000">
          <img src="https://gi.esmplus.com/irn2011/click/texture/sub_edge_1.png" alt="ì¢…ì´ ì—£ì§€ í…Œì´í”„">
          <div class="accessory-info"><div class="accessory-name">ì¢…ì´ ì—£ì§€ í…Œì´í”„ (10m)</div><div class="accessory-price">12,000ì›</div></div>
          <div class="accessory-controls"><input type="number" class="accessory-quantity" value="1" min="1"><button class="action-btn add-accessory-btn">ë‹´ê¸°</button></div>
        </div>
      </div>
    </div>
  </div>

  <div class="group-box">
    <div class="group-title">ì£¼ë¬¸ ë‚´ì—­</div>
    <div class="table-container">
      <table id="orderTable">
          <thead><tr><th>ëª©ì¬ ì¢…ë¥˜</th><th>ê°€ê³µ ìƒì„¸ ë‚´ì—­</th><th>ì‚¬ì´ì¦ˆ (mm)</th><th>ìˆ˜ëŸ‰</th><th>ê²¬ì </th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="orderTableBody"></tbody>
      </table>
    </div>
    <div class="shipping-notice">
      ì•ˆë‚´ëœ ì˜ˆìƒ ë°°ì†¡ë¹„ëŠ” í•©í¬ì¥ ì—¬ë¶€, ì‹¤ì œ í¬ì¥ ë¶€í”¼ ë° ë¬´ê²Œì— ë”°ë¼ ë³€ë™ë  ìˆ˜ ìˆìœ¼ë©°, ì¶”ê°€ ìš”ê¸ˆì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
  </div>

  <div class="group-box" id="finalInfo">
    <div class="group-title">4. ê¸°ë³¸ì •ë³´ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</div>
     <div class="info-notice">
      <div class="notice-item">
        <span class="icon">ğŸ“±</span>
        <div class="text">
          <strong>ì£¼ë¬¸ë²ˆí˜¸ê°€ íœ´ëŒ€í°ìœ¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤.</strong>
          <span>(ì´ë©”ì¼ ì‘ì„± ì‹œ í•¨ê»˜ ì „ì†¡)</span>
        </div>
      </div>
      <div class="notice-item">
        <span class="icon">â—</span>
        <div class="text">
          <strong>ë¬¸ìë¥¼ ëª» ë°›ìœ¼ì…¨ë‚˜ìš”?</strong>
          <span>[ì£¼ë¬¸ë‚´ì—­ ë‹¤ìš´] í›„ ë„¤ì´ë²„í†¡í†¡/ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.</span>
        </div>
      </div>
    </div>
    <div class="input-row">
      <label>ì„±í•¨:<input type="text" id="customerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required /></label>
      <label>íœ´ëŒ€í°:<input type="tel" id="customerPhone" placeholder="010-0000-0000" maxlength="13" oninput="formatPhoneNumber(this)" required /></label>
      <label>ì´ë©”ì¼:<input type="email" id="customerEmail" placeholder="example@email.com (ì„ íƒ)" /></label>
    </div>
    <div class="total" id="finalTotal"></div>
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
      <button class="submit-btn" id="sendBtn">ë³´ë‚´ê¸°</button>
      <button class="submit-btn" id="downloadBtn" onclick="downloadOrderReport()" style="background-color: #6c757d;">ì£¼ë¬¸ë‚´ì—­ ë‹¤ìš´</button>
    </div>
  </div>

  <div id="reportContainer" style="position: absolute; left: -9999px; top: auto; width: 800px; background-color: #fff; padding: 40px; font-family: 'Malgun Gothic', sans-serif; border: 1px solid #ccc;">
      <h1 style="text-align: center; border-bottom: 3px solid #333; padding-bottom: 15px; margin-bottom: 20px;">ì£¼ ë¬¸ ë‚´ ì—­ ì„œ</h1>
      <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
          <div><strong>ê³ ê°ëª…:</strong> <span id="report-customerName"></span></div>
          <div><strong>ì—°ë½ì²˜:</strong> <span id="report-customerPhone"></span></div>
          <div><strong>ì‘ì„±ì¼:</strong> <span id="report-date"></span></div>
      </div>
      <table id="report-items-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
              <tr style="background-color: #f2f2f2;">
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">í’ˆëª©</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">ì‚¬ì´ì¦ˆ(mm) / ìˆ˜ëŸ‰</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">ê°€ê³µë‚´ì—­</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">ê¸ˆì•¡</th>
              </tr>
          </thead>
          <tbody id="report-items-tbody">
          </tbody>
      </table>
      <div style="text-align: right; margin-top: 30px; font-size: 20px; font-weight: bold;">
          ì´ ê²¬ì  í•©ê³„: <span id="report-totalPrice" style="color: #d9534f;"></span>
      </div>
  </div>
  
  <div id="loadOrderModal" class="modal-overlay">
    <div class="modal-content">
        <h3>ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
        <div class="input-group">
            <label for="load-phone">íœ´ëŒ€í°</label>
            <input type="tel" id="load-phone" placeholder="010-1234-5678" required oninput="formatPhoneNumber(this)">
        </div>
        <div class="input-group">
            <label for="load-orderNo">ì£¼ë¬¸ë²ˆí˜¸</label>
            <input type="text" id="load-orderNo" placeholder="ì˜ˆ: 20240718-001" required>
        </div>
        <div class="modal-actions">
            <button class="action-btn" id="loadOrderConfirmBtn" onclick="confirmLoadOrder()">í™•ì¸</button>
            <button class="action-btn" onclick="closeLoadModal()" style="background-color: #6c757d;">ì·¨ì†Œ</button>
        </div>
    </div>
  </div>
  
  <div id="videoModal" class="modal-overlay">
    <div class="video-modal-content">
        <button class="modal-close-btn" onclick="closeVideoModal()">Ã—</button>
        <h3>ì—£ì§€ í…Œì´í”„ ì‹œê³µ ë°©ë²•</h3>
        <div class="video-container">
            <iframe id="youtubeVideo" width="560" height="315" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
    </div>
  </div>
  
  <!-- â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ -->
  <!-- [ìˆ˜ì •] ì´ ëª¨ë‹¬ HTMLì„ <script> íƒœê·¸ë³´ë‹¤ ìœ„ë¡œ ì˜®ê²¼ìŠµë‹ˆë‹¤. ì´ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤. -->
  <div id="progressModalOverlay" class="modal-overlay">
    <div id="progressModalContent" class="modal-content" style="text-align: center;">
      <h3 id="progressTitle">ì „ì†¡ ì¤‘...</h3>
      <img id="progressIcon" src="https://i.gifer.com/ZZ5H.gif" alt="ë¡œë”© ì¤‘" style="width: 80px; height: 80px; margin-bottom: 20px;">
      <p id="progressStatusText" style="margin-bottom: 20px; font-size: 1.1em; color: #333;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
      <div id="progressBarContainer" style="background-color: #e0e0e0; border-radius: 10px; padding: 3px; overflow: hidden;">
        <div id="progressBar" style="width: 0%; height: 20px; background-color: #007bff; border-radius: 7px; transition: width 0.5s ease-in-out;"></div>
      </div>
      <button id="progressModalCloseBtn" class="submit-btn" style="display: none; margin-top: 25px; background-color: #6c757d;">ë‹«ê¸°</button>
    </div>
  </div>
<div id="orderInstructionsModal" class="modal-overlay">
  <div class="modal-content" style="padding: 20px;">
    <h3 style="text-align: center; font-size: 1.2em; margin-bottom: 15px;">ì£¼ë¬¸ ë° ê²°ì œ ë°©ë²• ì•ˆë‚´</h3>
    
    <div class="info-notice" style="background-color: #fff; padding: 0; border: none; font-size: 0.9em;">
      
      <p style="margin-bottom: 5px;"><strong>1. ì›í•˜ì‹œëŠ” ì‡¼í•‘ëª°ì— ì ‘ì†í•´ì£¼ì„¸ìš”.</strong></p>
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <a href="https://naver.me/GJ5OEouG" target="_blank" style="flex: 1; text-decoration: none;">
          <button class="submit-btn" style="width: 100%; background-color: #03c75a; padding: 10px; font-size: 0.9em;">ë„¤ì´ë²„ ìŠ¤í† ì–´íŒœ</button>
        </a>
        <a href="https://link.coupang.com/a/cQ9keF" target="_blank" style="flex: 1; text-decoration: none;">
          <button class="submit-btn" style="width: 100%; background-color: #1184ff; padding: 10px; font-size: 0.9em;">ì¿ íŒ¡</button>
        </a>
      </div>

      <p style="margin-bottom: 5px;"><strong>2. ê²¬ì  ê¸ˆì•¡ë§Œí¼ ìˆ˜ëŸ‰ì„ ì„ íƒí•˜ì—¬ ê²°ì œí•´ì£¼ì„¸ìš”.</strong></p>
      <p style="padding: 10px; background-color: #f0f8ff; border-radius: 8px; line-height: 1.5; font-size: 0.95em;">
        ì´ ê²¬ì : <strong id="finalQuoteAmount" style="color: #007bff;">0ì›</strong><br>
        ì‡¼í•‘ëª°ì—ì„œ 1,000ì› ìƒí’ˆì˜ ìˆ˜ëŸ‰ì„ <strong id="paymentQuantity" style="color: red; font-size: 1.1em;">0</strong>ê°œë¡œ ì„ íƒí•˜ì—¬ ê²°ì œí•˜ì„¸ìš”.
      </p>
      
      <p style="margin-top: 15px; margin-bottom: 5px;"><strong>3. ë°°ì†¡ ë©”ì‹œì§€ ë€ì— ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ê¼­ ì…ë ¥í•´ì£¼ì„¸ìš”.</strong></p>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f0f8ff; border-radius: 8px;">
        <span style="font-size: 0.95em;">ì£¼ë¬¸ë²ˆí˜¸: <strong id="finalOrderNumber" style="color: #d9534f; font-size: 1.1em;">-</strong></span>
        <button id="copyOrderBtn" onclick="copyOrderNumber()" style="padding: 5px 12px; font-size: 0.85em; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap;">ë³µì‚¬</button>
      </div>

      <p style="margin-top: 15px; margin-bottom: 5px;"><strong>4. ë¬¸ì˜ì‚¬í•­ì€ ì•„ë˜ ìƒë‹´ í†¡ ì±„ë„ë¡œ ë¬¸ì˜ì£¼ì„¸ìš”.</strong></p>
    </div>

    <div class="modal-actions" style="margin-top: 10px; gap: 10px;">
       <a href="https://talk.naver.com/profile/wc80z0" target="_blank" style="text-decoration: none; flex: 1;"><button type="button" class="submit-btn" style="width:100%; background-color: #03c75a; padding: 10px; font-size: 0.9em;">ë„¤ì´ë²„ í†¡í†¡</button></a>
       <a href="http://pf.kakao.com/_NKxaxcl/chat" target="_blank" style="text-decoration: none; flex: 1;"><button type="button" class="submit-btn" style="width:100%; background-color: #fae100; color: #3c1e1e; padding: 10px; font-size: 0.9em;">ì¹´ì¹´ì˜¤í†¡</button></a>
    </div>
     <button class="submit-btn" onclick="closeInstructionsModal()" style="width: 100%; background-color: #6c757d; margin-top: 8px; padding: 10px; font-size: 0.9em;">ë‹«ê¸°</button>
  </div>
</div>

  <!-- â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² -->

<script>
// ê¸°ì¡´ ë°ì´í„° ì „ì†¡ìš© URLë“¤
const SPREADSHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzkTCXtkfn0zmQkXB3xFZEaczyHquAuGGZu_3KMiMHVz6SEGXvMbZV56EE8u7o-zEoLMw/exec'; // ë‹¨ê°€í‘œ
const SPREADSHEET_API_URL2 = 'https://script.google.com/macros/s/AKfycbzXHDF31Hi_yZaDR_BG_GfDdcY7a8h_9wShpptcvfCOP-EEUgLQTalICjOtXGfZkpiFpw/exec'; // ì£¼ë¬¸ì „ì†¡
                              
// --- ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ì„ íƒ ---
const woodSelect = document.getElementById('woodType');
const woodImg = document.getElementById('woodImg');
const noOptionCheckbox = document.getElementById("noOption");
const detailGroup = document.getElementById('detailGroup');
const detailsContainer = document.getElementById('detailsContainer');
const totalDiv = document.getElementById('totalPrice');
const finalTotalDiv = document.getElementById('finalTotal');
const submitBtn = document.getElementById('submitBtn');
const finalInfo = document.getElementById('finalInfo');
const orderTableBody = document.getElementById('orderTableBody');
const labelsContainer = document.getElementById('labels-container');
const loadOrderModal = document.getElementById('loadOrderModal');
const loadOrderConfirmBtn = document.getElementById('loadOrderConfirmBtn');
const videoModal = document.getElementById('videoModal');
const youtubeIframe = document.getElementById('youtubeVideo');

const progressModalOverlay = document.getElementById('progressModalOverlay');
const progressTitle = document.getElementById('progressTitle');
const progressIcon = document.getElementById('progressIcon');
const progressStatusText = document.getElementById('progressStatusText');
const progressBar = document.getElementById('progressBar');
const progressModalCloseBtn = document.getElementById('progressModalCloseBtn');

let priceTable = [];
let activeLabels = [];
let orderData = [];
let lastFocusedOption = null;
let hingeInputMode = 'Y_INPUT';
let jsonpTimeout;

const optionDetails = {
  sanding:   { label: 'ìƒŒë”©',           image: 'https://gi.esmplus.com/irn2011/click/texture/detail_sanding.png',  description: '<strong class="event-promo">[ì´ë²¤íŠ¸] í•œ ì¥ ë¬´ë£Œ ìƒŒë”©!</strong> ëª©ì¬ì˜ ëª¨ë“  ë©´(ì ˆë‹¨ë©´ í¬í•¨)ì„ ë¶€ë“œëŸ½ê²Œ ìƒŒë”©í•˜ì—¬ ê±°ì¹œ ë¶€ë¶„ì„ ì œê±°í•©ë‹ˆë‹¤.' },
  coating:   { 
    label: 'ì½”íŒ…', 
    image: 'https://gi.esmplus.com/irn2011/click/texture/detail_coating.png',  
    description: 'ì¼ë°˜ ë°”ë‹ˆì‰¬/ìŠ¤í…Œì¸ë³´ë‹¤ ìŠ¤í¬ë˜ì¹˜ì™€ ë‚´êµ¬ì„±ì´ ê°•í•œ <b>ìš°ë ˆíƒ„ í˜ì¸íŠ¸</b>ë¡œ ë§ˆê°í•©ë‹ˆë‹¤.<br>ëª©ì¬ ê¸¸ì´ì— ë”°ë¼ ê°€ê²©ì´ ë³€ë™ë˜ë©°, <b>ë‹¨ë©´ ë˜ëŠ” ì–‘ë©´ ì½”íŒ…</b>ì„ ì„ íƒí•´ì£¼ì„¸ìš”.<br><br><span style="background-color:#ff4d4d; color:#fff; padding:6px 10px; border-radius:4px; display:inline-block; font-weight:bold;">âš ï¸ ë‹¨ë©´ ì½”íŒ… ì‹œ ë„ë£Œì˜ ìˆ˜ì¶•ë ¥ìœ¼ë¡œ ì¸í•´ íœ¨ì´ ìƒê¹ë‹ˆë‹¤. ì œí’ˆ ìˆ˜ë ¹ í›„ ì¦‰ì‹œ ê³ ì • ì„¤ì¹˜ë¥¼ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤.</span>'
  },
  angled:    { label: 'ì‚¬ì„ ê°€ê³µ',       image: 'https://gi.esmplus.com/irn2011/click/texture/detail_45dgree.png',   description: '<strong class="event-promo">[ì´ë²¤íŠ¸] í•œ ì¥ì˜ í•œ ë©´ì€ ë¬´ë£Œ!</strong> (ì¶”ê°€ ë©´ë‹¹ 1,000ì›) ê¸°ë³¸ 45Â° ë¹—ê°ìœ¼ë¡œ ê°€ê³µí•©ë‹ˆë‹¤. ê°€ê³µì„ ì›í•˜ëŠ” ë©´ì„ ì²´í¬í•´ì£¼ì„¸ìš”.' },
  round:     { label: 'ëª¨ì„œë¦¬ ë¼ìš´ë“œ',   image: 'https://gi.esmplus.com/irn2011/click/texture/detail_round.png',  description: '<strong class="event-promo">[ì´ë²¤íŠ¸] í•œ ì¥ì˜ í•œ ê¼­ì§€ì ì€ ë¬´ë£Œ!</strong> (ì¶”ê°€ ê¼­ì§€ì ë‹¹ 1,000ì›) ê¸°ë³¸ 15R(ë°˜ì§€ë¦„ 15mm)ë¡œ ëª¨ì„œë¦¬ë¥¼ ë‘¥ê¸€ê²Œ ê°€ê³µí•©ë‹ˆë‹¤. ì›í•˜ëŠ” ëª¨ì„œë¦¬ë¥¼ ì²´í¬í•´ì£¼ì„¸ìš”.' },
  circlecut: { label: 'ì›í˜•íƒ€ê³µ',       image: 'https://gi.esmplus.com/irn2011/click/texture/detail_circle.png',description: '<strong class="event-promo">[ì´ë²¤íŠ¸] í•œ ì¥ì˜ í•œ ê°œ ë¬´ë£Œ íƒ€ê³µ!</strong> (ì¶”ê°€ íƒ€ê³µë‹¹ 3,000ì›) íƒ€ê³µì„ ì¶”ê°€í•˜ê³  ì¢Œí‘œ ë“±ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' },
  squarecut: { label: 'ì‚¬ê°íƒ€ê³µ',       image: 'https://gi.esmplus.com/irn2011/click/texture/detail_square.png',description: '<strong class="event-promo">[ì´ë²¤íŠ¸] í•œ ì¥ì˜ í•œ ê°œ ë¬´ë£Œ íƒ€ê³µ!</strong> (ì¶”ê°€ íƒ€ê³µë‹¹ 4,000ì›) íƒ€ê³µì„ ì¶”ê°€í•˜ê³  ì¢Œí‘œ ë“±ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' },
  hinge:     { label: 'ì‹±í¬ê²½ì²©',       image: 'https://gi.esmplus.com/irn2011/click/texture/detail_hinge.png',  description: '<strong class="event-promo">[ì´ë²¤íŠ¸] 2ê°œ ë¬´ë£Œ ì‹œê³µ!</strong> (ì¶”ê°€ ê°œë‹¹ 1,000ì›) ê²½ì²© ê°œìˆ˜ë¥¼ ì •í•˜ê³  ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }
};

window.onload = () => { loadPriceData(); loadOrders(); resetForm(false); };

async function loadPriceData() {
  totalDiv.textContent = 'ë‹¨ê°€í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
  try {
    const response = await fetch(SPREADSHEET_API_URL);
    if (!response.ok) throw new Error(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.statusText}`);
    priceTable = await response.json();
    console.log('ë‹¨ê°€í‘œ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', priceTable);
    handleProcessingOptionsLogic();
    updateAll();
  } catch (error) {
    console.error('ë‹¨ê°€í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    totalDiv.textContent = 'ì˜¤ë¥˜: ë‹¨ê°€í‘œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    alert('ê²¬ì  ì‹œìŠ¤í…œì˜ ë‹¨ê°€í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
  }
}

function handleOrderLoad(res) {
    console.log('load result:', res);

    if (!res || res.result !== 'success') {
      alert(res && res.message ? res.message : 'ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      return;
    }

    const rows = res.data || [];
    if (!rows.length) {
      alert('í•´ë‹¹ ì¡°ê±´ì˜ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // === ê¸°ì¡´ ì£¼ë¬¸/ë°°ì†¡ ë°°ì—´ ì´ˆê¸°í™” (ì´ˆë³´ì í˜ì´ì§€ êµ¬ì¡°ì— ë§ê²Œ) ===
    orders = [];
    shippingItems = [];
    let totalAmount = 0;

    rows.forEach(row => {
      const summary = String(row['ì£¼ë¬¸ë‚´ì—­ ìš”ì•½'] || '');
      const width   = row['í­'];
      const length  = row['ê¸¸ì´'];
      const qty     = row['ìˆ˜ëŸ‰'];
      const process = row['ê°€ê³µ'];
      const sum     = Number(row['í•©ê³„'] || 0);

      // 1) ì´ í•©ê³„ ì¤„
      if (summary === 'ì´ í•©ê³„') {
        totalAmount = sum;
        return;
      }

      // 2) ì˜ˆìƒ ë°°ì†¡ë¹„ ì¤„
      if (summary === 'ì˜ˆìƒ ë°°ì†¡ë¹„') {
        shippingItems.push({
          sizeCategory: summary,
          count: Number(qty || 0),
          // í•„ìš”í•˜ë©´ processì—ì„œ "5,000ì›/ê°œ" ê°™ì€ ë¶€ë¶„ íŒŒì‹±í•´ì„œ cost ë½‘ì„ ìˆ˜ë„ ìˆìŒ
          note: String(process || '')
        });
        return;
      }

      // 3) ì´ë²¤íŠ¸ í• ì¸ ì¤„
      if (summary.indexOf('[ì´ë²¤íŠ¸ í• ì¸]') === 0) {
        orders.push({
          type: 'discount',
          name: 'ì´ë²¤íŠ¸ í• ì¸',
          estimate: sum
        });
        return;
      }

      // 4) ì¼ë°˜ ëª©ì¬ ì£¼ë¬¸ ì¤„
      orders.push({
        type: 'board',
        woodTypeLabel: summary,         // "MDF 18T"
        width: Number(width || 0),
        length: Number(length || 0),
        quantity: Number(qty || 0),
        processText: String(process || ''),
        estimate: sum
      });
    });

    // === ì—¬ê¸°ì„œë¶€í„°ëŠ” ì´ˆë³´ì í˜ì´ì§€ì— ë§ê²Œ UI ê°±ì‹  ===
    // ì˜ˆ: ì£¼ë¬¸í‘œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°, í•©ê³„ ë³´ì—¬ì£¼ê¸° ë“±
    renderOrderTable();        // ê¸°ì¡´ì— ì“°ëŠ” í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
    updateTotalPrice(totalAmount);  // í•©ê³„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì‚¬ìš©

    // ê³ ê° ì •ë³´ (ì´ë¦„/ì „í™”/ì´ë©”ì¼)ë„ ì²« ì¤„ ê¸°ì¤€ìœ¼ë¡œ ì±„ìš°ê¸°
    const first = rows[0];
    if (first) {
      document.querySelector('#customerName').value  = first['ê³ ê°ëª…']   || '';
      document.querySelector('#customerPhone').value = first['ì—°ë½ì²˜']   || '';
      document.querySelector('#customerEmail').value = first['ì´ë©”ì¼']   || '';
      document.querySelector('#orderNo').value       = first['ì£¼ë¬¸ë²ˆí˜¸'] || '';
    }

    alert('ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
  }



function loadOrders() {
    const saved = localStorage.getItem('orderData');
    if (saved) {
        try {
            orderData = JSON.parse(saved);
            renderOrderTable();
        } catch(e) {
            console.error("ì €ì¥ëœ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", e);
            localStorage.removeItem('orderData');
        }
    }
}

function calculate() {
    const width = parseFloat(document.getElementById('width').value) || 0;
    const length = parseFloat(document.getElementById('length').value) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const selectedWoodType = woodSelect.value;

    if (priceTable.length === 0) {
        if(SPREADSHEET_API_URL.includes("ì—¬ê¸°ì—")) totalDiv.textContent = "ì˜¤ë¥˜: API ì£¼ì†Œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return 0;
    }

    const area = width * length;
    const basePrice = getUnitPrice(selectedWoodType, area);

    if (basePrice === 0 && area > 0) {
        totalDiv.textContent = `í•´ë‹¹ ì‚¬ì´ì¦ˆì˜ ë‹¨ê°€ ì •ë³´ ì—†ìŒ`;
        return 0;
    }

    let additionalCost = 0;

    if (!noOptionCheckbox.checked) {
        document.querySelectorAll('.option:checked:not(#noOption)').forEach(opt => {
            const container = document.querySelector(`.detail-item-container[data-option-key="${opt.value}"]`);
            switch (opt.value) {
                case 'sanding': additionalCost += 0; break;
                case 'coating':
                    if (container) {
                        const coatingType = container.querySelector('select')?.value;
                        const prices = getCoatingPrices();
                        additionalCost += (coatingType === 'ì–‘ë©´' ? prices.double : prices.single);
                    }
                    break;
                case 'angled':
                    if (container) additionalCost += Math.max(0, container.querySelectorAll('input[name="angled_side"]:checked').length - 1) * 1000;
                    break;
                case 'round':
                    if (container) additionalCost += Math.max(0, container.querySelectorAll('input[name="round_corner"]:checked').length - 1) * 1000;
                    break;
                case 'hinge':
                    const hingeTbody = document.getElementById('hingeTbody_hinge');
                    if (hingeTbody) {
                        additionalCost += Math.max(0, hingeTbody.rows.length - 2) * 1000;
                    }
                    break;
                case 'circlecut':
                    const circleTbody = document.getElementById('circleCutTbody_circlecut');
                    if (circleTbody) additionalCost += Math.max(0, circleTbody.rows.length - 1) * 3000;
                    break;
                case 'squarecut':
                    const squareTbody = document.getElementById('squareCutTbody_squarecut');
                    if (squareTbody) additionalCost += Math.max(0, squareTbody.rows.length - 1) * 4000;
                    break;
            }
        });
    }

    const pricePerPiece = basePrice + additionalCost;
    const total = Math.round(pricePerPiece * quantity);

    let priceText = `íŒì¬ê°’ ${basePrice.toLocaleString()}ì›`;
    if (additionalCost > 0) {
        priceText += ` + ì¶”ê°€ê°€ê³µë¹„ ${additionalCost.toLocaleString()}ì› = <strong>${pricePerPiece.toLocaleString()}ì›</strong>`;
    } else {
         priceText += ` = <strong>${pricePerPiece.toLocaleString()}ì›</strong>`
    }

    if (quantity > 1) {
        priceText += ` (Ã—${quantity}ê°œ) = <strong>${total.toLocaleString()}ì›</strong>`;
    }

    totalDiv.innerHTML = `í˜„ì¬ ê²¬ì : ${priceText}`;
    return total;
}

function getUnitPrice(woodTypeId, area) {
  if (priceTable.length === 0 || area <= 0) return 0;
  for (const tier of priceTable) {
    if (area <= tier.area) {
      return tier[woodTypeId] || 0;
    }
  }
  return 0;
}

function getCoatingPrices() {
    const length = parseFloat(document.getElementById('length').value) || 0;
    let singleCost = 0;
    if (length <= 600) singleCost = 5000;
    else if (length <= 1200) singleCost = 10000;
    else if (length <= 1800) singleCost = 15000;
    else singleCost = 15000;

    return {
        single: singleCost,
        double: singleCost * 2
    };
}

function updateCoatingOptionText() {
    const coatingSelect = document.getElementById('coatingType_coating');
    if (!coatingSelect) return;
    const prices = getCoatingPrices();
    coatingSelect.options[0].textContent = `ë‹¨ë©´ ì½”íŒ… (+${prices.single.toLocaleString()}ì›)`;
    coatingSelect.options[1].textContent = `ì–‘ë©´ ì½”íŒ… (+${prices.double.toLocaleString()}ì›)`;
}

function renderOrderTable() {
    orderTableBody.innerHTML = '';
    let itemsSubtotal = 0; // ë°°ì†¡ë¹„ ì œì™¸ ëª¨ë“  í•­ëª© í•©ê³„

    const style = document.createElement('style');
    style.innerHTML = `
      .discount-row td {
        color: #d9534f; font-weight: bold; background-color: #fff8f8;
        font-size: 0.9em; padding-top: 4px; padding-bottom: 4px;
      }
      .discount-row td:nth-child(2) { text-align: left; }
    `;
    document.head.appendChild(style);


    const tableHead = document.querySelector("#orderTable thead");
    tableHead.innerHTML = `<tr><th>ëª©ì¬ ì¢…ë¥˜</th><th>ê°€ê³µ ìƒì„¸ ë‚´ì—­</th><th>ì‚¬ì´ì¦ˆ (mm)</th><th>ìˆ˜ëŸ‰</th><th>ê²¬ì </th><th>ê´€ë¦¬</th></tr>`;

    const isLoadMode = orderData.some(order => order.isLoaded);

    orderData.forEach((order, index) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', index);
        const isLoadedOrder = order.isLoaded === true;
        const managementCellHtml = isLoadedOrder 
            ? `<td>ë¶ˆê°€</td>` 
            : `<td><button class="action-btn edit-btn" onclick="loadOrderForEdit(${index})">ìˆ˜ì •</button><button class="action-btn delete-btn" onclick="deleteOrder(${index})">ì‚­ì œ</button></td>`;

        const currentEstimate = Number(order.estimate) || 0;
        
        if (order.type !== 'shipping') {
             itemsSubtotal += currentEstimate;
        }

        // â–¼â–¼â–¼ [ìˆ˜ì •] ê° íƒ€ì…ì— ë”°ë¼ trì˜ innerHTMLì„ ì„¤ì •í•˜ê³  ë°”ë¡œ appendChild(tr)ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. â–¼â–¼â–¼
        if (order.type === 'shipping') {
            tr.className = 'shipping-row';
            tr.innerHTML = `<td>ì˜ˆìƒ ë°°ì†¡ë¹„</td><td>${order.name}</td><td>-</td><td style="text-align:center;">${order.quantity}</td><td>${currentEstimate.toLocaleString()}ì›</td><td>-</td>`;
            orderTableBody.appendChild(tr);
        } else if (order.type === 'discount') {
            tr.className = 'discount-row';
            tr.innerHTML = `<td>ì´ë²¤íŠ¸ í• ì¸</td><td>${order.name}</td><td>-</td><td>-</td><td>${currentEstimate.toLocaleString()}ì›</td><td></td>`;
            orderTableBody.appendChild(tr);
        } else if (order.type === 'accessory') {
            tr.innerHTML = `<td>ë¶€ìì¬</td><td>${order.name}</td><td>-</td><td>${order.quantity}</td><td>${currentEstimate.toLocaleString()}ì›</td>${managementCellHtml}`;
            tr.style.backgroundColor = '#fefae0';
            orderTableBody.appendChild(tr);
        } else if (order.woodTypeValue) {
            const woodOption = woodSelect.querySelector(`option[value="${order.woodTypeValue}"]`);
            const woodLabel = woodOption ? woodOption.text.split(' ')[0] : 'ì•Œìˆ˜ì—†ìŒ';
            let detailsHtml = '-';

            if (isLoadedOrder) {
                detailsHtml = (order.detailText?.loaded?.summary || ['-']).join('<br>'); 
            } else {
                if (order.noOption) { detailsHtml = 'ê°€ê³µ ì—†ìŒ'; } 
                else if (order.detailText && Object.keys(order.detailText).length > 0) {
                    let summaryArray = [];
                    Object.values(order.detailText).forEach(detail => {
                        if (detail.summary && Array.isArray(detail.summary)) {
                            detail.summary.forEach(s => summaryArray.push(s.replace(/<[^>]*>/g, '')));
                        }
                    });
                    detailsHtml = summaryArray.join('<br>') || '-';
                }
            }
             const priceToDisplay = isLoadedOrder ? currentEstimate : (order.originalEstimate || currentEstimate);
             tr.innerHTML = `<td>${woodLabel}</td><td>${detailsHtml}</td><td>${order.width} x ${order.length}</td><td>${order.quantity}</td><td>${priceToDisplay.toLocaleString()}ì›</td>${managementCellHtml}`;
             
             // ë©”ì¸ ëª©ì¬ í–‰ì„ ë¨¼ì € ì¶”ê°€í•©ë‹ˆë‹¤.
             orderTableBody.appendChild(tr);
             
             // â–¼â–¼â–¼ [í•µì‹¬ ìˆ˜ì •] ê·¸ ë‹¤ìŒì—, ìƒˆë¡œ ì¶”ê°€í•œ í•­ëª©ì¼ ê²½ìš°ì—ë§Œ í• ì¸ í–‰ì„ ë³„ë„ë¡œ ë§Œë“¤ì–´ ì¶”ê°€í•©ë‹ˆë‹¤. â–¼â–¼â–¼
             if (!isLoadedOrder && order.discount > 0) {
                const discountRow = document.createElement('tr');
                discountRow.className = 'discount-row';
                discountRow.innerHTML = `
                    <td>ì´ë²¤íŠ¸ í• ì¸</td><td>${(order.discountDetails || []).join('<br>')}</td>
                    <td>-</td><td>-</td><td>-${order.discount.toLocaleString()}ì›</td><td></td>`;
                orderTableBody.appendChild(discountRow);
             }
        }
    });

    let totalShippingCost = 0;
    if (!isLoadMode) {
        // ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ëª¨ë“œì—ì„œëŠ” í• ì¸ í•­ëª©ì´ ëª©ì¬ ê°ì²´ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ í•„í„°ë§í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
        const shippingItems = calculateShippingCost(orderData);
        if (shippingItems.length > 0) {
            shippingItems.forEach(item => {
                const shippingCost = item.cost * item.count;
                totalShippingCost += shippingCost;
                const shippingRow = document.createElement('tr');
                shippingRow.className = 'shipping-row';
                shippingRow.innerHTML = `<td>ì˜ˆìƒ ë°°ì†¡ë¹„</td><td>${item.sizeCategory} (ë°•ìŠ¤ ë‹¹ ${item.cost.toLocaleString()}ì›)</td><td>-</td><td style="text-align:center;">${item.count}</td><td>${shippingCost.toLocaleString()}ì›</td><td>-</td>`;
                orderTableBody.appendChild(shippingRow);
            });
        }
    } else {
        totalShippingCost = orderData
            .filter(o => o.type === 'shipping')
            .reduce((sum, item) => sum + (Number(item.estimate) || 0), 0);
    }
    
    const finalTotal = itemsSubtotal + totalShippingCost;
    finalTotalDiv.textContent = `ì´ ê²¬ì  í•©ê³„ (ì˜ˆìƒ ë°°ì†¡ë¹„ í¬í•¨): ${finalTotal.toLocaleString()}ì›`;

    if (orderData.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-summary-row';
        totalRow.innerHTML = `<td colspan="4">ì´ í•©ê³„ (ë°°ì†¡ë¹„ í¬í•¨)</td><td colspan="2">${finalTotal.toLocaleString()}ì›</td>`;
        orderTableBody.appendChild(totalRow);
    }

    if (orderData.length > 0) {
        finalInfo.style.display = 'block';
        const isAllLoaded = orderData.every(order => order.isLoaded);
        document.getElementById('finalInfo').querySelectorAll('input, button').forEach(el => {
            const isControlField = ['sendBtn', 'customerName', 'customerPhone', 'customerEmail'].includes(el.id);
            if (isControlField) { el.disabled = isAllLoaded; } 
            else { el.disabled = false; }
        });
    } else {
        finalInfo.style.display = 'none';
    }
}

function loadOrderForEdit(index) {
    const order = orderData[index];
    if (!order || order.type === 'accessory' || order.isLoaded) return;

    document.getElementById('woodType').value = order.woodTypeValue;
    document.getElementById('width').value = order.width;
    document.getElementById('length').value = order.length;
    document.getElementById('quantity').value = order.quantity;
    document.querySelectorAll('.option').forEach(cb => { cb.checked = order.options.includes(cb.value); cb.closest('.processing-item').classList.toggle('selected', cb.checked); });
    const hingeDetail = order.detailText?.hinge;
    hingeInputMode = hingeDetail?.data?.mode || 'Y_INPUT';
    renderDetails();

    setTimeout(() => {
        if (order.detailText) {
            Object.entries(order.detailText).forEach(([key, detail]) => {
                const container = document.querySelector(`.detail-item-container[data-option-key="${key}"]`);
                if (!container || !detail.data) return;
                const data = detail.data;
                if (container.querySelector(`#memo_${key}`)) container.querySelector(`#memo_${key}`).value = data.memo || '';
                switch (key) {
                    case 'coating': if(data.type) container.querySelector(`#coatingType_${key}`).value = data.type; break;
                    case 'angled': if(data.sides?.length) { data.sides.forEach(val => { const checkbox = container.querySelector(`input[name="angled_side"][value="${val}"]`); if (checkbox) checkbox.checked = true; }); } if (data.memo) container.querySelector(`#angledMemo_${key}`).value = data.memo; break;
                    case 'round': if(data.corners?.length) { data.corners.forEach(val => { const checkbox = container.querySelector(`input[name="round_corner"][value="${val}"]`); if (checkbox) checkbox.checked = true; }); } if (data.memo) container.querySelector(`#roundMemo_${key}`).value = data.memo; break;
                    case 'circlecut': if (Array.isArray(data)) { const tbody = container.querySelector('#circleCutTbody_circlecut'); if (tbody) tbody.innerHTML = ''; data.forEach(cutInfo => addCircleCutRow(key, cutInfo)); } break;
                    case 'squarecut': if (Array.isArray(data)) { const tbody = container.querySelector('#squareCutTbody_squarecut'); if (tbody) tbody.innerHTML = ''; data.forEach(cutInfo => addSquareCutRow(key, cutInfo)); } break;
                    case 'hinge': if (Array.isArray(data.positions) && data.positions.length > 0) { const countInput = container.querySelector(`#hingeCount_${key}`); countInput.value = data.positions.length; hingeInputMode = data.mode || 'Y_INPUT'; updateHingeTable(key); setTimeout(() => { const tbody = container.querySelector(`#hingeTbody_${key}`); if(tbody) { tbody.querySelectorAll('tr').forEach((row, i) => { if (hingeInputMode === 'Y_INPUT') { row.querySelector('.hinge-pos-y').value = data.positions[i].y || ''; } else { row.querySelector('.hinge-pos-x').value = data.positions[i].x || ''; } }); } }, 50); } break;
                }
            });
        }
        updateAll();
    }, 100);

    deleteOrder(index);
    alert('ì„ íƒí•œ í•­ëª©ì„ ì–‘ì‹ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ [ê²¬ì  ë‹´ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteOrder(index) { 
    if (orderData[index] && orderData[index].isLoaded) {
        alert("ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    orderData.splice(index, 1); 
    saveOrders(); 
    renderOrderTable(); 
}

function saveOrders() {
    localStorage.setItem('orderData', JSON.stringify(orderData));
}

document.addEventListener('DOMContentLoaded', () => {
     document.querySelectorAll(".processing-item").forEach(item => {
        item.addEventListener("click", (e) => {
            e.preventDefault();
            const input = item.querySelector("input[type=checkbox]");
            const optionId = input.id;

            if (optionId === 'coating' && !input.checked && document.getElementById('sanding').checked) {
                deselectOption('sanding'); 
                alert("ì½”íŒ… ì‘ì—…ì—ëŠ” ê¸°ë³¸ ìƒŒë”©ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ìƒŒë”© ì˜µì…˜ì´ ìë™ìœ¼ë¡œ í•´ì œë©ë‹ˆë‹¤.");
            }
            
            if (optionId === 'coating' && !input.checked && woodSelect.value === 'pyeonbaek18T') {
                if (!confirm("í¸ë°±ë‚˜ë¬´ì— ì½”íŒ… ì‹œ ê³ ìœ ì˜ í–¥ì´ ì•½í•´ì§ˆ ìˆ˜ ìˆì–´ ì¶”ì²œë“œë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ì½”íŒ…ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return; 
                }
            }

            if (optionId === 'noOption') {
                noOptionCheckbox.checked = true;
                item.classList.add('selected');
                document.querySelectorAll(".option:not(#noOption)").forEach(cb => {
                    cb.checked = false;
                    cb.closest('.processing-item').classList.remove('selected');
                });
                lastFocusedOption = null;
            } else {
                input.checked = !input.checked;
                item.classList.toggle('selected', input.checked);
                if (input.checked) {
                    lastFocusedOption = optionId;
                    noOptionCheckbox.checked = false;
                    noOptionCheckbox.closest('.processing-item').classList.remove('selected');
                } else {
                    if (lastFocusedOption === optionId) lastFocusedOption = null;
                }
                if (document.querySelectorAll('.option:checked:not(#noOption)').length === 0) {
                    noOptionCheckbox.checked = true;
                    noOptionCheckbox.closest('.processing-item').classList.add('selected');
                    lastFocusedOption = null;
                }
            }
            handleProcessingOptionsLogic(); 
            renderDetails();
            updateAll();
        });
    });

    submitBtn.addEventListener('click', () => {
        if (orderData.some(order => order.isLoaded)) {
            alert("ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì´ í¬í•¨ë˜ì–´ ìˆì–´ ìƒˆë¡œ ë‹´ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.");
            return;
        }
        const width = document.getElementById('width').value;
        const length = document.getElementById('length').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        if (!width || !length || parseFloat(width) <= 0 || parseFloat(length) <= 0) {
            alert("í­ê³¼ ê¸¸ì´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (!validateAll()) {
            alert('ì…ë ¥ ê°’ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ í•­ëª©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }

        const area = parseFloat(width) * parseFloat(length);
        const basePrice = getUnitPrice(woodSelect.value, area);
        
        let originalProcessingCost = 0;
        let eventDiscountPerPiece = 0;
        let discountDetails = [];

        const selectedOptions = Array.from(document.querySelectorAll('.option:checked')).map(cb => cb.value);

        selectedOptions.forEach(key => {
          if (key === 'none') return;
          const container = document.querySelector(`.detail-item-container[data-option-key="${key}"]`);
          switch (key) {
            case 'sanding':
              originalProcessingCost += 5000;
              eventDiscountPerPiece += 5000;
              discountDetails.push('ìƒŒë”© ë¬´ë£Œ');
              break;
            case 'coating':
              if (container) {
                const coatingType = container.querySelector('select')?.value;
                const prices = getCoatingPrices();
                const cost = (coatingType === 'ì–‘ë©´' ? prices.double : prices.single);
                originalProcessingCost += cost;
              }
              break;
            case 'angled':
              if (container) {
                const count = container.querySelectorAll('input[name="angled_side"]:checked').length;
                originalProcessingCost += count * 1000;
                if (count > 0) {
                    eventDiscountPerPiece += 1000;
                    discountDetails.push('ì‚¬ì„ ê°€ê³µ 1ë©´ ë¬´ë£Œ');
                }
              }
              break;
            case 'round':
              if (container) {
                const count = container.querySelectorAll('input[name="round_corner"]:checked').length;
                originalProcessingCost += count * 1000;
                if (count > 0) {
                    eventDiscountPerPiece += 1000;
                    discountDetails.push('ëª¨ì„œë¦¬ ë¼ìš´ë“œ 1ê°œ ë¬´ë£Œ');
                }
              }
              break;
            case 'hinge':
              const hingeTbody = document.getElementById('hingeTbody_hinge');
              if (hingeTbody) {
                  const count = hingeTbody.rows.length;
                  originalProcessingCost += count * 1000;
                  
                  const discountCount = Math.min(count, 2);
                  if (discountCount > 0) {
                      eventDiscountPerPiece += discountCount * 1000;
                      discountDetails.push(`ì‹±í¬ê²½ì²© ${discountCount}ê°œ ë¬´ë£Œ`);
                  }
              }
              break;
            case 'circlecut':
              const circleTbody = document.getElementById('circleCutTbody_circlecut');
              if (circleTbody) {
                const count = circleTbody.rows.length;
                originalProcessingCost += count * 3000;
                if (count > 0) {
                    eventDiscountPerPiece += 3000;
                    discountDetails.push('ì›í˜•íƒ€ê³µ 1ê°œ ë¬´ë£Œ');
                }
              }
              break;
            case 'squarecut':
              const squareTbody = document.getElementById('squareCutTbody_squarecut');
              if (squareTbody) {
                const count = squareTbody.rows.length;
                originalProcessingCost += count * 4000;
                if (count > 0) {
                    eventDiscountPerPiece += 4000;
                    discountDetails.push('ì‚¬ê°íƒ€ê³µ 1ê°œ ë¬´ë£Œ');
                }
              }
              break;
          }
        });

        const originalEstimatePerPiece = basePrice + originalProcessingCost;
        const totalOriginalEstimate = originalEstimatePerPiece * quantity;
        const totalEventDiscount = eventDiscountPerPiece * quantity;
        const finalEstimateTotal = totalOriginalEstimate - totalEventDiscount;

        const currentOrder = {
            woodTypeValue: woodSelect.value,
            width: width,
            length: length,
            quantity: quantity,
            noOption: noOptionCheckbox.checked,
            options: selectedOptions,
            detailText: {},
            originalEstimate: totalOriginalEstimate,
            estimate: finalEstimateTotal,
            discount: totalEventDiscount,
            discountDetails: discountDetails
        };

        currentOrder.options.forEach(key => {
            if(key === 'none') return;
            const container = document.querySelector(`.detail-item-container[data-option-key="${key}"]`);
            if(!container) return;
            const details = {};
            let summaryParts = [];
            const memoTextarea = container.querySelector(`#memo_${key}`);
            if(memoTextarea && memoTextarea.value.trim()) details.memo = memoTextarea.value.trim();

            switch (key) {
                case 'sanding': summaryParts.push('<b>ìƒŒë”©</b>'); break;
                case 'coating':
                    const type = container.querySelector(`#coatingType_${key}`).value;
                    const prices = getCoatingPrices();
                    const price = type === 'ì–‘ë©´' ? prices.double : prices.single;
                    details.data = {type};
                    summaryParts.push(`<b>ì½”íŒ…</b>: ${type} (+${price.toLocaleString()}ì›)`);
                    break;
                case 'angled':
                    const sides = Array.from(container.querySelectorAll('input[name="angled_side"]:checked')).map(cb => cb.value);
                    const memoAngled = container.querySelector(`#angledMemo_${key}`)?.value;
                    details.data = {sides, memo: memoAngled};
                    if (sides.length > 0) summaryParts.push(`<b>ì‚¬ì„ </b>: [${sides.join(',')}]ë²ˆ ë©´`);
                    if (memoAngled) summaryParts.push(`[ìš”ì²­ì‚¬í•­] ${memoAngled}`);
                    break;
                case 'round':
                    const corners = Array.from(container.querySelectorAll('input[name="round_corner"]:checked')).map(cb => cb.value);
                    const memoRound = container.querySelector(`#roundMemo_${key}`)?.value;
                    details.data = {corners, memo: memoRound};
                    if (corners.length > 0) summaryParts.push(`<b>ë¼ìš´ë“œ</b>: [${corners.join(',')}]ë²ˆ ëª¨ì„œë¦¬`);
                    if (memoRound) summaryParts.push(`[ìš”ì²­ì‚¬í•­] ${memoRound}`);
                    break;
                case 'circlecut': case 'squarecut':
                    const isCircle = key === 'circlecut';
                    const tbody = container.querySelector(isCircle ? '#circleCutTbody_circlecut' : '#squareCutTbody_squarecut');
                    const cuts = [];
                    tbody.querySelectorAll('tr').forEach((row, index) => {
                        const cutInfo = isCircle ? { x: row.querySelector('.circle-cut-x').value || '0', y: row.querySelector('.circle-cut-y').value || '0', r: row.querySelector('.circle-cut-r').value || '0', memo: row.querySelector('.circle-cut-memo').value || '' } : { x: row.querySelector('.square-cut-x').value || '0', y: row.querySelector('.square-cut-y').value || '0', w: row.querySelector('.square-cut-w').value || '0', h: row.querySelector('.square-cut-h').value || '0', memo: row.querySelector('.square-cut-memo').value || '' };
                        cuts.push(cutInfo);
                        const summaryText = isCircle ? `<b>ì›í˜•${index+1}</b>: (X:${cutInfo.x},Y:${cutInfo.y}), R:${cutInfo.r}` : `<b>ì‚¬ê°${index+1}</b>: (X:${cutInfo.x},Y:${cutInfo.y}), ${cutInfo.w}x${cutInfo.h}`;
                        summaryParts.push(`${summaryText} <small>(${cutInfo.memo})</small>`);
                    });
                    details.data = cuts;
                    break;
                case 'hinge':
                    const hingePositions = [];
                    container.querySelector(`#hingeTbody_${key}`)?.querySelectorAll('tr').forEach((row, index) => {
                        let xPos, yPos;
                        if (hingeInputMode === 'Y_INPUT') {
                            xPos = 23; yPos = row.querySelector('.hinge-pos-y').value || '0';
                        } else {
                            xPos = row.querySelector('.hinge-pos-x').value || '0'; yPos = 23;
                        }
                        hingePositions.push({ x: xPos, y: yPos });
                        summaryParts.push(`<b>ê²½ì²©${index+1}</b>: (X:${xPos}, Y:${yPos})`);
                    });
                    details.data = { mode: hingeInputMode, positions: hingePositions };
                    break;
            }
            if (details.memo && !['round', 'angled', 'hinge', 'coating'].includes(key)) {
                summaryParts.push(`[ìš”ì²­ì‚¬í•­] ${details.memo}`);
            }
            if(summaryParts.length > 0) {
                currentOrder.detailText[key] = { data: details.data, summary: summaryParts };
            }
        });

        orderData.push(currentOrder);
        saveOrders();
        renderOrderTable();
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const email = document.getElementById('customerEmail').value.trim();

        if (!name || !phone) { alert("ì„±í•¨, íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        const phoneRegex = /^010-\d{4}-\d{4}$/;
        if (!phoneRegex.test(phone)) {
            alert("íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥¸ í˜•ì‹(010-1234-5678)ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            document.getElementById('customerPhone').focus();
            return;
        }

        if (orderData.length === 0) { alert("ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (orderData.every(order => order.isLoaded)) { alert("ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ë‹¤ì‹œ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

        showProgressModal();

        const reconstructedOrders = [];
        const sourceOrders = orderData.filter(order => !order.isLoaded);

        sourceOrders.forEach(order => {
            const originalOrder = JSON.parse(JSON.stringify(order));
            if (originalOrder.originalEstimate) {
                originalOrder.estimate = originalOrder.originalEstimate;
            }
            reconstructedOrders.push(originalOrder);
            if (order.discount > 0) {
                reconstructedOrders.push({
                    woodTypeValue: 'ì´ë²¤íŠ¸ í• ì¸',
                    width: '-', length: '-', quantity: '-',
                    detailText: { summary: (order.discountDetails || []).join(', ') },
                    estimate: -order.discount, type: 'discount'
                });
            }
        });

        const itemsSubtotal = orderData.reduce((sum, item) => sum + item.estimate, 0);
        const shippingItems = calculateShippingCost(orderData);
        const totalShippingCost = shippingItems.reduce((sum, item) => sum + (item.cost * item.count), 0);
        const finalTotal = itemsSubtotal + totalShippingCost;

        const finalOrder = {
            customer: { name, phone, email },
            orders: reconstructedOrders,
            shippingItems: shippingItems,
            shippingCost: totalShippingCost,
            totalPrice: finalTotal
        };

        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        sendBtn.textContent = 'ì „ì†¡ ì¤‘...';

        const formData = new FormData();
        formData.append('data', JSON.stringify(finalOrder));

        setTimeout(() => {
            updateProgress(40, 'ê²¬ì  ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            
            fetch(SPREADSHEET_API_URL2, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(result => {
                console.log('Server response:', result);
                if (result.result === "success" && result.orderNo) {
        // ì „ì†¡ ì„±ê³µ ì‹œ, 2ì´ˆ í›„ progress ëª¨ë‹¬ì„ ë‹«ê³  ì£¼ë¬¸ ì•ˆë‚´ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
        showProgressSuccess('ê²¬ì ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! ì ì‹œ í›„ ê²°ì œ ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.');
        
        setTimeout(() => {
            hideProgressModal(); // ë¡œë”©ì°½ ë‹«ê¸°
            // ì„œë²„ì—ì„œ ë°›ì€ ì£¼ë¬¸ë²ˆí˜¸(result.orderNo)ì™€ ì´ ê²¬ì (finalTotal)ìœ¼ë¡œ ìƒˆ ëª¨ë‹¬ ì—´ê¸°
            openInstructionsModal(result.orderNo, finalTotal); 
        }, 2000);

    } else {
        // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë¡œì§ ìœ ì§€
        showProgressError('ì„œë²„ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (result.message || 'Unknown error'));
    }
    // â–²â–²â–²â–²â–² [í•µì‹¬ ìˆ˜ì •] ì—¬ê¸°ê¹Œì§€ ì…ë‹ˆë‹¤ â–²â–²â–²â–²â–²
})
            .catch(error => {
                console.error('Fetch Error:', error);
                showProgressError('ì „ì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ë³´ë‚´ê¸°';
            });
        }, 500);
    });

    progressModalCloseBtn.addEventListener('click', hideProgressModal);

    document.querySelectorAll('.accessory-category').forEach(category => {
        category.addEventListener('click', () => {
            const targetId = category.dataset.target;
            const targetPanel = document.getElementById(targetId);
            const isActive = category.classList.contains('active');
            
            document.querySelectorAll('.accessory-category').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.accessory-details').forEach(p => p.style.display = 'none');
            
            if (!isActive) {
                category.classList.add('active');
                if (targetPanel) targetPanel.style.display = 'grid';
            }
        });
    });
    document.getElementById('accessory-details-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('add-accessory-btn')) {
            const itemElement = e.target.closest('.accessory-item');
            const quantityInput = itemElement.querySelector('.accessory-quantity');
            const name = itemElement.dataset.name;
            const price = parseInt(itemElement.dataset.price, 10);
            const quantity = parseInt(quantityInput.value, 10);
            if (quantity > 0) {
                const accessoryOrder = { type: 'accessory', name: name, quantity: quantity, estimate: price * quantity };
                orderData.push(accessoryOrder);
                saveOrders();
                renderOrderTable();
                alert(`'${name}' ${quantity}ê°œë¥¼ ì£¼ë¬¸ ë‚´ì—­ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
                quantityInput.value = '1';
            } else {
                alert('ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }
    });

    document.querySelectorAll('#width, #length, #quantity, #woodType').forEach(el => {
        el.addEventListener('input', () => {
            if (el.id === 'woodType') {
                woodImg.src = woodSelect.options[woodSelect.selectedIndex].getAttribute('data-image');
                handleProcessingOptionsLogic();
            }
            if (el.id === 'width' || el.id === 'length') {
                resetCameraPosition();
            }
            updateAll();
        });
    });
    window.onclick = function(event) { 
        if (event.target == loadOrderModal) { closeLoadModal(); }
        if (event.target == videoModal) { closeVideoModal(); }
    }
});

function resetForm(fullReset = true) {
    document.getElementById('woodType').selectedIndex = 0;
    document.getElementById('width').value = '';
    document.getElementById('length').value = '';
    document.getElementById('quantity').value = '1';
    noOptionCheckbox.checked = true;
    noOptionCheckbox.closest('.processing-item').classList.add('selected');
    document.querySelectorAll(".option:not(#noOption)").forEach(cb => {
        cb.checked = false;
        cb.closest('.processing-item').classList.remove('selected');
    });
    lastFocusedOption = null;
    hingeInputMode = 'Y_INPUT';
    handleProcessingOptionsLogic();
    renderDetails();
    updateAll();
    resetCameraPosition();
    if (fullReset) {
        orderData = [];
        saveOrders();
        renderOrderTable();
        ['customerName', 'customerPhone', 'customerEmail'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('finalInfo').querySelectorAll('input, button').forEach(el => el.disabled = false);
    }
}

function updateAll() {
    const widthInput = document.getElementById('width');
    const lengthInput = document.getElementById('length');
    const width = parseFloat(widthInput.value) || 0;
    const length = parseFloat(lengthInput.value) || 0;
    let isValid = true;

    widthInput.style.backgroundColor = (width > 600) ? '#ffdddd' : '';
    if (width > 600) isValid = false;

    lengthInput.style.backgroundColor = (length > 1800) ? '#ffdddd' : '';
    if (length > 1800) isValid = false;
    
    if (!isValid) {
        totalDiv.textContent = 'ìµœëŒ€ ì‚¬ì´ì¦ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.';
        if (width > 600) alert("í­ì˜ ìµœëŒ€ ê¸¸ì´ëŠ” 600mm ì…ë‹ˆë‹¤.");
        if (length > 1800) alert("ê¸¸ì´ì˜ ìµœëŒ€ ê¸¸ì´ëŠ” 1800mm ì…ë‹ˆë‹¤.");
        return;
    }

    calculate();
    validateAll();
    updateWoodModel();
    updateCoatingOptionText();
}

function showProgressModal() {
    progressTitle.textContent = 'ì „ì†¡ ì¤‘...';
    progressIcon.src = 'https://i.gifer.com/ZZ5H.gif';
    progressIcon.alt = 'ë¡œë”© ì¤‘';
    progressModalCloseBtn.style.display = 'none';
    progressBar.style.backgroundColor = '#007bff';
    progressModalOverlay.style.display = 'flex';
    updateProgress(10, 'ì „ì†¡ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
}

function updateProgress(percent, message) {
    progressBar.style.width = percent + '%';
    progressStatusText.textContent = message;
}

function showProgressSuccess(message) {
    updateProgress(100, message);
    progressTitle.textContent = 'ì „ì†¡ ì™„ë£Œ';
    progressIcon.src = 'https://i.imgur.com/UDS2wje.png';
    progressIcon.alt = 'ì„±ê³µ';
    progressModalCloseBtn.style.display = 'block';
}

function showProgressError(message) {
    updateProgress(100, message);
    progressBar.style.backgroundColor = '#dc3545';
    progressTitle.textContent = 'ì „ì†¡ ì‹¤íŒ¨';
    progressIcon.src = 'https://i.imgur.com/P4Q6r5A.png';
    progressIcon.alt = 'ì‹¤íŒ¨';
    progressModalCloseBtn.style.display = 'block';
}

function hideProgressModal() {
    progressModalOverlay.style.display = 'none';
}

function formatPhoneNumber(input) {
    let val = input.value.replace(/\D/g, '');
    if (val.length > 3 && val.length <= 7) val = `${val.slice(0,3)}-${val.slice(3)}`;
    else if (val.length > 7) val = `${val.slice(0,3)}-${val.slice(3,7)}-${val.slice(7,11)}`;
    input.value = val;
}

function renderDetails() {
    const selectedKeys = new Set(Array.from(document.querySelectorAll('.option:checked:not(#noOption)')).map(cb => cb.value));
    detailGroup.style.display = selectedKeys.size > 0 ? 'block' : 'none';
    const currentlyDisplayed = new Set(Array.from(detailsContainer.querySelectorAll('.detail-item-container')).map(c => c.dataset.optionKey));
    
    selectedKeys.forEach(key => {
        if (!currentlyDisplayed.has(key)) {
            const info = optionDetails[key];
            if (!info) return;
            const container = document.createElement('div');
            container.className = 'detail-item-container';
            container.setAttribute('data-option-key', key);
            const removeBtnHtml = `<button class="remove-detail-btn" onclick="deselectOption('${key}')" title="ê°€ê³µ í•´ì œ">Ã—</button>`;
            const imagePanel = `<div class="detail-image-panel"><img src="${info.image}" alt="${info.label} ê°€ì´ë“œ ì´ë¯¸ì§€"></div>`;
            let inputsHtml = `<div class="detail-input-panel">${removeBtnHtml}<h4>${info.label} ìƒì„¸ ì„¤ì •</h4><p>${info.description || ''}</p>`;

            switch (key) {
                case 'coating': inputsHtml += `<div class="input-group"><label for="coatingType_${key}">ì½”íŒ… ë°©ì‹</label><select id="coatingType_${key}" onchange="updateAll()"><option value="ë‹¨ë©´">ë‹¨ë©´ ì½”íŒ…</option><option value="ì–‘ë©´">ì–‘ë©´ ì½”íŒ…</option></select></div>`; break;
                case 'angled': inputsHtml += `<table class="detail-table"><thead><tr><th>A(ì¢Œì¸¡)</th><th>B(ìƒë‹¨)</th><th>C(ìš°ì¸¡)</th><th>D(í•˜ë‹¨)</th></tr></thead><tbody><tr><td><input type="checkbox" name="angled_side" value="A" oninput="updateAll()"></td><td><input type="checkbox" name="angled_side" value="B" oninput="updateAll()"></td><td><input type="checkbox" name="angled_side" value="C" oninput="updateAll()"></td><td><input type="checkbox" name="angled_side" value="D" oninput="updateAll()"></td></tr></tbody></table><div class="input-group" style="margin-top:10px;"><label for="angledMemo_${key}">ìš”ì²­ì‚¬í•­</label><input type="text" id="angledMemo_${key}" placeholder="ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”."></div>`; break;
                case 'round': inputsHtml += `<table class="detail-table"><thead><tr><th>1ë²ˆ(ì¢Œìƒ)</th><th>2ë²ˆ(ì¢Œí•˜)</th><th>3ë²ˆ(ìš°ìƒ)</th><th>4ë²ˆ(ìš°í•˜)</th></tr></thead><tbody><tr><td><input type="checkbox" name="round_corner" value="1" oninput="updateAll()"></td><td><input type="checkbox" name="round_corner" value="2" oninput="updateAll()"></td><td><input type="checkbox" name="round_corner" value="3" oninput="updateAll()"></td><td><input type="checkbox" name="round_corner" value="4" oninput="updateAll()"></td></tr></tbody></table><div class="input-group" style="margin-top:10px;"><label for="roundMemo_${key}">ìš”ì²­ì‚¬í•­</label><input type="text" id="roundMemo_${key}" placeholder="ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”."></div>`; break;
                case 'circlecut': inputsHtml += `<div class="table-container"><table class="detail-table"><thead><tr><th>X(mm)</th><th>Y(mm)</th><th>ë°˜ì§€ë¦„(R)</th><th>ìš”ì²­</th><th>ê´€ë¦¬</th></tr></thead><tbody id="circleCutTbody_${key}"></tbody></table></div><button type="button" class="action-btn add-row-btn" onclick="addCircleCutRow('${key}')">íƒ€ê³µ ì¶”ê°€</button>`; setTimeout(() => addCircleCutRow(key), 0); break;
               case 'squarecut': inputsHtml += `<div class="table-container"><table class="detail-table"><thead><tr><th>X1 (mm)</th><th>Y1 (mm)</th><th>X2 (mm)</th><th>Y2 (mm)</th><th>ìš”ì²­</th><th>ê´€ë¦¬</th></tr></thead><tbody id="squareCutTbody_${key}"></tbody></table></div><button type="button" class="action-btn add-row-btn" onclick="addSquareCutRow('${key}')">íƒ€ê³µ ì¶”ê°€</button>`; setTimeout(() => addSquareCutRow(key), 0); break;
                case 'hinge': inputsHtml += `<div class="input-group" style="display: flex; flex-direction: row; align-items: center; gap: 10px;"><label for="hingeCount_${key}" style="flex-shrink: 0; margin-top: 0;">ê²½ì²© ê°œìˆ˜</label><input type="number" id="hingeCount_${key}" value="2" min="1" oninput="updateHingeTable('${key}')" style="width: 80px; flex-grow: 0; margin-top: 0;"><button type="button" class="action-btn toggle-axis-btn" onclick="toggleHingeInputMode('${key}')" style="padding: 8px 12px; font-size: 0.9em; margin-top: 0; flex-grow: 1;">X/Y ì¶• ë³€ê²½</button></div><p style="font-size: 0.9em; color: #555; margin-top: 5px;">ğŸ’¡ <strong>Tip:</strong> ì¢Œí‘œë¥¼ ë¹„ì›Œë‘ì‹œë©´, ëª©ìˆ˜ê°€ ëª©ì¬ ì‚¬ì´ì¦ˆì— ë§ì¶° ê· ë“±í•˜ê²Œ ê°€ê³µí•´ ë“œë¦½ë‹ˆë‹¤.</p><div class="table-container"><table class="detail-table" style="margin-top:10px;"><thead id="hingeThead_${key}"></thead><tbody id="hingeTbody_${key}"></tbody></table></div>`; setTimeout(() => updateHingeTable(key), 0); break;
                default: inputsHtml += `<div class="input-group"><label for="memo_${key}">ì¶”ê°€ ìš”ì²­ì‚¬í•­</label><textarea id="memo_${key}" rows="3"></textarea></div>`;
            }
            inputsHtml += `</div>`;
            container.innerHTML = imagePanel + inputsHtml;
            detailsContainer.appendChild(container);
        }
    });
    detailsContainer.querySelectorAll('.detail-item-container').forEach(c => {
        if (!selectedKeys.has(c.dataset.optionKey)) c.remove();
    });
}

function deselectOption(key) {
    const checkbox = document.getElementById(key);
    if (!checkbox) return;
    checkbox.checked = false;
    checkbox.closest('.processing-item').classList.remove('selected');
    if (document.querySelectorAll('.option:checked:not(#noOption)').length === 0) {
        noOptionCheckbox.checked = true;
        noOptionCheckbox.closest('.processing-item').classList.add('selected');
    }
    renderDetails();
    updateAll();
}

function addCircleCutRow(key, data = { x: '', y: '', r: '', memo: '' }) { const tbody = document.getElementById(`circleCutTbody_${key}`); if (!tbody) return; const newRow = tbody.insertRow(); newRow.innerHTML = `<td><input type="number" class="circle-cut-x number-input" placeholder="X" value="${data.x}" oninput="updateAll()"></td><td><input type="number" class="circle-cut-y number-input" placeholder="Y" value="${data.y}" oninput="updateAll()"></td><td><input type="number" class="circle-cut-r number-input" placeholder="R" value="${data.r}" oninput="updateAll()"></td><td><input type="text" class="circle-cut-memo memo-input" placeholder="ìš”ì²­ì‚¬í•­" value="${data.memo}"></td><td><button type="button" class="action-btn delete-btn delete-btn-short" onclick="this.closest('tr').remove(); updateAll();">-</button></td>`; updateAll(); }
function addSquareCutRow(key, data = { x: '', y: '', w: '', h: '', memo: '' }) { const tbody = document.getElementById(`squareCutTbody_${key}`); if (!tbody) return; const newRow = tbody.insertRow(); newRow.innerHTML = `<td><input type="number" class="square-cut-x number-input" placeholder="X1" value="${data.x}" oninput="updateAll()"></td><td><input type="number" class="square-cut-y number-input" placeholder="Y1" value="${data.y}" oninput="updateAll()"></td><td><input type="number" class="square-cut-w number-input" placeholder="X2" value="${data.w}" oninput="updateAll()"></td><td><input type="number" class="square-cut-h number-input" placeholder="Y2" value="${data.h}" oninput="updateAll()"></td><td><input type="text" class="square-cut-memo memo-input" placeholder="ìš”ì²­ì‚¬í•­" value="${data.memo}"></td><td><button type="button" class="action-btn delete-btn delete-btn-short" onclick="this.closest('tr').remove(); updateAll();">-</button></td>`; updateAll(); }
function toggleHingeInputMode(key) { hingeInputMode = (hingeInputMode === 'Y_INPUT') ? 'X_INPUT' : 'Y_INPUT'; updateHingeTable(key); }
function updateHingeTable(key) { const countInput = document.getElementById(`hingeCount_${key}`); const thead = document.getElementById(`hingeThead_${key}`); const tbody = document.getElementById(`hingeTbody_${key}`); if (!countInput || !tbody || !thead) return; const count = parseInt(countInput.value) || 0; tbody.innerHTML = ''; if (hingeInputMode === 'Y_INPUT') { thead.innerHTML = `<tr><th>ë²ˆí˜¸</th><th>X ì¢Œí‘œ</th><th>Y ì¢Œí‘œ (ìƒë‹¨ ê¸°ì¤€)</th></tr>`; for (let i = 0; i < count; i++) { const newRow = tbody.insertRow(); newRow.innerHTML = `<td>${i + 1}</td><td>23 mm (ê³ ì •)</td><td><input type="number" class="hinge-pos-y" placeholder="Y ì¢Œí‘œ" value="" oninput="updateAll()"></td>`; } } else { thead.innerHTML = `<tr><th>ë²ˆí˜¸</th><th>X ì¢Œí‘œ (ì¢Œì¸¡ ê¸°ì¤€)</th><th>Y ì¢Œí‘œ</th></tr>`; for (let i = 0; i < count; i++) { const newRow = tbody.insertRow(); newRow.innerHTML = `<td>${i + 1}</td><td><input type="number" class="hinge-pos-x" placeholder="X ì¢Œí‘œ" value="" oninput="updateAll()"></td><td>23 mm (ê³ ì •)</td>`; } } updateAll(); }
function validateAll() { let isValid = true; if (document.getElementById('circlecut')?.checked && !validateCircleCut()) isValid = false; if (document.getElementById('squarecut')?.checked && !validateSquareCut()) isValid = false; return isValid; }
function validateCircleCut() { let isValid = true; const width = parseFloat(document.getElementById('width').value) || 0; const length = parseFloat(document.getElementById('length').value) || 0; const tableBody = document.getElementById('circleCutTbody_circlecut'); if (!tableBody) return true; tableBody.querySelectorAll('tr').forEach(row => { const xInput = row.querySelector('.circle-cut-x'); const yInput = row.querySelector('.circle-cut-y'); const x = parseFloat(xInput.value) || 0; const y = parseFloat(yInput.value) || 0; const r = parseFloat(row.querySelector('.circle-cut-r').value) || 0; xInput.style.borderColor = (x - r < 0 || x + r > width) ? 'red' : ''; yInput.style.borderColor = (y - r < 0 || y + r > length) ? 'red' : ''; if (xInput.style.borderColor === 'red' || yInput.style.borderColor === 'red') isValid = false; }); return isValid; }
function validateSquareCut() { let isValid = true; const width = parseFloat(document.getElementById('width').value) || 0; const length = parseFloat(document.getElementById('length').value) || 0; const tableBody = document.getElementById('squareCutTbody_squarecut'); if (!tableBody) return true; tableBody.querySelectorAll('tr').forEach(row => { const xInput = row.querySelector('.square-cut-x'); const yInput = row.querySelector('.square-cut-y'); const x = parseFloat(xInput.value) || 0; const y = parseFloat(yInput.value) || 0; const w = parseFloat(row.querySelector('.square-cut-w').value) || 0; const h = parseFloat(row.querySelector('.square-cut-h').value) || 0; xInput.style.borderColor = (x < 0 || x + w > width) ? 'red' : ''; yInput.style.borderColor = (y < 0 || y + h > length) ? 'red' : ''; if (xInput.style.borderColor === 'red' || yInput.style.borderColor === 'red') isValid = false; }); return isValid; }

function getBaseShippingCost(length) { if (length <= 600) return 5000; if (length > 600 && length <= 1200) return 8000; if (length > 1200 && length <= 1800) return 10000; return 10000; }
function getShippingSizeCategory(length) { if (length <= 600) return "ê¸¸ì´ 600mm ì´í•˜"; if (length <= 1200) return "ê¸¸ì´ 601 ~ 1200mm"; return "ê¸¸ì´ 1201 ~ 1800mm"; }
function calculateShippingCost(currentOrderData) {
    if (!currentOrderData || currentOrderData.length === 0) return [];
    const hasWoodPanel = currentOrderData.some(order => order.woodTypeValue);
    if (!hasWoodPanel && currentOrderData.length > 0) { return [{ cost: 4000, sizeCategory: "ë¶€ìì¬ ê¸°ë³¸ ë°°ì†¡ë¹„", count: 1 }]; }
    const allPieces = [];
    currentOrderData.forEach(order => {
        if (order.woodTypeValue) {
            for (let i = 0; i < parseInt(order.quantity, 10); i++) {
                const w = parseFloat(order.width);
                const l = parseFloat(order.length);
                allPieces.push({ width: Math.min(w, l), length: Math.max(w, l) });
            }
        }
    });
    if (allPieces.length === 0) return [];
    allPieces.sort((a, b) => (b.width * b.length) - (a.width * a.length));
    const packages = [];
    allPieces.forEach(piece => {
        let isPacked = false;
        for (const pack of packages) {
            if (pack.pieces.length < 5 && piece.width <= pack.base.width && piece.length <= pack.base.length) {
                pack.pieces.push(piece);
                isPacked = true;
                break;
            }
        }
        if (!isPacked) packages.push({ base: piece, pieces: [piece] });
    });
    const groupedPackages = {};
    packages.forEach(pack => {
        const cost = getBaseShippingCost(pack.base.length);
        if (!groupedPackages[cost]) groupedPackages[cost] = { cost: cost, sizeCategory: getShippingSizeCategory(pack.base.length), count: 0 };
        groupedPackages[cost].count++;
    });
    return Object.values(groupedPackages);
}

function downloadOrderReport() {
    if (orderData.length === 0) { alert("ë‹¤ìš´ë¡œë“œí•  ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    const reportDiv = document.getElementById('reportContainer');
    const name = document.getElementById('customerName').value.trim() || 'ê³ ê°';
    const phone = document.getElementById('customerPhone').value.trim();
    const now = new Date();
    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    document.getElementById('report-customerName').textContent = name;
    document.getElementById('report-customerPhone').textContent = phone;
    document.getElementById('report-date').textContent = dateStr;
    const itemsTbody = document.getElementById('report-items-tbody');
    itemsTbody.innerHTML = '';
    let itemsSubtotal = 0;
    orderData.forEach((order) => {
        let detailsText = '', sizeText = '', nameText = '';
        const displayPrice = order.originalEstimate ? order.originalEstimate : order.estimate;
        if(order.woodTypeValue){
            const woodOption = woodSelect.querySelector(`option[value="${order.woodTypeValue}"]`);
            nameText = woodOption ? woodOption.text : 'ì•Œìˆ˜ì—†ìŒ';
            sizeText = `${order.width} x ${order.length}<br>(${order.quantity}ê°œ)`;
            if (order.isLoaded) {
                 detailsText = (order.detailText?.loaded?.summary || ['-']).join('<br>');
            } else if (order.noOption) {
                detailsText = 'ê°€ê³µ ì—†ìŒ';
            } else {
                const detailsArray = [];
                Object.values(order.detailText).forEach(detail => {
                    if(detail.summary && detail.summary.length > 0) detail.summary.forEach(line => detailsArray.push(line.replace(/<[^>]*>/g, '')));
                });
                detailsText = detailsArray.join('<br>') || '-';
            }
        } else if (order.type === 'accessory') {
            nameText = `[ë¶€ìì¬] ${order.name}`;
            sizeText = `ìˆ˜ëŸ‰: ${order.quantity}ê°œ`;
            detailsText = '-';
        }
        const row = itemsTbody.insertRow();
        row.innerHTML = `<td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;">${nameText}</td><td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;">${sizeText}</td><td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;">${detailsText}</td><td style="border: 1px solid #ddd; padding: 10px; vertical-align: top; text-align: right;">${displayPrice.toLocaleString()} ì›</td>`;
        
        if (order.discount > 0) {
            const discountRow = itemsTbody.insertRow();
            discountRow.style.color = '#d9534f';
            discountRow.innerHTML = `
                <td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;"><strong>ì´ë²¤íŠ¸ í• ì¸</strong></td>
                <td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;" colspan="2">${(order.discountDetails || []).join(', ')}</td>
                <td style="border: 1px solid #ddd; padding: 10px; vertical-align: top; text-align: right;"><strong>-${order.discount.toLocaleString()} ì›</strong></td>
            `;
        }
        itemsSubtotal += order.estimate;
    });
    const shippingItems = calculateShippingCost(orderData);
    let totalShippingCost = 0;
    if (shippingItems.length > 0) {
        shippingItems.forEach(item => {
            const shippingCost = item.cost * item.count;
            totalShippingCost += shippingCost;
            const row = itemsTbody.insertRow();
            row.innerHTML = `<td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;"><strong>ì˜ˆìƒ ë°°ì†¡ë¹„</strong></td><td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;">${item.sizeCategory}<br>(${item.count}ê°œ)</td><td style="border: 1px solid #ddd; padding: 10px; vertical-align: top;">ë°•ìŠ¤ ë‹¹ ${item.cost.toLocaleString()}ì›</td><td style="border: 1px solid #ddd; padding: 10px; vertical-align: top; text-align: right;">${shippingCost.toLocaleString()} ì›</td>`;
        });
    }
    document.getElementById('report-totalPrice').textContent = `${(itemsSubtotal + totalShippingCost).toLocaleString()} ì›`;
    reportDiv.style.display = 'block';
    html2canvas(reportDiv).then(canvas => {
        reportDiv.style.display = 'none';
        const image = canvas.toDataURL('image/png', 1.0);
        const a = document.createElement('a');
        a.href = image;
        a.download = `ì£¼ë¬¸ë‚´ì—­ì„œ_${name}_${dateStr}.png`;
        a.click();
    });
}

const canvas = document.getElementById('previewCanvas');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf0f0f0);
const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
renderer.setPixelRatio(window.devicePixelRatio);
const initialWidth = canvas.clientWidth || 500;
const initialHeight = canvas.clientHeight || 400;
renderer.setSize(initialWidth, initialHeight);
const camera = new THREE.PerspectiveCamera(50, initialWidth / initialHeight, 0.1, 1000);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
scene.add(new THREE.AmbientLight(0xdddddd));
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(5, 10, 7.5);
scene.add(light);
let woodMesh = null;
let sceneObjects = [];
function resetCameraPosition() {
    const width = parseFloat(document.getElementById('width').value) || 300;
    const length = parseFloat(document.getElementById('length').value) || 1200;
    const height = 18;
    const maxDim = Math.max(width, length, height) / 100;
    camera.position.set(maxDim * 0.7, maxDim * 0.7, maxDim * 1.2);
    camera.lookAt(0, 0, 0);
    controls.target.set(0, 0, 0);
}
function animate() { requestAnimationFrame(animate); activeLabels.forEach(label => { const screenPosition = label.position.clone().project(camera); if (screenPosition.z > 1.0) { label.element.style.display = 'none'; } else { label.element.style.display = 'block'; const x = (screenPosition.x * 0.5 + 0.5) * canvas.clientWidth; const y = (-screenPosition.y * 0.5 + 0.5) * canvas.clientHeight; label.element.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`; } }); controls.update(); renderer.render(scene, camera); }
animate();
function createLabel(text, positionVector, color) { const div = document.createElement('div'); div.textContent = text; div.style.position = 'absolute'; div.style.color = color; div.style.fontWeight = 'bold'; div.style.backgroundColor = 'rgba(255, 255, 255, 0.7)'; div.style.padding = '2px 5px'; div.style.borderRadius = '3px'; div.style.fontSize = '12px'; div.style.whiteSpace = 'nowrap'; div.style.userSelect = 'none'; labelsContainer.appendChild(div); activeLabels.push({ element: div, position: positionVector }); }
function clearLabels() { activeLabels.forEach(label => labelsContainer.removeChild(label.element)); activeLabels = []; }
function createDimensionLine(start, end, labelText, color) { const lineMaterial = new THREE.LineBasicMaterial({ color: 0xff0000 }); const offset = 0.2; let p1, p2; if (Math.abs(start.x - end.x) > Math.abs(start.z - end.z)) { const zOffset = start.z > 0 ? offset : -offset; p1 = new THREE.Vector3(start.x, start.y, start.z + zOffset); p2 = new THREE.Vector3(end.x, end.y, end.z + zOffset); } else { const xOffset = start.x > 0 ? offset : -offset; p1 = new THREE.Vector3(start.x + xOffset, start.y, start.z); p2 = new THREE.Vector3(end.x + xOffset, end.y, end.z); } const line1 = new THREE.Line(new THREE.BufferGeometry().setFromPoints([start, p1]), lineMaterial); const line2 = new THREE.Line(new THREE.BufferGeometry().setFromPoints([end, p2]), lineMaterial); const mainLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints([p1, p2]), lineMaterial); scene.add(line1, line2, mainLine); sceneObjects.push(line1, line2, mainLine); const labelPos = p1.clone().lerp(p2, 0.5); createLabel(labelText, labelPos, color); }
function createCornerLabel(text, position, color) { const offset = 0.3; let labelPos = position.clone(); labelPos.x += Math.sign(position.x || 0.1) * offset; labelPos.y += offset; labelPos.z += Math.sign(position.z || 0.1) * offset; createLabel(text, labelPos, color); }
function updateWoodModel() { const width = parseFloat(document.getElementById('width').value) || 0; const length = parseFloat(document.getElementById('length').value) || 0; const height = 18; if (woodMesh) scene.remove(woodMesh); sceneObjects.forEach(obj => scene.remove(obj)); sceneObjects = []; clearLabels(); if (width <= 0 || length <= 0) { renderer.render(scene, camera); return; } const geometry = new THREE.BoxGeometry(width / 100, height / 100, length / 100); const texture = new THREE.TextureLoader().load('https://gi.esmplus.com/irn2011/click/texture/line_texture.jpg'); texture.repeat.set(width / 300, length / 1200); texture.wrapS = THREE.RepeatWrapping; texture.wrapT = THREE.RepeatWrapping; const woodMaterial = new THREE.MeshPhongMaterial({ map: texture }); const pinkMaterial = new THREE.MeshPhongMaterial({ color: 0xff69b4 }); const whiteMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff }); const blueHighlightMaterial = new THREE.MeshPhongMaterial({ color: 0x007bff, transparent: true, opacity: 0.7 }); const materials = Array(6).fill(null).map(() => woodMaterial.clone()); const selectedOptionValues = Array.from(document.querySelectorAll('.option:checked:not(#noOption)')).map(opt => opt.value); if (['circlecut', 'squarecut', 'hinge'].includes(lastFocusedOption)) materials[2] = whiteMaterial; if (selectedOptionValues.includes('angled')) { const container = document.querySelector('.detail-item-container[data-option-key="angled"]'); container?.querySelectorAll('input[name="angled_side"]:checked').forEach(cb => { if (cb.value === 'A') materials[1] = blueHighlightMaterial; if (cb.value === 'B') materials[4] = blueHighlightMaterial; if (cb.value === 'C') materials[0] = blueHighlightMaterial; if (cb.value === 'D') materials[5] = blueHighlightMaterial; }); } if (selectedOptionValues.includes('coating')) { const select = document.querySelector('.detail-item-container[data-option-key="coating"] select'); if (select?.value === 'ë‹¨ë©´') materials[2] = pinkMaterial; else if (select?.value === 'ì–‘ë©´') { materials[2] = pinkMaterial; materials[3] = pinkMaterial; } } woodMesh = new THREE.Mesh(geometry, materials); scene.add(woodMesh); const edges = new THREE.EdgesGeometry(geometry); const lineMaterial = new THREE.LineBasicMaterial({ color: 0x000000 }); const edgeLines = new THREE.LineSegments(edges, lineMaterial); woodMesh.add(edgeLines); const topY = height / 200; const w_half = width / 200; const l_half = length / 200; switch (lastFocusedOption) { case 'angled': createCornerLabel('A(ì¢Œì¸¡)', new THREE.Vector3(-w_half, topY, 0), 'blue'); createCornerLabel('B(ìƒë‹¨)', new THREE.Vector3(0, topY, l_half), 'blue'); createCornerLabel('C(ìš°ì¸¡)', new THREE.Vector3(w_half, topY, 0), 'blue'); createCornerLabel('D(í•˜ë‹¨)', new THREE.Vector3(0, topY, -l_half), 'blue'); break; case 'round': createDimensionLine(new THREE.Vector3(-w_half, topY, l_half), new THREE.Vector3(w_half, topY, l_half), `í­: ${width}mm`, 'black'); createDimensionLine(new THREE.Vector3(-w_half, topY, -l_half), new THREE.Vector3(-w_half, topY, l_half), `ê¸¸ì´: ${length}mm`, 'black'); createCornerLabel('1', new THREE.Vector3(-w_half, topY, l_half), 'blue'); createCornerLabel('2', new THREE.Vector3(-w_half, topY, -l_half), 'blue'); createCornerLabel('3', new THREE.Vector3(w_half, topY, l_half), 'blue'); createCornerLabel('4', new THREE.Vector3(w_half, topY, -l_half), 'blue'); break; case 'circlecut': case 'squarecut': case 'hinge': createDimensionLine(new THREE.Vector3(-w_half, topY, l_half), new THREE.Vector3(w_half, topY, l_half), `í­: ${width}mm`, 'black'); createDimensionLine(new THREE.Vector3(-w_half, topY, -l_half), new THREE.Vector3(-w_half, topY, l_half), `ê¸¸ì´: ${length}mm`, 'black'); const basePointPos = new THREE.Vector3(-w_half, topY, l_half); const pointMesh = new THREE.Mesh(new THREE.SphereGeometry(0.05, 16, 16), new THREE.MeshBasicMaterial({ color: 0xff0000 })); pointMesh.position.copy(basePointPos); scene.add(pointMesh); sceneObjects.push(pointMesh); createLabel("ê¸°ì¤€ì ", basePointPos.clone().add(new THREE.Vector3(-0.1, 0.3, 0.3)), 'red'); break; default: createDimensionLine(new THREE.Vector3(-w_half, topY, l_half), new THREE.Vector3(w_half, topY, l_half), `í­: ${width}mm`, 'black'); createDimensionLine(new THREE.Vector3(-w_half, topY, -l_half), new THREE.Vector3(-w_half, topY, l_half), `ê¸¸ì´: ${length}mm`, 'black'); break; } const markerMat = new THREE.MeshBasicMaterial({ color: 0x800080, side: THREE.DoubleSide }); if (document.getElementById('round')?.checked) { const container = document.querySelector('.detail-item-container[data-option-key="round"]'); container?.querySelectorAll('input[name="round_corner"]:checked').forEach(cb => { const positions = { '1':[-w_half,topY,l_half],'2':[-w_half,topY,-l_half],'3':[w_half,topY,l_half],'4':[w_half,topY,-l_half] }; if (positions[cb.value]) { const sphere = new THREE.Mesh(new THREE.SphereGeometry(0.05, 16, 16), markerMat); sphere.position.fromArray(positions[cb.value]); scene.add(sphere); sceneObjects.push(sphere); } }); } if (document.getElementById('circlecut')?.checked) { document.querySelectorAll('#circleCutTbody_circlecut tr').forEach(row => { const r = parseFloat(row.querySelector('.circle-cut-r').value) || 0; if (r > 0) { const x = parseFloat(row.querySelector('.circle-cut-x').value) || 0; const y = parseFloat(row.querySelector('.circle-cut-y').value) || 0; const hole = new THREE.Mesh(new THREE.CircleGeometry(r / 100, 32), markerMat); hole.position.set((x / 100) - w_half, topY + 0.001, l_half - (y / 100)); hole.rotation.x = -Math.PI / 2; scene.add(hole); sceneObjects.push(hole); } }); } if (document.getElementById('squarecut')?.checked) { document.querySelectorAll('#squareCutTbody_squarecut tr').forEach(row => { const w = parseFloat(row.querySelector('.square-cut-w').value) || 0; const h = parseFloat(row.querySelector('.square-cut-h').value) || 0; if (w > 0 && h > 0) { const x = parseFloat(row.querySelector('.square-cut-x').value) || 0; const y = parseFloat(row.querySelector('.square-cut-y').value) || 0; const hole = new THREE.Mesh(new THREE.PlaneGeometry(w / 100, h / 100), markerMat); hole.position.set((x + w/2)/100 - w_half, topY + 0.001, l_half - (y + h/2)/100); hole.rotation.x = -Math.PI / 2; scene.add(hole); sceneObjects.push(hole); } }); } if (document.getElementById('hinge')?.checked) { document.querySelectorAll('#hingeTbody_hinge tr').forEach(row => { let x, y; if (hingeInputMode === 'Y_INPUT') { x = 23; y = parseFloat(row.querySelector('.hinge-pos-y')?.value) || 0; } else { x = parseFloat(row.querySelector('.hinge-pos-x')?.value) || 0; y = 23; } if(x > 0 && y > 0) { const hole = new THREE.Mesh(new THREE.CircleGeometry(17.5 / 100, 32), markerMat); hole.position.set((x / 100) - w_half, topY + 0.001, l_half - (y / 100)); hole.rotation.x = -Math.PI / 2; scene.add(hole); sceneObjects.push(hole); } }); } }
window.addEventListener('resize', () => { const container = document.querySelector('div.wood-image'); if (container && container.clientWidth > 0 && container.clientHeight > 0) { renderer.setSize(container.clientWidth, container.clientHeight); camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix(); } });

function openLoadModal() { loadOrderModal.style.display = 'flex'; }
function closeLoadModal() { loadOrderModal.style.display = 'none'; }
function openVideoModal(url) {
    youtubeIframe.src = url;
    videoModal.style.display = 'flex';
}
function closeVideoModal() {
    videoModal.style.display = 'none';
    youtubeIframe.src = '';
}

const orderInstructionsModal = document.getElementById('orderInstructionsModal');

function openInstructionsModal(orderNumber, totalAmount) {
  if (!orderInstructionsModal) return;

  // 1000ì› ë‹¨ìœ„ë¡œ ê²°ì œ ìˆ˜ëŸ‰ ê³„ì‚° (ì˜¬ë¦¼ ì²˜ë¦¬í•˜ì—¬ ê³ ê°ì´ ì ê²Œë‚´ëŠ” ê²½ìš° ë°©ì§€)
  const paymentQty = Math.ceil(totalAmount / 1000);

  // ëª¨ë‹¬ ì•ˆì˜ ë‚´ìš© ì±„ìš°ê¸°
  document.getElementById('finalQuoteAmount').textContent = totalAmount.toLocaleString() + 'ì›';
  document.getElementById('paymentQuantity').textContent = paymentQty;
  document.getElementById('finalOrderNumber').textContent = orderNumber;
  
  // ëª¨ë‹¬ ë³´ì´ê¸°
  orderInstructionsModal.style.display = 'flex';
}

function closeInstructionsModal() {
  if (orderInstructionsModal) {
    orderInstructionsModal.style.display = 'none';
  }
}

// â–¼â–¼â–¼ [ì¶”ê°€] ì£¼ë¬¸ë²ˆí˜¸ ë³µì‚¬ ê¸°ëŠ¥ í•¨ìˆ˜ â–¼â–¼â–¼
function copyOrderNumber() {
    const orderNumberEl = document.getElementById('finalOrderNumber');
    const copyBtn = document.getElementById('copyOrderBtn');
    const orderNumber = orderNumberEl.innerText;

    if (orderNumber && orderNumber !== '-') {
        // í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ ë³µì‚¬
        navigator.clipboard.writeText(orderNumber).then(() => {
            // ì„±ê³µ ì‹œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ í›„ 2ì´ˆ ë’¤ ì›ìƒë³µêµ¬
            const originalText = copyBtn.innerText;
            copyBtn.innerText = 'ë³µì‚¬ë¨!';
            copyBtn.disabled = true;
            setTimeout(() => {
                copyBtn.innerText = originalText;
                copyBtn.disabled = false;
            }, 2000);
        }).catch(err => {
            console.error('ì£¼ë¬¸ë²ˆí˜¸ ë³µì‚¬ ì‹¤íŒ¨:', err);
            alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
        });
    }
}

function confirmLoadOrder() {
    const phone = document.getElementById('load-phone').value.trim();
    const orderNo = document.getElementById('load-orderNo').value.trim();

    if (!phone || !orderNo) {
        alert('íœ´ëŒ€í° ë²ˆí˜¸ì™€ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    loadOrderConfirmBtn.disabled = true;
    loadOrderConfirmBtn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

    const oldScript = document.getElementById('jsonp_script');
    if(oldScript) oldScript.remove();
    
    jsonpTimeout = setTimeout(() => {
        if(loadOrderConfirmBtn.disabled) {
            alert("ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë²„ ì‘ë‹µì´ ì—†ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            loadOrderConfirmBtn.disabled = false;
            loadOrderConfirmBtn.textContent = 'í™•ì¸';
        }
    }, 15000);

    const script = document.createElement('script');
    script.id = 'jsonp_script';
    script.src = `${SPREADSHEET_API_URL2}?callback=handleOrderDataResponse&phone=${encodeURIComponent(phone)}&orderNo=${encodeURIComponent(orderNo)}`;
    
    script.onerror = function() {
        clearTimeout(jsonpTimeout);
        alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URL ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        loadOrderConfirmBtn.disabled = false;
        loadOrderConfirmBtn.textContent = 'í™•ì¸';
    };

    document.head.appendChild(script);
}

function handleOrderDataResponse(result) {
    clearTimeout(jsonpTimeout); 

    const phoneInput = document.getElementById('load-phone');
    const orderNoInput = document.getElementById('load-orderNo');

    loadOrderConfirmBtn.disabled = false;
    loadOrderConfirmBtn.textContent = 'í™•ì¸';

    if (result.result === 'success' && result.data && result.data.length > 0) {
        orderData = []; // ê¸°ì¡´ ì£¼ë¬¸ ë‚´ì—­ ì´ˆê¸°í™”
        
        result.data.forEach(row => {
            // [ìˆ˜ì •] ì‹œíŠ¸ í—¤ë” ì´ë¦„('í’ˆëª…')ê³¼ ë§¤ì¹­ë˜ë„ë¡ ë³€ê²½ (í˜¸í™˜ì„±ì„ ìœ„í•´ OR ì¡°ê±´ ì¶”ê°€)
            const summary = String(row['í’ˆëª…'] || row['ì£¼ë¬¸ë‚´ì—­ ìš”ì•½'] || '');
            const estimate = parseFloat(row['í•©ê³„']) || 0;
            
            // [ìˆ˜ì •] ì‹œíŠ¸ í—¤ë” ì´ë¦„('ê°€ê³µìƒì„¸')ê³¼ ë§¤ì¹­ë˜ë„ë¡ ë³€ê²½
            const processing = row['ê°€ê³µìƒì„¸'] || row['ê°€ê³µ'] || '';

            if (summary === 'ì´ í•©ê³„') {
                return; // í•©ê³„ í–‰ì€ ê±´ë„ˆëœë‹ˆë‹¤.
            }

            let orderItem = { isLoaded: true };

            if (summary === '[ì´ë²¤íŠ¸ í• ì¸]') {
                orderItem.type = 'discount';
                orderItem.name = processing || 'ì´ë²¤íŠ¸ í• ì¸ ì ìš©';
                orderItem.estimate = estimate; 
            } else if (summary === 'ì˜ˆìƒ ë°°ì†¡ë¹„') {
                orderItem.type = 'shipping';
                orderItem.name = processing || 'ë°°ì†¡ë¹„ ìƒì„¸';
                orderItem.quantity = row['ìˆ˜ëŸ‰'];
                orderItem.estimate = estimate;
            } else if (summary.startsWith('[ë¶€ìì¬]')) {
                orderItem.type = 'accessory';
                orderItem.name = summary.replace('[ë¶€ìì¬] ', '');
                orderItem.quantity = row['ìˆ˜ëŸ‰'];
                orderItem.estimate = estimate;
            } else { // ì¼ë°˜ ëª©ì¬ ìƒí’ˆ
                const woodOption = Array.from(woodSelect.options).find(opt => 
                    opt.text.startsWith(summary)
                );
                
                orderItem.woodTypeValue = woodOption ? woodOption.value : summary;
                // [ìˆ˜ì •] ì‹œíŠ¸ í—¤ë” ì´ë¦„('í­(mm)', 'ê¸¸ì´(mm)')ê³¼ ë§¤ì¹­ë˜ë„ë¡ ë³€ê²½
                orderItem.width = row['í­(mm)'] || row['í­'];
                orderItem.length = row['ê¸¸ì´(mm)'] || row['ê¸¸ì´'];
                orderItem.quantity = row['ìˆ˜ëŸ‰'];
                orderItem.estimate = estimate; 
                orderItem.detailText = {};
                
                if (processing && processing !== '-' && processing !== '') {
                    orderItem.detailText.loaded = { summary: String(processing).split(' | ') };
                }
            }
            orderData.push(orderItem);
        });

        // ê³ ê° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        if(result.data[0]) {
            document.getElementById('customerName').value = result.data[0]['ì„±í•¨'] || result.data[0]['ê³ ê°ëª…'] || '';
            document.getElementById('customerPhone').value = result.data[0]['ì „í™”ë²ˆí˜¸'] || result.data[0]['ì—°ë½ì²˜'] || '';
            document.getElementById('customerEmail').value = result.data[0]['ì´ë©”ì¼ì£¼ì†Œ'] || result.data[0]['ì´ë©”ì¼'] || '';
        }

        renderOrderTable();
        closeLoadModal();
        alert("ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ëŠ” ìˆ˜ì •ì´ ë¶ˆê°€í•˜ë©°, ì£¼ë¬¸ ë‚´ì—­ ë‹¤ìš´ë¡œë“œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        
        phoneInput.value = '';
        orderNoInput.value = '';

    } else {
        alert('ì¼ì¹˜í•˜ëŠ” ì£¼ë¬¸ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}
function handleProcessingOptionsLogic() {
    const selectedWood = woodSelect.value;
    const isCoatingSelected = document.getElementById('coating').checked;
    const sandingItem = document.getElementById('sanding').closest('.processing-item');
    const coatingItem = document.getElementById('coating').closest('.processing-item');

    sandingItem.style.opacity = '1';
    sandingItem.style.pointerEvents = 'auto';
    coatingItem.style.opacity = '1';
    coatingItem.style.pointerEvents = 'auto';

    if (selectedWood === 'mdf18T' || selectedWood === 'pvc18T') {
        sandingItem.style.opacity = '0.4';
        sandingItem.style.pointerEvents = 'none';
        if (document.getElementById('sanding').checked) {
            deselectOption('sanding');
        }
        coatingItem.style.opacity = '0.4';
        coatingItem.style.pointerEvents = 'none';
        if (document.getElementById('coating').checked) {
            deselectOption('coating');
        }
    }

    if (isCoatingSelected) {
        sandingItem.style.opacity = '0.4';
        sandingItem.style.pointerEvents = 'none';
    }
}
</script>
</body>
</html>
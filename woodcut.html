<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì•„ì´ë¦°ê°€êµ¬ - AI ëª©ì¬ ê²¬ì  ì±„íŒ…</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .header .subtitle {
      font-size: 11px;
      opacity: .8;
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-panel {
      width: 420px;
      min-width: 320px;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
      background: #fff;
      flex-shrink: 0;
    }

    .preview-panel {
      flex: 1;
      background: #1a1a2e;
      display: flex;
      flex-direction: column;
      min-width: 0;
      position: relative;
    }

    .preview-canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-height: 0;
    }

    #previewCanvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    .msg {
      max-width: 92%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 13.5px;
      line-height: 1.6;
      word-break: break-word;
      animation: fadeIn .3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .bot-msg {
      background: #f0f4ff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      color: #222;
    }

    .user-msg {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .chat-input-area input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 13.5px;
      outline: none;
      transition: border .2s;
    }

    .chat-input-area input:focus {
      border-color: #3498db;
    }

    .chat-input-area button {
      padding: 10px 18px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 13.5px;
      font-weight: 600;
      cursor: pointer;
    }

    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .quick-btn {
      display: inline-block;
      padding: 6px 12px;
      background: #fff;
      border: 1.5px solid #3498db;
      color: #3498db;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      font-weight: 500;
    }

    .quick-btn:hover {
      background: #3498db;
      color: #fff;
    }

    .estimate-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-radius: 16px;
      padding: 16px;
      margin-top: 8px;
    }

    .estimate-card h3 {
      font-size: 15px;
      margin-bottom: 10px;
    }

    .estimate-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, .15);
    }

    .estimate-row:last-child {
      border: none;
    }

    .estimate-total {
      font-size: 18px;
      font-weight: 700;
      text-align: right;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 2px solid rgba(255, 255, 255, .3);
    }

    .estimate-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .estimate-actions button {
      flex: 1;
      padding: 8px 0;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-add-order {
      background: #2ecc71;
      color: #fff;
    }

    .btn-add-order:hover {
      background: #27ae60;
    }

    .btn-new-est {
      background: rgba(255, 255, 255, .2);
      color: #fff;
    }

    .btn-new-est:hover {
      background: rgba(255, 255, 255, .35);
    }

    .preview-header {
      padding: 10px 16px;
      background: rgba(0, 0, 0, .3);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .preview-info {
      padding: 10px 16px;
      background: rgba(0, 0, 0, .2);
      color: #82b1ff;
      font-size: 12px;
      text-align: center;
      flex-shrink: 0;
    }

    .order-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 320px;
      height: 100%;
      background: rgba(255, 255, 255, .97);
      box-shadow: -4px 0 20px rgba(0, 0, 0, .15);
      z-index: 50;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .order-panel-header {
      padding: 14px 16px;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .order-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 12.5px;
      border-left: 4px solid #3498db;
    }

    .order-item .oi-title {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .order-item .oi-detail {
      color: #666;
    }

    .order-item .oi-price {
      font-weight: 700;
      color: #e74c3c;
      text-align: right;
      margin-top: 4px;
    }

    .order-item .oi-remove {
      float: right;
      background: none;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      line-height: 1;
    }

    .order-panel-footer {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .order-panel-footer .total-row {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .btn-checkout {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .status-bar {
      background: #2c3e50;
      color: #82b1ff;
      padding: 6px 20px;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .customer-form {
      background: #fff;
      border-radius: 12px;
      padding: 14px;
      margin-top: 8px;
      border: 1px solid #e0e0e0;
    }

    .customer-form h4 {
      margin-bottom: 10px;
      color: #2c3e50;
    }

    .form-row {
      margin-bottom: 8px;
    }

    .form-row label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 3px;
    }

    .form-row input,
    .form-row textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
    }

    .form-row input:focus,
    .form-row textarea:focus {
      border-color: #3498db;
    }

    .btn-submit-order {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }

    .payment-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .payment-link {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
    }

    /* ê°€ê³µ ì˜µì…˜ (ë³µìˆ˜ ì„ íƒ - ì›ë³¸ ìŠ¤íƒ€ì¼) */
    .proc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .proc-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 2px solid #ddd;
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all .2s;
      font-size: 11px;
      background: #fff;
    }

    .proc-item img {
      width: 100%;
      max-width: 60px;
      height: auto;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .proc-item.selected {
      border: 3px solid #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, .5);
      background: #f0f7ff;
    }

    .proc-item.disabled {
      opacity: .4;
      pointer-events: none;
    }

    /* ê°€ê³µ ì„œë¸Œì˜µì…˜ */
    .proc-sub {
      margin-top: 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      font-size: 12px;
    }

    .proc-sub .sub-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 6px;
    }

    .proc-sub select,
    .proc-sub input[type="number"] {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
    }

    .side-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .side-item {
      padding: 6px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all .2s;
      background: #fff;
    }

    .side-item:hover {
      border-color: #3498db;
    }

    .side-item.active {
      border-color: #e74c3c;
      background: #fff0f0;
      color: #e74c3c;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 14px;
      align-self: flex-start;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #aaa;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: .2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: .4s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0)
      }

      40% {
        transform: scale(1)
      }
    }

    /* ëª©ì¬ ì„ íƒ ë²„íŠ¼ */
    .wood-btn-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 4px 0;
    }

    .wood-select-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      transition: all .2s;
      color: #333;
    }

    .wood-select-btn:hover {
      border-color: #3498db;
      background: #f0f7ff;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(52, 152, 219, .15);
    }

    .wood-select-btn.active {
      border-color: #2ecc71;
      background: #f0fff4;
    }

    .wood-select-btn .wood-thumb {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid rgba(0, 0, 0, .1);
    }

    .wood-select-btn .wood-label {
      flex: 1;
    }

    .wood-select-btn .wood-label .wname {
      font-size: 13px;
      font-weight: 700;
    }

    .wood-select-btn .wood-label .wdesc {
      font-size: 11px;
      color: #888;
      margin-top: 1px;
    }

    .wood-select-btn .arrow-icon {
      font-size: 16px;
      color: #aaa;
    }

    .wood-detail-card {
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a2e;
      margin-top: 6px;
      animation: wdSlide .3s ease;
    }

    @keyframes wdSlide {
      from {
        opacity: 0;
        transform: translateY(-8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .wood-detail-card img {
      width: 100%;
      display: block;
      max-height: 180px;
      object-fit: cover;
    }

    .wood-detail-actions {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      background: #1a1a2e;
    }

    .wood-detail-actions button {
      flex: 1;
      padding: 9px 0;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-select-wood {
      background: #2ecc71;
      color: #fff;
    }

    .btn-select-wood:hover {
      background: #27ae60;
    }

    .btn-youtube {
      background: #ff0000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .btn-youtube:hover {
      background: #cc0000;
    }

    .btn-youtube svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }

    .event-tag {
      display: inline-block;
      background: #fff0f6;
      color: #e11d78;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      border: 1px solid #ffc2d8;
      margin-bottom: 4px;
    }

    @media(max-width:800px) {
      .main {
        flex-direction: column;
      }

      .chat-panel {
        width: 100%;
        max-width: 100%;
        height: 50vh;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }

      .preview-panel {
        height: 50vh;
      }

      .order-panel {
        width: 100%;
      }

      .proc-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #fff;
      width: 90%;
      max-width: 500px;
      border-radius: 20px;
      padding: 30px;
      position: relative;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    .instruction-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .instruction-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .instruction-row b {
      color: #e74c3c;
    }

    /* REPORT CONTAINER (HIDDEN) */
    #reportContainer {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 800px;
      background: #fff;
      padding: 40px;
      box-sizing: border-box;
      font-family: 'Pretendard', sans-serif;
    }
  </style>
</head>

<body>

  <div class="header">
    <div>
      <h1>ì•„ì´ë¦°ê°€êµ¬</h1>
      <div class="subtitle">AI ëª©ì¬ ê²¬ì  ì‹œìŠ¤í…œ</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button onclick="openLoadModal()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button onclick="generateReport()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">ê²¬ì ì„œ</button>
      <button onclick="toggleOrderPanel()"
        style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 14px;border-radius:20px;font-size:12px;cursor:pointer;">
        ì£¼ë¬¸ëª©ë¡ <span id="orderBadge"
          style="background:#e74c3c;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;display:none;">0</span>
      </button>
    </div>
  </div>

  <div class="main">
    <div class="chat-panel">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="ì˜ˆ: MDF 400x1000 2ì¥ ì‚¬ì„ ê°€ê³µ A,B"
          onkeydown="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">ì „ì†¡</button>
      </div>
    </div>
    <div class="preview-panel">
      <div class="preview-header"><span>3D ë¯¸ë¦¬ë³´ê¸°</span><span id="previewDim"
          style="font-size:11px;color:#82b1ff;">-</span></div>
      <div class="preview-canvas-wrap"><canvas id="previewCanvas"></canvas></div>
      <div class="preview-info" id="previewInfo">ëª©ì¬ë¥¼ ì„ íƒí•˜ë©´ 3D ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div class="order-panel" id="orderPanel" style="display:none;"></div>
    </div>
  </div>

  <div class="status-bar"><span id="statusLeft">ëŒ€ê¸° ì¤‘</span><span id="statusRight"></span></div>
  <div id="reportContainer"
    style="position:absolute;left:-9999px;top:0;width:800px;background:#fff;padding:30px;font-family:'Noto Sans KR',sans-serif;">
  </div>

  <script>
    // ============================================================
    // CONFIG & URLs (ì›ë³¸ ê·¸ëŒ€ë¡œ)
    // ============================================================
    const PRICE_API_URL = 'https://script.google.com/macros/s/AKfycbzkTCXtkfn0zmQkXB3xFZEaczyHquAuGGZu_3KMiMHVz6SEGXvMbZV56EE8u7o-zEoLMw/exec';
    const API_URL = 'https://script.google.com/macros/s/AKfycbzXHDF31Hi_yZaDR_BG_GfDdcY7a8h_9wShpptcvfCOP-EEUgLQTalICjOtXGfZkpiFpw/exec';
    const SESSION_ID = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

    // ============================================================
    // WOOD DATA (ì›ë³¸ ì´ë¯¸ì§€/í…ìŠ¤ì²˜ URL ì‚¬ìš©)
    // ============================================================
    const WOOD_DATA = {
      mdf18T: { name: 'MDF 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/mdf.png', thickness: 18, desc: 'ê°€ì„±ë¹„ ì¢‹ì€ ê¸°ë³¸ í•©íŒ', canSand: false, canCoat: false },
      pvc18T: { name: 'PVCë³´ë“œ 18T+PET (ì™„ì „ë°©ìˆ˜)', image: 'https://gi.esmplus.com/irn2011/click/texture/pvc.png', thickness: 18, desc: 'ì™„ì „ë°©ìˆ˜ Â· ìš•ì‹¤/ì£¼ë°© ì¶”ì²œ', canSand: false, canCoat: false },
      misong18T: { name: 'ë¯¸ì†¡ì§‘ì„±ëª© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/misong.png', thickness: 18, desc: 'ë¶€ë“œëŸ¬ìš´ ì›ëª© ëŠë‚Œ', canSand: true, canCoat: true },
      pyeonbaek18T: { name: 'í¸ë°±ì§‘ì„±ëª© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/pyenon.png', thickness: 18, desc: 'í”¼í†¤ì¹˜ë“œ Â· í”„ë¦¬ë¯¸ì—„ ì›ëª©', canSand: true, canCoat: true },
      mulbau18T: { name: 'ë©€ë°”ìš° ì§‘ì„±ëª© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/mulbau.png', thickness: 18, desc: 'ê³ ê¸‰ í•˜ë“œìš°ë“œ Â· ê°•í•œ ë‚´êµ¬ì„±', canSand: true, canCoat: true }
    };

    const WOOD_YOUTUBE = {
      mdf18T: 'https://youtu.be/gb2ETOmWzAI',
      pvc18T: 'https://youtu.be/iKc5odpOETg',
      misong18T: 'https://youtu.be/vk0Pa0uXu1w',
      pyeonbaek18T: 'https://youtu.be/xdmOsSKHXQU',
      mulbau18T: 'https://youtu.be/zxTFCZ9oIdk'
    };

    const WOOD_KEYS = ['mdf18T', 'pvc18T', 'misong18T', 'pyeonbaek18T', 'mulbau18T'];

    // ê°€ê³µ ì˜µì…˜ (ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©, ë³µìˆ˜ ì„ íƒ)
    const PROC_OPTIONS = [
      { key: 'none', label: 'ê°€ê³µì—†ìŒ', image: 'https://gi.esmplus.com/irn2011/click/texture/null.png', group: 'none' },
      { key: 'sanding', label: 'ìƒŒë”©', image: 'https://gi.esmplus.com/irn2011/click/texture/sanding.png', group: 'base', event: 'í•œ ì¥ ë¬´ë£Œ ìƒŒë”©!' },
      { key: 'coating', label: 'íˆ¬ëª…ì½”íŒ…', image: 'https://gi.esmplus.com/irn2011/click/texture/coating.png', group: 'base' },
      { key: 'angled', label: 'ì‚¬ì„ ê°€ê³µ', image: 'https://gi.esmplus.com/irn2011/click/texture/45dgree.png', group: 'extra', event: 'í•œ ë©´ ë¬´ë£Œ!', needSides: true },
      { key: 'round', label: 'ëª¨ì„œë¦¬ ë¼ìš´ë“œ', image: 'https://gi.esmplus.com/irn2011/click/texture/round.png', group: 'extra', event: 'í•œ ê¼­ì§€ì  ë¬´ë£Œ!', needCorners: true },
      { key: 'circlecut', label: 'ì›í˜•íƒ€ê³µ', image: 'https://gi.esmplus.com/irn2011/click/texture/circle.png', group: 'extra', event: 'í•œ ê°œ ë¬´ë£Œ!' },
      { key: 'squarecut', label: 'ì‚¬ê°íƒ€ê³µ', image: 'https://gi.esmplus.com/irn2011/click/texture/sagak.png', group: 'extra', event: 'í•œ ê°œ ë¬´ë£Œ!' },
      { key: 'hinge', label: 'ì‹±í¬ê²½ì²©', image: 'https://gi.esmplus.com/irn2011/click/texture/hinge.png', group: 'extra', event: '2ê°œ ë¬´ë£Œ ì‹œê³µ!' }
    ];

    // ============================================================
    // STATE
    // ============================================================
    let currentWood = null, currentWidth = 0, currentLength = 0, currentQty = 1;
    let selectedProcs = new Set(); // ë³µìˆ˜ ì„ íƒ í‚¤ ì§‘í•©
    let procDetails = {}; // {angled:{sides:['A','B']}, round:{corners:['1','3']}, ...}
    let orderList = [], priceTable = [], openWoodDetail = null;
    let scene, camera, renderer, controls, boardGroup, woodMesh, sceneObjects = [];

    // ============================================================
    // INIT
    // ============================================================
    window.addEventListener('DOMContentLoaded', () => {
      init3D();
      loadPriceTable();
      showWoodCards();
    });

    // ============================================================
    // PRICE TABLE (ì›ë³¸ ê·¸ëŒ€ë¡œ)
    // ============================================================
    async function loadPriceTable() {
      try {
        const r = await fetch(PRICE_API_URL);
        priceTable = await r.json();
        updateStatus('ë‹¨ê°€í‘œ ë¡œë“œ ì™„ë£Œ', '');
      } catch (e) {
        console.warn('ë‹¨ê°€í‘œ ë¡œë“œ ì‹¤íŒ¨:', e);
        updateStatus('ë‹¨ê°€í‘œ ë¡œë“œ ì‹¤íŒ¨', '');
      }
    }

    // ì›ë³¸ getUnitPrice ê·¸ëŒ€ë¡œ
    function getUnitPrice(woodTypeId, area) {
      if (!priceTable.length || area <= 0) return 0;
      for (const tier of priceTable) {
        if (area <= tier.area) return tier[woodTypeId] || 0;
      }
      return 0;
    }

    // ì›ë³¸ ì½”íŒ… ê°€ê²© ê·¸ëŒ€ë¡œ
    function getCoatingPrices() {
      const length = currentLength || 0;
      let s = 0;
      if (length <= 600) s = 5000;
      else if (length <= 1200) s = 10000;
      else s = 15000;
      return { single: s, double: s * 2 };
    }

    // ì›ë³¸ ë°°ì†¡ë¹„ ê·¸ëŒ€ë¡œ
    function getBaseShippingCost(length) {
      if (length <= 600) return 5000;
      if (length <= 1200) return 8000;
      return 10000;
    }
    function calculateShippingCost(orders) {
      if (!orders || !orders.length) return [];
      const hasWood = orders.some(o => o.woodTypeValue);
      if (!hasWood) return [{ cost: 4000, sizeCategory: 'ë¶€ìì¬ ê¸°ë³¸ ë°°ì†¡ë¹„', count: 1 }];
      const pieces = [];
      orders.forEach(o => {
        if (o.woodTypeValue) {
          for (let i = 0; i < parseInt(o.quantity); i++) {
            const w = parseFloat(o.width), l = parseFloat(o.length);
            pieces.push({ width: Math.min(w, l), length: Math.max(w, l) });
          }
        }
      });
      if (!pieces.length) return [];
      pieces.sort((a, b) => (b.width * b.length) - (a.width * a.length));
      const packs = [];
      pieces.forEach(p => {
        let packed = false;
        for (const pk of packs) {
          if (pk.pieces.length < 5 && p.width <= pk.base.width && p.length <= pk.base.length) { pk.pieces.push(p); packed = true; break; }
        }
        if (!packed) packs.push({ base: p, pieces: [p] });
      });
      const grouped = {};
      packs.forEach(pk => {
        const cost = getBaseShippingCost(pk.base.length);
        if (!grouped[cost]) grouped[cost] = { cost, sizeCategory: pk.base.length <= 600 ? '600mm ì´í•˜' : pk.base.length <= 1200 ? '601~1200mm' : '1201~1800mm', count: 0 };
        grouped[cost].count++;
      });
      return Object.values(grouped);
    }

    // ============================================================
    // ê²¬ì  ê³„ì‚° (ì›ë³¸ calculate() ë¡œì§ ë°˜ì˜)
    // ============================================================
    function calculatePrice() {
      if (!currentWood || currentWidth <= 0 || currentLength <= 0) return null;
      const area = currentWidth * currentLength;
      const basePrice = getUnitPrice(currentWood, area);
      if (basePrice === 0 && area > 0) return null;

      let additionalCost = 0;
      let eventDiscount = 0;
      let discountDetails = [];

      selectedProcs.forEach(key => {
        const d = procDetails[key] || {};
        switch (key) {
          case 'sanding':
            additionalCost += 5000;
            eventDiscount += 5000;
            discountDetails.push('ìƒŒë”© ë¬´ë£Œ');
            break;
          case 'coating':
            const cp = getCoatingPrices();
            additionalCost += (d.type === 'ì–‘ë©´' ? cp.double : cp.single);
            break;
          case 'angled':
            const aSides = (d.sides || []).length;
            additionalCost += aSides * 1000;
            if (aSides > 0) { eventDiscount += 1000; discountDetails.push('ì‚¬ì„  1ë©´ ë¬´ë£Œ'); }
            break;
          case 'round':
            const rCorners = (d.corners || []).length;
            additionalCost += rCorners * 1000;
            if (rCorners > 0) { eventDiscount += 1000; discountDetails.push('ë¼ìš´ë“œ 1ê°œ ë¬´ë£Œ'); }
            break;
          case 'circlecut':
            const cCount = d.count || 1;
            additionalCost += cCount * 3000;
            if (cCount > 0) { eventDiscount += 3000; discountDetails.push('ì›í˜•íƒ€ê³µ 1ê°œ ë¬´ë£Œ'); }
            break;
          case 'squarecut':
            const sCount = d.count || 1;
            additionalCost += sCount * 4000;
            if (sCount > 0) { eventDiscount += 4000; discountDetails.push('ì‚¬ê°íƒ€ê³µ 1ê°œ ë¬´ë£Œ'); }
            break;
          case 'hinge':
            const hCount = d.count || 2;
            additionalCost += hCount * 1000;
            const hDisc = Math.min(hCount, 2);
            if (hDisc > 0) { eventDiscount += hDisc * 1000; discountDetails.push(`ê²½ì²© ${hDisc}ê°œ ë¬´ë£Œ`); }
            break;
        }
      });

      const origPerPiece = basePrice + additionalCost;
      const origTotal = origPerPiece * currentQty;
      const totalDiscount = eventDiscount * currentQty;
      const finalTotal = origTotal - totalDiscount;
      const shipping = calculateShippingFromCurrent(finalTotal);

      return {
        basePrice, additionalCost, origPerPiece, origTotal,
        eventDiscount, totalDiscount, discountDetails,
        finalTotal, shipping,
        grandTotal: finalTotal + shipping
      };
    }

    function calculateShippingFromCurrent(totalPrice) {
      // ê°„ì†Œí™”: í˜„ì¬ ê²¬ì  1ê±´ ê¸°ì¤€ ë°°ì†¡ë¹„
      if (currentLength <= 600) return 5000;
      if (currentLength <= 1200) return 8000;
      return 10000;
    }

    // ============================================================
    // CHAT HELPERS
    // ============================================================
    function addBotMessage(html) { const d = document.createElement('div'); d.className = 'msg bot-msg'; d.innerHTML = html; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
    function addUserMessage(text) { const d = document.createElement('div'); d.className = 'msg user-msg'; d.textContent = text; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
    function scrollChat() { const c = document.getElementById('chatMessages'); setTimeout(() => { c.scrollTop = c.scrollHeight; }, 50); }
    function showTyping() { const d = document.createElement('div'); d.className = 'typing-indicator'; d.id = 'typingIndicator'; d.innerHTML = '<span></span><span></span><span></span>'; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
    function hideTyping() { const e = document.getElementById('typingIndicator'); if (e) e.remove(); }
    function updateStatus(l, r) { document.getElementById('statusLeft').textContent = l || ''; document.getElementById('statusRight').textContent = r || ''; }

    async function postToServer(data) {
      const r = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, body: JSON.stringify(data) });
      return await r.json();
    }

    // ============================================================
    // SEND & PROCESS
    // ============================================================
    function sendMessage() {
      const inp = document.getElementById('chatInput'); const t = inp.value.trim(); if (!t) return;
      inp.value = ''; addUserMessage(t);
      // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ê²ƒì€ ì¦‰ì‹œ AIì—ê²Œ ë³´ëƒ„
      sendToAI(t);
    }

    async function processInput(text) {
      const lo = text.toLowerCase().replace(/\s+/g, '');

      // 1) ëª©ì¬ ì„ íƒ (ì¶”ì²œ/ë¬¼ì–´ë³´ëŠ” ì˜ë„ê°€ ì•„ë‹ ë•Œë§Œ ì§€ë¦„ê¸¸ë¡œ ì²˜ë¦¬)
      const isConsulting = lo.includes('ì¶”ì²œ') || lo.includes('ì–´ë•Œ') || lo.includes('ì–´ë–¤') || lo.includes('ìƒë‹´') || lo.includes('ì¢‹ì•„');
      const aliases = { mdf18T: ['mdf'], pvc18T: ['pvc', 'í”¼ë¸Œì´ì”¨'], misong18T: ['ë¯¸ì†¡'], pyeonbaek18T: ['í¸ë°±'], mulbau18T: ['ë©€ë°”ìš°'] };
      if (!isConsulting) {
        for (const key of WOOD_KEYS) {
          if (aliases[key].some(a => lo.includes(a))) {
            selectWood(key);
            const sm = text.match(/(\d{2,4})\s*[xXÃ—\*]\s*(\d{2,4})/);
            if (sm) {
              const w = parseInt(sm[1]), l = parseInt(sm[2]);
              const qm = text.match(/(\d+)\s*ì¥/);
              setSize(w, l, qm ? parseInt(qm[1]) : 1);
              parseProcessingsFromText(text);
              if (selectedProcs.size) showEstimate();
            }
            return;
          }
        }
      }

      // 2) ì‚¬ì´ì¦ˆ
      const sm = text.match(/(\d{2,4})\s*[xXÃ—\*]\s*(\d{2,4})/);
      if (sm && currentWood) {
        const w = parseInt(sm[1]), l = parseInt(sm[2]), qm = text.match(/(\d+)\s*ì¥/);
        setSize(w, l, qm ? parseInt(qm[1]) : 1);
        parseProcessingsFromText(text);
        if (selectedProcs.size) showEstimate();
        return;
      }

      // 3) ìˆ˜ëŸ‰
      const qo = text.match(/^(\d+)\s*ì¥$/);
      if (qo && currentWood && currentWidth > 0) { currentQty = parseInt(qo[1]); addBotMessage('ìˆ˜ëŸ‰: <b>' + currentQty + 'ì¥</b>'); showEstimate(); return; }

      // 4) í‚¤ì›Œë“œ (ì™„ì „ ì¼ì¹˜ ë˜ëŠ” ëª…í™•í•œ ëª…ë ¹ì–´ë§Œ ì²˜ë¦¬)
      if (lo === 'ì£¼ë¬¸' || (lo.includes('ì£¼ë¬¸') && orderList.length > 0)) { showCustomerForm(); return; }
      if (lo === 'ì´ˆê¸°í™”' || lo === 'ë¦¬ì…‹') { resetAll(); addBotMessage('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); showWoodCards(); return; }
      if (lo === 'ëª©ì¬' || lo === 'ì¢…ë¥˜' || lo === 'ëª©ì¬ì¢…ë¥˜') { showWoodCards(); return; }

      // ì§€ì—­ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ë²„íŠ¼ í´ë¦­ ì „ìš©ì´ë¯€ë¡œ)
    }

    function parseProcessingsFromText(text) {
      const lo = text.toLowerCase();
      if (lo.includes('ì‚¬ì„ ') || lo.includes('êº½ê¸°')) {
        selectedProcs.add('angled');
        const sides = [];
        if (/[aAê°€]/.test(text)) sides.push('A'); if (/[bBë‚˜]/.test(text)) sides.push('B');
        if (/[cCë‹¤]/.test(text)) sides.push('C'); if (/[dDë¼]/.test(text)) sides.push('D');
        procDetails.angled = { sides: sides.length ? sides : ['A'] };
      }
      if (lo.includes('ë¼ìš´ë“œ') || lo.includes('ë‘¥ê¸€')) {
        selectedProcs.add('round'); procDetails.round = { corners: ['1'] };
      }
      if (lo.includes('ì›í˜•') || lo.includes('ì›ì»·')) { selectedProcs.add('circlecut'); procDetails.circlecut = { count: 1 }; }
      if (lo.includes('ì‚¬ê°ì»·') || lo.includes('ì‚¬ê°í™€')) { selectedProcs.add('squarecut'); procDetails.squarecut = { count: 1 }; }
      if (lo.includes('ê²½ì²©')) { const hm = text.match(/(\d+)\s*ê°œ/); selectedProcs.add('hinge'); procDetails.hinge = { count: hm ? parseInt(hm[1]) : 2 }; }
      if (lo.includes('ì½”íŒ…') && lo.includes('ì–‘')) { selectedProcs.add('coating'); procDetails.coating = { type: 'ì–‘ë©´' }; }
      else if (lo.includes('ì½”íŒ…')) { selectedProcs.add('coating'); procDetails.coating = { type: 'ë‹¨ë©´' }; }
      if (lo.includes('ì‚¬í¬') || lo.includes('ìƒŒë”©')) { selectedProcs.add('sanding'); procDetails.sanding = {}; }

      if (selectedProcs.size) {
        addBotMessage('ê°€ê³µ: <b>' + getProcSummary() + '</b>');
        updateWoodModel();
      }
    }

    function getProcSummary() {
      if (!selectedProcs.size) return 'ê°€ê³µì—†ìŒ';
      return Array.from(selectedProcs).map(key => {
        const opt = PROC_OPTIONS.find(o => o.key === key);
        let label = opt ? opt.label : key;
        const d = procDetails[key] || {};
        if (key === 'angled' && d.sides) label += '(' + d.sides.join(',') + ')';
        if (key === 'round' && d.corners) label += '(' + d.corners.join(',') + ')';
        if (key === 'hinge' && d.count) label += '(' + d.count + 'ê°œ)';
        if (key === 'coating' && d.type) label += '(' + d.type + ')';
        if (key === 'circlecut' && d.count > 1) label += '(' + d.count + 'ê°œ)';
        if (key === 'squarecut' && d.count > 1) label += '(' + d.count + 'ê°œ)';
        return label;
      }).join(' + ');
    }

    // ============================================================
    // AI
    // ============================================================
    async function sendToAI(text) {
      showTyping(); updateStatus('AI ì‘ë‹µ ëŒ€ê¸° ì¤‘...', '');
      try {
        const resp = await postToServer({ type: 'chat', cid: SESSION_ID, message: text });
        hideTyping();
        if (resp.result === 'error') { addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); updateStatus('ì˜¤ë¥˜', ''); return; }

        // ë°ì´í„° êµ¬ì¡° ë³´ì • (resp ìì²´ì— reply/actionì´ ìˆê±°ë‚˜ resp.dataì— ìˆëŠ” ê²½ìš° ëª¨ë‘ ëŒ€ì‘)
        const d = (resp.reply || resp.action) ? resp : (resp.data || resp);
        addBotMessage(d.reply || d.message || d.text || 'ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        // show_processing: ëª©ì¬+ì‚¬ì´ì¦ˆ+ìˆ˜ëŸ‰ì´ ëª¨ë‘ í™•ì • â†’ ì¶”ê°€ê°€ê³µ ì˜µì…˜ ë²„íŠ¼ í‘œì‹œ
        if (d.action === 'show_processing' && d.data) {
          if (d.data.woodType) currentWood = d.data.woodType;
          if (d.data.width) currentWidth = Number(d.data.width);
          if (d.data.length) currentLength = Number(d.data.length);
          if (d.data.qty) currentQty = Number(d.data.qty);
          selectedProcs.clear(); procDetails = {};
          updateWoodModel();
          showProcessingOptions();
          const wd = WOOD_DATA[currentWood];
          updateStatus(wd ? wd.name + ' ì„ íƒë¨' : 'ëª©ì¬ ì„ íƒë¨', 'ê°€ê³µ ì˜µì…˜ ì„ íƒ ëŒ€ê¸°');
        }

        // estimate: ì´ì „ í˜¸í™˜ìš© (í˜¹ì‹œ estimateê°€ ì˜¤ë©´ ê²¬ì  í‘œì‹œ)
        if (d.action === 'estimate' && d.data) {
          if (d.data.woodType) currentWood = d.data.woodType;
          if (d.data.width) currentWidth = Number(d.data.width);
          if (d.data.length) currentLength = Number(d.data.length);
          if (d.data.qty) currentQty = Number(d.data.qty);
          updateWoodModel(); showEstimate();
        }

        if (d.action === 'show_woods') showWoodCards();
        if (!['show_processing', 'estimate', 'show_woods'].includes(d.action)) updateStatus('ëŒ€ê¸° ì¤‘', '');
      } catch (e) { hideTyping(); addBotMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'); updateStatus('ì—°ê²° ì˜¤ë¥˜', ''); console.error(e); }
    }

    // ============================================================
    // WOOD SELECTION (ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©)
    // ============================================================
    function showWoodCards() {
      let h = '<div class="wood-btn-list">';
      WOOD_KEYS.forEach(key => {
        const wd = WOOD_DATA[key];
        h += `<div>
      <div class="wood-select-btn" onclick="toggleWoodDetail('${key}',this)" id="woodBtn_${key}">
        <img class="wood-thumb" src="${wd.image}" alt="${wd.name}" onerror="this.style.display='none'">
        <div class="wood-label">
          <div class="wname">${wd.name}</div>
          <div class="wdesc">${wd.desc}</div>
        </div>
        <span class="arrow-icon">â–¸</span>
      </div>
      <div id="woodDetail_${key}"></div>
    </div>`;
      });
      h += '</div>';
      addBotMessage(h);
    }

    function toggleWoodDetail(key, btnEl) {
      const container = document.getElementById('woodDetail_' + key);
      if (!container) return;
      if (openWoodDetail === key) { container.innerHTML = ''; openWoodDetail = null; if (btnEl) btnEl.classList.remove('active'); return; }
      if (openWoodDetail) {
        const prev = document.getElementById('woodDetail_' + openWoodDetail); if (prev) prev.innerHTML = '';
        const pb = document.getElementById('woodBtn_' + openWoodDetail); if (pb) pb.classList.remove('active');
      }
      const wd = WOOD_DATA[key], yt = WOOD_YOUTUBE[key] || '';
      container.innerHTML = `
    <div class="wood-detail-card">
      <img src="${wd.image}" alt="${wd.name}" onerror="this.style.display='none'">
      <div class="wood-detail-actions">
        <button class="btn-select-wood" onclick="selectWoodFromCard('${key}')">âœ“ ${wd.name} ì„ íƒ</button>
        ${yt ? `<button class="btn-youtube" onclick="window.open('${yt}','_blank')">
          <svg viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
          ì˜ìƒ</button>`: ''}
      </div>
    </div>`;
      openWoodDetail = key; if (btnEl) btnEl.classList.add('active');
      setTimeout(() => { container.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100);
    }

    function selectWoodFromCard(key) {
      const c = document.getElementById('woodDetail_' + key); if (c) c.innerHTML = ''; openWoodDetail = null;
      selectWood(key);
    }

    function selectWood(key) {
      currentWood = key; currentWidth = 0; currentLength = 0; currentQty = 1;
      selectedProcs.clear(); procDetails = {};
      const wd = WOOD_DATA[key];
      addBotMessage(`<b>${wd.name}</b> ì„ íƒ!<br>ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ê°€ë¡œÃ—ì„¸ë¡œ mm)
    <div class="quick-buttons">
      <span class="quick-btn" onclick="processInput('300x400')">300Ã—400</span>
      <span class="quick-btn" onclick="processInput('400x600')">400Ã—600</span>
      <span class="quick-btn" onclick="processInput('400x800')">400Ã—800</span>
      <span class="quick-btn" onclick="processInput('500x1000')">500Ã—1000</span>
      <span class="quick-btn" onclick="processInput('600x1200')">600Ã—1200</span>
    </div>`);
      updateWoodModel();
      updateStatus(wd.name + ' ì„ íƒë¨', 'ì‚¬ì´ì¦ˆ ì…ë ¥ ëŒ€ê¸°');
    }

    // ============================================================
    // SIZE
    // ============================================================
    function setSize(w, l, qty) {
      if (w > 600) { addBotMessage('í­ì€ ìµœëŒ€ <b>600mm</b>ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      if (l > 1800) { addBotMessage('ê¸¸ì´ëŠ” ìµœëŒ€ <b>1800mm</b>ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      if (w < 10 || l < 10) { addBotMessage('ìµœì†Œ ì‚¬ì´ì¦ˆëŠ” <b>10mm</b>ì…ë‹ˆë‹¤.'); return; }
      currentWidth = w; currentLength = l; currentQty = qty || 1;
      addBotMessage(`ì‚¬ì´ì¦ˆ: <b>${w} Ã— ${l}mm</b>, ìˆ˜ëŸ‰: <b>${currentQty}ì¥</b><br>ê°€ê³µ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)`);
      showProcessingOptions();
      updateWoodModel();
    }

    // ============================================================
    // PROCESSING OPTIONS (ë³µìˆ˜ ì„ íƒ, ì›ë³¸ ì´ë¯¸ì§€)
    // ============================================================
    function showProcessingOptions() {
      const wd = WOOD_DATA[currentWood] || {};
      let h = '<div class="proc-grid">';
      PROC_OPTIONS.forEach(p => {
        const isActive = selectedProcs.has(p.key) || (p.key === 'none' && !selectedProcs.size);
        let disabled = false;
        if (p.key === 'sanding' && !wd.canSand) disabled = true;
        if (p.key === 'coating' && !wd.canCoat) disabled = true;
        if (p.key === 'sanding' && selectedProcs.has('coating')) disabled = true;

        h += `<div class="proc-item${isActive ? ' selected' : ''}${disabled ? ' disabled' : ''}" onclick="toggleProc('${p.key}')" id="procItem_${p.key}">
      <img src="${p.image}" alt="${p.label}">
      <div>${p.label}</div>
      ${p.event ? '<div class="event-tag">' + p.event + '</div>' : ''}
    </div>`;
      });
      h += '</div>';
      h += '<div id="procSubArea"></div>';
      h += '<div style="margin-top:8px;"><span class="quick-btn" onclick="confirmProc()" style="background:#2ecc71;color:#fff;border-color:#2ecc71;">âœ“ ê°€ê³µ í™•ì • â†’ ê²¬ì  ë³´ê¸°</span></div>';
      addBotMessage(h);
    }

    function toggleProc(key) {
      const wd = WOOD_DATA[currentWood] || {};

      if (key === 'none') {
        selectedProcs.clear(); procDetails = {};
      } else {
        selectedProcs.delete('none');// none í•´ì œ

        // coating ì„ íƒ ì‹œ sanding ìë™ í•´ì œ
        if (key === 'coating' && !selectedProcs.has('coating')) {
          if (selectedProcs.has('sanding')) { selectedProcs.delete('sanding'); delete procDetails.sanding; }
        }
        // ì œì•½ ì²´í¬
        if (key === 'sanding' && (!wd.canSand || selectedProcs.has('coating'))) return;
        if (key === 'coating' && !wd.canCoat) return;

        if (selectedProcs.has(key)) {
          selectedProcs.delete(key); delete procDetails[key];
        } else {
          selectedProcs.add(key);
          // ê¸°ë³¸ê°’
          if (key === 'angled') procDetails.angled = { sides: [] };
          if (key === 'round') procDetails.round = { corners: [] };
          if (key === 'coating') procDetails.coating = { type: 'ë‹¨ë©´' };
          if (key === 'circlecut') procDetails.circlecut = { count: 1 };
          if (key === 'squarecut') procDetails.squarecut = { count: 1 };
          if (key === 'hinge') procDetails.hinge = { count: 2 };
          if (key === 'sanding') procDetails.sanding = {};
        }
        if (!selectedProcs.size) { selectedProcs.clear(); }// ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ none ìƒíƒœ
      }

      // UI ì—…ë°ì´íŠ¸
      PROC_OPTIONS.forEach(p => {
        const el = document.getElementById('procItem_' + p.key);
        if (!el) return;
        const isActive = selectedProcs.has(p.key) || (p.key === 'none' && !selectedProcs.size);
        el.classList.toggle('selected', isActive);
        // disable ë¡œì§
        let dis = false;
        if (p.key === 'sanding' && (!wd.canSand || selectedProcs.has('coating'))) dis = true;
        if (p.key === 'coating' && !wd.canCoat) dis = true;
        el.classList.toggle('disabled', dis);
      });

      renderProcSub();
      updateWoodModel();
    }

    function renderProcSub() {
      const area = document.getElementById('procSubArea');
      if (!area) return;
      let h = '';

      if (selectedProcs.has('coating')) {
        const d = procDetails.coating || { type: 'ë‹¨ë©´' };
        const cp = getCoatingPrices();
        h += `<div class="proc-sub"><div class="sub-title">ì½”íŒ… ë°©ì‹</div>
      <select onchange="procDetails.coating.type=this.value;updateWoodModel();">
        <option value="ë‹¨ë©´" ${d.type === 'ë‹¨ë©´' ? 'selected' : ''}>ë‹¨ë©´ ì½”íŒ… (+${cp.single.toLocaleString()}ì›)</option>
        <option value="ì–‘ë©´" ${d.type === 'ì–‘ë©´' ? 'selected' : ''}>ì–‘ë©´ ì½”íŒ… (+${cp.double.toLocaleString()}ì›)</option>
      </select></div>`;
      }

      if (selectedProcs.has('angled')) {
        const d = procDetails.angled || { sides: [] };
        h += `<div class="proc-sub"><div class="sub-title">ì‚¬ì„ ê°€ê³µ ë©´ ì„ íƒ (ë³µìˆ˜ ê°€ëŠ¥, ì¶”ê°€ë©´ +1,000ì›)</div>
      <div class="side-grid">
        ${['A(ì¢Œì¸¡)', 'B(ìƒë‹¨)', 'C(ìš°ì¸¡)', 'D(í•˜ë‹¨)'].map((label, i) => {
          const val = ['A', 'B', 'C', 'D'][i];
          return `<div class="side-item${d.sides.includes(val) ? ' active' : ''}" onclick="toggleAngledSide('${val}')">${label}</div>`;
        }).join('')}
      </div></div>`;
      }

      if (selectedProcs.has('round')) {
        const d = procDetails.round || { corners: [] };
        h += `<div class="proc-sub"><div class="sub-title">ë¼ìš´ë“œ ëª¨ì„œë¦¬ ì„ íƒ (ë³µìˆ˜ ê°€ëŠ¥, ì¶”ê°€ëª¨ì„œë¦¬ +1,000ì›)</div>
      <div class="side-grid">
        ${['1(ì¢Œìƒ)', '2(ì¢Œí•˜)', '3(ìš°ìƒ)', '4(ìš°í•˜)'].map((label, i) => {
          const val = String(i + 1);
          return `<div class="side-item${d.corners.includes(val) ? ' active' : ''}" onclick="toggleRoundCorner('${val}')">${label}</div>`;
        }).join('')}
      </div></div>`;
      }

      if (selectedProcs.has('hinge')) {
        const d = procDetails.hinge || { count: 2 };
        h += `<div class="proc-sub"><div class="sub-title">ê²½ì²© ê°œìˆ˜ (2ê°œê¹Œì§€ ë¬´ë£Œ, ì¶”ê°€ +1,000ì›/ê°œ)</div>
      <input type="number" value="${d.count}" min="1" max="10" onchange="procDetails.hinge.count=parseInt(this.value)||2;updateWoodModel();"></div>`;
      }

      if (selectedProcs.has('circlecut')) {
        const d = procDetails.circlecut || { count: 1 };
        h += `<div class="proc-sub"><div class="sub-title">ì›í˜•íƒ€ê³µ ê°œìˆ˜ (1ê°œ ë¬´ë£Œ, ì¶”ê°€ +3,000ì›/ê°œ)</div>
      <input type="number" value="${d.count}" min="1" max="10" onchange="procDetails.circlecut.count=parseInt(this.value)||1;updateWoodModel();"></div>`;
      }

      if (selectedProcs.has('squarecut')) {
        const d = procDetails.squarecut || { count: 1 };
        h += `<div class="proc-sub"><div class="sub-title">ì‚¬ê°íƒ€ê³µ ê°œìˆ˜ (1ê°œ ë¬´ë£Œ, ì¶”ê°€ +4,000ì›/ê°œ)</div>
      <input type="number" value="${d.count}" min="1" max="10" onchange="procDetails.squarecut.count=parseInt(this.value)||1;updateWoodModel();"></div>`;
      }

      area.innerHTML = h;
    }

    function toggleAngledSide(val) {
      const d = procDetails.angled || (procDetails.angled = { sides: [] });
      const i = d.sides.indexOf(val);
      if (i >= 0) d.sides.splice(i, 1); else d.sides.push(val);
      renderProcSub(); updateWoodModel();
    }

    function toggleRoundCorner(val) {
      const d = procDetails.round || (procDetails.round = { corners: [] });
      const i = d.corners.indexOf(val);
      if (i >= 0) d.corners.splice(i, 1); else d.corners.push(val);
      renderProcSub(); updateWoodModel();
    }

    function confirmProc() {
      addBotMessage('ê°€ê³µ í™•ì •: <b>' + getProcSummary() + '</b>');
      updateWoodModel();
      showEstimate();
    }

    // ============================================================
    // ESTIMATE
    // ============================================================
    function showEstimate() {
      if (!currentWood || currentWidth <= 0) return;
      const p = calculatePrice();
      if (!p) { addBotMessage('í•´ë‹¹ ì‚¬ì´ì¦ˆì˜ ë‹¨ê°€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const wd = WOOD_DATA[currentWood];

      let procDetailHtml = '';
      if (p.additionalCost > 0) {
        procDetailHtml += `<div class="estimate-row"><span>ê°€ê³µë¹„ ìƒì„¸</span><span>+${p.additionalCost.toLocaleString()}ì›</span></div>`;
      }
      if (p.totalDiscount > 0) {
        procDetailHtml += `<div class="estimate-row" style="color:#ffd700;"><span>ì´ë²¤íŠ¸ í• ì¸</span><span>-${p.totalDiscount.toLocaleString()}ì›</span></div>`;
        p.discountDetails.forEach(dd => {
          procDetailHtml += `<div class="estimate-row" style="font-size:11px;color:#ffd700;"><span style="padding-left:10px;">â”” ${dd}</span><span></span></div>`;
        });
      }

      // ì„ì‹œ ë°°ì†¡ë¹„ (ë¦¬ë·°ìš©)
      const tempShipping = getBaseShippingCost(currentLength);

      addBotMessage(`
    <div class="estimate-card">
      <h3>ğŸ“‹ ê²¬ì ì„œ</h3>
      <div class="estimate-row"><span>ëª©ì¬</span><span>${wd.name}</span></div>
      <div class="estimate-row"><span>ì‚¬ì´ì¦ˆ</span><span>${currentWidth} Ã— ${currentLength} mm</span></div>
      <div class="estimate-row"><span>ìˆ˜ëŸ‰</span><span>${currentQty}ì¥</span></div>
      <div class="estimate-row"><span>ê°€ê³µ</span><span>${getProcSummary()}</span></div>
      <div class="estimate-row"><span>íŒì¬ ë‹¨ê°€</span><span>${p.basePrice.toLocaleString()}ì›</span></div>
      ${procDetailHtml}
      <div class="estimate-row" style="font-weight:600;"><span>ì¥ë‹¹ (í• ì¸ í›„)</span><span>${Math.round(p.finalTotal / currentQty).toLocaleString()}ì›</span></div>
      <div class="estimate-row"><span>ì†Œê³„ (${currentQty}ì¥)</span><span>${p.finalTotal.toLocaleString()}ì›</span></div>
      <div class="estimate-row" style="opacity:0.7; font-size:11px;"><span>ì˜ˆìƒ ë°°ì†¡ë¹„ (ë°•ìŠ¤ í•˜ë‚˜ë‹¹)</span><span>${tempShipping.toLocaleString()}ì›</span></div>
      <div class="estimate-total">ì†Œê³„ í•©ê³„: ${p.finalTotal.toLocaleString()}ì›</div>
      <div class="estimate-actions">
        <button class="btn-add-order" onclick="addToOrder()">ì£¼ë¬¸ëª©ë¡ì— ì¶”ê°€</button>
        <button class="btn-new-est" onclick="resetEstimate();showWoodCards();">ìƒˆ ê²¬ì </button>
      </div>
    </div>`);

      document.getElementById('previewDim').textContent = `${currentWidth}Ã—${currentLength}mm ${wd.name}`;
      updateStatus('ê²¬ì  ì™„ë£Œ', p.finalTotal.toLocaleString() + 'ì›');
    }

    // ============================================================
    // ORDER
    // ============================================================
    function addToOrder() {
      const p = calculatePrice(); if (!p) return;
      const wd = WOOD_DATA[currentWood];
      orderList.push({
        woodTypeValue: currentWood,
        woodName: wd.name,
        width: currentWidth,
        length: currentLength,
        quantity: currentQty,
        processingSummary: getProcSummary(),
        selectedProcs: Array.from(selectedProcs),
        procDetails: JSON.parse(JSON.stringify(procDetails)),
        basePrice: p.basePrice,
        additionalCost: p.additionalCost,
        originalTotal: p.origTotal,
        discount: p.totalDiscount,
        discountDetails: p.discountDetails,
        estimate: p.finalTotal
      });

      addBotMessage(`<b>${wd.name} ${currentWidth}Ã—${currentLength}mm ${currentQty}ì¥</b> ì¶”ê°€!
    <div class="quick-buttons">
      <span class="quick-btn" onclick="resetEstimate();showWoodCards();">ë‹¤ë¥¸ ëª©ì¬ ì¶”ê°€</span>
      <span class="quick-btn" onclick="showCustomerStoreLinks()">ë¶€ìì¬/ì‡¼í•‘ëª° ë³´ê¸°</span>
      <span class="quick-btn" onclick="showCustomerForm()">ì£¼ë¬¸í•˜ê¸° (${orderList.length}ê±´)</span>
    </div>`);
      updateOrderBadge(); renderOrderPanel(); resetEstimate();
    }

    function removeOrderItem(idx) { orderList.splice(idx, 1); updateOrderBadge(); renderOrderPanel(); }
    function toggleOrderPanel() { const p = document.getElementById('orderPanel'); if (p.style.display === 'none') { p.style.display = 'flex'; renderOrderPanel(); } else p.style.display = 'none'; }

    function renderOrderPanel() {
      const panel = document.getElementById('orderPanel');
      if (!orderList.length) {
        panel.innerHTML = `<div class="order-panel-header"><span>ì£¼ë¬¸ëª©ë¡</span><button onclick="toggleOrderPanel()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">âœ•</button></div>
      <div class="order-panel-body" style="display:flex;align-items:center;justify-content:center;color:#999;">ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>`; return;
      }

      let itemTotal = 0;
      let ih = '';
      orderList.forEach((item, idx) => {
        itemTotal += item.estimate;
        let discHtml = item.discount > 0 ? `<div style="color:#ffcc00;font-size:11px;">í• ì¸: -${item.discount.toLocaleString()}ì›</div>` : '';
        ih += `<div class="order-item">
      <button class="oi-remove" onclick="removeOrderItem(${idx})">âœ•</button>
      <div class="oi-title">${item.woodName}</div>
      <div class="oi-detail">${item.width}Ã—${item.length}mm / ${item.quantity}ì¥ / ${item.processingSummary}</div>
      ${discHtml}
      <div class="oi-price">${item.estimate.toLocaleString()}ì›</div>
    </div>`;
      });

      // ë°°ì†¡ë¹„ ê³„ì‚°
      const shippingItems = calculateShippingCost(orderList);
      let totalShip = 0;
      let shipHtml = '';
      shippingItems.forEach(si => {
        const sc = si.cost * si.count;
        totalShip += sc;
        shipHtml += `<div class="order-item" style="border-left-color:#f1c40f; background:#fffdf0;">
      <div class="oi-title">ì˜ˆìƒ ë°°ì†¡ë¹„</div>
      <div class="oi-detail">${si.sizeCategory} (${si.count}ê°œ)</div>
      <div class="oi-price">${sc.toLocaleString()}ì›</div>
    </div>`;
      });

      const grandTotal = itemTotal + totalShip;

      panel.innerHTML = `
    <div class="order-panel-header"><span>ì£¼ë¬¸ëª©ë¡ (${orderList.length}ê±´)</span><button onclick="toggleOrderPanel()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">âœ•</button></div>
    <div class="order-panel-body">${ih}${shipHtml}</div>
    <div class="order-panel-footer">
      <div class="total-row"><span>ì´ í•©ê³„</span><span>${grandTotal.toLocaleString()}ì›</span></div>
      <button class="btn-checkout" onclick="toggleOrderPanel();showCustomerForm();">ì£¼ë¬¸ ì§„í–‰í•˜ê¸°</button>
    </div>`;
    }

    // ============================================================
    // CUSTOMER FORM
    // ============================================================
    function showCustomerForm() {
      if (!orderList.length) { addBotMessage('ì£¼ë¬¸ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }
      if (orderList.some(i => i.isLoaded)) { addBotMessage('ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ì „ì†¡ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.<div class="quick-buttons"><span class="quick-btn" onclick="generateReport()">ğŸ“¸ ê²¬ì ì„œ ì €ì¥</span></div>'); return; }
      let gt = 0; orderList.forEach(i => { gt += i.estimate; });
      const shipItems = calculateShippingCost(orderList); shipItems.forEach(si => { gt += si.cost * si.count; });
      addBotMessage(`
    <div class="customer-form">
      <h4>ì£¼ë¬¸ì ì •ë³´</h4>
      <div class="form-row"><label>ì„±í•¨ *</label><input type="text" id="custName" placeholder="í™ê¸¸ë™"></div>
      <div class="form-row"><label>ì—°ë½ì²˜ *</label><input type="tel" id="custPhone" placeholder="010-1234-5678" oninput="formatPhoneNumber(this)" maxlength="13"></div>
      <div class="form-row"><label>ì´ë©”ì¼</label><input type="email" id="custEmail" placeholder="example@email.com (ì„ íƒ)"></div>
      <div class="form-row"><label>ìš”ì²­ì‚¬í•­</label><textarea id="custMemo" rows="2" placeholder="íŠ¹ì´ì‚¬í•­"></textarea></div>
      <div style="text-align:right;font-size:14px;font-weight:700;color:#e74c3c;margin:8px 0;">ì´ ê²°ì œê¸ˆì•¡: ${gt.toLocaleString()}ì›</div>
      <button class="btn-submit-order" onclick="submitOrder()">ì£¼ë¬¸ ì œì¶œí•˜ê¸°</button>
    </div>`);
    }

    async function submitOrder() {
      const name = document.getElementById('custName').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const email = document.getElementById('custEmail')?.value.trim() || '';
      const memo = document.getElementById('custMemo').value.trim();
      if (!name || !phone) { addBotMessage('ì„±í•¨ê³¼ ì—°ë½ì²˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      showTyping(); updateStatus('ì£¼ë¬¸ ì œì¶œ ì¤‘...', '');
      try {
        const resp = await postToServer({ type: 'order', data: { customer: { name, phone, email, memo }, items: orderList, sessionId: SESSION_ID, timestamp: new Date().toISOString() } });
        hideTyping();
        if (resp.result === 'success' || resp.orderNumber || resp.orderNo) {
          const on = resp.orderNo || resp.orderNumber || resp.data?.orderNumber || 'IRN-' + Date.now();
          let itemTotal = 0;
          orderList.forEach(i => { itemTotal += i.estimate; });
          const shipItems = calculateShippingCost(orderList);
          let shipTotal = 0;
          shipItems.forEach(si => shipTotal += (si.cost * si.count));
          const grandTotal = itemTotal + shipTotal;

          updateSubmitOrderSuccess(on, grandTotal);

          orderList = []; updateOrderBadge(); renderOrderPanel(); updateStatus('ì£¼ë¬¸ ì™„ë£Œ', on);
        } else { addBotMessage('ì£¼ë¬¸ ì œì¶œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); updateStatus('ì£¼ë¬¸ ì‹¤íŒ¨', ''); }
      } catch (e) { hideTyping(); addBotMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'); updateStatus('ì—°ê²° ì˜¤ë¥˜', ''); console.error(e); }
    }

    function resetEstimate() { currentWidth = 0; currentLength = 0; currentQty = 1; selectedProcs.clear(); procDetails = {}; }
    function resetAll() { currentWood = null; resetEstimate(); }

    // ============================================================
    // THREE.JS 3D (ì›ë³¸ í…ìŠ¤ì²˜ + ë¡œì§)
    // ============================================================
    function init3D() {
      const wrap = document.querySelector('.preview-canvas-wrap');
      const canvas = document.getElementById('previewCanvas');
      const w = wrap.clientWidth || 600, h = wrap.clientHeight || 400;
      scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f0f0);
      camera = new THREE.PerspectiveCamera(50, w / h, 0.1, 1000);
      camera.position.set(3, 3, 5);
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(w, h); renderer.setPixelRatio(window.devicePixelRatio);
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.08;
      scene.add(new THREE.AmbientLight(0xdddddd));
      const dl = new THREE.DirectionalLight(0xffffff, 1); dl.position.set(5, 10, 7.5); scene.add(dl);
      boardGroup = new THREE.Group(); scene.add(boardGroup);
      sceneObjects = [];
      animate3D();
      new ResizeObserver(() => {
        const ww = wrap.clientWidth, hh = wrap.clientHeight;
        if (ww > 0 && hh > 0) { camera.aspect = ww / hh; camera.updateProjectionMatrix(); renderer.setSize(ww, hh); }
      }).observe(wrap);
    }

    function animate3D() { requestAnimationFrame(animate3D); if (controls) controls.update(); if (renderer && scene && camera) renderer.render(scene, camera); }

    function updateWoodModel() {
      // Clear
      if (woodMesh) { scene.remove(woodMesh); woodMesh = null; }
      sceneObjects.forEach(o => scene.remove(o)); sceneObjects = [];

      if (!currentWood || currentWidth <= 0 || currentLength <= 0) return;

      const width = currentWidth, length = currentLength, height = 18;
      const w = width / 100, h = height / 100, l = length / 100;

      // ì›ë³¸ í…ìŠ¤ì²˜
      const texture = new THREE.TextureLoader().load('https://gi.esmplus.com/irn2011/click/texture/line_texture.jpg');
      texture.repeat.set(width / 300, length / 1200);
      texture.wrapS = THREE.RepeatWrapping; texture.wrapT = THREE.RepeatWrapping;
      const woodMat = new THREE.MeshPhongMaterial({ map: texture });
      const pinkMat = new THREE.MeshPhongMaterial({ color: 0xff69b4 });
      const blueMat = new THREE.MeshPhongMaterial({ color: 0x007bff, transparent: true, opacity: 0.7 });
      const purpleMat = new THREE.MeshBasicMaterial({ color: 0x800080, side: THREE.DoubleSide });

      const materials = Array(6).fill(null).map(() => woodMat.clone());

      // ì½”íŒ… í‘œì‹œ
      if (selectedProcs.has('coating')) {
        const type = (procDetails.coating || {}).type;
        if (type === 'ë‹¨ë©´') materials[2] = pinkMat;
        else if (type === 'ì–‘ë©´') { materials[2] = pinkMat; materials[3] = pinkMat; }
      }
      // ì‚¬ì„  í‘œì‹œ
      if (selectedProcs.has('angled')) {
        const sides = (procDetails.angled || {}).sides || [];
        sides.forEach(s => {
          if (s === 'A') materials[1] = blueMat;
          if (s === 'B') materials[4] = blueMat;
          if (s === 'C') materials[0] = blueMat;
          if (s === 'D') materials[5] = blueMat;
        });
      }

      const geo = new THREE.BoxGeometry(w, h, l);
      woodMesh = new THREE.Mesh(geo, materials);
      scene.add(woodMesh);

      // ì—£ì§€
      const edges = new THREE.EdgesGeometry(geo);
      woodMesh.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 })));

      const topY = h / 2, hw = w / 2, hl = l / 2;

      // ë¼ìš´ë“œ ë§ˆì»¤
      if (selectedProcs.has('round')) {
        const corners = (procDetails.round || {}).corners || [];
        const posMap = { '1': [-hw, topY, hl], '2': [-hw, topY, -hl], '3': [hw, topY, hl], '4': [hw, topY, -hl] };
        corners.forEach(c => {
          if (posMap[c]) {
            const sp = new THREE.Mesh(new THREE.SphereGeometry(0.05, 16, 16), purpleMat);
            sp.position.fromArray(posMap[c]); scene.add(sp); sceneObjects.push(sp);
          }
        });
      }

      // ê²½ì²© ë§ˆì»¤
      if (selectedProcs.has('hinge')) {
        const count = (procDetails.hinge || {}).count || 2;
        for (let i = 0; i < count; i++) {
          const t = (i + 1) / (count + 1);
          const hole = new THREE.Mesh(new THREE.CircleGeometry(17.5 / 100, 32), purpleMat);
          hole.position.set(23 / 100 - hw, topY + 0.001, hl - t * l);
          hole.rotation.x = -Math.PI / 2;
          scene.add(hole); sceneObjects.push(hole);
        }
      }

      // ì›í˜•íƒ€ê³µ ë§ˆì»¤
      if (selectedProcs.has('circlecut')) {
        const count = (procDetails.circlecut || {}).count || 1;
        for (let i = 0; i < count; i++) {
          const hole = new THREE.Mesh(new THREE.CircleGeometry(0.15, 32), purpleMat);
          hole.position.set(0, topY + 0.001, (i * 0.4) - hl / 2);
          hole.rotation.x = -Math.PI / 2;
          scene.add(hole); sceneObjects.push(hole);
        }
      }

      // ì‚¬ê°íƒ€ê³µ ë§ˆì»¤
      if (selectedProcs.has('squarecut')) {
        const count = (procDetails.squarecut || {}).count || 1;
        for (let i = 0; i < count; i++) {
          const hole = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 0.3), purpleMat);
          hole.position.set(0, topY + 0.001, (i * 0.4) - hl / 2);
          hole.rotation.x = -Math.PI / 2;
          scene.add(hole); sceneObjects.push(hole);
        }
      }

      // ì¹˜ìˆ˜ì„ 
      const lineMat = new THREE.LineBasicMaterial({ color: 0xff0000 });
      const wLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-hw, topY, hl + 0.2), new THREE.Vector3(hw, topY, hl + 0.2)]), lineMat);
      const lLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-hw - 0.2, topY, -hl), new THREE.Vector3(-hw - 0.2, topY, hl)]), lineMat);
      scene.add(wLine, lLine); sceneObjects.push(wLine, lLine);

      // ì¹´ë©”ë¼
      const maxDim = Math.max(w, l, h);
      camera.position.set(maxDim * 0.7, maxDim * 0.7, maxDim * 1.2);
      camera.lookAt(0, 0, 0); controls.target.set(0, 0, 0); controls.update();

      document.getElementById('previewInfo').textContent = `${WOOD_DATA[currentWood].name} | ${width}Ã—${length}mm | ê°€ê³µ: ${getProcSummary()}`;
      document.getElementById('previewDim').textContent = `${width}Ã—${length}mm`;
    }

    // ============================================================
    // MODALS & HELPERS
    // ============================================================
    function openInstructionsModal(orderNumber, totalAmount) {
      const m = document.getElementById('orderInstructionsModal');
      const paymentQty = Math.ceil(totalAmount / 1000);
      document.getElementById('finalQuoteAmount').textContent = totalAmount.toLocaleString() + 'ì›';
      document.getElementById('paymentQuantity').textContent = paymentQty + 'ê°œ';
      document.getElementById('finalOrderNumber').textContent = orderNumber;
      m.style.display = 'flex';
    }
    function closeInstructionsModal() { document.getElementById('orderInstructionsModal').style.display = 'none'; }
    function copyOrderNumber() {
      const orderNumber = document.getElementById('finalOrderNumber').innerText;
      const btn = document.getElementById('copyOrderBtn');
      if (orderNumber && orderNumber !== '-') {
        navigator.clipboard.writeText(orderNumber).then(() => {
          const orig = btn.innerText; btn.innerText = 'ë³µì‚¬ë¨!'; btn.disabled = true;
          setTimeout(() => { btn.innerText = orig; btn.disabled = false; }, 2000);
        }).catch(() => { alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.'); });
      }
    }

    function showCustomerStoreLinks() {
      addBotMessage(`
        <div style="padding:10px;">
          <h4 style="margin-bottom:10px;">ğŸ›’ êµ¬ë§¤ ë§í¬ ì•ˆë‚´</h4>
          <div class="payment-links">
            <a class="payment-link" style="background:#03c75a;" href="https://smartstore.naver.com/irun2011" target="_blank">ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</a>
            <a class="payment-link" style="background:#1184ff;" href="https://link.coupang.com/a/cQ9keF" target="_blank">ì¿ íŒ¡ ë¸Œëœë“œìƒµ</a>
          </div>
          <p style="font-size:12px;color:#666;margin-top:10px;">ë¶€ìì¬ ë° ê¸°ì„±í’ˆì€ ìœ„ ë§í¬ì—ì„œ ë°”ë¡œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>`);
    }

    // ============================================================
    // REPORT (PNG DOWNLOAD)
    // ============================================================
    async function generateReport() {
      if (!orderList.length) { addBotMessage('ì£¼ë¬¸ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }
      const c = document.getElementById('reportContainer');
      let itemTotal = 0, rows = '';

      orderList.forEach((item) => {
        itemTotal += item.estimate;
        let discRow = '';
        if (item.discount > 0) {
          discRow = `<tr style="color:#d9534f; background:#fff8f8;"><td style="border:1px solid #ddd;padding:8px;">ì´ë²¤íŠ¸ í• ì¸</td><td style="border:1px solid #ddd;padding:8px;" colspan="2">${item.discountDetails.join(', ')}</td><td style="border:1px solid #ddd;padding:8px;text-align:right;">-${item.discount.toLocaleString()}ì›</td></tr>`;
        }
        rows += `<tr>
          <td style="border:1px solid #ddd;padding:12px;"><b>${item.woodName}</b></td>
          <td style="border:1px solid #ddd;padding:12px;">${item.processingSummary}</td>
          <td style="border:1px solid #ddd;padding:12px;">${item.width}Ã—${item.length}mm / ${item.quantity}ì¥</td>
          <td style="border:1px solid #ddd;padding:12px;text-align:right;">${item.estimate.toLocaleString()}ì›</td>
        </tr>${discRow}`;
      });

      const shipItems = calculateShippingCost(orderList);
      let totalShip = 0;
      shipItems.forEach(si => {
        const sc = si.cost * si.count; totalShip += sc;
        rows += `<tr style="background:#fcfcfc;"><td style="border:1px solid #ddd;padding:10px;"><b>ì˜ˆìƒ ë°°ì†¡ë¹„</b></td><td style="border:1px solid #ddd;padding:10px;">${si.sizeCategory}</td><td style="border:1px solid #ddd;padding:10px;">ìˆ˜ëŸ‰: ${si.count}ê°œ</td><td style="border:1px solid #ddd;padding:10px;text-align:right;">${sc.toLocaleString()}ì›</td></tr>`;
      });

      const finalGT = itemTotal + totalShip;

      c.innerHTML = `
        <div style="border:2px solid #2c3e50; padding:20px;">
          <div style="text-align:center;margin-bottom:30px;">
            <h1 style="color:#2c3e50; margin:0; font-size:28px;">ì•„ì´ë¦°ê°€êµ¬ ëª©ì¬ ê²¬ì  ë‚´ì—­ì„œ</h1>
            <p style="color:#7f8c8d; font-size:14px;">ë°œí–‰ì¼: ${new Date().toLocaleString('ko-KR')}</p>
          </div>
          <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
            <thead><tr style="background:#2c3e50; color:#fff;"><th style="padding:12px; border:1px solid #2c3e50;">í•­ëª©</th><th style="padding:12px; border:1px solid #2c3e50;">ê°€ê³µì •ë³´</th><th style="padding:12px; border:1px solid #2c3e50;">ê·œê²©/ìˆ˜ëŸ‰</th><th style="padding:12px; border:1px solid #2c3e50;">ê¸ˆì•¡</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <div style="text-align:right; border-top:2px solid #2c3e50; padding:20px 0;">
            <span style="font-size:18px; color:#7f8c8d;">ì´ ê²¬ì  í•©ê³„ (ë°°ì†¡ë¹„ í¬í•¨):</span>
            <span style="font-size:32px; font-weight:800; color:#e74c3c; margin-left:20px;">${finalGT.toLocaleString()} ì›</span>
          </div>
          <div style="background:#f8f9fa; padding:15px; margin-top:20px; font-size:12px; color:#666; line-height:1.6;">
            â€» ë³¸ ê²¬ì ì„œëŠ” ìì¬ ë° ê°€ê³µë¹„ ì˜ˆì‚° ì‚°ì¶œì„ ìœ„í•œ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.<br>
            â€» ì‹¤ì œ ê²°ì œ ì „ ìƒì„¸ ê°€ê° ë‚´ì—­ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>`;

      try {
        const canvas = await html2canvas(c, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `ì•„ì´ë¦°ê°€êµ¬_ê²¬ì ë‚´ì—­ì„œ_${Date.now()}.png`;
        link.href = imgData;
        link.click();
        addBotMessage('ê²¬ì  ë‚´ì—­ì„œê°€ ì´ë¯¸ì§€(PNG)ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error(e);
        addBotMessage('ë‚´ì—­ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // sync with submitOrder to show instructions modal
    // and add download button to the chat
    function updateSubmitOrderSuccess(on, gt) {
      addBotMessage(`
        <div style="text-align:center;padding:16px;">
          <div style="font-size:40px;margin-bottom:8px;">âœ…</div>
          <div style="font-size:18px;font-weight:700;color:#2c3e50;">ì£¼ë¬¸ ìš”ì²­ ì™„ë£Œ!</div>
          <p style="font-size:13px;color:#666;">ì£¼ë¬¸ë²ˆí˜¸: <b>${on}</b><br>ì´ ê²°ì œê¸ˆì•¡: <b>${gt.toLocaleString()}ì›</b></p>
          <div class="quick-buttons" style="justify-content:center;margin-top:12px;">
            <span class="quick-btn" style="background:#34495e;" onclick="generateReport()">ğŸ“¸ ê²¬ì ë‚´ì—­ì„œ ì €ì¥</span>
            <span class="quick-btn" onclick="openInstructionsModal('${on}', ${gt})">ğŸ’° ê²°ì œë°©ë²• ì•ˆë‚´</span>
          </div>
          <div class="quick-buttons" style="justify-content:center;margin-top:8px;">
            <span class="quick-btn" onclick="resetAll();showWoodCards();">ìƒˆ ê²¬ì  ì‹œì‘</span>
          </div>
        </div>`);
    }

    // ============================================================
    // updateOrderBadge
    // ============================================================
    function updateOrderBadge() {
      const badge = document.getElementById('orderBadge');
      if (!badge) return;
      if (orderList.length > 0) { badge.style.display = 'inline'; badge.textContent = orderList.length; }
      else { badge.style.display = 'none'; }
    }

    // ============================================================
    // ORDER PANEL (side panel)
    // ============================================================
    function ensureOrderPanel() {
      if (document.getElementById('orderPanel')) return;
      const panel = document.createElement('div');
      panel.id = 'orderPanel';
      panel.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eee;">
          <h3 style="margin:0;font-size:16px;">ì£¼ë¬¸ ëª©ë¡</h3>
          <button onclick="toggleOrderPanel()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#666;">&times;</button>
        </div>
        <div id="orderPanelContent" style="flex:1;overflow-y:auto;padding:10px;"></div>`;
      const style = document.createElement('style');
      style.textContent = `
        #orderPanel { position:fixed;top:0;right:-420px;width:400px;max-width:90vw;height:100vh;background:#fff;
          box-shadow:-4px 0 20px rgba(0,0,0,0.15);z-index:10001;display:flex;flex-direction:column;transition:right 0.3s ease; }
        #orderPanel.open { right:0; }
        .order-item-card { background:#f9f9f9;border:1px solid #eee;border-radius:10px;padding:10px 12px;margin-bottom:8px;font-size:12px; }
        .order-item-card.accessory { background:#f0fff4;border-color:#b2dfdb; }
        .order-item-card.discount { background:#fff8f8;border-color:#ffcdd2;color:#d32f2f; }
        .order-item-card.shipping { background:#f3f4f6;border-color:#e0e0e0; }
        .order-item-card .item-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:4px; }
        .order-item-card .item-header b { font-size:13px; }
        .order-item-card .item-detail { color:#666;line-height:1.5; }
        .order-item-card .item-price { text-align:right;font-weight:700;color:#2c3e50;margin-top:4px; }
        .order-summary-bar { padding:12px 16px;border-top:2px solid #2c3e50;background:#f8f9fa; }
        .order-btn-row { display:flex;gap:8px;padding:10px 16px;border-top:1px solid #eee; }
        .order-btn-row button { flex:1;padding:10px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px; }`;
      document.head.appendChild(style);
      document.body.appendChild(panel);
    }

    function toggleOrderPanel() {
      ensureOrderPanel(); renderOrderPanel();
      const panel = document.getElementById('orderPanel');
      panel.classList.toggle('open');
    }

    function renderOrderPanel() {
      ensureOrderPanel();
      const c = document.getElementById('orderPanelContent');
      if (!c) return;
      if (orderList.length === 0) { c.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">ì£¼ë¬¸ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>'; return; }
      let html = '', itemTotal = 0;
      const hasLoaded = orderList.some(i => i.isLoaded);
      orderList.forEach((item, idx) => {
        if (item.type === 'discount') {
          html += `<div class="order-item-card discount"><div class="item-header"><b>ì´ë²¤íŠ¸ í• ì¸</b></div><div class="item-detail">${item.name || ''}</div><div class="item-price" style="color:#d32f2f;">${item.estimate < 0 ? '' : '-'}${Math.abs(item.estimate).toLocaleString()}ì›</div></div>`;
          itemTotal += item.estimate;
        } else if (item.type === 'shipping') {
          html += `<div class="order-item-card shipping"><div class="item-header"><b>ì˜ˆìƒ ë°°ì†¡ë¹„</b></div><div class="item-detail">${item.name || ''} ${item.quantity ? '(' + item.quantity + 'ê°œ)' : ''}</div><div class="item-price">${item.estimate.toLocaleString()}ì›</div></div>`;
          itemTotal += item.estimate;
        } else if (item.type === 'accessory') {
          html += `<div class="order-item-card accessory"><div class="item-header"><b>[ë¶€ìì¬] ${item.name}</b>${!item.isLoaded ? '<button onclick="removeOrderItem(' + idx + ')" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;">âœ•</button>' : ''}</div><div class="item-detail">ìˆ˜ëŸ‰: ${item.quantity}ê°œ</div><div class="item-price">${item.estimate.toLocaleString()}ì›</div></div>`;
          itemTotal += item.estimate;
        } else {
          const deleteBtn = !item.isLoaded ? `<button onclick="removeOrderItem(${idx})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;">âœ•</button>` : '';
          html += `<div class="order-item-card"><div class="item-header"><b>${item.woodName || item.woodTypeValue}</b>${deleteBtn}</div>
            <div class="item-detail">${item.width || 0}Ã—${item.length || 0}mm / ${item.quantity || 1}ì¥<br>ê°€ê³µ: ${item.processingSummary || 'ì—†ìŒ'}</div>
            <div class="item-price">${item.estimate.toLocaleString()}ì›${item.discount > 0 ? ' <span style="color:#d32f2f;font-size:11px;">(í• ì¸ -' + item.discount.toLocaleString() + 'ì›)</span>' : ''}</div></div>`;
          itemTotal += item.estimate;
        }
      });
      // Shipping (for non-loaded orders)
      if (!hasLoaded) {
        const shipItems = calculateShippingCost(orderList);
        let shipTotal = 0;
        shipItems.forEach(si => {
          const sc = si.cost * si.count; shipTotal += sc;
          html += `<div class="order-item-card shipping"><div class="item-header"><b>ì˜ˆìƒ ë°°ì†¡ë¹„</b></div><div class="item-detail">${si.sizeCategory} (${si.count}ê°œ) Ã— ${si.cost.toLocaleString()}ì›</div><div class="item-price">${sc.toLocaleString()}ì›</div></div>`;
        });
        itemTotal += shipTotal;
      }
      html += `<div class="order-summary-bar"><div style="display:flex;justify-content:space-between;"><span style="font-weight:600;">ì´ í•©ê³„ (ë°°ì†¡ë¹„ í¬í•¨)</span><span style="font-size:18px;font-weight:800;color:#e74c3c;">${itemTotal.toLocaleString()}ì›</span></div></div>`;
      html += `<div class="order-btn-row"><button style="background:#2ecc71;color:#fff;" onclick="showCustomerForm();toggleOrderPanel();">ì£¼ë¬¸í•˜ê¸°</button><button style="background:#34495e;color:#fff;" onclick="generateReport();">ê²¬ì ì„œ ì €ì¥</button><button style="background:#e74c3c;color:#fff;" onclick="clearAllOrders();">ì „ì²´ ì‚­ì œ</button></div>`;
      c.innerHTML = html;
    }

    function removeOrderItem(idx) {
      if (orderList[idx]?.isLoaded) { alert('ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      orderList.splice(idx, 1);
      saveOrders(); updateOrderBadge(); renderOrderPanel();
    }

    function clearAllOrders() {
      if (orderList.some(i => i.isLoaded)) { alert('ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if (!confirm('ëª¨ë“  ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      orderList = []; saveOrders(); updateOrderBadge(); renderOrderPanel();
      addBotMessage('ì£¼ë¬¸ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ============================================================
    // localStorage PERSISTENCE
    // ============================================================
    function saveOrders() { localStorage.setItem('chatOrderData', JSON.stringify(orderList)); }
    function loadOrders() {
      try {
        const saved = localStorage.getItem('chatOrderData');
        if (saved) { orderList = JSON.parse(saved); updateOrderBadge(); }
      } catch (e) { console.warn('ì£¼ë¬¸ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', e); localStorage.removeItem('chatOrderData'); }
    }

    // Hook into addToOrder to persist
    const _origAddToOrder = addToOrder;
    addToOrder = function () { _origAddToOrder(); saveOrders(); };
    const _origRemoveOrderItem = removeOrderItem;
    removeOrderItem = function (idx) { _origRemoveOrderItem(idx); saveOrders(); };

    // Load on init
    window.addEventListener('DOMContentLoaded', () => { loadOrders(); });

    // ============================================================
    // ACCESSORY DATA & CHAT CARDS
    // ============================================================
    const ACCESSORY_DATA = {
      screws: {
        title: 'í”¼ìŠ¤',
        desc: 'êµ¬ë¦¬ ì²œì—° ëª©ê³µìš© í”¼ìŠ¤ë¡œ, ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” í”¼ìŠ¤ ì…ë‹ˆë‹¤.',
        items: [{ name: 'ëª©ê³µìš© í”¼ìŠ¤ (20ê°œ)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt2.png' }]
      },
      hinges: {
        title: 'ê²½ì²©',
        desc: 'ê°€êµ¬ ë¬¸ì§ ë“±ì— ì‚¬ìš©í•˜ëŠ” ê¸°ë³¸ ê²½ì²©ê³¼, ë¬¸ì´ ë¶€ë“œëŸ½ê²Œ ë‹«íˆë„ë¡ ë„ì™€ì£¼ëŠ” ìŠ¤ë¬´ë¸Œ ì˜µì…˜ì…ë‹ˆë‹¤.',
        items: [
          { name: '110ë„ ì‹±í¬ ê²½ì²© (1ì„¸íŠ¸=2ea)', price: 2000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge2.png' },
          { name: 'ê²½ì²© ìŠ¤ë¬´ë¸Œ (1ì„¸íŠ¸=2ea)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge3.png' }
        ]
      },
      sandpaper: {
        title: 'ì‚¬í¬',
        desc: 'ìˆ«ìê°€ ë‚®ì„ìˆ˜ë¡ ê±°ì¹ ê³ , ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ½ìŠµë‹ˆë‹¤.',
        items: [
          { name: 'ì‚¬í¬ #80 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_80.png' },
          { name: 'ì‚¬í¬ #150 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_150.png' },
          { name: 'ì‚¬í¬ #220 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_220.png' },
          { name: 'ì‚¬í¬ #320 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_320.png' }
        ]
      },
      tape: {
        title: 'ì—£ì§€í…Œì´í”„',
        desc: 'ëª©ì¬ì˜ ì ˆë‹¨ë©´ì„ ë§ˆê°í•˜ì—¬ ê¹”ë”í•˜ê²Œ ë§Œë“¤ê³  ìŠµê¸°ë¡œë¶€í„° ë³´í˜¸í•˜ëŠ” ë§ˆê°ì¬ì…ë‹ˆë‹¤.',
        items: [
          { name: 'PVC ì—£ì§€ í…Œì´í”„ (10m)', price: 8000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge_2.png' },
          { name: 'ì¢…ì´ ì—£ì§€ í…Œì´í”„ (10m)', price: 12000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge_1.png' }
        ]
      }
    };

    function showAccessoryCategories() {
      let h = '<div style="margin-bottom:6px;font-weight:600;">ë¶€ìì¬ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:</div><div class="proc-grid" style="grid-template-columns:repeat(2,1fr);">';
      const cats = [
        { key: 'screws', label: 'í”¼ìŠ¤', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png' },
        { key: 'hinges', label: 'ê²½ì²©', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png' },
        { key: 'sandpaper', label: 'ì‚¬í¬', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png' },
        { key: 'tape', label: 'ì—£ì§€í…Œì´í”„', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge.png' }
      ];
      cats.forEach(c => {
        h += `<div class="proc-item" onclick="showAccessoryItems('${c.key}')"><img src="${c.img}" alt="${c.label}"><div>${c.label}</div></div>`;
      });
      h += '</div>';
      addBotMessage(h);
    }

    function showAccessoryItems(catKey) {
      const cat = ACCESSORY_DATA[catKey];
      if (!cat) return;
      let h = `<div style="font-weight:600;margin-bottom:6px;">${cat.title}</div><p style="font-size:12px;color:#666;margin-bottom:8px;">${cat.desc}`;
      if (catKey === 'tape') {
        h += ` <a href="#" onclick="openVideoModal('https://www.youtube.com/embed/goC8S1Enjcg?si=7B93_Wk53lxoeqEj');return false;" style="color:#3498db;font-weight:600;">ì‹œê³µì˜ìƒ ë³´ê¸°</a>`;
      }
      h += '</p>';
      cat.items.forEach((item, i) => {
        const uid = catKey + '_' + i;
        h += `<div style="display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #eee;border-radius:10px;margin-bottom:6px;background:#fff;">
          <img src="${item.image}" style="width:50px;height:50px;border-radius:6px;object-fit:cover;" alt="${item.name}">
          <div style="flex:1;"><div style="font-weight:600;font-size:12px;">${item.name}</div><div style="color:#e74c3c;font-size:12px;">${item.price.toLocaleString()}ì›</div></div>
          <input type="number" id="accQty_${uid}" value="1" min="1" style="width:45px;text-align:center;border:1px solid #ddd;border-radius:6px;padding:4px;font-size:12px;">
          <button onclick="addAccessoryToOrder('${catKey}',${i})" style="padding:6px 12px;background:#2ecc71;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;">ë‹´ê¸°</button>
        </div>`;
      });
      addBotMessage(h);
    }

    function addAccessoryToOrder(catKey, itemIndex) {
      const cat = ACCESSORY_DATA[catKey];
      const item = cat.items[itemIndex];
      const uid = catKey + '_' + itemIndex;
      const qtyEl = document.getElementById('accQty_' + uid);
      const qty = parseInt(qtyEl?.value) || 1;
      if (qty < 1) { addBotMessage('ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      orderList.push({ type: 'accessory', woodTypeValue: null, woodName: '[ë¶€ìì¬]', name: item.name, width: 0, length: 0, quantity: qty, processingSummary: '-', selectedProcs: [], procDetails: {}, basePrice: item.price, additionalCost: 0, originalTotal: item.price * qty, discount: 0, discountDetails: [], estimate: item.price * qty });
      saveOrders(); updateOrderBadge(); renderOrderPanel();
      addBotMessage(`<b>${item.name}</b> ${qty}ê°œë¥¼ ì£¼ë¬¸ëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (${(item.price * qty).toLocaleString()}ì›)
      <div class="quick-buttons"><span class="quick-btn" onclick="showAccessoryCategories()">ë¶€ìì¬ ë” ë³´ê¸°</span><span class="quick-btn" onclick="showCustomerForm()">ì£¼ë¬¸í•˜ê¸° (${orderList.length}ê±´)</span></div>`);
    }

    // ============================================================
    // PROGRESS MODAL
    // ============================================================
    function showProgressModal() {
      document.getElementById('progressTitle').textContent = 'ì „ì†¡ ì¤‘...';
      document.getElementById('progressIcon').src = 'https://i.gifer.com/ZZ5H.gif';
      document.getElementById('progressModalCloseBtn').style.display = 'none';
      document.getElementById('progressBar').style.backgroundColor = '#007bff';
      document.getElementById('progressModalOverlay').style.display = 'flex';
      updateProgress(10, 'ì „ì†¡ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    }
    function updateProgress(pct, msg) {
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressStatusText').textContent = msg;
    }
    function showProgressSuccess(msg) {
      updateProgress(100, msg);
      document.getElementById('progressTitle').textContent = 'ì „ì†¡ ì™„ë£Œ';
      document.getElementById('progressIcon').src = 'https://i.imgur.com/UDS2wje.png';
      document.getElementById('progressModalCloseBtn').style.display = 'block';
    }
    function showProgressError(msg) {
      updateProgress(100, msg);
      document.getElementById('progressBar').style.backgroundColor = '#dc3545';
      document.getElementById('progressTitle').textContent = 'ì „ì†¡ ì‹¤íŒ¨';
      document.getElementById('progressIcon').src = 'https://i.imgur.com/P4Q6r5A.png';
      document.getElementById('progressModalCloseBtn').style.display = 'block';
    }
    function hideProgressModal() { document.getElementById('progressModalOverlay').style.display = 'none'; }

    // ============================================================
    // VIDEO MODAL
    // ============================================================
    function openVideoModal(url) { document.getElementById('youtubeVideo').src = url; document.getElementById('videoModal').style.display = 'flex'; }
    function closeVideoModal() { document.getElementById('videoModal').style.display = 'none'; document.getElementById('youtubeVideo').src = ''; }

    // ============================================================
    // LOAD ORDER (JSONP)
    // ============================================================
    let jsonpTimeout;
    function openLoadModal() { document.getElementById('loadOrderModal').style.display = 'flex'; }
    function closeLoadModal() { document.getElementById('loadOrderModal').style.display = 'none'; }
    function formatPhoneNumber(input) {
      let val = input.value.replace(/\D/g, '');
      if (val.length > 3 && val.length <= 7) val = val.slice(0, 3) + '-' + val.slice(3);
      else if (val.length > 7) val = val.slice(0, 3) + '-' + val.slice(3, 7) + '-' + val.slice(7, 11);
      input.value = val;
    }
    function confirmLoadOrder() {
      const phone = document.getElementById('load-phone').value.trim();
      const orderNo = document.getElementById('load-orderNo').value.trim();
      if (!phone || !orderNo) { alert('íœ´ëŒ€í° ë²ˆí˜¸ì™€ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const btn = document.getElementById('loadOrderConfirmBtn');
      btn.disabled = true; btn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      const old = document.getElementById('jsonp_script'); if (old) old.remove();
      jsonpTimeout = setTimeout(() => { if (btn.disabled) { alert('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.'); btn.disabled = false; btn.textContent = 'í™•ì¸'; } }, 15000);
      const script = document.createElement('script');
      script.id = 'jsonp_script';
      script.src = `${API_URL}?callback=handleOrderDataResponse&phone=${encodeURIComponent(phone)}&orderNo=${encodeURIComponent(orderNo)}`;
      script.onerror = () => { clearTimeout(jsonpTimeout); alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); btn.disabled = false; btn.textContent = 'í™•ì¸'; };
      document.head.appendChild(script);
    }
    function handleOrderDataResponse(result) {
      clearTimeout(jsonpTimeout);
      const btn = document.getElementById('loadOrderConfirmBtn');
      btn.disabled = false; btn.textContent = 'í™•ì¸';
      if (result.result === 'success' && result.data && result.data.length > 0) {
        orderList = [];
        result.data.forEach(row => {
          const summary = String(row['í’ˆëª…'] || row['ì£¼ë¬¸ë‚´ì—­ ìš”ì•½'] || '');
          const estimate = parseFloat(row['í•©ê³„']) || 0;
          const processing = row['ê°€ê³µìƒì„¸'] || row['ê°€ê³µ'] || '';
          if (summary === 'ì´ í•©ê³„') return;
          let item = { isLoaded: true, estimate };
          if (summary === '[ì´ë²¤íŠ¸ í• ì¸]') { item.type = 'discount'; item.name = processing || 'ì´ë²¤íŠ¸ í• ì¸'; item.woodName = 'í• ì¸'; }
          else if (summary === 'ì˜ˆìƒ ë°°ì†¡ë¹„') { item.type = 'shipping'; item.name = processing || 'ë°°ì†¡ë¹„'; item.woodName = 'ë°°ì†¡'; item.quantity = row['ìˆ˜ëŸ‰']; }
          else if (summary.startsWith('[ë¶€ìì¬]')) { item.type = 'accessory'; item.name = summary.replace('[ë¶€ìì¬] ', ''); item.woodName = '[ë¶€ìì¬]'; item.quantity = row['ìˆ˜ëŸ‰']; }
          else {
            item.woodTypeValue = summary; item.woodName = summary;
            item.width = row['í­(mm)'] || row['í­'] || 0; item.length = row['ê¸¸ì´(mm)'] || row['ê¸¸ì´'] || 0;
            item.quantity = row['ìˆ˜ëŸ‰'] || 1;
            item.processingSummary = processing || 'ê°€ê³µ ì—†ìŒ';
            item.selectedProcs = []; item.procDetails = {}; item.discount = 0; item.discountDetails = [];
          }
          orderList.push(item);
        });
        saveOrders(); updateOrderBadge(); renderOrderPanel();
        closeLoadModal();
        addBotMessage('âœ… ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ëŠ” ìˆ˜ì • ë¶ˆê°€ì´ë©°, ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        document.getElementById('load-phone').value = ''; document.getElementById('load-orderNo').value = '';
      } else { alert('ì¼ì¹˜í•˜ëŠ” ì£¼ë¬¸ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
    }

    // ============================================================
    // ENHANCED processInput (accessory/load keywords)
    // ============================================================
    const _origProcessInput = processInput;
    processInput = async function (text) {
      const lo = text.toLowerCase().replace(/\s+/g, '');
      if (lo.includes('ë¶€ìì¬') || lo.includes('í”¼ìŠ¤') || lo.includes('ì‚¬í¬') || lo.includes('ì—£ì§€') || lo.includes('í…Œì´í”„')) {
        if (lo.includes('í”¼ìŠ¤')) showAccessoryItems('screws');
        else if (lo.includes('ì‚¬í¬')) showAccessoryItems('sandpaper');
        else if (lo.includes('ì—£ì§€') || lo.includes('í…Œì´í”„')) showAccessoryItems('tape');
        else showAccessoryCategories();
        return;
      }
      if (lo.includes('ë¶ˆëŸ¬ì˜¤ê¸°') || lo.includes('ì´ì „ì£¼ë¬¸')) { openLoadModal(); return; }
      return _origProcessInput(text);
    };

    // ============================================================
    // ENHANCED submitOrder with progress modal
    // ============================================================
    submitOrder = async function () {
      const name = document.getElementById('custName').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const email = document.getElementById('custEmail')?.value.trim() || '';
      const memo = document.getElementById('custMemo').value.trim();
      if (!name || !phone) { addBotMessage('ì„±í•¨ê³¼ ì—°ë½ì²˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      const phoneRegex = /^010-\d{4}-\d{4}$/;
      if (!phoneRegex.test(phone)) { addBotMessage('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ 010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      showProgressModal();
      updateStatus('ì£¼ë¬¸ ì œì¶œ ì¤‘...', '');
      try {
        updateProgress(40, 'ê²¬ì  ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
        const resp = await postToServer({ type: 'order', data: { customer: { name, phone, email, memo }, items: orderList, sessionId: SESSION_ID, timestamp: new Date().toISOString() } });
        if (resp.result === 'success' || resp.orderNumber || resp.orderNo) {
          const on = resp.orderNo || resp.orderNumber || resp.data?.orderNumber || 'IRN-' + Date.now();
          let itemTotal = 0; orderList.forEach(i => { itemTotal += i.estimate; });
          const shipItems = calculateShippingCost(orderList); let shipTotal = 0;
          shipItems.forEach(si => shipTotal += (si.cost * si.count));
          const grandTotal = itemTotal + shipTotal;
          showProgressSuccess('ê²¬ì ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
          setTimeout(() => {
            hideProgressModal();
            updateSubmitOrderSuccess(on, grandTotal);
            openInstructionsModal(on, grandTotal);
          }, 2000);
          orderList = []; saveOrders(); updateOrderBadge(); renderOrderPanel(); updateStatus('ì£¼ë¬¸ ì™„ë£Œ', on);
        } else {
          showProgressError('ì„œë²„ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (resp.message || ''));
          updateStatus('ì£¼ë¬¸ ì‹¤íŒ¨', '');
        }
      } catch (e) {
        showProgressError('ì „ì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        updateStatus('ì—°ê²° ì˜¤ë¥˜', ''); console.error(e);
      }
    };

    // Modal dismiss on overlay click
    window.addEventListener('click', (e) => {
      if (e.target.id === 'loadOrderModal') closeLoadModal();
      if (e.target.id === 'videoModal') closeVideoModal();
    });
  </script>

  <!-- ORDER INSTRUCTIONS MODAL -->
  <div id="orderInstructionsModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeInstructionsModal()">&times;</span>
      <div class="modal-title">ğŸ“¦ ì£¼ë¬¸ ì•ˆë‚´</div>
      <div class="instruction-box">
        <div class="instruction-row"><span>ìµœì¢… ê²¬ì  ê¸ˆì•¡</span><b id="finalQuoteAmount">-</b></div>
        <div class="instruction-row"><span>ê²°ì œ ìˆ˜ëŸ‰ (1,000ì› ë‹¨ìœ„)</span><b id="paymentQuantity">-</b></div>
        <div class="instruction-row">
          <span>ì£¼ë¬¸ ë²ˆí˜¸</span>
          <span style="display:flex;align-items:center;gap:8px;">
            <b id="finalOrderNumber">-</b>
            <button id="copyOrderBtn" onclick="copyOrderNumber()"
              style="padding:4px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:11px;">ğŸ“‹
              ë³µì‚¬</button>
          </span>
        </div>
      </div>
      <p style="font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 20px;">
        ìœ„ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ë³µì‚¬í•˜ì‹  í›„, ì•„ë˜ ê²°ì œ ë§í¬ì—ì„œ<br>
        <b>ê²°ì œ ìˆ˜ëŸ‰</b>ë§Œí¼ ê°œìˆ˜ë¥¼ ì„¤ì •í•˜ì—¬ ê²°ì œí•´ ì£¼ì„¸ìš”.
      </p>
      <div class="payment-links">
        <a class="payment-link" style="background:#03c75a;" href="https://naver.me/GJ5OEouG" target="_blank">ë„¤ì´ë²„ ìŠ¤í† ì–´
          ê²°ì œ</a>
        <a class="payment-link" style="background:#1184ff;" href="https://link.coupang.com/a/cQ9keF" target="_blank">ì¿ íŒ¡
          ê²°ì œ</a>
      </div>
      <div style="margin-top:15px;display:flex;gap:8px;justify-content:center;">
        <a href="https://talk.naver.com/ct/wc4u6d" target="_blank"
          style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:#03c75a;color:#fff;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;">ğŸ’¬
          ë„¤ì´ë²„ í†¡í†¡</a>
        <a href="https://pf.kakao.com/_xgxkxjxj" target="_blank"
          style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:#FEE500;color:#3C1E1E;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;">ğŸ’¬
          ì¹´ì¹´ì˜¤í†¡ ìƒë‹´</a>
      </div>
      <button class="btn-checkout" style="margin-top:15px; background:#7f8c8d;"
        onclick="closeInstructionsModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- PROGRESS MODAL -->
  <div id="progressModalOverlay" class="modal-overlay">
    <div class="modal-content" style="text-align: center;">
      <h3 id="progressTitle">ì „ì†¡ ì¤‘...</h3>
      <img id="progressIcon" src="https://i.gifer.com/ZZ5H.gif" alt="ë¡œë”© ì¤‘"
        style="width:80px;height:80px;margin-bottom:20px;">
      <p id="progressStatusText" style="margin-bottom:20px;font-size:1.1em;color:#333;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
      <div style="background:#e0e0e0;border-radius:10px;padding:3px;overflow:hidden;">
        <div id="progressBar"
          style="width:0%;height:20px;background:#007bff;border-radius:7px;transition:width 0.5s ease-in-out;"></div>
      </div>
      <button id="progressModalCloseBtn" class="btn-checkout" style="display:none;margin-top:25px;background:#7f8c8d;"
        onclick="hideProgressModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- VIDEO MODAL -->
  <div id="videoModal" class="modal-overlay">
    <div class="modal-content" style="max-width:800px;text-align:left;">
      <span class="modal-close" onclick="closeVideoModal()">&times;</span>
      <h3 style="margin-bottom:10px;">ì—£ì§€ í…Œì´í”„ ì‹œê³µ ë°©ë²•</h3>
      <div style="position:relative;width:100%;padding-bottom:56.25%;height:0;">
        <iframe id="youtubeVideo" style="position:absolute;top:0;left:0;width:100%;height:100%;" src="" frameborder="0"
          allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture"
          allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- LOAD ORDER MODAL -->
  <div id="loadOrderModal" class="modal-overlay">
    <div class="modal-content" style="text-align:left;">
      <span class="modal-close" onclick="closeLoadModal()">&times;</span>
      <div class="modal-title">ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°</div>
      <div class="form-row"><label>íœ´ëŒ€í°</label><input type="tel" id="load-phone" placeholder="010-1234-5678"></div>
      <div class="form-row"><label>ì£¼ë¬¸ë²ˆí˜¸</label><input type="text" id="load-orderNo" placeholder="ì˜ˆ: 20240718-001"></div>
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-checkout" style="background:linear-gradient(135deg,#3498db,#2980b9);"
          id="loadOrderConfirmBtn" onclick="confirmLoadOrder()">í™•ì¸</button>
        <button class="btn-checkout" style="background:#7f8c8d;" onclick="closeLoadModal()">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <div id="reportContainer"></div>
</body>

</html>
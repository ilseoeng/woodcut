<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÏïÑÏù¥Î¶∞Í∞ÄÍµ¨ - AI Î™©Ïû¨ Í≤¨Ï†Å Ï±ÑÌåÖ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .header .subtitle {
      font-size: 11px;
      opacity: .8;
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-panel {
      width: 420px;
      min-width: 300px;
      max-width: 70vw;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e0e0;
      background: #fdfdfd;
      flex-shrink: 0;
    }

    .splitter {
      width: 8px;
      background: #eee;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 100;
      flex-shrink: 0;
    }

    .splitter:hover,
    .splitter.active {
      background: #3498db;
    }

    .splitter::after {
      content: "";
      width: 2px;
      height: 30px;
      background: #ccc;
      border-radius: 1px;
    }

    .splitter:hover::after,
    .splitter.active::after {
      background: #fff;
    }

    .preview-panel {
      flex: 1;
      background: #1a1a2e;
      display: flex;
      flex-direction: column;
      min-width: 0;
      position: relative;
    }

    .preview-canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-height: 0;
    }

    #previewCanvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    .msg {
      max-width: 92%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 13.5px;
      line-height: 1.6;
      word-break: break-word;
      animation: fadeIn .3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .bot-msg {
      background: #f0f4ff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      color: #222;
    }

    .msg.full {
      max-width: 100%;
      padding: 0;
      background: none;
      box-shadow: none;
    }

    .user-msg {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .chat-input-area input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 13.5px;
      outline: none;
      transition: border .2s;
    }

    .chat-input-area input:focus {
      border-color: #3498db;
    }

    .chat-input-area button {
      padding: 10px 18px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 13.5px;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
    }

    .sns-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      text-decoration: none;
      font-size: 16px;
      font-weight: 800;
      flex-shrink: 0;
      transition: all .2s;
    }

    .sns-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
    }

    .sns-naver {
      background: #03c75a;
      color: #fff;
    }

    .sns-kakao {
      background: #FEE500;
      color: #3C1E1E;
    }

    /* 3D Interactive Tag */
    .proc-tag {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.98);
      border: 1.5px solid #3498db;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      pointer-events: auto !important;
      transition: all 0.2s;
      min-width: 60px;
      position: relative;
    }

    .proc-tag:hover {
      background: #fff;
      border-color: #2980b9;
      transform: translateY(-2px);
    }

    /* Accessory UI */
    .acc-card {
      position: relative;
      background: #fff;
      border: 2px solid #3498db;
      border-radius: 16px;
      padding: 20px;
      margin: 8px 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .acc-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 2px solid #f0f2f5;
      padding-bottom: 10px;
    }

    .acc-card-title {
      font-size: 18px;
      font-weight: 800;
      color: #2c3e50;
    }

    .acc-close-btn {
      background: #f0f2f5;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      color: #7f8c8d;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .acc-close-btn:hover {
      background: #e74c3c;
      color: #fff;
    }

    .acc-back-btn {
      background: #f0f2f5;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
      transition: all 0.2s;
    }

    .acc-back-btn:hover {
      background: #e0e0e0;
    }

    .acc-category-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .acc-category {
      background: #f8f9fa;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .acc-category:hover {
      border-color: #3498db;
      background: #eef7ff;
      transform: translateY(-2px);
    }

    .acc-category.active {
      border-color: #3498db;
      background: #3498db;
      color: #fff;
    }

    .acc-category img {
      width: 48px;
      height: 48px;
      margin-bottom: 8px;
    }

    .acc-category div {
      font-size: 13px;
      font-weight: 700;
    }

    .acc-item-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .acc-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border: 1px solid #f0f2f5;
      border-radius: 12px;
      background: #fff;
      transition: border-color 0.2s;
    }

    .acc-item:hover {
      border-color: #3498db;
    }

    .acc-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .acc-info {
      flex: 1;
      min-width: 0;
      /* ÌÖçÏä§Ìä∏ Ï§ÑÎ∞îÍøà ÌóàÏö© */
    }

    .acc-name {
      font-size: 15px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
      line-height: 1.4;
      word-break: keep-all;
      /* Îã®Ïñ¥ Îã®ÏúÑ Ï§ÑÎ∞îÍøà */
    }

    .acc-price {
      font-size: 14px;
      color: #e74c3c;
      font-weight: 700;
    }

    .acc-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
      /* Î≤ÑÌäº ÏòÅÏó≠ Ï§ÑÏñ¥Îì§ÏßÄ ÏïäÏùå */
    }

    .acc-qty {
      width: 50px;
      height: 38px;
      padding: 0;
      border: 2px solid #eee;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      box-sizing: border-box;
    }

    .acc-add-btn {
      height: 38px;
      padding: 0 16px;
      background: #2ecc71;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      /* ÌÖçÏä§Ìä∏ Ï§ÑÎ∞îÍøà Î∞©ÏßÄ */
    }

    .acc-add-btn:hover {
      background: #27ae60;
    }

    .proc-tag-name {
      font-size: 11px;
      font-weight: 700;
      color: #2c3e50;
      line-height: 1.3;
      text-align: center;
    }

    .proc-tag-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      color: #e74c3c;
      border: 1.5px solid #e74c3c;
      border-radius: 50%;
      font-size: 9px;
      font-weight: 800;
      transition: all 0.2s;
      z-index: 10;
    }

    .proc-tag-remove:hover {
      background: #e74c3c;
      color: #fff;
    }

    #proc-tag-overlay {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
      z-index: 100;
      pointer-events: none;
    }

    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .quick-btn {
      display: inline-block;
      padding: 6px 12px;
      background: #fff;
      border: 1.5px solid #3498db;
      color: #3498db;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      font-weight: 500;
    }

    .quick-btn:hover {
      background: #3498db;
      color: #fff;
    }

    .estimate-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-radius: 16px;
      padding: 16px;
      margin-top: 8px;
    }

    .estimate-card h3 {
      font-size: 15px;
      margin-bottom: 10px;
    }

    .estimate-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, .15);
    }

    .estimate-row:last-child {
      border: none;
    }

    .estimate-total {
      font-size: 18px;
      font-weight: 700;
      text-align: right;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 2px solid rgba(255, 255, 255, .3);
    }

    .estimate-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .estimate-actions button {
      flex: 1;
      padding: 8px 0;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-add-order {
      background: #2ecc71;
      color: #fff;
    }

    .btn-add-order:hover {
      background: #27ae60;
    }

    .btn-new-est {
      background: rgba(255, 255, 255, .2);
      color: #fff;
    }

    .btn-new-est:hover {
      background: rgba(255, 255, 255, .35);
    }

    .preview-header {
      padding: 10px 16px;
      background: rgba(0, 0, 0, .3);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .preview-info {
      padding: 10px 16px;
      background: rgba(0, 0, 0, .2);
      color: #82b1ff;
      font-size: 12px;
      text-align: center;
      flex-shrink: 0;
    }

    .order-panel {
      background: #fff;
      width: 95%;
      max-width: 600px;
      max-height: 85vh;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .order-panel-header {
      padding: 14px 16px;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    /* ORDER TABLE STYLE */
    .order-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
      color: #333;
    }

    .order-table th {
      background: #f8f9fa;
      padding: 8px;
      border-bottom: 2px solid #ddd;
      font-weight: 600;
      text-align: left;
    }

    .order-table td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    .order-table tr:last-child td {
      border-bottom: none;
    }

    .order-table .shipping-row td {
      background: #fffdf0;
      color: #7f8c8d;
    }

    .order-table .discount-row td {
      background: #fff0f0;
      color: #c0392b;
    }

    .order-table .total-row td {
      background: #eaf2f8;
      font-weight: 700;
      border-top: 2px solid #3498db;
    }

    .oi-remove-btn {
      background: #ff6b6b;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 11px;
    }



    .order-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 12.5px;
      border-left: 4px solid #3498db;
    }

    .order-item .oi-title {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .order-item .oi-detail {
      color: #666;
    }

    .order-item .oi-price {
      font-weight: 700;
      color: #e74c3c;
      text-align: right;
      margin-top: 4px;
    }

    .order-item .oi-remove {
      float: right;
      background: none;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      line-height: 1;
    }

    .order-panel-footer {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .order-panel-footer .total-row {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .btn-checkout {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .status-bar {
      background: #2c3e50;
      color: #82b1ff;
      padding: 6px 20px;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .customer-form {
      background: #fff;
      border-radius: 12px;
      padding: 14px;
      margin-top: 8px;
      border: 1px solid #e0e0e0;
    }

    .customer-form h4 {
      margin-bottom: 10px;
      color: #2c3e50;
    }

    .form-row {
      margin-bottom: 8px;
    }

    .form-row label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 3px;
    }

    .form-row input,
    .form-row textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
    }

    .form-row input:focus,
    .form-row textarea:focus {
      border-color: #3498db;
    }

    .btn-submit-order {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }

    .payment-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .payment-link {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
    }

    /* Í∞ÄÍ≥µ ÏòµÏÖò (Î≥µÏàò ÏÑ†ÌÉù - ÏõêÎ≥∏ Ïä§ÌÉÄÏùº) */
    .proc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .proc-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 2px solid #ddd;
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all .2s;
      font-size: 11px;
      background: #fff;
    }

    .proc-item img {
      width: 100%;
      max-width: 60px;
      height: auto;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .proc-item.selected {
      border: 3px solid #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, .5);
      background: #f0f7ff;
    }

    .proc-item.disabled {
      opacity: .4;
      pointer-events: none;
    }

    /* Í∞ÄÍ≥µ ÏÑúÎ∏åÏòµÏÖò */
    .proc-sub {
      margin-top: 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      font-size: 12px;
    }

    .proc-sub .sub-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 6px;
    }

    .proc-sub select,
    .proc-sub input[type="number"] {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
    }

    .side-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .side-item {
      padding: 6px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all .2s;
      background: #fff;
    }

    .side-item:hover {
      border-color: #3498db;
    }

    .side-item.active {
      border-color: #e74c3c;
      background: #fff0f0;
      color: #e74c3c;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 14px;
      align-self: flex-start;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #aaa;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: .2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: .4s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0)
      }

      40% {
        transform: scale(1)
      }
    }

    /* Î™©Ïû¨ ÏÑ†ÌÉù Î≤ÑÌäº */
    .wood-btn-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 4px 0;
    }

    .wood-card-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: #fff;
      transition: all .2s;
      color: #333;
    }

    .wood-card-item:hover {
      border-color: #3498db;
      background: #f0f7ff;
    }

    .wood-card-item .wood-thumb {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid rgba(0, 0, 0, .1);
    }

    .wood-card-item .wood-label {
      flex: 1;
      min-width: 0;
    }

    .wood-card-item .wood-label .wname {
      font-size: 13px;
      font-weight: 700;
    }

    .wood-card-item .wood-label .wdesc {
      font-size: 11px;
      color: #888;
      margin-top: 1px;
    }

    .wood-btn-group {
      display: flex;
      gap: 5px;
      flex-shrink: 0;
    }

    .wood-btn-group button {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }

    .wood-btn-select {
      background: #2ecc71;
      color: #fff;
    }

    .wood-btn-select:hover {
      background: #27ae60;
    }

    .wood-btn-desc {
      background: #3498db;
      color: #fff;
    }

    .wood-btn-desc:hover {
      background: #2980b9;
    }

    /* Ï±ÑÌåÖ ÎÇ¥ YouTube ÏûÑÎ≤†Îìú */
    .yt-embed-wrap {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      height: 0;
      border-radius: 12px;
      overflow: hidden;
      margin: 12px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid #eee;
    }

    .yt-embed-wrap iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .wood-detail-card {
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a2e;
      margin-top: 6px;
      animation: wdSlide .3s ease;
    }

    @keyframes wdSlide {
      from {
        opacity: 0;
        transform: translateY(-8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .wood-detail-card img {
      width: 100%;
      display: block;
      max-height: 180px;
      object-fit: cover;
    }

    .wood-detail-actions {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      background: #1a1a2e;
    }

    .wood-detail-actions button {
      flex: 1;
      padding: 9px 0;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-select-wood {
      background: #2ecc71;
      color: #fff;
    }

    .btn-select-wood:hover {
      background: #27ae60;
    }

    .btn-youtube {
      background: #ff0000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .btn-youtube:hover {
      background: #cc0000;
    }

    .btn-youtube svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }

    .event-tag {
      display: inline-block;
      background: #fff0f6;
      color: #e11d78;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      border: 1px solid #ffc2d8;
      margin-bottom: 4px;
    }

    @media(max-width:800px) {
      .main {
        flex-direction: column;
      }

      .chat-panel {
        width: 100%;
        max-width: 100%;
        height: 50vh;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }

      .preview-panel {
        height: 50vh;
      }

      .order-panel {
        width: 100%;
      }

      .proc-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #fff;
      width: 90%;
      max-width: 500px;
      border-radius: 20px;
      padding: 30px;
      position: relative;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    .instruction-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .instruction-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .instruction-row b {
      color: #e74c3c;
    }

    /* REPORT CONTAINER (HIDDEN) */
    #reportContainer {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 800px;
      background: #fff;
      padding: 40px;
      box-sizing: border-box;
      font-family: 'Pretendard', sans-serif;
    }
  </style>
</head>

<body>

  <div class="header">
    <div>
      <h1>ÏïÑÏù¥Î¶∞Í∞ÄÍµ¨</h1>
      <div class="subtitle">AI Î™©Ïû¨ Í≤¨Ï†Å ÏãúÏä§ÌÖú</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button onclick="openLoadModal()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">Î∂àÎü¨Ïò§Í∏∞</button>
      <button onclick="confirmReset()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">Ï¥àÍ∏∞Ìôî</button>
      <button onclick="generateReport()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">Í≤¨Ï†ÅÏÑú</button>
      <button onclick="toggleOrderPanel()"
        style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 14px;border-radius:20px;font-size:12px;cursor:pointer;">
        Ï£ºÎ¨∏Î™©Î°ù <span id="orderBadge"
          style="background:#e74c3c;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;display:none;">0</span>
      </button>
    </div>
  </div>

  <div class="main">
    <div class="chat-panel">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Ïòà: MDF 400x1000 2Ïû•"
          onkeydown="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">Ï†ÑÏÜ°</button>
        <a href="https://talk.naver.com/profile/wc80z0" target="_blank" class="sns-btn sns-naver"
          title="ÎÑ§Ïù¥Î≤Ñ ÌÜ°ÌÜ° ÏÉÅÎã¥">N</a>
        <a href="http://pf.kakao.com/_NKxaxcl/chat" target="_blank" class="sns-btn sns-kakao" title="Ïπ¥Ïπ¥Ïò§ÌÜ° ÏÉÅÎã¥">K</a>
      </div>
    </div>
    <div class="splitter" id="splitter"></div>
    <div class="preview-panel">
      <div class="preview-header">
        <span>3D ÎØ∏Î¶¨Î≥¥Í∏∞</span>
        <div style="display:flex;align-items:center;gap:8px;">
          <span id="previewDim" style="font-size:11px;color:#82b1ff;">-</span>
          <button id="btnToggle3D" onclick="toggle3DView()"
            style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;padding:0 4px;"
            title="ÌôîÎ©¥ ÌôïÎåÄ/Ï∂ïÏÜå">‚õ∂</button>
        </div>
      </div>
      <div class="preview-canvas-wrap">
        <canvas id="previewCanvas"></canvas>
        <div id="labels-container"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden;">
        </div>
        <div id="proc-tag-overlay"></div>
      </div>
      <div class="preview-info" id="previewInfo"></div>
    </div>
  </div>

  <div id="orderPanelOverlay" class="modal-overlay">
    <div class="order-panel" id="orderPanel"></div>
  </div>

  <div class="status-bar"><span id="statusLeft">ÎåÄÍ∏∞ Ï§ë</span><span id="statusRight"></span></div>
  <div id="reportContainer"
    style="position:absolute;left:-9999px;top:0;width:800px;background:#fff;padding:30px;font-family:'Noto Sans KR',sans-serif;">
  </div>

  <script>
    // ============================================================
    // CONFIG & URLs (ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú)
    // ============================================================
    const PRICE_API_URL = 'https://script.google.com/macros/s/AKfycbzkTCXtkfn0zmQkXB3xFZEaczyHquAuGGZu_3KMiMHVz6SEGXvMbZV56EE8u7o-zEoLMw/exec';
    const API_URL = 'https://script.google.com/macros/s/AKfycbzXHDF31Hi_yZaDR_BG_GfDdcY7a8h_9wShpptcvfCOP-EEUgLQTalICjOtXGfZkpiFpw/exec';
    const SESSION_ID = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

    // ============================================================
    // WOOD DATA (ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ/ÌÖçÏä§Ï≤ò URL ÏÇ¨Ïö©)
    // ============================================================
    const WOOD_DATA = {
      mdf18T: { name: 'MDF 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/mdf.png', thickness: 18, desc: 'Í∞ÄÏÑ±ÎπÑ Ï¢ãÏùÄ Í∏∞Î≥∏ Ìï©Ìåê', canSand: false, canCoat: false },
      pvc18T: { name: 'PVCÎ≥¥Îìú 18T+PET (ÏôÑÏ†ÑÎ∞©Ïàò)', image: 'https://gi.esmplus.com/irn2011/click/texture/pvc.png', thickness: 18, desc: 'ÏôÑÏ†ÑÎ∞©Ïàò ¬∑ ÏöïÏã§/Ï£ºÎ∞© Ï∂îÏ≤ú', canSand: false, canCoat: false },
      misong18T: { name: 'ÎØ∏ÏÜ°ÏßëÏÑ±Î™© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/misong.png', thickness: 18, desc: 'Î∂ÄÎìúÎü¨Ïö¥ ÏõêÎ™© ÎäêÎÇå', canSand: true, canCoat: true },
      pyeonbaek18T: { name: 'Ìé∏Î∞±ÏßëÏÑ±Î™© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/pyenon.png', thickness: 18, desc: 'ÌîºÌÜ§ÏπòÎìú ¬∑ ÌîÑÎ¶¨ÎØ∏ÏóÑ ÏõêÎ™©', canSand: true, canCoat: true },
      mulbau18T: { name: 'Î©ÄÎ∞îÏö∞ ÏßëÏÑ±Î™© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/mulbau.png', thickness: 18, desc: 'Í≥†Í∏â ÌïòÎìúÏö∞Îìú ¬∑ Í∞ïÌïú ÎÇ¥Íµ¨ÏÑ±', canSand: true, canCoat: true }
    };

    const WOOD_YOUTUBE = {
      mdf18T: 'https://youtu.be/gb2ETOmWzAI',
      pvc18T: 'https://youtu.be/iKc5odpOETg',
      misong18T: 'https://youtu.be/vk0Pa0uXu1w',
      pyeonbaek18T: 'https://youtu.be/xdmOsSKHXQU',
      mulbau18T: 'https://youtu.be/zxTFCZ9oIdk'
    };

    const WOOD_KEYS = ['mdf18T', 'pvc18T', 'misong18T', 'pyeonbaek18T', 'mulbau18T'];

    // Í∞ÄÍ≥µ ÏòµÏÖò (ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©, Î≥µÏàò ÏÑ†ÌÉù)
    const PROC_OPTIONS = [
      { key: 'none', label: 'Í∞ÄÍ≥µÏóÜÏùå', image: 'https://gi.esmplus.com/irn2011/click/texture/null.png', group: 'none' },
      { key: 'sanding', label: 'ÏÉåÎî©', image: 'https://gi.esmplus.com/irn2011/click/texture/sanding.png', group: 'base', event: 'Ìïú Ïû• Î¨¥Î£å ÏÉåÎî©!' },
      { key: 'coating', label: 'Ìà¨Î™ÖÏΩîÌåÖ', image: 'https://gi.esmplus.com/irn2011/click/texture/coating.png', group: 'base' },
      { key: 'angled', label: 'ÏÇ¨ÏÑ†Í∞ÄÍ≥µ', image: 'https://gi.esmplus.com/irn2011/click/texture/45dgree.png', group: 'extra', event: 'Ìïú Î©¥ Î¨¥Î£å!', needSides: true },
      { key: 'round', label: 'Î™®ÏÑúÎ¶¨ ÎùºÏö¥Îìú', image: 'https://gi.esmplus.com/irn2011/click/texture/round.png', group: 'extra', event: 'Ìïú Íº≠ÏßÄÏ†ê Î¨¥Î£å!', needCorners: true },
      { key: 'circlecut', label: 'ÏõêÌòïÌÉÄÍ≥µ', image: 'https://gi.esmplus.com/irn2011/click/texture/circle.png', group: 'extra', event: 'Ìïú Í∞ú Î¨¥Î£å!' },
      { key: 'squarecut', label: 'ÏÇ¨Í∞ÅÌÉÄÍ≥µ', image: 'https://gi.esmplus.com/irn2011/click/texture/sagak.png', group: 'extra', event: 'Ìïú Í∞ú Î¨¥Î£å!' },
      { key: 'hinge', label: 'Ïã±ÌÅ¨Í≤ΩÏ≤©', image: 'https://gi.esmplus.com/irn2011/click/texture/hinge.png', group: 'extra', event: '2Í∞ú Î¨¥Î£å ÏãúÍ≥µ!' }
    ];

    // ============================================================
    // STATE
    // ============================================================
    let currentWood = 'woodType1'; // Í∏∞Î≥∏Í∞í (Ï∂îÌõÑ Ï¥àÍ∏∞Ìôî)
    let currentWidth = 0, currentLength = 0, currentQty = 1;
    let selectedProcs = new Set(); // Î≥µÏàò ÏÑ†ÌÉù ÌÇ§ ÏßëÌï©
    let procDetails = {}; // {angled:{sides:['A','B']}, round:{corners:['1','3']}, ...}
    let lastFocusedOption = null;

    // --- Ï¥àÍ∏∞Ìôî ---
    let orderList = [];
    let lastSubmittedOrders = []; // Ï£ºÎ¨∏ ÏôÑÎ£å ÌõÑ Í≤¨Ï†ÅÏÑú Ï†ÄÏû•ÏùÑ ÏúÑÌïú Î∞±ÏóÖ
    let priceTable = [], openWoodDetail = null;
    let scene, camera, renderer, controls, boardGroup, woodMesh, sceneObjects = [];

    // ============================================================
    // INIT
    // ============================================================
    window.addEventListener('DOMContentLoaded', async () => {
      init3D();
      loadPriceTable();
      showGreeting();
      initSplitter(); // Ïä§ÌîåÎ¶¨ÌÑ∞ Ï¥àÍ∏∞Ìôî
    });

    // ============================================================
    // SPLITTER (RESIZE)
    // ============================================================
    function initSplitter() {
      const splitter = document.getElementById('splitter');
      const chatPanel = document.querySelector('.chat-panel');
      const main = document.querySelector('.main');
      let isDragging = false;

      // Mouse Events (PC)
      splitter.addEventListener('mousedown', (e) => {
        isDragging = true;
        splitter.classList.add('active');
        document.body.style.cursor = window.innerWidth <= 800 ? 'row-resize' : 'col-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const isMobile = window.innerWidth <= 800;
        const mainRect = main.getBoundingClientRect();

        if (isMobile) {
          // Vertical Resize
          let newHeight = e.clientY - mainRect.top;
          if (newHeight < 100) newHeight = 100; // Min height
          if (newHeight > mainRect.height - 100) newHeight = mainRect.height - 100; // Max height
          chatPanel.style.height = newHeight + 'px';
          // Flex basis update might be needed if height doesn't work directly in some flex setups,
          // but with flex-direction column, height should work if flex is handled correctly.
          // However, .chat-panel is flex item.
        } else {
          // Horizontal Resize
          let newWidth = e.clientX - mainRect.left;
          if (newWidth < 300) newWidth = 300;
          if (newWidth > mainRect.width * 0.7) newWidth = mainRect.width * 0.7;
          chatPanel.style.width = newWidth + 'px';
        }
        onWindowResize();
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          splitter.classList.remove('active');
          document.body.style.cursor = '';
          document.body.style.removeProperty('user-select');
          onWindowResize();
        }
      });

      // Touch Events (Mobile)
      splitter.addEventListener('touchstart', (e) => {
        isDragging = true;
        splitter.classList.add('active');
        document.body.style.userSelect = 'none';
      }, { passive: false });

      document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const isMobile = window.innerWidth <= 800;
        const mainRect = main.getBoundingClientRect();
        const touch = e.touches[0];

        if (isMobile) {
          let newHeight = touch.clientY - mainRect.top;
          if (newHeight < 100) newHeight = 100;
          if (newHeight > mainRect.height - 100) newHeight = mainRect.height - 100;
          chatPanel.style.height = newHeight + 'px';
        } else {
          let newWidth = touch.clientX - mainRect.left;
          if (newWidth < 300) newWidth = 300;
          if (newWidth > mainRect.width * 0.7) newWidth = mainRect.width * 0.7;
          chatPanel.style.width = newWidth + 'px';
        }
        onWindowResize();
        if (e.cancelable) e.preventDefault(); // Prevent scrolling
      }, { passive: false });

      document.addEventListener('touchend', () => {
        if (isDragging) {
          isDragging = false;
          splitter.classList.remove('active');
          document.body.style.removeProperty('user-select');
          onWindowResize();
        }
      });
    }

    function toggle3DView() {
      const chatPanel = document.querySelector('.chat-panel');
      const splitter = document.getElementById('splitter');
      const btn = document.getElementById('btnToggle3D');
      const isHidden = chatPanel.style.display === 'none';

      if (isHidden) {
        chatPanel.style.display = '';
        splitter.style.display = '';
        btn.textContent = '‚õ∂'; // Expand icon
      } else {
        chatPanel.style.display = 'none';
        splitter.style.display = 'none';
        btn.textContent = '‚Ü©'; // Restore icon
      }
      onWindowResize();
    }

    async function showGreeting() {
      // 1. Ïù∏ÏÇ¨
      showTyping();
      await new Promise(r => setTimeout(r, 600));
      hideTyping();
      addBotMessage(`<div style="font-size: 1.1em; font-weight: 600; color: #2c3e50;">üëã ÏïàÎÖïÌïòÏÑ∏Ïöî! ÏïÑÏù¥Î¶∞Í∞ÄÍµ¨ AI ÎπÑÏÑúÏûÖÎãàÎã§.</div>`);

      // 2. Í∏∞Îä• ÏÜåÍ∞ú
      showTyping();
      await new Promise(r => setTimeout(r, 1000));
      hideTyping();
      addBotMessage(`ÏõêÌïòÏãúÎäî Î™©Ïû¨Ïùò Ï¢ÖÎ•òÏôÄ ÏÇ¨Ïù¥Ï¶à(Í∞ÄÎ°úxÏÑ∏Î°ú)Î•º ÎßêÏîÄÌï¥Ï£ºÏãúÎ©¥, <br><b>3D ÎØ∏Î¶¨Î≥¥Í∏∞</b>ÏôÄ Ìï®Íªò <b>Ïã§Ï†Ñ Í≤¨Ï†Å</b>ÏùÑ Ï¶âÏãú Í≥ÑÏÇ∞Ìï¥ ÎìúÎ¶¥Í≤åÏöî.`);

      // 3. ÏÇ¨Ïö©Î≤ï ÏïàÎÇ¥
      showTyping();
      await new Promise(r => setTimeout(r, 1000));
      hideTyping();
      addBotMessage(`Î®ºÏ†Ä ÏïÑÎûòÏóêÏÑú ÏõêÌïòÏãúÎäî Î™©Ïû¨Î•º ÏÑ†ÌÉùÌïòÏãúÍ±∞ÎÇò,<br>Ï±ÑÌåÖÏ∞ΩÏóê "MDF 400x600 2Ïû• Ïû¨Îã®Ìï¥Ï§ò"ÏôÄ Í∞ôÏù¥ ÏûÖÎ†•Ìï¥ Î≥¥ÏÑ∏Ïöî!`);

      // 4. Ï∂îÏ≤ú Ï†úÏïà
      showTyping();
      await new Promise(r => setTimeout(r, 1000));
      hideTyping();
      addBotMessage(`ÌòπÏãú Ïñ¥Îñ§ Î™©Ïû¨Î•º ÏÑ†ÌÉùÌï†ÏßÄ Í≥†ÎØºÎêòÏãúÎÇòÏöî?<br><b>ÏÇ¨Ïö©ÌïòÏã§ Ïö©ÎèÑ</b>Î•º ÎßêÏîÄÌï¥ Ï£ºÏãúÎ©¥ Îî± ÎßûÎäî Î™©Ïû¨Î•º Ï∂îÏ≤úÌï¥ ÎìúÎ¶¥Í≤åÏöî.`);

      // 5. Î™©Ïû¨ Ïπ¥Îìú
      setTimeout(showWoodCards, 500);
    }

    // ============================================================
    // PRICE TABLE (ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú)
    // ============================================================
    async function loadPriceTable() {
      try {
        const r = await fetch(PRICE_API_URL);
        priceTable = await r.json();
        updateStatus('Îã®Í∞ÄÌëú Î°úÎìú ÏôÑÎ£å', '');
      } catch (e) {
        console.warn('Îã®Í∞ÄÌëú Î°úÎìú Ïã§Ìå®:', e);
        updateStatus('Îã®Í∞ÄÌëú Î°úÎìú Ïã§Ìå®', '');
      }
    }

    // ÏõêÎ≥∏ getUnitPrice Í∑∏ÎåÄÎ°ú
    function getUnitPrice(woodTypeId, area) {
      if (!priceTable.length || area <= 0) return 0;
      for (const tier of priceTable) {
        if (area <= tier.area) return tier[woodTypeId] || 0;
      }
      return 0;
    }

    // ÏõêÎ≥∏ ÏΩîÌåÖ Í∞ÄÍ≤© Í∑∏ÎåÄÎ°ú
    function getCoatingPrices() {
      const length = currentLength || 0;
      let s = 0;
      if (length <= 600) s = 5000;
      else if (length <= 1200) s = 10000;
      else s = 15000;
      return { single: s, double: s * 2 };
    }

    // ÏõêÎ≥∏ Î∞∞ÏÜ°ÎπÑ Í∑∏ÎåÄÎ°ú
    function getBaseShippingCost(length) {
      if (length <= 600) return 5000;
      if (length <= 1200) return 8000;
      return 10000;
    }
    function calculateShippingCost(orders) {
      if (!orders || !orders.length) return [];
      const hasWood = orders.some(o => o.woodTypeValue);
      if (!hasWood) return [{ cost: 4000, sizeCategory: 'Î∂ÄÏûêÏû¨ Í∏∞Î≥∏ Î∞∞ÏÜ°ÎπÑ', count: 1 }];
      const pieces = [];
      orders.forEach(o => {
        if (o.woodTypeValue) {
          for (let i = 0; i < parseInt(o.quantity); i++) {
            const w = parseFloat(o.width), l = parseFloat(o.length);
            pieces.push({ width: Math.min(w, l), length: Math.max(w, l) });
          }
        }
      });
      if (!pieces.length) return [];
      pieces.sort((a, b) => (b.width * b.length) - (a.width * a.length));
      const packs = [];
      pieces.forEach(p => {
        let packed = false;
        for (const pk of packs) {
          if (pk.pieces.length < 5 && p.width <= pk.base.width && p.length <= pk.base.length) { pk.pieces.push(p); packed = true; break; }
        }
        if (!packed) packs.push({ base: p, pieces: [p] });
      });
      const grouped = {};
      packs.forEach(pk => {
        const cost = getBaseShippingCost(pk.base.length);
        if (!grouped[cost]) grouped[cost] = { cost, sizeCategory: pk.base.length <= 600 ? '600mm Ïù¥Ìïò' : pk.base.length <= 1200 ? '601~1200mm' : '1201~1800mm', count: 0 };
        grouped[cost].count++;
      });
      return Object.values(grouped);
    }

    // ============================================================
    // Í≤¨Ï†Å Í≥ÑÏÇ∞ (ÏõêÎ≥∏ calculate() Î°úÏßÅ Î∞òÏòÅ)
    // ============================================================
    function calculatePrice() {
      if (!currentWood || currentWidth <= 0 || currentLength <= 0) return null;
      const area = currentWidth * currentLength;
      const basePrice = getUnitPrice(currentWood, area);
      if (basePrice === 0 && area > 0) return null;

      let additionalCost = 0;
      let eventDiscount = 0;
      let discountDetails = [];

      selectedProcs.forEach(key => {
        const d = procDetails[key] || {};
        switch (key) {
          case 'sanding':
            additionalCost += 5000;
            eventDiscount += 5000;
            discountDetails.push('ÏÉåÎî© Î¨¥Î£å');
            break;
          case 'coating':
            const cp = getCoatingPrices();
            additionalCost += (d.type === 'ÏñëÎ©¥' ? cp.double : cp.single);
            break;
          case 'angled':
            const aSides = (d.sides || []).length;
            additionalCost += aSides * 1000;
            if (aSides > 0) { eventDiscount += 1000; discountDetails.push('ÏÇ¨ÏÑ† 1Î©¥ Î¨¥Î£å'); }
            break;
          case 'round':
            const rCorners = (d.corners || []).length;
            additionalCost += rCorners * 1000;
            if (rCorners > 0) { eventDiscount += 1000; discountDetails.push('ÎùºÏö¥Îìú 1Í∞ú Î¨¥Î£å'); }
            break;
          case 'circlecut':
            const cCount = d.count || 1;
            additionalCost += cCount * 3000;
            if (cCount > 0) { eventDiscount += 3000; discountDetails.push('ÏõêÌòïÌÉÄÍ≥µ 1Í∞ú Î¨¥Î£å'); }
            break;
          case 'squarecut':
            const sCount = d.count || 1;
            additionalCost += sCount * 4000;
            if (sCount > 0) { eventDiscount += 4000; discountDetails.push('ÏÇ¨Í∞ÅÌÉÄÍ≥µ 1Í∞ú Î¨¥Î£å'); }
            break;
          case 'hinge':
            const hCount = d.count || 2;
            additionalCost += hCount * 1000;
            const hDisc = Math.min(hCount, 2);
            if (hDisc > 0) { eventDiscount += hDisc * 1000; discountDetails.push(`Í≤ΩÏ≤© ${hDisc}Í∞ú Î¨¥Î£å`); }
            break;
        }
      });

      const origPerPiece = basePrice + additionalCost;
      const origTotal = origPerPiece * currentQty;
      const totalDiscount = eventDiscount * currentQty;
      const finalTotal = origTotal - totalDiscount;
      const shipping = calculateShippingFromCurrent(finalTotal);

      return {
        basePrice, additionalCost, origPerPiece, origTotal,
        eventDiscount, totalDiscount, discountDetails,
        finalTotal, shipping,
        grandTotal: finalTotal + shipping
      };
    }

    function calculateShippingFromCurrent(totalPrice) {
      // Í∞ÑÏÜåÌôî: ÌòÑÏû¨ Í≤¨Ï†Å 1Í±¥ Í∏∞Ï§Ä Î∞∞ÏÜ°ÎπÑ
      if (currentLength <= 600) return 5000;
      if (currentLength <= 1200) return 8000;
      return 10000;
    }

    // ============================================================
    // CHAT HELPERS
    // ============================================================
    function addBotMessage(html, isFull = false) {
      const d = document.createElement('div');
      d.className = 'msg bot-msg' + (isFull ? ' full' : '');
      d.innerHTML = html;
      document.getElementById('chatMessages').appendChild(d);
      scrollChat();
    }
    function addUserMessage(text) { const d = document.createElement('div'); d.className = 'msg user-msg'; d.textContent = text; document.getElementById('chatMessages').appendChild(d); scrollChat(); }

    function clearChatAndStartNew() {
      document.getElementById('chatMessages').innerHTML = '';
      resetEstimate();
      showGreeting();
    }
    function scrollChat() { const c = document.getElementById('chatMessages'); setTimeout(() => { c.scrollTop = c.scrollHeight; }, 50); }
    function showTyping() { const d = document.createElement('div'); d.className = 'typing-indicator'; d.id = 'typingIndicator'; d.innerHTML = '<span></span><span></span><span></span>'; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
    function hideTyping() { const e = document.getElementById('typingIndicator'); if (e) e.remove(); }
    function updateStatus(l, r) { document.getElementById('statusLeft').textContent = l || ''; document.getElementById('statusRight').textContent = r || ''; }

    async function postToServer(data) {
      const r = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, body: JSON.stringify(data) });
      return await r.json();
    }

    // ============================================================
    // SEND & PROCESS
    // ============================================================
    function sendMessage() {
      const inp = document.getElementById('chatInput'); const t = inp.value.trim(); if (!t) return;
      inp.value = ''; addUserMessage(t);
      // Î°úÏª¨ Ï≤òÎ¶¨Í∞Ä ÏÑ±Í≥µÌïòÎ©¥ AIÏóêÍ≤å Î≥¥ÎÇ¥ÏßÄ ÏïäÏùå
      if (processInput(t)) return;
      sendToAI(t);
    }

    function processInput(text) {
      const lo = text.toLowerCase().replace(/\s+/g, '');

      // 0) Í∞ÄÍ≤© ÎπÑÍµê ÏöîÏ≤≠ Í∞êÏßÄ (ÏÇ¨Ïù¥Ï¶à + Ï†ÄÎ†¥/Ïãº/ÎπÑÍµê/Ï∂îÏ≤ú ÌÇ§ÏõåÎìú)
      const sizeMatch = text.match(/(\d{2,4})\s*[xX√ó\*]\s*(\d{2,4})/);
      const isPriceQuery = lo.includes('Ï†ÄÎ†¥') || lo.includes('Ïãº') || lo.includes('ÎπÑÍµê') || lo.includes('Í∞ÄÍ≤©') || lo.includes('ÏñºÎßà');
      if (sizeMatch && isPriceQuery) {
        const w = parseInt(sizeMatch[1]), l = parseInt(sizeMatch[2]);
        const qm = text.match(/(\d+)\s*Ïû•/);
        const q = qm ? parseInt(qm[1]) : null;
        compareWoodPrices(w, l, q);
        return true;
      }

      // 1) Î™©Ïû¨ ÏÑ†ÌÉù
      const isConsulting = lo.includes('Ï∂îÏ≤ú') || lo.includes('Ïñ¥Îïå') || lo.includes('Ïñ¥Îñ§') || lo.includes('ÏÉÅÎã¥') || lo.includes('Ï¢ãÏïÑ');
      const aliases = { mdf18T: ['mdf'], pvc18T: ['pvc', 'ÌîºÎ∏åÏù¥Ïî®'], misong18T: ['ÎØ∏ÏÜ°'], pyeonbaek18T: ['Ìé∏Î∞±'], mulbau18T: ['Î©ÄÎ∞îÏö∞'] };
      if (!isConsulting) {
        for (const key of WOOD_KEYS) {
          if (aliases[key].some(a => lo.includes(a))) {
            selectWood(key);
            const sm = text.match(/(\d{2,4})\s*[xX√ó\*]\s*(\d{2,4})/);
            if (sm) {
              const w = parseInt(sm[1]), l = parseInt(sm[2]);
              const qm = text.match(/(\d+)\s*Ïû•/);
              if (qm) {
                setSize(w, l, parseInt(qm[1]));
                parseProcessingsFromText(text);
                if (selectedProcs.size) showEstimate();
              } else {
                setSize(w, l, null); // ÏàòÎüâ ÏóÜÏùå -> setSizeÎ°ú ÎÑòÍ≤®ÏÑú Í≤ΩÍ≥† Ï≤¥ÌÅ¨ ÌõÑ ÏàòÎüâ ÏûÖÎ†• ÏöîÏ≤≠
              }
            }
            return true;
          }
        }
      }

      // 2) ÏÇ¨Ïù¥Ï¶àÎßå Îì§Ïñ¥Ïò® Í≤ΩÏö∞
      const sm = text.match(/(\d{2,4})\s*[xX√ó\*]\s*(\d{2,4})/);
      if (sm && currentWood) {
        const w = parseInt(sm[1]), l = parseInt(sm[2]), qm = text.match(/(\d+)\s*Ïû•/);
        if (qm) {
          setSize(w, l, parseInt(qm[1]));
          parseProcessingsFromText(text);
          if (selectedProcs.size) showEstimate();
        } else {
          setSize(w, l, null); // ÏàòÎüâ ÏóÜÏùå -> setSizeÎ°ú ÎÑòÍ≤®ÏÑú Í≤ΩÍ≥† Ï≤¥ÌÅ¨ ÌõÑ ÏàòÎüâ ÏûÖÎ†• ÏöîÏ≤≠
        }
        return true;
      }

      // 3) ÏàòÎüâ (Ïà´ÏûêÎßå ÏûàÍ±∞ÎÇò 'Ïû•', 'Í∞ú' Îì±Ïù¥ Î∂ôÏùÄ Í≤ΩÏö∞)
      // "2Ïû•Ïù¥Ïöî", "2Í∞ú", "2" Îì± Ï≤òÎ¶¨
      const qo = text.match(/(\d+)\s*(?:Ïû•|Í∞ú|Ïöî|Ïû•Ïù¥Ïöî|Í∞úÏöî)?/);
      // Îã®, Î¨∏Ïû•Ïóê Îã§Î•∏ Ïà´ÏûêÍ∞Ä ÏÑûÏó¨ ÏûàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú ^...$ Î≥¥Îã§Îäî Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Ï≤òÎ¶¨ÌïòÎêò, 
      // ÎßåÏïΩ currentWidth/LengthÍ∞Ä ÏÑ§Ï†ïÎêú ÏÉÅÌÉúÏóêÏÑú Îì§Ïñ¥Ïò® ÏßßÏùÄ Ïà´ÏûêÎùºÎ©¥ ÏàòÎüâÏúºÎ°ú Í∞ÑÏ£º
      if (qo && currentWood && currentWidth > 0 && currentLength > 0 && (text.length < 10 || lo.includes('Ïû•') || lo.includes('Í∞ú'))) {
        currentQty = parseInt(qo[1]);
        addBotMessage(`ÏàòÎüâ: <b>${currentQty}Ïû•</b> ÌôïÏù∏ÌñàÏäµÎãàÎã§.<br>Í∞ÄÍ≥µ ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. (Î≥µÏàò ÏÑ†ÌÉù Í∞ÄÎä•)`);
        showProcessingOptions();
        updateWoodModel();
        updateStatus('Í∞ÄÍ≥µ ÏòµÏÖò ÎåÄÍ∏∞', '');
        return true;
      }

      // 4) ÌÇ§ÏõåÎìú
      // 4) ÌÇ§ÏõåÎìú
      if (lo === 'Ï£ºÎ¨∏' || (lo.includes('Ï£ºÎ¨∏') && orderList.length > 0)) { initiateOrder(); return true; }
      if (lo === 'Ï¥àÍ∏∞Ìôî' || lo === 'Î¶¨ÏÖã') { resetAll(); return true; }
      if (lo === 'Î™©Ïû¨' || lo === 'Ï¢ÖÎ•ò' || lo.includes('Î™©Ïû¨Ï¢ÖÎ•ò')) { showWoodCards(); return true; }

      // 5) Î∂ÄÏûêÏû¨ Î∞è Í∏∞ÌÉÄ Í∏∞Îä• (ÌÜµÌï©Îê®)
      if (lo.includes('Î∂ÄÏûêÏû¨') || lo.includes('ÌîºÏä§') || lo.includes('ÏÇ¨Ìè¨') || lo.includes('Ïó£ÏßÄ') || lo.includes('ÌÖåÏù¥ÌîÑ')) {
        // ÏßàÎ¨∏ ÌòïÌÉú(Î≠êÏïº, Î≠î, Ïñ¥ÎñªÍ≤å, ÏÑ§Î™Ö Îì±)Ïù∏ Í≤ΩÏö∞ Î°úÏª¨ÏóêÏÑú Í∞ÄÎ°úÏ±ÑÏßÄ ÏïäÍ≥† AIÏóêÍ≤å ÎÑòÍπÄ
        const isQuestion = lo.includes('?') || lo.includes('Î≠ê') || lo.includes('Î≠î') || lo.includes('Î¨¥Ïóá') || lo.includes('ÏÑ§Î™Ö') || lo.includes('Ïñ¥ÎñªÍ≤å') || lo.includes('Ïñ¥Îñ§') || lo.includes('ÏùòÎØ∏');
        if (!isQuestion) {
          if (lo.includes('ÌîºÏä§')) showSpecificAccessoryCategory('screws');
          else if (lo.includes('ÏÇ¨Ìè¨')) showSpecificAccessoryCategory('sandpaper');
          else if (lo.includes('Ïó£ÏßÄ') || lo.includes('ÌÖåÏù¥ÌîÑ')) showSpecificAccessoryCategory('tape');
          else showAccessoryCategories();
          return true;
        }
      }
      if (lo.includes('Î∂àÎü¨Ïò§Í∏∞') || lo.includes('Ïù¥Ï†ÑÏ£ºÎ¨∏')) { openLoadModal(); return true; }

      return false;
    }

    function parseProcessingsFromText(text) {
      const lo = text.toLowerCase();
      if (lo.includes('ÏÇ¨ÏÑ†') || lo.includes('Í∫ΩÍ∏∞')) {
        selectedProcs.add('angled');
        const sides = [];
        if (/[aAÍ∞Ä]/.test(text)) sides.push('A'); if (/[bBÎÇò]/.test(text)) sides.push('B');
        if (/[cCÎã§]/.test(text)) sides.push('C'); if (/[dDÎùº]/.test(text)) sides.push('D');
        procDetails.angled = { sides: sides.length ? sides : ['A'] };
      }
      if (lo.includes('ÎùºÏö¥Îìú') || lo.includes('Îë•Í∏Ä')) {
        selectedProcs.add('round'); procDetails.round = { corners: ['1'] };
      }
      if (lo.includes('ÏõêÌòï') || lo.includes('ÏõêÏª∑')) { selectedProcs.add('circlecut'); procDetails.circlecut = { count: 1 }; }
      if (lo.includes('ÏÇ¨Í∞ÅÏª∑') || lo.includes('ÏÇ¨Í∞ÅÌôÄ')) { selectedProcs.add('squarecut'); procDetails.squarecut = { count: 1 }; }
      if (lo.includes('Í≤ΩÏ≤©')) { const hm = text.match(/(\d+)\s*Í∞ú/); selectedProcs.add('hinge'); procDetails.hinge = { count: hm ? parseInt(hm[1]) : 2 }; }
      if (lo.includes('ÏΩîÌåÖ') && lo.includes('Ïñë')) { selectedProcs.add('coating'); procDetails.coating = { type: 'ÏñëÎ©¥' }; }
      else if (lo.includes('ÏΩîÌåÖ')) { selectedProcs.add('coating'); procDetails.coating = { type: 'Îã®Î©¥' }; }
      if (lo.includes('ÏÇ¨Ìè¨') || lo.includes('ÏÉåÎî©')) { selectedProcs.add('sanding'); procDetails.sanding = {}; }

      if (selectedProcs.size) {
        addBotMessage('Í∞ÄÍ≥µ: <b>' + getProcSummary() + '</b>');
        updateWoodModel();
      }
    }

    function getProcSummary() {
      if (!selectedProcs.size) return 'Í∞ÄÍ≥µÏóÜÏùå';
      return Array.from(selectedProcs).map(key => {
        const opt = PROC_OPTIONS.find(o => o.key === key);
        let label = opt ? opt.label : key;
        const d = procDetails[key] || {};
        if (key === 'angled' && d.sides) label += '(' + d.sides.join(',') + ')';
        if (key === 'round' && d.corners) label += '(' + d.corners.join(',') + ')';
        if (key === 'hinge' && d.count) label += '(' + d.count + 'Í∞ú)';
        if (key === 'coating' && d.type) label += '(' + d.type + ')';
        if (key === 'circlecut') {
          if (d.holes && d.holes.length > 0) {
            const hStr = d.holes.map((h, idx) => `[${idx + 1}]X:${h.x},Y:${h.y},R:${h.r}`).join(' ');
            label += ` (${hStr})`;
          } else if (d.count) {
            label += '(' + d.count + 'Í∞ú)';
          }
        }
        if (key === 'squarecut') {
          if (d.holes && d.holes.length > 0) {
            const hStr = d.holes.map((h, idx) => `[${idx + 1}]X:${h.x},Y:${h.y},W:${h.w},H:${h.h}`).join(' ');
            label += ` (${hStr})`;
          } else if (d.count) {
            label += '(' + d.count + 'Í∞ú)';
          }
        }
        return label;
      }).join(' + ');
    }

    // ============================================================
    // AI
    // ============================================================
    async function sendToAI(text) {
      showTyping(); updateStatus('AI ÏùëÎãµ ÎåÄÍ∏∞ Ï§ë...', '');
      try {
        const resp = await postToServer({ type: 'chat', cid: SESSION_ID, message: text });
        hideTyping();
        if (resp.result === 'error') { addBotMessage('Ï£ÑÏÜ°Ìï©ÎãàÎã§. Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'); updateStatus('Ïò§Î•ò', ''); return; }

        // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Î≥¥Ï†ï (resp ÏûêÏ≤¥Ïóê reply/actionÏù¥ ÏûàÍ±∞ÎÇò resp.dataÏóê ÏûàÎäî Í≤ΩÏö∞ Î™®Îëê ÎåÄÏùë)
        const d = (resp.reply || resp.action) ? resp : (resp.data || resp);
        addBotMessage(d.reply || d.message || d.text || 'ÏùëÎãµÏùÑ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');

        // show_processing: Î™©Ïû¨+ÏÇ¨Ïù¥Ï¶à+ÏàòÎüâÏù¥ Î™®Îëê ÌôïÏ†ï ‚Üí Ï∂îÍ∞ÄÍ∞ÄÍ≥µ ÏòµÏÖò Î≤ÑÌäº ÌëúÏãú
        if (d.action === 'show_processing' && d.data) {
          if (d.data.woodType) currentWood = d.data.woodType;
          if (d.data.width) currentWidth = Number(d.data.width);
          if (d.data.length) currentLength = Number(d.data.length);
          if (d.data.qty) currentQty = Number(d.data.qty);
          selectedProcs.clear(); procDetails = {};
          updateWoodModel();
          showProcessingOptions();
          const wd = WOOD_DATA[currentWood];
          updateStatus(wd ? wd.name + ' ÏÑ†ÌÉùÎê®' : 'Î™©Ïû¨ ÏÑ†ÌÉùÎê®', 'Í∞ÄÍ≥µ ÏòµÏÖò ÏÑ†ÌÉù ÎåÄÍ∏∞');
        }

        // estimate: Ïù¥Ï†Ñ Ìò∏ÌôòÏö© (ÌòπÏãú estimateÍ∞Ä Ïò§Î©¥ Í≤¨Ï†Å ÌëúÏãú)
        if (d.action === 'estimate' && d.data) {
          if (d.data.woodType) currentWood = d.data.woodType;
          if (d.data.width) currentWidth = Number(d.data.width);
          if (d.data.length) currentLength = Number(d.data.length);
          if (d.data.qty) currentQty = Number(d.data.qty);
          updateWoodModel(); showEstimate();
        }

        if (d.action === 'show_woods') showWoodCards();
        if (!['show_processing', 'estimate', 'show_woods'].includes(d.action)) updateStatus('ÎåÄÍ∏∞ Ï§ë', '');
      } catch (e) { hideTyping(); addBotMessage('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÏûÖÎãàÎã§.'); updateStatus('Ïó∞Í≤∞ Ïò§Î•ò', ''); console.error(e); }
    }

    // ============================================================
    // WOOD SELECTION (ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
    // ============================================================
    function showWoodCards() {
      let h = '<div class="wood-btn-list">';
      WOOD_KEYS.forEach(key => {
        const wd = WOOD_DATA[key];
        h += `<div class="wood-card-item">
        <img class="wood-thumb" src="${wd.image}" alt="${wd.name}" onerror="this.style.display='none'">
        <div class="wood-label">
          <div class="wname">${wd.name}</div>
          <div class="wdesc">${wd.desc}</div>
        </div>
        <div class="wood-btn-group">
          <button class="wood-btn-select" onclick="selectWoodFromCard('${key}')">ÏÑ†ÌÉù</button>
          <button class="wood-btn-desc" onclick="showWoodExplanation('${key}')">ÏÑ§Î™Ö</button>
        </div>
      </div>`;
      });
      h += '</div>';
      addBotMessage(h);
    }

    function showWoodExplanation(key) {
      const wd = WOOD_DATA[key];
      const ytUrl = WOOD_YOUTUBE[key] || '';
      if (!wd) return;

      // YouTube Ïç∏ÎÑ§Ïùº + ÌÅ¥Î¶≠ÌïòÎ©¥ ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Í∏∞ (file:// ÌôòÍ≤ΩÏóêÏÑú iframe Error 153 Î∞©ÏßÄ)
      let videoHtml = '';
      if (ytUrl) {
        let videoId = '';
        const shortMatch = ytUrl.match(/youtu\.be\/([\w-]+)/);
        const longMatch = ytUrl.match(/[?&]v=([\w-]+)/);
        videoId = shortMatch ? shortMatch[1] : (longMatch ? longMatch[1] : '');
        if (videoId) {
          const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
          videoHtml = `
            <div onclick="openVideoModal('${embedUrl}', '${wd.name} ÏÑ§Î™Ö ÏòÅÏÉÅ');return false;" style="display:block;position:relative;border-radius:12px;overflow:hidden;margin-top:12px;cursor:pointer;text-decoration:none;">
              <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" style="width:100%;display:block;border-radius:12px;">
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:42px;background:rgba(255,0,0,0.85);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                <div style="width:0;height:0;border-style:solid;border-width:10px 0 10px 18px;border-color:transparent transparent transparent #fff;margin-left:3px;"></div>
              </div>
              <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.7);color:#fff;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;">‚ñ∂ ÏòÅÏÉÅ Î≥¥Í∏∞ (ÌåùÏóÖ)</div>
            </div>`;
        }
      }

      const descriptions = {
        mdf18T: 'MDF 18TÎäî Í∞ÄÏÑ±ÎπÑÍ∞Ä Ï†ïÎßê Ï¢ãÏùÄ ÏÜåÏû¨ÏòàÏöî üòä\n\nÎ™©Ïû¨ ÏÑ¨Ïú†Î•º ÏïïÏ∂ïÌï¥ÏÑú ÎßåÎì§Ïñ¥ÏÑú ÌëúÎ©¥Ïù¥ ÏïÑÏ£º Îß§ÎÅÑÎüΩÎãµÎãàÎã§. ÎçïÎ∂ÑÏóê ÌéòÏù∏Ìä∏ Ïπ†ÌïòÍ∏∞ÏóêÎèÑ Ï¢ãÍ≥†, ÏÑ†Î∞òÏù¥ÎÇò ÏàòÎÇ©Ïû• ÎßåÎì§ Îïå Í∞ÄÏû• ÎßéÏù¥ Ïì∞Ïó¨Ïöî.',
        pvc18T: 'PVCÎ≥¥ÎìúÎäî ÏôÑÏ†Ñ Î∞©ÏàòÍ∞Ä ÌäπÏßïÏù¥ÏóêÏöî! üöø\n\nÎ¨ºÏù¥ ÎãøÏïÑÎèÑ Ïç©ÏßÄ ÏïäÏïÑÏÑú ÏöïÏã§Ïù¥ÎÇò Ï£ºÎ∞© Ïã±ÌÅ¨ÎåÄ Ï£ºÎ≥ÄÏóê Ïì∞Í∏∞ Îî± Ï¢ãÎãµÎãàÎã§. PET ÏΩîÌåÖÏù¥ ÎêòÏñ¥ ÏûàÏñ¥ÏÑú ÍπîÎÅîÌïòÍ≥† ÏÑ∏ÌÉÅÏã§Ïù¥ÎÇò Î∞úÏΩîÎãàÏö©ÏúºÎ°úÎèÑ Ïù∏Í∏∞Í∞Ä ÎßéÏïÑÏöî.',
        misong18T: 'ÎØ∏ÏÜ°ÏßëÏÑ±Î™©ÏùÄ ÎÇòÎ¨¥ Î≥∏Ïó∞Ïùò Îî∞ÎúªÌïú ÎäêÎÇåÏùÑ Ïûò ÏÇ¥Î†§Ï§òÏöî üå≤\n\nÍ≤∞Ïù¥ Î∂ÄÎìúÎü¨ÏõåÏÑú DIY ÌïòÏãúÎäî Î∂ÑÎì§Ïù¥ Í∞ÄÏû• ÏÑ†Ìò∏ÌïòÏãúÎäî ÏõêÎ™© Ï§ë ÌïòÎÇòÏ£†. ÏÉåÎî©Ïù¥Îûë ÏΩîÌåÖÏùÑ Í±∞ÏπòÎ©¥ Ìõ®Ïî¨ Îçî Í≥†Í∏âÏä§Îü¨Ïö¥ ÎäêÎÇåÏù¥ ÎÇúÎãµÎãàÎã§.',
        pyeonbaek18T: 'Ìé∏Î∞±ÏßëÏÑ±Î™©ÏùÄ Ìñ•Í∏∞Î∂ÄÌÑ∞ Îã¨ÎùºÏöî! üåø\n\nÎ™∏Ïóê Ï¢ãÏùÄ ÌîºÌÜ§ÏπòÎìúÍ∞Ä ÎÇòÏôÄÏÑú ÏïÑÏù¥Îì§ Î∞©Ïù¥ÎÇò Ïπ®Ïã§ Í∞ÄÍµ¨Ïóê Ï†ïÎßê Ï∂îÏ≤úÎìúÎ†§Ïöî. Ìï≠Í∑† Ìö®Í≥ºÎèÑ ÏûàÏñ¥ÏÑú Í±¥Í∞ïÍπåÏßÄ ÏÉùÍ∞ÅÌïú ÌîÑÎ¶¨ÎØ∏ÏóÑ ÏõêÎ™©Ïù¥ÎûçÎãàÎã§.',
        mulbau18T: 'Î©ÄÎ∞îÏö∞Îäî ÏïÑÏ£º Îã®Îã®ÌïòÍ≥† Î¨µÏßÅÌïú ÌïòÎìúÏö∞ÎìúÏòàÏöî üí™\n\nÌäπÏú†Ïùò ÏßôÏùÄ ÏÉâÍ∞êÏù¥ Ï†ïÎßê Í≥†Í∏âÏä§ÎüΩÏ£†. ÎÇ¥Íµ¨ÏÑ±Ïù¥ ÏõåÎÇô Ï¢ãÏïÑÏÑú Î¨¥Í±∞Ïö¥ Í±∏ Ïò¨Î¶¨Îäî ÌÖåÏù¥Î∏î ÏÉÅÌåêÏù¥ÎÇò Í≥†ÌíçÏä§Îü¨Ïö¥ Ïù∏ÌÖåÎ¶¨Ïñ¥Ïóê ÎßéÏù¥ ÏÇ¨Ïö©ÎèºÏöî.'
      };

      const detailText = (descriptions[key] || wd.desc).replace(/\n/g, '<br>');

      // ÌÉÄÏù¥Ìïë Ìö®Í≥º: Ïû†Ïãú ÌÉÄÏù¥Ìïë ÌëúÏãú ÌõÑ Î©îÏãúÏßÄÎ•º Î≥¥Ïó¨Ï§å
      showTyping();
      setTimeout(() => {
        hideTyping();
        addBotMessage(`
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <img src="${wd.image}" style="width:36px; height:36px; border-radius:8px; object-fit:cover; border:1px solid #eee;">
            <b style="color:#2c3e50; font-size:14px;">${wd.name}</b>
          </div>
          <div style="font-size:13px; line-height:1.7; color:#333;">${detailText}</div>
          <div style="display:flex; gap:6px; font-size:11px; color:#666; margin-top:10px; flex-wrap:wrap;">
            <span style="background:#f0f7ff; color:#3498db; padding:3px 8px; border-radius:12px; font-weight:600;">ÎëêÍªò ${wd.thickness}mm</span>
            <span style="background:#f8f9fa; padding:3px 8px; border-radius:12px;">ÏÉåÎî© ${wd.canSand ? 'Í∞ÄÎä• ‚úÖ' : 'Î∂àÍ∞Ä ‚ùå'}</span>
            <span style="background:#f8f9fa; padding:3px 8px; border-radius:12px;">ÏΩîÌåÖ ${wd.canCoat ? 'Í∞ÄÎä• ‚úÖ' : 'Î∂àÍ∞Ä ‚ùå'}</span>
          </div>
          ${videoHtml}
          <div class="quick-buttons" style="margin-top:12px;">
            <span class="quick-btn" style="background:#2ecc71; color:#fff; border-color:#2ecc71; font-weight:700;" onclick="selectWoodFromCard('${key}')">‚úì Ïù¥ Î™©Ïû¨Î°ú ÏÑ†ÌÉùÌï†Í≤åÏöî</span>
            <span class="quick-btn" onclick="showWoodCards()">Îã§Î•∏ Î™©Ïû¨ ÎçîÎ≥¥Í∏∞</span>
          </div>
        `);
      }, 800);
    }

    function selectWoodFromCard(key) {
      const c = document.getElementById('woodDetail_' + key); if (c) c.innerHTML = ''; openWoodDetail = null;
      selectWood(key);
    }

    function selectWood(key) {
      currentWood = key; currentWidth = 0; currentLength = 0; currentQty = 1;
      selectedProcs.clear(); procDetails = {};
      const wd = WOOD_DATA[key];
      addBotMessage(`<b>${wd.name}</b> ÏÑ†ÌÉù!<br>ÏÇ¨Ïù¥Ï¶àÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (Í∞ÄÎ°úxÏÑ∏Î°ú mm)<br>(ex: 400x1000 ÏÇ¨Ïù¥Ï¶à)`);
      updateWoodModel();
      updateStatus(wd.name + ' ÏÑ†ÌÉùÎê®', 'ÏÇ¨Ïù¥Ï¶à ÏûÖÎ†• ÎåÄÍ∏∞');
    }

    // ============================================================
    // SIZE
    // ============================================================
    // ============================================================
    // SIZE
    // ============================================================
    const LAMINATED_WOODS = ['misong18T', 'pyeonbaek18T', 'mulbau18T'];

    function setSize(w, l, qty) {
      if (w > 600) { addBotMessage('Ìè≠ÏùÄ ÏµúÎåÄ <b>600mm</b>ÍπåÏßÄ Í∞ÄÎä•Ìï©ÎãàÎã§.'); return; }
      if (l > 1800) { addBotMessage('Í∏∏Ïù¥Îäî ÏµúÎåÄ <b>1800mm</b>ÍπåÏßÄ Í∞ÄÎä•Ìï©ÎãàÎã§.'); return; }
      if (w < 10 || l < 10) { addBotMessage('ÏµúÏÜå ÏÇ¨Ïù¥Ï¶àÎäî <b>10mm</b>ÏûÖÎãàÎã§.'); return; }

      // ÏßëÏÑ±Î™© ÎÇòÎ≠áÍ≤∞ Î∞©Ìñ• Í≤ΩÍ≥† (Ìè≠ > Í∏∏Ïù¥)
      if (LAMINATED_WOODS.includes(currentWood) && w > l) {
        addBotMessage(`
          <div style="border:2px solid #e74c3c; padding:15px; border-radius:12px; background:#fff5f5; margin-bottom:10px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
               <span style="font-size:24px;">‚ö†Ô∏è</span>
               <b style="color:#c0392b; font-size:16px;">ÌååÏÜê Ï£ºÏùò ÏïàÎÇ¥</b>
            </div>
            Í≥†Í∞ùÎãò, ÏûÖÎ†•ÌïòÏã† ÏÇ¨Ïù¥Ï¶à(<b>${w} x ${l}mm</b>)Îäî <span style="color:#e74c3c;font-weight:bold;">Ìè≠Ïù¥ Í∏∏Ïù¥Î≥¥Îã§ ÎÑìÏäµÎãàÎã§.</span><br><br>
            ÏÑ†ÌÉùÌïòÏã† ÏßëÏÑ±Î™©(ÎØ∏ÏÜ°, Ìé∏Î∞±, Î©ÄÎ∞îÏö∞)ÏùÄ ÎÇòÎ≠áÍ≤∞ Î∞©Ìñ•Ïù¥ ÏûàÏñ¥, Ïù¥ÎåÄÎ°ú Ï†úÏûë Ïãú <b>Í≤∞ÎåÄÎ°ú Ï™ºÍ∞úÏßÄÍ±∞ÎÇò Î∞∞ÏÜ° Ï§ë ÌååÏÜêÎê† ÏúÑÌóò</b>Ïù¥ Îß§Ïö∞ ÎÜíÏäµÎãàÎã§.<br>
            (‚Äª MDF, PVCÎäî Ìï¥ÎãπÎêòÏßÄ ÏïäÏùå)<br><br>
            <img src="./wood_grain_warning.png" style="width:100%; max-width:400px; border-radius:8px; display:block; margin:0 auto 10px auto; border:1px solid #ddd;">
            ÌòπÏãú <b>${l} x ${w}mm</b> (ÎÇòÎ≠áÍ≤∞ Í∏∏Ïù¥ Î∞©Ìñ•)ÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?
            <div class="quick-buttons" style="margin-top:15px; justify-content:center;">
               <span class="quick-btn" style="background:#27ae60; color:#fff;" onclick="applySize(${l}, ${w}, ${qty})">üîÑ ${l}x${w}Î°ú Î≥ÄÍ≤Ω (Í∂åÏû•)</span>
               <span class="quick-btn" style="background:#e74c3c; color:white; border-color:#c0392b;" onclick="applySize(${w}, ${l}, ${qty})">‚ö†Ô∏è ÏïÑÎãàÏöî, Ïù¥ÎåÄÎ°ú ÏßÑÌñâ (ÌååÏÜêÍ∞êÏàò)</span>
            </div>
          </div>
        `);
        return;
      }

      applySize(w, l, qty);
    }

    function applySize(w, l, qty) {
      currentWidth = w; currentLength = l;

      if (qty) {
        currentQty = qty;
        let msg = `ÏÇ¨Ïù¥Ï¶à: <b>${w} √ó ${l}mm</b>, ÏàòÎüâ: <b>${currentQty}Ïû•</b><br>`;
        if (LAMINATED_WOODS.includes(currentWood) && w > l) {
          msg += `<span style="color:#e74c3c; font-size:12px;">(‚Äª ÌååÏÜê ÏúÑÌóò Í∞êÏàòÌïòÍ≥† ÏßÑÌñâ)</span><br>`;
        }
        msg += `Í∞ÄÍ≥µ ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. (Î≥µÏàò ÏÑ†ÌÉù Í∞ÄÎä•)`;
        addBotMessage(msg);
        showProcessingOptions();
        updateWoodModel();
        updateStatus('Í∞ÄÍ≥µ ÏòµÏÖò ÎåÄÍ∏∞', '');
      } else {
        // ÏàòÎüâÏù¥ ÏóÜÏúºÎ©¥ ÏàòÎüâ ÏûÖÎ†• ÏöîÏ≤≠
        addBotMessage(`ÏÇ¨Ïù¥Ï¶à: <b>${w} √ó ${l}mm</b> ÏÑ†ÌÉù!<br>ÏàòÎüâÏùÄ Î™á Ïû•Ïù¥ ÌïÑÏöîÌïòÏã†Í∞ÄÏöî?`);
        updateWoodModel();
        updateStatus('ÏàòÎüâ ÏûÖÎ†• ÎåÄÍ∏∞', '');
      }
    }

    // ============================================================
    // PROCESSING OPTIONS (Î≥µÏàò ÏÑ†ÌÉù, ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ)
    // ============================================================
    function showProcessingOptions() {
      const wd = WOOD_DATA[currentWood] || {};
      let h = '<div class="proc-grid">';
      PROC_OPTIONS.forEach(p => {
        const isActive = selectedProcs.has(p.key) || (p.key === 'none' && !selectedProcs.size);
        let disabled = false;
        if (p.key === 'sanding' && !wd.canSand) disabled = true;
        if (p.key === 'coating' && !wd.canCoat) disabled = true;
        if (p.key === 'sanding' && selectedProcs.has('coating')) disabled = true;

        h += `<div class="proc-item${isActive ? ' selected' : ''}${disabled ? ' disabled' : ''}" onclick="toggleProc('${p.key}')" id="procItem_${p.key}">
      <img src="${p.image}" alt="${p.label}">
      <div>${p.label}</div>
      ${p.event ? '<div class="event-tag">' + p.event + '</div>' : ''}
    </div>`;
      });
      h += '</div>';
      h += '<div id="procSubArea"></div>';
      h += '<div style="margin-top:8px;"><span class="quick-btn" onclick="confirmProc()" style="background:#2ecc71;color:#fff;border-color:#2ecc71;">‚úì Í∞ÄÍ≥µ ÌôïÏ†ï ‚Üí Í≤¨Ï†Å Î≥¥Í∏∞</span></div>';
      addBotMessage(h);
      renderProcSub(); // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∞ÄÍ≥µÎì§Ïùò ÏÉÅÏÑ∏ ÏÑ§Ï†ï ÌëúÏãú
    }

    function toggleProc(key) {
      const wd = WOOD_DATA[currentWood] || {};

      if (key === 'none') {
        selectedProcs.clear(); procDetails = {};
      } else {
        selectedProcs.delete('none');// none Ìï¥Ï†ú

        // coating ÏÑ†ÌÉù Ïãú sanding ÏûêÎèô Ìï¥Ï†ú
        if (key === 'coating' && !selectedProcs.has('coating')) {
          if (selectedProcs.has('sanding')) { selectedProcs.delete('sanding'); delete procDetails.sanding; }
        }
        // Ï†úÏïΩ Ï≤¥ÌÅ¨
        if (key === 'sanding' && (!wd.canSand || selectedProcs.has('coating'))) return;
        if (key === 'coating' && !wd.canCoat) return;

        if (selectedProcs.has(key)) {
          selectedProcs.delete(key); delete procDetails[key];
          if (lastFocusedOption === key) lastFocusedOption = null;
        } else {
          selectedProcs.add(key);
          lastFocusedOption = key;
          // Í∏∞Î≥∏Í∞í
          if (key === 'angled') procDetails.angled = { sides: [] };
          if (key === 'round') procDetails.round = { corners: [] };
          if (key === 'coating') procDetails.coating = { type: 'Îã®Î©¥' };
          if (key === 'circlecut') procDetails.circlecut = { count: 1, holes: [{ x: 50, y: 50, r: 20 }] };
          if (key === 'squarecut') procDetails.squarecut = { count: 1, holes: [{ x: 50, y: 50, w: 50, h: 50 }] };
          if (key === 'hinge') procDetails.hinge = { count: 2, mode: 'Y_INPUT', positions: [{ x: 23, y: '' }, { x: 23, y: '' }] };
          if (key === 'sanding') procDetails.sanding = {};
        }
        if (!selectedProcs.size) { selectedProcs.clear(); }// ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÏúºÎ©¥ none ÏÉÅÌÉú
      }

      // UI ÏóÖÎç∞Ïù¥Ìä∏
      PROC_OPTIONS.forEach(p => {
        const el = document.getElementById('procItem_' + p.key);
        if (!el) return;
        const isActive = selectedProcs.has(p.key) || (p.key === 'none' && !selectedProcs.size);
        el.classList.toggle('selected', isActive);
        // disable Î°úÏßÅ
        let dis = false;
        if (p.key === 'sanding' && (!wd.canSand || selectedProcs.has('coating'))) dis = true;
        if (p.key === 'coating' && !wd.canCoat) dis = true;
        el.classList.toggle('disabled', dis);
      });

      renderProcSub();
      updateWoodModel();
    }

    function renderProcSub() {
      const area = document.getElementById('procSubArea');
      if (!area) return;
      let h = '';

      if (selectedProcs.has('coating')) {
        const d = procDetails.coating || { type: 'Îã®Î©¥' };
        const cp = getCoatingPrices();
        h += `<div class="proc-sub"><div class="sub-title">ÏΩîÌåÖ Î∞©Ïãù</div>
      <select onchange="procDetails.coating.type=this.value;renderProcSub();updateWoodModel();">
        <option value="Îã®Î©¥" ${d.type === 'Îã®Î©¥' ? 'selected' : ''}>Îã®Î©¥ ÏΩîÌåÖ (+${cp.single.toLocaleString()}Ïõê)</option>
        <option value="ÏñëÎ©¥" ${d.type === 'ÏñëÎ©¥' ? 'selected' : ''}>ÏñëÎ©¥ ÏΩîÌåÖ (+${cp.double.toLocaleString()}Ïõê)</option>
      </select>
      ${d.type === 'Îã®Î©¥' ? `<div style="margin-top:8px; padding:8px; background:#fff0f0; border-radius:4px; font-size:11px; color:#d9534f; line-height:1.4;">
        ‚ö†Ô∏è <strong>Îã®Î©¥ ÏΩîÌåÖ Ïãú</strong> ÎèÑÎ£åÏùò ÏàòÏ∂ïÎ†•ÏúºÎ°ú Ïù∏Ìï¥ Ìú®Ïù¥ ÏÉùÍπÅÎãàÎã§. Ï†úÌíà ÏàòÎ†π ÌõÑ Ï¶âÏãú Í≥†Ï†ï ÏÑ§ÏπòÎ•º Í∂åÏû•ÎìúÎ¶ΩÎãàÎã§.
      </div>` : ''}
      </div>`;
      }

      if (selectedProcs.has('angled')) {
        const d = procDetails.angled || { sides: [] };
        h += `<div class="proc-sub"><div class="sub-title">ÏÇ¨ÏÑ†Í∞ÄÍ≥µ Î©¥ ÏÑ†ÌÉù (Î≥µÏàò Í∞ÄÎä•, Ï∂îÍ∞ÄÎ©¥ +1,000Ïõê)</div>
      <div class="side-grid">
        ${['A(Ï¢åÏ∏°)', 'B(ÏÉÅÎã®)', 'C(Ïö∞Ï∏°)', 'D(ÌïòÎã®)'].map((label, i) => {
          const val = ['A', 'B', 'C', 'D'][i];
          return `<div class="side-item${d.sides.includes(val) ? ' active' : ''}" onclick="toggleAngledSide('${val}')">${label}</div>`;
        }).join('')}
      </div></div>`;
      }

      if (selectedProcs.has('round')) {
        const d = procDetails.round || { corners: [] };
        h += `<div class="proc-sub"><div class="sub-title">ÎùºÏö¥Îìú Î™®ÏÑúÎ¶¨ ÏÑ†ÌÉù (Î≥µÏàò Í∞ÄÎä•, Ï∂îÍ∞ÄÎ™®ÏÑúÎ¶¨ +1,000Ïõê)</div>
      <div class="side-grid">
        ${['1(Ï¢åÏÉÅ)', '2(Ï¢åÌïò)', '3(Ïö∞ÏÉÅ)', '4(Ïö∞Ìïò)'].map((label, i) => {
          const val = String(i + 1);
          return `<div class="side-item${d.corners.includes(val) ? ' active' : ''}" onclick="toggleRoundCorner('${val}')">${label}</div>`;
        }).join('')}
      </div></div>`;
      }

      if (selectedProcs.has('hinge')) {
        const d = procDetails.hinge || { count: 2, mode: 'Y_INPUT', positions: [] };
        if (!d.mode) d.mode = 'Y_INPUT';
        if (!d.positions) d.positions = [];
        while (d.positions.length < d.count) {
          if (d.mode === 'Y_INPUT') d.positions.push({ x: 23, y: '' });
          else d.positions.push({ x: '', y: 23 });
        }
        while (d.positions.length > d.count) d.positions.pop();

        let tableRows = '';
        d.positions.forEach((p, i) => {
          if (d.mode === 'Y_INPUT') {
            tableRows += `<tr>
            <td style="padding:4px;">${i + 1}</td>
            <td>23 mm (Í≥†Ï†ï)</td>
            <td><input type="number" value="${p.y}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateHingeData(${i},'y',this.value)" placeholder="Y Ï¢åÌëú"></td>
            </tr>`;
          } else {
            tableRows += `<tr>
            <td style="padding:4px;">${i + 1}</td>
            <td><input type="number" value="${p.x}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateHingeData(${i},'x',this.value)" placeholder="X Ï¢åÌëú"></td>
            <td>23 mm (Í≥†Ï†ï)</td>
            </tr>`;
          }
        });

        h += `<div class="proc-sub"><div class="sub-title">Ïã±ÌÅ¨Í≤ΩÏ≤© (2Í∞úÍπåÏßÄ Î¨¥Î£å, Ï∂îÍ∞Ä +1,000Ïõê/Í∞ú)<br><span style="font-weight:normal;color:#666;">‚ÄªÍ∏∞Ï§ÄÏ†ê: Ï¢åÏ∏°ÏÉÅÎã® (mm)</span></div>
      <div style="margin-bottom:8px; text-align:center;">
        <img src="https://gi.esmplus.com/irn2011/click/texture/detail_hinge.png" alt="Ïã±ÌÅ¨Í≤ΩÏ≤© Í∞ÄÏù¥Îìú" style="max-width:100%; border-radius:4px; border:1px solid #eee;">
      </div>
      <p style="font-size:11px; color:#555; margin:4px 0;">üí° Ï¢åÌëúÎ•º ÎπÑÏõåÎëêÏãúÎ©¥, Î™©ÏàòÍ∞Ä Î™©Ïû¨ ÏÇ¨Ïù¥Ï¶àÏóê ÎßûÏ∂∞ Í∑†Îì±ÌïòÍ≤å Í∞ÄÍ≥µÌï¥ ÎìúÎ¶ΩÎãàÎã§.</p>
      <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
        <span>Í∞úÏàò:</span>
        <input type="number" value="${d.count}" min="1" max="10" style="width:60px;" onchange="updateHingeCount(this.value)">
        <button type="button" onclick="toggleHingeMode()" style="padding:4px 10px; font-size:11px; border:1px solid #ccc; border-radius:4px; cursor:pointer; background:#f0f0f0;">X/Y Ï∂ï Î≥ÄÍ≤Ω</button>
      </div>
      <table style="width:100%; font-size:11px; text-align:center; border-collapse:collapse;">
        <thead><tr style="background:#eee;"><th style="padding:4px;">No</th><th>X Ï¢åÌëú</th><th>Y Ï¢åÌëú</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table></div>`;
      }

      if (selectedProcs.has('circlecut')) {
        const d = procDetails.circlecut || { count: 1, holes: [{ x: 50, y: 50, r: 20 }] };
        if (!d.holes) d.holes = [];
        // Î∞∞Ïó¥ ÌÅ¨Í∏∞ ÎßûÏ∂§
        while (d.holes.length < d.count) d.holes.push({ x: 50, y: 50, r: 20 });
        while (d.holes.length > d.count) d.holes.pop();

        let tableRows = '';
        d.holes.forEach((hole, i) => {
          tableRows += `<tr>
          <td style="padding:4px;">${i + 1}</td>
          <td><input type="number" value="${hole.x}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateCircleCutData(${i},'x',this.value)"></td>
          <td><input type="number" value="${hole.y}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateCircleCutData(${i},'y',this.value)"></td>
          <td><input type="number" value="${hole.r}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateCircleCutData(${i},'r',this.value)"></td>
        </tr>`;
        });

        h += `<div class="proc-sub"><div class="sub-title">ÏõêÌòïÌÉÄÍ≥µ (Í∞úÎãπ 3,000Ïõê, 1Í∞ú Î¨¥Î£å)<br><span style="font-weight:normal;color:#666;">‚ÄªÍ∏∞Ï§ÄÏ†ê: Ï¢åÏ∏°ÏÉÅÎã® (mm)</span></div>
      <div style="margin-bottom:8px; text-align:center;">
        <img src="https://gi.esmplus.com/irn2011/click/texture/detail_circle.png" alt="ÏõêÌòïÌÉÄÍ≥µ Í∞ÄÏù¥Îìú" style="max-width:100%; border-radius:4px; border:1px solid #eee;">
      </div>
      <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
        <span>Í∞úÏàò:</span>
        <input type="number" value="${d.count}" min="1" max="10" style="width:60px;" onchange="updateCircleCutCount(this.value)">
      </div>
      <table style="width:100%; font-size:11px; text-align:center; border-collapse:collapse;">
        <thead><tr style="background:#eee;"><th style="padding:4px;">No</th><th>X(Í∞ÄÎ°ú)</th><th>Y(ÏÑ∏Î°ú)</th><th>R(Î∞òÏßÄÎ¶Ñ)</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table></div>`;
      }

      if (selectedProcs.has('squarecut')) {
        const d = procDetails.squarecut || { count: 1, holes: [{ x: 50, y: 50, w: 50, h: 50 }] };
        if (!d.holes) d.holes = [];
        while (d.holes.length < d.count) d.holes.push({ x: 50, y: 50, w: 50, h: 50 });
        while (d.holes.length > d.count) d.holes.pop();

        let tableRows = '';
        d.holes.forEach((h, i) => {
          tableRows += `<tr>
          <td style="padding:4px;">${i + 1}</td>
          <td><input type="number" value="${h.x}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'x',this.value)" placeholder="X1"></td>
          <td><input type="number" value="${h.y}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'y',this.value)" placeholder="Y1"></td>
          <td><input type="number" value="${h.w}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'w',this.value)" placeholder="X2(Ìè≠)"></td>
          <td><input type="number" value="${h.h}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'h',this.value)" placeholder="Y2(Í∏∏Ïù¥)"></td>
        </tr>`;
        });

        h += `<div class="proc-sub"><div class="sub-title">ÏÇ¨Í∞ÅÌÉÄÍ≥µ (Í∞úÎãπ 4,000Ïõê, 1Í∞ú Î¨¥Î£å)<br><span style="font-weight:normal;color:#666;">‚ÄªÍ∏∞Ï§ÄÏ†ê: Ï¢åÏ∏°ÏÉÅÎã® (mm)</span></div>
      <div style="margin-bottom:8px; text-align:center;">
        <img src="https://gi.esmplus.com/irn2011/click/texture/detail_square.png" alt="ÏÇ¨Í∞ÅÌÉÄÍ≥µ Í∞ÄÏù¥Îìú" style="max-width:100%; border-radius:4px; border:1px solid #eee;">
      </div>
      <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
        <span>Í∞úÏàò:</span>
        <input type="number" value="${d.count}" min="1" max="10" style="width:60px;" onchange="updateSquareCutCount(this.value)">
      </div>
      <table style="width:100%; font-size:11px; text-align:center; border-collapse:collapse;">
        <thead><tr style="background:#eee;"><th style="padding:4px;">No</th><th>X1</th><th>Y1</th><th>X2(Ìè≠)</th><th>Y2(Í∏∏Ïù¥)</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table></div>`;
      }

      area.innerHTML = h;
    }



    function updateCircleCutCount(val) {
      const v = parseInt(val) || 1;
      let d = procDetails.circlecut;
      if (!d) d = procDetails.circlecut = { count: 1, holes: [] };
      d.count = v;
      if (!d.holes) d.holes = [];
      while (d.holes.length < v) d.holes.push({ x: 50, y: 50, r: 20 });
      while (d.holes.length > v) d.holes.pop();
      renderProcSub();
      updateWoodModel();
    }

    function updateCircleCutData(idx, key, val) {
      const v = parseFloat(val) || 0;
      if (procDetails.circlecut && procDetails.circlecut.holes && procDetails.circlecut.holes[idx]) {
        procDetails.circlecut.holes[idx][key] = v;
        updateWoodModel();
      }
    }

    function updateSquareCutCount(val) {
      const v = parseInt(val) || 1;
      let d = procDetails.squarecut;
      if (!d) d = procDetails.squarecut = { count: 1, holes: [] };
      d.count = v;
      if (!d.holes) d.holes = [];
      while (d.holes.length < v) d.holes.push({ x: 50, y: 50, w: 50, h: 50 });
      while (d.holes.length > v) d.holes.pop();
      renderProcSub();
      updateWoodModel();
    }

    function updateSquareCutData(idx, key, val) {
      const v = parseFloat(val) || 0;
      if (procDetails.squarecut && procDetails.squarecut.holes && procDetails.squarecut.holes[idx]) {
        procDetails.squarecut.holes[idx][key] = v;
        updateWoodModel();
      }
    }

    function updateHingeCount(val) {
      const v = parseInt(val) || 2;
      let d = procDetails.hinge;
      if (!d) d = procDetails.hinge = { count: 2, mode: 'Y_INPUT', positions: [] };
      d.count = v;
      if (!d.positions) d.positions = [];
      while (d.positions.length < v) {
        if (d.mode === 'Y_INPUT') d.positions.push({ x: 23, y: '' });
        else d.positions.push({ x: '', y: 23 });
      }
      while (d.positions.length > v) d.positions.pop();
      renderProcSub();
      updateWoodModel();
    }

    function toggleHingeMode() {
      let d = procDetails.hinge;
      if (!d) return;
      d.mode = (d.mode === 'Y_INPUT') ? 'X_INPUT' : 'Y_INPUT';
      // Reset positions for new mode
      d.positions = [];
      for (let i = 0; i < d.count; i++) {
        if (d.mode === 'Y_INPUT') d.positions.push({ x: 23, y: '' });
        else d.positions.push({ x: '', y: 23 });
      }
      renderProcSub();
      updateWoodModel();
    }

    function updateHingeData(idx, key, val) {
      const v = parseFloat(val) || 0;
      if (procDetails.hinge && procDetails.hinge.positions && procDetails.hinge.positions[idx]) {
        procDetails.hinge.positions[idx][key] = v;
        updateWoodModel();
      }
    }

    function toggleAngledSide(val) {
      const d = procDetails.angled || (procDetails.angled = { sides: [] });
      const i = d.sides.indexOf(val);
      if (i >= 0) d.sides.splice(i, 1); else d.sides.push(val);
      renderProcSub(); updateWoodModel();
    }

    function toggleRoundCorner(val) {
      const d = procDetails.round || (procDetails.round = { corners: [] });
      const i = d.corners.indexOf(val);
      if (i >= 0) d.corners.splice(i, 1); else d.corners.push(val);
      renderProcSub(); updateWoodModel();
    }

    function confirmProc() {
      addBotMessage('Í∞ÄÍ≥µ ÌôïÏ†ï: <b>' + getProcSummary() + '</b>');
      updateWoodModel();
      showEstimate();
    }

    // ============================================================
    // ESTIMATE
    // ============================================================
    function showEstimate() {
      if (!currentWood || currentWidth <= 0) return;
      const p = calculatePrice();
      if (!p) { addBotMessage('Ìï¥Îãπ ÏÇ¨Ïù¥Ï¶àÏùò Îã®Í∞Ä Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.'); return; }
      const wd = WOOD_DATA[currentWood];

      let procDetailHtml = '';
      if (p.additionalCost > 0) {
        procDetailHtml += `<div class="estimate-row"><span>Í∞ÄÍ≥µÎπÑ ÏÉÅÏÑ∏</span><span>+${p.additionalCost.toLocaleString()}Ïõê</span></div>`;
      }
      if (p.totalDiscount > 0) {
        procDetailHtml += `<div class="estimate-row" style="color:#ffd700;"><span>Ïù¥Î≤§Ìä∏ Ìï†Ïù∏</span><span>-${p.totalDiscount.toLocaleString()}Ïõê</span></div>`;
        p.discountDetails.forEach(dd => {
          procDetailHtml += `<div class="estimate-row" style="font-size:11px;color:#ffd700;"><span style="padding-left:10px;">‚îî ${dd}</span><span></span></div>`;
        });
      }

      // ÏûÑÏãú Î∞∞ÏÜ°ÎπÑ (Î¶¨Î∑∞Ïö©)
      const tempShipping = getBaseShippingCost(currentLength);

      addBotMessage(`
    <div class="estimate-card">
      <h3>üìã Í≤¨Ï†ÅÏÑú</h3>
      <div class="estimate-row"><span>Î™©Ïû¨</span><span>${wd.name}</span></div>
      <div class="estimate-row"><span>ÏÇ¨Ïù¥Ï¶à</span><span>${currentWidth} √ó ${currentLength} mm</span></div>
      <div class="estimate-row"><span>ÏàòÎüâ</span><span>${currentQty}Ïû•</span></div>
      <div class="estimate-row"><span>Í∞ÄÍ≥µ</span><span>${getProcSummary()}</span></div>
      <div class="estimate-row"><span>ÌåêÏû¨ Îã®Í∞Ä</span><span>${p.basePrice.toLocaleString()}Ïõê</span></div>
      ${procDetailHtml}
      <div class="estimate-row" style="font-weight:600;"><span>Ïû•Îãπ (Ìï†Ïù∏ ÌõÑ)</span><span>${Math.round(p.finalTotal / currentQty).toLocaleString()}Ïõê</span></div>
      <div class="estimate-row"><span>ÏÜåÍ≥Ñ (${currentQty}Ïû•)</span><span>${p.finalTotal.toLocaleString()}Ïõê</span></div>
      <div class="estimate-row" style="opacity:0.7; font-size:11px;"><span>ÏòàÏÉÅ Î∞∞ÏÜ°ÎπÑ (Î∞ïÏä§ ÌïòÎÇòÎãπ)</span><span>${tempShipping.toLocaleString()}Ïõê</span></div>
      <div class="estimate-total">ÏÜåÍ≥Ñ Ìï©Í≥Ñ: ${p.finalTotal.toLocaleString()}Ïõê</div>
      <div class="estimate-actions">
        <button class="btn-add-order" onclick="addToOrder()">Ï£ºÎ¨∏Î™©Î°ùÏóê Ï∂îÍ∞Ä</button>
    <button class="btn-new-est" onclick="clearChatAndStartNew()">ÏÉà Í≤¨Ï†Å</button>
  </div>
</div>`);

      document.getElementById('previewDim').textContent = `${currentWidth}√ó${currentLength}mm ${wd.name}`;
      updateStatus('Í≤¨Ï†Å ÏôÑÎ£å', p.finalTotal.toLocaleString() + 'Ïõê');
    }

    // ============================================================
    // ORDER
    // ============================================================
    function addToOrder() {
      const p = calculatePrice(); if (!p) return;
      const wd = WOOD_DATA[currentWood];
      orderList.push({
        woodTypeValue: currentWood,
        woodName: wd.name,
        width: currentWidth,
        length: currentLength,
        quantity: currentQty,
        processingSummary: getProcSummary(),
        selectedProcs: Array.from(selectedProcs),
        procDetails: JSON.parse(JSON.stringify(procDetails)),
        basePrice: p.basePrice,
        additionalCost: p.additionalCost,
        originalTotal: p.origTotal,
        discount: p.totalDiscount,
        discountDetails: p.discountDetails,
        estimate: p.finalTotal
      });

      addBotMessage(`<b>${wd.name} ${currentWidth}√ó${currentLength}mm ${currentQty}Ïû•</b> Ï∂îÍ∞Ä!
<div class="quick-buttons">
  <span class="quick-btn" onclick="clearChatAndStartNew()">Îã§Î•∏ Î™©Ïû¨ Ï∂îÍ∞Ä</span>
  <span class="quick-btn" onclick="showAccessoryCategories()">Î∂ÄÏûêÏû¨ Ï∂îÍ∞Ä</span>
  <span class="quick-btn" onclick="initiateOrder()">Ï£ºÎ¨∏ÌïòÍ∏∞ (${orderList.length}Í±¥)</span>
</div>`);
      updateOrderBadge(); renderOrderPanel(); resetEstimate();
    }

    function removeOrderItem(idx) { orderList.splice(idx, 1); updateOrderBadge(); renderOrderPanel(); }

    function removeProc(key, e) {
      if (e) e.stopPropagation();
      selectedProcs.delete(key);
      delete procDetails[key];
      if (selectedProcs.size === 0) selectedProcs.add('none');
      updateWoodModel();
      showProcessingOptions(); // ÏòµÏÖò Î≤ÑÌäº ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
      renderOrderPanel();
      updateOrderBadge();
    }

    function editProc(key) {
      // Í∞ÄÍ≥µ ÏòµÏÖòÏ∞ΩÏùÑ Îã§Ïãú ÎùÑÏõå ÏÉÅÏÑ∏ ÏÑ§Ï†ïÏùÑ Ìï† Ïàò ÏûàÍ≤å Ìï®
      showProcessingOptions();
      // ÌäπÏ†ï Í∞ÄÍ≥µÏóê ÎåÄÌïú ÏïàÎÇ¥ Î©îÏãúÏßÄ Ï∂îÍ∞Ä (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
      const opt = PROC_OPTIONS.find(o => o.key === key);
      if (opt) {
        addBotMessage(`<b>${opt.label}</b> ÏÑ§Ï†ïÏùÑ ÏúÑ Ï∞ΩÏóêÏÑú Î≥ÄÍ≤ΩÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.`);
      }
    }

    function toggleOrderPanel(show) {
      const overlay = document.getElementById('orderPanelOverlay');
      if (show === undefined) {
        show = overlay.style.display === 'none' || overlay.style.display === '';
      }
      if (show) {
        overlay.style.display = 'flex';
        renderOrderPanel();
      } else {
        overlay.style.display = 'none';
      }
    }

    function renderOrderPanel() {
      const panel = document.getElementById('orderPanel');
      if (!orderList.length) {
        panel.innerHTML = `<div class="order-panel-header"><span>Ï£ºÎ¨∏Î™©Î°ù</span><button onclick="toggleOrderPanel()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">‚úï</button></div>
      <div class="order-panel-body" style="display:flex;align-items:center;justify-content:center;color:#999;">ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.</div>`; return;
      }

      let itemTotal = 0;
      let rows = '';

      orderList.forEach((item, idx) => {
        itemTotal += item.estimate;
        const details = item.type === 'accessory' ? (item.name || '-') : (item.processingSummary || 'Í∞ÄÍ≥µ ÏóÜÏùå');
        const sizeStr = item.width > 0 ? `${item.width}x${item.length}` : '-';

        rows += `<tr>
          <td>${item.type === 'accessory' ? '[Î∂ÄÏûêÏû¨]' : item.woodName}</td>
          <td>${details}</td>
          <td>${sizeStr}</td>
          <td>${item.quantity}</td>
          <td>${item.estimate.toLocaleString()}</td>
          <td><button class="oi-remove-btn" onclick="removeOrderItem(${idx})">ÏÇ≠Ï†ú</button></td>
        </tr>`;

        if (item.discount > 0) {
          rows += `<tr class="discount-row">
             <td>Ïù¥Î≤§Ìä∏ Ìï†Ïù∏</td>
             <td>${(item.discountDetails || []).join(', ')}</td>
             <td colspan="2">-</td>
             <td>-${item.discount.toLocaleString()}</td>
             <td></td>
           </tr>`;
        }
      });

      // Î∞∞ÏÜ°ÎπÑ
      const shippingItems = calculateShippingCost(orderList);
      let totalShip = 0;
      shippingItems.forEach(si => {
        const sc = si.cost * si.count;
        totalShip += sc;
        rows += `<tr class="shipping-row">
          <td>ÏòàÏÉÅ Î∞∞ÏÜ°ÎπÑ</td>
          <td>${si.sizeCategory}</td>
          <td>-</td>
          <td>${si.count}</td>
          <td>${sc.toLocaleString()}</td>
          <td></td>
        </tr>`;
      });

      const grandTotal = itemTotal + totalShip;

      panel.innerHTML = `
    <div class="order-panel-header"><span>Ï£ºÎ¨∏Î™©Î°ù (${orderList.length}Í±¥)</span><button onclick="toggleOrderPanel()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">‚úï</button></div>
    <div class="order-panel-body">
      <table class="order-table">
        <thead>
          <tr>
            <th>ÌíàÎ™Ö</th>
            <th>Í∞ÄÍ≥µÏÉÅÏÑ∏</th>
            <th>ÏÇ¨Ïù¥Ï¶à</th>
            <th>ÏàòÎüâ</th>
            <th>Í≤¨Ï†Å</th>
            <th>Í¥ÄÎ¶¨</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
           <tr class="total-row">
             <td colspan="4" style="text-align:right;">Ï¥ù Ìï©Í≥Ñ</td>
             <td colspan="2" style="color:#e74c3c;">${grandTotal.toLocaleString()}Ïõê</td>
           </tr>
        </tfoot>
      </table>
    </div>
    <div class="order-panel-footer">
      <div class="total-row"><span>Ï¥ù Ìï©Í≥Ñ</span><span style="color:#e74c3c;">${grandTotal.toLocaleString()}Ïõê</span></div>
      <button class="btn-checkout" onclick="toggleOrderPanel(false);showCustomerForm();">Ï£ºÎ¨∏ ÏßÑÌñâÌïòÍ∏∞</button>
    </div>`;
    }

    function removeOrderItem(idx) {
      if (orderList[idx]?.isLoaded) { alert('Î∂àÎü¨Ïò® Ï£ºÎ¨∏ÏùÄ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.'); return; }
      orderList.splice(idx, 1);
      saveOrders(); updateOrderBadge(); renderOrderPanel();
      if (orderList.length === 0) {
        addBotMessage('Ï£ºÎ¨∏ Î™©Î°ùÏù¥ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§. ÏÉàÎ°úÏö¥ Î™©Ïû¨Î•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.');
        showWoodCards();
      } else {
        addBotMessage('ÏÑ†ÌÉùÌïú Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌñàÏäµÎãàÎã§.');
        initiateOrder();
      }
    }

    function clearAllOrders() {
      if (orderList.some(i => i.isLoaded)) { alert('Î∂àÎü¨Ïò® Ï£ºÎ¨∏ÏùÄ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.'); return; }
      if (!confirm('Î™®Îì† Ï£ºÎ¨∏ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      orderList = []; saveOrders(); updateOrderBadge(); renderOrderPanel();
      addBotMessage('Ï£ºÎ¨∏Î™©Î°ùÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
      showWoodCards();
    }

    // ============================================================
    // CUSTOMER FORM
    // ============================================================
    // ============================================================
    // CUSTOMER FORM
    // ============================================================
    function initiateOrder() {
      if (!orderList.length) { addBotMessage('Ï£ºÎ¨∏Î™©Î°ùÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'); return; }
      addBotMessage('üõí ÌåùÏóÖÏúºÎ°ú ÎÇòÌÉÄÎÇú Ï£ºÎ¨∏Î™©Î°ùÏùÑ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî. (Í∞ÄÎèÖÏÑ±ÏùÑ ÏúÑÌïú Í∞úÏÑ†ÏûÖÎãàÎã§)');
      toggleOrderPanel(true);
    }

    function showCustomerForm() {
      if (!orderList.length) { addBotMessage('Ï£ºÎ¨∏Î™©Î°ùÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'); return; }
      if (orderList.some(i => i.isLoaded)) { addBotMessage('Î∂àÎü¨Ïò® Ï£ºÎ¨∏ÏùÄ Ï†ÑÏÜ°Ïù¥ Î∂àÍ∞ÄÌï©ÎãàÎã§.<div class="quick-buttons"><span class="quick-btn" onclick="generateReport()">üì∏ Í≤¨Ï†ÅÏÑú Ï†ÄÏû•</span></div>'); return; }
      let gt = 0; orderList.forEach(i => { gt += i.estimate; });
      const shipItems = calculateShippingCost(orderList); shipItems.forEach(si => { gt += si.cost * si.count; });
      addBotMessage(`
<div class="customer-form">
  <h4>Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥</h4>
  <div class="form-row"><label>ÏÑ±Ìï® *</label><input type="text" id="custName" placeholder="ÌôçÍ∏∏Îèô"></div>
  <div class="form-row"><label>Ïó∞ÎùΩÏ≤ò *</label><input type="tel" id="custPhone" placeholder="010-1234-5678" oninput="formatPhoneNumber(this)" maxlength="13"></div>
  <div class="form-row"><label>Ïù¥Î©îÏùº</label><input type="email" id="custEmail" placeholder="example@email.com (ÏÑ†ÌÉù)"></div>
  <div style="text-align:right;font-size:14px;font-weight:700;color:#e74c3c;margin:8px 0;">Ï¥ù Í≤∞Ï†úÍ∏àÏï°: ${gt.toLocaleString()}Ïõê</div>
  <button class="btn-submit-order" onclick="submitOrder()">Ï£ºÎ¨∏ Ï†úÏ∂úÌïòÍ∏∞</button>
</div>`);
    }

    function resetEstimate() { currentWidth = 0; currentLength = 0; currentQty = 1; selectedProcs.clear(); procDetails = {}; updateWoodModel(); }

    function compareWoodPrices(w, l, q) {
      if (!priceTable.length) {
        addBotMessage('Îã®Í∞ÄÌëúÎ•º ÏïÑÏßÅ Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }
      const area = w * l;
      const results = WOOD_KEYS.map(key => {
        const wd = WOOD_DATA[key];
        const unitPrice = getUnitPrice(key, area);
        return { key, name: wd.name, price: unitPrice, desc: wd.desc };
      }).filter(r => r.price > 0).sort((a, b) => a.price - b.price);

      if (!results.length) {
        addBotMessage(`${w}√ó${l}mm ÏÇ¨Ïù¥Ï¶àÏóê ÎåÄÌïú Í∞ÄÍ≤© Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
        return;
      }

      const cheapest = results[0];
      let rows = results.map((r, i) => {
        const tag = i === 0 ? ' <span style="color:#2ecc71;font-weight:800;">‚úÖ ÏµúÏ†ÄÍ∞Ä</span>' : '';
        const selectAction = q
          ? `selectWood('${r.key}');setSize(${w},${l},${q});`
          : `selectWood('${r.key}');currentWidth=${w};currentLength=${l};addBotMessage('<b>${r.name}</b> ${w}√ó${l}mm ÏÇ¨Ïù¥Ï¶àÎ•º ÏÑ†ÌÉùÌïòÏÖ®ÏäµÎãàÎã§.<br>ÏàòÎüâÏùÄ Î™á Ïû•Ïù¥ ÌïÑÏöîÌïòÏã†Í∞ÄÏöî?');updateWoodModel();updateStatus('ÏàòÎüâ ÏûÖÎ†• ÎåÄÍ∏∞','');`;

        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #f0f2f5;${i === 0 ? 'background:#f0fff4;border-radius:8px;' : ''}">
          <div style="flex:1;min-width:0;margin-right:8px;">
            <span style="font-weight:700;color:#2c3e50;">${i + 1}. ${r.name}</span>${tag}
            <div style="font-size:11px;color:#7f8c8d;margin-top:2px;">${r.desc}</div>
          </div>
          <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
            <span style="font-weight:800;color:${i === 0 ? '#e74c3c' : '#555'};font-size:15px;white-space:nowrap;">${r.price.toLocaleString()}Ïõê</span>
            <button onclick="${selectAction}" style="border:1px solid #3498db;background:#fff;color:#3498db;border-radius:4px;padding:2px 8px;font-size:11px;font-weight:600;cursor:pointer;">ÏÑ†ÌÉù</button>
          </div>
        </div>`;
      }).join('');

      const footerBtns = q
        ? `<span class="quick-btn" onclick="selectWood('${cheapest.key}');setSize(${w},${l},${q});">${cheapest.name}ÏúºÎ°ú ÏßÑÌñâÌïòÍ∏∞</span>`
        : `<span class="quick-btn" onclick="selectWood('${cheapest.key}');currentWidth=${w};currentLength=${l};addBotMessage('<b>${cheapest.name}</b> ${w}√ó${l}mm ÏÇ¨Ïù¥Ï¶àÎ•º ÏÑ†ÌÉùÌïòÏÖ®ÏäµÎãàÎã§.<br>ÏàòÎüâÏùÄ Î™á Ïû•Ïù¥ ÌïÑÏöîÌïòÏã†Í∞ÄÏöî?');updateWoodModel();updateStatus('ÏàòÎüâ ÏûÖÎ†• ÎåÄÍ∏∞','');">${cheapest.name} Í≤¨Ï†Å Î≥¥Í∏∞</span>`;

      addBotMessage(`
        <div style="border:2px solid #3498db;border-radius:16px;overflow:hidden;">
          <div style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:14px 16px;">
            <div style="font-size:16px;font-weight:800;">üìä ${w}√ó${l}mm Î™©Ïû¨ Í∞ÄÍ≤© ÎπÑÍµê</div>
            <div style="font-size:12px;opacity:.8;margin-top:4px;">Î©¥Ï†Å: ${area.toLocaleString()}mm¬≤ Í∏∞Ï§Ä${q ? ` (ÏàòÎüâ: ${q}Ïû•)` : ' (1Ïû•, Í∞ÄÍ≥µ Ï†Ñ)'}</div>
          </div>
          <div style="padding:4px 0;">${rows}</div>
          <div style="padding:12px 16px;background:#f8f9fa;border-top:1px solid #eee;">
            <div style="font-size:13px;color:#2c3e50;margin-bottom:8px;">üí° <b>${cheapest.name}</b>Ïù¥(Í∞Ä) Í∞ÄÏû• Ï†ÄÎ†¥Ìï©ÎãàÎã§!</div>
            <div class="quick-buttons">
              ${footerBtns}
              <span class="quick-btn" onclick="showWoodCards()">Î™©Ïû¨ ÏßÅÏ†ë ÏÑ†ÌÉù</span>
            </div>
          </div>
        </div>
      `);
    }

    function confirmReset() {
      if (confirm('Ï£ºÎ¨∏ Î™©Î°ùÍ≥º Ï±ÑÌåÖ ÎÇ¥Ïö©ÏùÑ Î™®Îëê Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        resetAll();
      }
    }

    function resetAll() {
      currentWood = null;
      resetEstimate();
      orderList = [];
      updateOrderBadge();
      renderOrderPanel();
      document.getElementById('chatMessages').innerHTML = '';
      showGreeting();
    }

    // ============================================================
    // THREE.JS 3D (ÏõêÎ≥∏ ÌÖçÏä§Ï≤ò + Î°úÏßÅ)
    // ============================================================
    function init3D() {
      const wrap = document.querySelector('.preview-canvas-wrap');
      const canvas = document.getElementById('previewCanvas');
      const w = wrap.clientWidth || 600, h = wrap.clientHeight || 400;
      scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f0f0);
      camera = new THREE.PerspectiveCamera(50, w / h, 0.1, 1000);
      camera.position.set(3, 3, 5);
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(w, h); renderer.setPixelRatio(window.devicePixelRatio);
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.08;
      scene.add(new THREE.AmbientLight(0xdddddd));
      const dl = new THREE.DirectionalLight(0xffffff, 1); dl.position.set(5, 10, 7.5); scene.add(dl);
      boardGroup = new THREE.Group(); scene.add(boardGroup);
      sceneObjects = [];
      activeLabels = [];
      animate3D();
      new ResizeObserver(() => {
        const ww = wrap.clientWidth, hh = wrap.clientHeight;
        if (ww > 0 && hh > 0) { camera.aspect = ww / hh; camera.updateProjectionMatrix(); renderer.setSize(ww, hh); }
      }).observe(wrap);
    }

    function animate3D() {
      requestAnimationFrame(animate3D);
      if (controls) controls.update();
      if (renderer && scene && camera) renderer.render(scene, camera);

      // ÎùºÎ≤® ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
      activeLabels.forEach(label => {
        const screenPosition = label.position.clone().project(camera);
        if (screenPosition.z > 1.0) {
          label.element.style.display = 'none';
        } else {
          label.element.style.display = 'block';
          const canvas = renderer.domElement;
          const x = (screenPosition.x * 0.5 + 0.5) * canvas.clientWidth;
          const y = (-screenPosition.y * 0.5 + 0.5) * canvas.clientHeight;
          label.element.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
        }
      });
    }

    // ============================================================
    // DIMENSION HELPERS
    // ============================================================
    let activeLabels = [];
    const labelsContainer = document.getElementById('labels-container');

    function createLabel(text, positionVector, color) {
      if (!labelsContainer) return;
      const div = document.createElement('div');
      div.innerHTML = text; // HTML ÏßÄÏõê
      div.style.position = 'absolute';
      div.style.color = color;
      div.style.fontWeight = 'bold';
      div.style.backgroundColor = 'rgba(255, 255, 255, 0.8)'; // Î∞∞Í≤Ω Ìà¨Î™ÖÎèÑ Ï°∞Ï†ï
      div.style.padding = '2px 5px';
      div.style.borderRadius = '3px';
      div.style.fontSize = '12px';
      div.style.whiteSpace = 'nowrap'; // Ï§ÑÎ∞îÍøà Î∞©ÏßÄ (br ÌÉúÍ∑∏Îäî ÏûëÎèô)
      div.style.textAlign = 'center'; // Ï§ëÏïô Ï†ïÎ†¨
      div.style.userSelect = 'none';
      div.style.pointerEvents = 'auto';
      div.style.top = '0'; div.style.left = '0'; // Ï¥àÍ∏∞ ÏúÑÏπò
      labelsContainer.appendChild(div);
      activeLabels.push({ element: div, position: positionVector });
    }

    function clearLabels() {
      if (!labelsContainer) return;
      activeLabels.forEach(label => { if (label.element.parentNode) label.element.parentNode.removeChild(label.element); });
      activeLabels = [];
    }

    function createDimensionLine(start, end, labelText, color) {
      const lineMaterial = new THREE.LineBasicMaterial({ color: 0xff0000 });
      const offset = 0.2;
      let p1, p2;

      // Îçî Í∏¥ Ï∂ïÏùÑ Í∏∞Ï§ÄÏúºÎ°ú Ïò§ÌîÑÏÖã Î∞©Ìñ• Í≤∞Ï†ï
      if (Math.abs(start.x - end.x) > Math.abs(start.z - end.z)) {
        const zOffset = start.z > 0 ? offset : -offset;
        p1 = new THREE.Vector3(start.x, start.y, start.z + zOffset);
        p2 = new THREE.Vector3(end.x, end.y, end.z + zOffset);
      } else {
        const xOffset = start.x > 0 ? offset : -offset;
        p1 = new THREE.Vector3(start.x + xOffset, start.y, start.z);
        p2 = new THREE.Vector3(end.x + xOffset, end.y, end.z);
      }

      const line1 = new THREE.Line(new THREE.BufferGeometry().setFromPoints([start, p1]), lineMaterial);
      const line2 = new THREE.Line(new THREE.BufferGeometry().setFromPoints([end, p2]), lineMaterial);
      const mainLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints([p1, p2]), lineMaterial);

      scene.add(line1, line2, mainLine);
      sceneObjects.push(line1, line2, mainLine);

      const labelPos = p1.clone().lerp(p2, 0.5);
      createLabel(labelText, labelPos, color);
    }

    function createCornerLabel(text, position, color) {
      const offset = 0.3;
      let labelPos = position.clone();
      labelPos.x += Math.sign(position.x || 0.1) * offset;
      labelPos.y += offset;
      labelPos.z += Math.sign(position.z || 0.1) * offset;
      createLabel(text, labelPos, color);
    }

    function updateWoodModel() {
      // Clear labels first to prevent persistence regardless of early return
      clearLabels();

      // Clear mesh
      if (woodMesh) { scene.remove(woodMesh); woodMesh = null; }
      sceneObjects.forEach(o => scene.remove(o)); sceneObjects = [];

      if (!currentWood || currentWidth <= 0 || currentLength <= 0) return;

      const width = currentWidth, length = currentLength, height = 18;
      const w = width / 100, h = height / 100, l = length / 100;

      // ÏõêÎ≥∏ ÌÖçÏä§Ï≤ò
      const texture = new THREE.TextureLoader().load('https://gi.esmplus.com/irn2011/click/texture/line_texture.jpg');
      texture.repeat.set(width / 300, length / 1200);
      texture.wrapS = THREE.RepeatWrapping; texture.wrapT = THREE.RepeatWrapping;
      const woodMat = new THREE.MeshPhongMaterial({ map: texture });
      const pinkMat = new THREE.MeshPhongMaterial({ color: 0xff69b4 });
      const blueMat = new THREE.MeshPhongMaterial({ color: 0x007bff, transparent: true, opacity: 0.7 });
      const purpleMat = new THREE.MeshBasicMaterial({ color: 0x800080, side: THREE.DoubleSide });

      const materials = Array(6).fill(null).map(() => woodMat.clone());

      // ÏΩîÌåÖ ÌëúÏãú
      if (selectedProcs.has('coating')) {
        const type = (procDetails.coating || {}).type;
        if (type === 'Îã®Î©¥') materials[2] = pinkMat;
        else if (type === 'ÏñëÎ©¥') { materials[2] = pinkMat; materials[3] = pinkMat; }
      }
      // ÏÇ¨ÏÑ† ÌëúÏãú
      if (selectedProcs.has('angled')) {
        const sides = (procDetails.angled || {}).sides || [];
        sides.forEach(s => {
          if (s === 'A') materials[1] = blueMat;
          if (s === 'B') materials[4] = blueMat;
          if (s === 'C') materials[0] = blueMat;
          if (s === 'D') materials[5] = blueMat;
        });
      }

      const geo = new THREE.BoxGeometry(w, h, l);
      woodMesh = new THREE.Mesh(geo, materials);
      scene.add(woodMesh);

      // Ïó£ÏßÄ
      const edges = new THREE.EdgesGeometry(geo);
      woodMesh.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 })));

      const topY = h / 2, hw = w / 2, hl = l / 2;

      // ÎùºÏö¥Îìú ÎßàÏª§
      if (selectedProcs.has('round')) {
        const corners = (procDetails.round || {}).corners || [];
        const posMap = { '1': [-hw, topY, hl], '2': [-hw, topY, -hl], '3': [hw, topY, hl], '4': [hw, topY, -hl] };
        corners.forEach(c => {
          if (posMap[c]) {
            const sp = new THREE.Mesh(new THREE.SphereGeometry(0.12, 16, 16), purpleMat);
            sp.position.fromArray(posMap[c]); scene.add(sp); sceneObjects.push(sp);
          }
        });
      }

      // Í≤ΩÏ≤© ÎßàÏª§
      if (selectedProcs.has('hinge')) {
        const d = procDetails.hinge || {};
        const positions = d.positions || [];
        const count = d.count || 2;

        if (positions.length > 0) {
          positions.forEach((p, i) => {
            let px = parseFloat(p.x) || 0;
            let py = parseFloat(p.y) || 0;

            // Ï¢åÌëúÍ∞Ä ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∑†Îì± Î∞∞Ïπò
            if (d.mode === 'Y_INPUT' && !p.y && p.y !== 0) {
              py = ((i + 1) / (count + 1)) * length;
              px = 23;
            } else if (d.mode === 'X_INPUT' && !p.x && p.x !== 0) {
              px = ((i + 1) / (count + 1)) * width;
              py = 23;
            }

            if (px > 0 || py > 0) {
              const hole = new THREE.Mesh(new THREE.CircleGeometry(17.5 / 100, 32), purpleMat);
              hole.position.set((px / 100) - hw, topY + 0.001, hl - (py / 100));
              hole.rotation.x = -Math.PI / 2;
              scene.add(hole); sceneObjects.push(hole);

              const labelHtml = `<div style="line-height:1.2;">No.${i + 1}<br><span style="font-size:10px; font-weight:normal;">X:${px}, Y:${py}</span></div>`;
              createLabel(labelHtml, hole.position.clone().add(new THREE.Vector3(0, 0.2, 0)), 'black');
            }
          });
        } else {
          // fallback: Í∑†Îì± Î∞∞Ïπò
          for (let i = 0; i < count; i++) {
            const t = (i + 1) / (count + 1);
            const hole = new THREE.Mesh(new THREE.CircleGeometry(17.5 / 100, 32), purpleMat);
            hole.position.set(23 / 100 - hw, topY + 0.001, hl - t * l);
            hole.rotation.x = -Math.PI / 2;
            scene.add(hole); sceneObjects.push(hole);
          }
        }
      }

      // ÏõêÌòïÌÉÄÍ≥µ ÎßàÏª§
      if (selectedProcs.has('circlecut')) {
        const d = procDetails.circlecut || {};
        const holes = d.holes || [];
        // ÌïòÏúÑ Ìò∏ÌôòÏÑ± (holesÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞)
        if (!d.holes && d.count) {
          for (let i = 0; i < d.count; i++) {
            const hole = new THREE.Mesh(new THREE.CircleGeometry(0.15, 32), purpleMat);
            hole.position.set(0, topY + 0.001, (i * 0.4) - hl / 2);
            hole.rotation.x = -Math.PI / 2;
            scene.add(hole); sceneObjects.push(hole);
          }
        } else {
          holes.forEach((hInfo, i) => {
            if (hInfo.r > 0) {
              const rUnit = hInfo.r / 100;
              const xUnit = hInfo.x / 100;
              const yUnit = hInfo.y / 100;
              // X: Ï¢åÏ∏°( -hw )ÏóêÏÑú +xUnit
              // Y: ÏÉÅÎã®( -hl ?? ÏïÑÎãà, Ïù¥Ï†Ñ Î°úÏßÅ 'B(ÏÉÅÎã®)'ÏùÄ +Z Î∞©Ìñ•Ïù¥ÏóàÎÇò? ÌôïÏù∏ ÌïÑÏöî.
              // angled Î°úÏßÅ: B(ÏÉÅÎã®) = [0, topY, l_half] -> +ZÍ∞Ä ÏÉÅÎã®.
              // D(ÌïòÎã®) = [0, topY, -l_half] -> -ZÍ∞Ä ÌïòÎã®.
              // A(Ï¢åÏ∏°) = [-w_half, topY, 0] -> -XÍ∞Ä Ï¢åÏ∏°.
              // C(Ïö∞Ï∏°) = [w_half, topY, 0] -> +XÍ∞Ä Ïö∞Ï∏°.

              // Îî∞ÎùºÏÑú ÏÉÅÎã®(Top)ÏùÄ +Z. Ï¢åÏ∏°(Left)Îäî -X.
              // User Input X (from Left): -hw + xUnit
              // User Input Y (from Top): hl - yUnit

              const hole = new THREE.Mesh(new THREE.CircleGeometry(rUnit, 32), purpleMat);
              hole.position.set(-hw + xUnit, topY + 0.001, hl - yUnit);
              hole.rotation.x = -Math.PI / 2;
              scene.add(hole); sceneObjects.push(hole);

              // ÎùºÎ≤®: X, Y, R Í∞í ÌëúÏãú
              const labelHtml = `<div style="line-height:1.2;">No.${i + 1}<br><span style="font-size:10px; font-weight:normal;">X:${hInfo.x}, Y:${hInfo.y}<br>R:${hInfo.r}</span></div>`;
              createLabel(labelHtml, hole.position.clone().add(new THREE.Vector3(0, 0.2, 0)), 'black');
            }
          });
        }
      }

      // ÏÇ¨Í∞ÅÌÉÄÍ≥µ ÎßàÏª§
      if (selectedProcs.has('squarecut')) {
        const d = procDetails.squarecut || {};
        const holes = d.holes || [];
        if (!d.holes && d.count) {
          for (let i = 0; i < d.count; i++) {
            const hole = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 0.3), purpleMat);
            hole.position.set(0, topY + 0.001, (i * 0.4) - hl / 2);
            hole.rotation.x = -Math.PI / 2;
            scene.add(hole); sceneObjects.push(hole);
          }
        } else {
          holes.forEach((hInfo, i) => {
            const x = hInfo.x || 0, y = hInfo.y || 0;
            const w = hInfo.w || 0, h = hInfo.h || 0;

            if (w > 0 && h > 0) {
              const cutW_unit = w / 100;
              const cutH_unit = h / 100;
              const cutX_unit = x / 100;
              const cutY_unit = y / 100;

              const centerX = -hw + cutX_unit + (cutW_unit / 2);
              const centerZ = hl - cutY_unit - (cutH_unit / 2);

              const hole = new THREE.Mesh(new THREE.PlaneGeometry(cutW_unit, cutH_unit), purpleMat);
              hole.position.set(centerX, topY + 0.001, centerZ);
              hole.rotation.x = -Math.PI / 2;
              scene.add(hole); sceneObjects.push(hole);

              const labelHtml = `<div style="line-height:1.2;">No.${i + 1}<br><span style="font-size:10px; font-weight:normal;">X:${x}, Y:${y}<br>W:${w}, H:${h}</span></div>`;
              createLabel(labelHtml, hole.position.clone().add(new THREE.Vector3(0, 0.2, 0)), 'black');
            }
          });
        }
      }

      // ÏπòÏàòÏÑ† (Í∏∞Ï°¥ Îã®Ïàú ÏÑ† Ï†úÍ±∞ ÌõÑ Ìï®Ïàò Ïù¥Ïö©)


      // Í∏∞Î≥∏ ÏπòÏàòÏÑ†
      if (lastFocusedOption !== 'angled') {
        createDimensionLine(new THREE.Vector3(-hw, topY, hl), new THREE.Vector3(hw, topY, hl), `Ìè≠: ${width} mm`, 'black');
        createDimensionLine(new THREE.Vector3(-hw, topY, -hl), new THREE.Vector3(-hw, topY, hl), `Í∏∏Ïù¥: ${length} mm`, 'black');
      }

      // ÎùºÏö¥Îìú/ÏÇ¨ÏÑ† ÏΩîÎÑà ÎùºÎ≤®
      if (lastFocusedOption === 'angled') {
        createCornerLabel('A', new THREE.Vector3(-hw, topY, 0), 'blue');
        createCornerLabel('B', new THREE.Vector3(0, topY, hl), 'blue');
        createCornerLabel('C', new THREE.Vector3(hw, topY, 0), 'blue');
        createCornerLabel('D', new THREE.Vector3(0, topY, -hl), 'blue');
      }
      if (lastFocusedOption === 'round') {
        createCornerLabel('1', new THREE.Vector3(-hw, topY, hl), 'blue');
        createCornerLabel('2', new THREE.Vector3(-hw, topY, -hl), 'blue');
        createCornerLabel('3', new THREE.Vector3(hw, topY, hl), 'blue');
        createCornerLabel('4', new THREE.Vector3(hw, topY, -hl), 'blue');
      }

      // Ïπ¥Î©îÎùº Update
      // Ï∂îÍ∞Ä Í∞ÄÍ≥µ ÌÉúÍ∑∏ (UI Overlay - Ïö∞Ï∏° ÏÉÅÎã® Í≥†Ï†ï)
      const overlay = document.getElementById('proc-tag-overlay');
      if (overlay) {
        overlay.innerHTML = ''; // Ï¥àÍ∏∞Ìôî
        Array.from(selectedProcs).forEach(key => {
          if (key === 'none') return;
          const opt = PROC_OPTIONS.find(o => o.key === key);
          if (!opt) return;

          const tagDiv = document.createElement('div');
          tagDiv.className = 'proc-tag';
          tagDiv.style.pointerEvents = 'auto'; // ÌÅ¥Î¶≠ Í∞ÄÎä•ÌïòÍ≤å
          tagDiv.onclick = () => editProc(key);
          tagDiv.innerHTML = `
            <span class="proc-tag-name">${getProcTagLabel(key)}</span>
            <span class="proc-tag-remove" onclick="removeProc('${key}', event)">‚úï</span>
          `;
          overlay.appendChild(tagDiv);
        });
      }

      const maxDim = Math.max(w, l, h);
      camera.position.set(maxDim * 0.7, maxDim * 0.7, maxDim * 1.2);
      camera.lookAt(0, 0, 0); controls.target.set(0, 0, 0); controls.update();

      document.getElementById('previewInfo').innerHTML = ''; // ÌïòÎã® Í≤ÄÏ†ï Î∂ÄÎ∂Ñ Ï†úÍ±∞ (ÌÖçÏä§Ìä∏ ÎπÑÏõÄ)
      document.getElementById('previewDim').textContent = `${width}√ó${length} mm`;
    }

    function getProcTagLabel(key) {
      const opt = PROC_OPTIONS.find(o => o.key === key);
      if (!opt) return key;
      let label = opt.label;
      const d = procDetails[key] || {};
      if (key === 'coating' && d.type) label += `<br><span style="font-size:10px;font-weight:normal;">(${d.type}ÏΩîÌåÖ)</span>`;
      if (key === 'angled' && d.sides && d.sides.length) label += `<br><span style="font-size:10px;font-weight:normal;">(${d.sides.join(',')})</span>`;
      if (key === 'round' && d.corners && d.corners.length) label += `<br><span style="font-size:10px;font-weight:normal;">(${d.corners.join(',')})</span>`;

      if (key === 'hinge' && d.count) {
        label += `<br><span style="font-size:10px;font-weight:normal;">(${d.count}Í∞ú)`;
        if (d.positions && d.positions.length) {
          d.positions.forEach((p, i) => {
            const xVal = (p.x === '' || p.x === undefined) ? '?' : p.x;
            const yVal = (p.y === '' || p.y === undefined) ? '?' : p.y;
            label += `<br>#${i + 1}: X${xVal}, Y${yVal}`;
          });
        }
        label += `</span>`;
      }
      if (key === 'circlecut' && d.holes && d.holes.length) {
        label += `<br><span style="font-size:10px;font-weight:normal;">(${d.holes.length}Í∞ú)`;
        d.holes.forEach((h, i) => {
          label += `<br>#${i + 1}: X${h.x}, Y${h.y} (R${h.r})`;
        });
        label += `</span>`;
      }
      if (key === 'squarecut' && d.holes && d.holes.length) {
        label += `<br><span style="font-size:10px;font-weight:normal;">(${d.holes.length}Í∞ú)`;
        d.holes.forEach((h, i) => {
          label += `<br>#${i + 1}: X${h.x}, Y${h.y} (${h.w}x${h.h})`;
        });
        label += `</span>`;
      }
      return label;
    }

    // ============================================================
    // MODALS & HELPERS
    // ============================================================
    function openInstructionsModal(orderNumber, totalAmount) {
      const m = document.getElementById('orderInstructionsModal');
      const paymentQty = Math.ceil(totalAmount / 1000);
      document.getElementById('finalQuoteAmount').textContent = totalAmount.toLocaleString() + 'Ïõê';
      document.getElementById('paymentQuantity').textContent = paymentQty + 'Í∞ú';
      document.getElementById('finalOrderNumber').textContent = orderNumber;
      m.style.display = 'flex';
    }
    function closeInstructionsModal() { document.getElementById('orderInstructionsModal').style.display = 'none'; }
    function copyOrderNumber() {
      const orderNumber = document.getElementById('finalOrderNumber').innerText;
      const btn = document.getElementById('copyOrderBtn');
      if (orderNumber && orderNumber !== '-') {
        navigator.clipboard.writeText(orderNumber).then(() => {
          const orig = btn.innerText; btn.innerText = 'Î≥µÏÇ¨Îê®!'; btn.disabled = true;
          setTimeout(() => { btn.innerText = orig; btn.disabled = false; }, 2000);
        }).catch(() => { alert('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏßÅÏ†ë Î≥µÏÇ¨Ìï¥Ï£ºÏÑ∏Ïöî.'); });
      }
    }

    function showCustomerStoreLinks() {
      addBotMessage(`
        < div style = "padding:10px;" >
          <h4 style="margin-bottom:10px;">üõí Íµ¨Îß§ ÎßÅÌÅ¨ ÏïàÎÇ¥</h4>
          <div class="payment-links">
            <a class="payment-link" style="background:#03c75a;" href="https://smartstore.naver.com/irun2011" target="_blank">ÎÑ§Ïù¥Î≤Ñ Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥</a>
            <a class="payment-link" style="background:#1184ff;" href="https://link.coupang.com/a/cQ9keF" target="_blank">Ïø†Ìå° Î∏åÎûúÎìúÏÉµ</a>
          </div>
          <p style="font-size:12px;color:#666;margin-top:10px;">Î∂ÄÏûêÏû¨ Î∞è Í∏∞ÏÑ±ÌíàÏùÄ ÏúÑ ÎßÅÌÅ¨ÏóêÏÑú Î∞îÎ°ú Íµ¨Îß§ Í∞ÄÎä•Ìï©ÎãàÎã§.</p>
        </div > `);
    }

    // ============================================================
    // REPORT (PNG DOWNLOAD)
    // ============================================================
    async function generateReport() {
      const items = orderList.length ? orderList : lastSubmittedOrders;
      if (!items.length) { addBotMessage('Ï£ºÎ¨∏Î™©Î°ùÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'); return; }
      const c = document.getElementById('reportContainer');
      let itemTotal = 0, rows = '';

      items.forEach((item) => {
        itemTotal += item.estimate;
        let discRow = '';
        if (item.discount > 0) {
          discRow = `<tr style="color:#d9534f; background:#fff8f8;"><td style="border:1px solid #ddd;padding:8px;">Ïù¥Î≤§Ìä∏ Ìï†Ïù∏</td><td style="border:1px solid #ddd;padding:8px;" colspan="2">${item.discountDetails.join(', ')}</td><td style="border:1px solid #ddd;padding:8px;text-align:right;">-${item.discount.toLocaleString()}Ïõê</td></tr>`;
        }
        const itemName = item.type === 'accessory' ? '[Î∂ÄÏûêÏû¨]' : item.woodName;
        const itemDetails = item.type === 'accessory' ? (item.name || '-') : (item.processingSummary || 'Í∞ÄÍ≥µ ÏóÜÏùå');
        const itemSize = item.type === 'accessory' ? `ÏàòÎüâ: ${item.quantity}Í∞ú` : `${item.width}√ó${item.length}mm / ${item.quantity}Ïû•`;

        rows += `<tr>
          <td style="border:1px solid #ddd;padding:12px;"><b>${itemName}</b></td>
          <td style="border:1px solid #ddd;padding:12px;">${itemDetails}</td>
          <td style="border:1px solid #ddd;padding:12px;">${itemSize}</td>
          <td style="border:1px solid #ddd;padding:12px;text-align:right;">${item.estimate.toLocaleString()}Ïõê</td>
        </tr>${discRow}`;
      });

      const shipItems = calculateShippingCost(items);
      let totalShip = 0;
      shipItems.forEach(si => {
        const sc = si.cost * si.count; totalShip += sc;
        rows += `<tr style="background:#fcfcfc;"><td style="border:1px solid #ddd;padding:10px;"><b>ÏòàÏÉÅ Î∞∞ÏÜ°ÎπÑ</b></td><td style="border:1px solid #ddd;padding:10px;">${si.sizeCategory}</td><td style="border:1px solid #ddd;padding:10px;">ÏàòÎüâ: ${si.count}Í∞ú</td><td style="border:1px solid #ddd;padding:10px;text-align:right;">${sc.toLocaleString()}Ïõê</td></tr>`;
      });

      const finalGT = itemTotal + totalShip;

      c.innerHTML = `
        <div style="border:2px solid #2c3e50; padding:20px;">
          <div style="text-align:center;margin-bottom:30px;">
            <h1 style="color:#2c3e50; margin:0; font-size:28px;">ÏïÑÏù¥Î¶∞Í∞ÄÍµ¨ Î™©Ïû¨ Í≤¨Ï†Å ÎÇ¥Ïó≠ÏÑú</h1>
            <p style="color:#7f8c8d; font-size:14px;">Î∞úÌñâÏùº: ${new Date().toLocaleString('ko-KR')}</p>
          </div>
          <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
            <thead><tr style="background:#2c3e50; color:#fff;"><th style="padding:12px; border:1px solid #2c3e50;">Ìï≠Î™©</th><th style="padding:12px; border:1px solid #2c3e50;">Í∞ÄÍ≥µÏ†ïÎ≥¥</th><th style="padding:12px; border:1px solid #2c3e50;">Í∑úÍ≤©/ÏàòÎüâ</th><th style="padding:12px; border:1px solid #2c3e50;">Í∏àÏï°</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <div style="text-align:right; border-top:2px solid #2c3e50; padding:20px 0;">
            <span style="font-size:18px; color:#7f8c8d;">Ï¥ù Í≤¨Ï†Å Ìï©Í≥Ñ (Î∞∞ÏÜ°ÎπÑ Ìè¨Ìï®):</span>
            <span style="font-size:32px; font-weight:800; color:#e74c3c; margin-left:20px;">${finalGT.toLocaleString()} Ïõê</span>
          </div>
          <div style="background:#f8f9fa; padding:15px; margin-top:20px; font-size:12px; color:#666; line-height:1.6;">
            ‚Äª Î≥∏ Í≤¨Ï†ÅÏÑúÎäî ÏûêÏû¨ Î∞è Í∞ÄÍ≥µÎπÑ ÏòàÏÇ∞ ÏÇ∞Ï∂úÏùÑ ÏúÑÌïú Ï∞∏Í≥†Ïö©ÏûÖÎãàÎã§.<br>
            ‚Äª Ïã§Ï†ú Í≤∞Ï†ú Ï†Ñ ÏÉÅÏÑ∏ Í∞ÄÍ∞ê ÎÇ¥Ïó≠Ïù¥ Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.
          </div>
        </div>`;

      try {
        const canvas = await html2canvas(c, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `ÏïÑÏù¥Î¶∞Í∞ÄÍµ¨_Í≤¨Ï†ÅÎÇ¥Ïó≠ÏÑú_${Date.now()}.png`;
        link.href = imgData;
        link.click();
        addBotMessage('Í≤¨Ï†Å ÎÇ¥Ïó≠ÏÑúÍ∞Ä Ïù¥ÎØ∏ÏßÄ(PNG)Î°ú Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
      } catch (e) {
        console.error(e);
        addBotMessage('ÎÇ¥Ïó≠ÏÑú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      }
    }

    // sync with submitOrder to show instructions modal
    // and add download button to the chat
    function updateSubmitOrderSuccess(on, gt) {
      addBotMessage(`
        <div style="text-align:center;padding:16px;">
          <div style="font-size:40px;margin-bottom:8px;">‚úÖ</div>
          <div style="font-size:18px;font-weight:700;color:#2c3e50;">Ï£ºÎ¨∏ ÏöîÏ≤≠ ÏôÑÎ£å!</div>
          <p style="font-size:13px;color:#666;">Ï£ºÎ¨∏Î≤àÌò∏: <b>${on}</b><br>Ï¥ù Í≤∞Ï†úÍ∏àÏï°: <b>${gt.toLocaleString()}Ïõê</b></p>
          <div class="quick-buttons" style="justify-content:center;margin-top:12px;">
            <span class="quick-btn" style="background:#34495e;" onclick="generateReport()">üì∏ Í≤¨Ï†ÅÎÇ¥Ïó≠ÏÑú Ï†ÄÏû•</span>
            <span class="quick-btn" onclick="openInstructionsModal('${on}', ${gt})">üí∞ Í≤∞Ï†úÎ∞©Î≤ï ÏïàÎÇ¥</span>
          </div>
          <div class="quick-buttons" style="justify-content:center;margin-top:8px;">
            <span class="quick-btn" onclick="resetAll();showWoodCards();">ÏÉà Í≤¨Ï†Å ÏãúÏûë</span>
          </div>
        </div>`);
    }

    // ============================================================
    // updateOrderBadge
    // ============================================================
    function updateOrderBadge() {
      const badge = document.getElementById('orderBadge');
      if (!badge) return;
      if (orderList.length > 0) { badge.style.display = 'inline'; badge.textContent = orderList.length; }
      else { badge.style.display = 'none'; }
    }



    // ============================================================
    // localStorage PERSISTENCE
    // ============================================================
    function saveOrders() { localStorage.setItem('chatOrderData', JSON.stringify(orderList)); }
    function loadOrders() {
      try {
        const saved = localStorage.getItem('chatOrderData');
        if (saved) { orderList = JSON.parse(saved); updateOrderBadge(); }
      } catch (e) { console.warn('Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê Ïã§Ìå®:', e); localStorage.removeItem('chatOrderData'); }
    }

    // Hook into addToOrder to persist
    const _origAddToOrder = addToOrder;
    addToOrder = function () { _origAddToOrder(); saveOrders(); };
    const _origRemoveOrderItem = removeOrderItem;
    removeOrderItem = function (idx) { _origRemoveOrderItem(idx); saveOrders(); };

    // Load on init
    window.addEventListener('DOMContentLoaded', () => { loadOrders(); });

    // ============================================================
    // ACCESSORY DATA & CHAT CARDS
    // ============================================================
    const ACCESSORY_DATA = {
      screws: {
        title: 'ÌîºÏä§',
        desc: 'Íµ¨Î¶¨ Ï≤úÏó∞ Î™©Í≥µÏö© ÌîºÏä§Î°ú, Í∞ÄÏû• ÎßéÏù¥ ÏÇ¨Ïö©ÌïòÎäî ÌîºÏä§ ÏûÖÎãàÎã§.',
        items: [{ name: 'Î™©Í≥µÏö© ÌîºÏä§ (20Í∞ú)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt2.png' }]
      },
      hinges: {
        title: 'Í≤ΩÏ≤©',
        desc: 'Í∞ÄÍµ¨ Î¨∏Ïßù Îì±Ïóê ÏÇ¨Ïö©ÌïòÎäî Í∏∞Î≥∏ Í≤ΩÏ≤©Í≥º, Î¨∏Ïù¥ Î∂ÄÎìúÎüΩÍ≤å Îã´ÌûàÎèÑÎ°ù ÎèÑÏôÄÏ£ºÎäî Ïä§Î¨¥Î∏å ÏòµÏÖòÏûÖÎãàÎã§.',
        items: [
          { name: '110ÎèÑ Ïã±ÌÅ¨ Í≤ΩÏ≤© (1ÏÑ∏Ìä∏=2ea)', price: 2000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge2.png' },
          { name: 'Í≤ΩÏ≤© Ïä§Î¨¥Î∏å (1ÏÑ∏Ìä∏=2ea)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge3.png' }
        ]
      },
      sandpaper: {
        title: 'ÏÇ¨Ìè¨',
        desc: 'Ïà´ÏûêÍ∞Ä ÎÇÆÏùÑÏàòÎ°ù Í±∞Ïπ†Í≥†, ÎÜíÏùÑÏàòÎ°ù Î∂ÄÎìúÎüΩÏäµÎãàÎã§.',
        items: [
          { name: 'ÏÇ¨Ìè¨ #80 (2Ïû•)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_80.png' },
          { name: 'ÏÇ¨Ìè¨ #150 (2Ïû•)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_150.png' },
          { name: 'ÏÇ¨Ìè¨ #220 (2Ïû•)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_220.png' },
          { name: 'ÏÇ¨Ìè¨ #320 (2Ïû•)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_320.png' }
        ]
      },
      tape: {
        title: 'Ïó£ÏßÄÌÖåÏù¥ÌîÑ',
        desc: 'Î™©Ïû¨Ïùò Ï†àÎã®Î©¥ÏùÑ ÎßàÍ∞êÌïòÏó¨ ÍπîÎÅîÌïòÍ≤å ÎßåÎì§Í≥† ÏäµÍ∏∞Î°úÎ∂ÄÌÑ∞ Î≥¥Ìò∏ÌïòÎäî ÎßàÍ∞êÏû¨ÏûÖÎãàÎã§.',
        items: [
          { name: 'PVC Ïó£ÏßÄ ÌÖåÏù¥ÌîÑ (10m)', price: 8000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge_2.png' },
          { name: 'Ï¢ÖÏù¥ Ïó£ÏßÄ ÌÖåÏù¥ÌîÑ (10m)', price: 12000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge_1.png' }
        ]
      }
    };

    let currentAccCardId = 0;
    function showAccessoryCategories() {
      const cardId = 'acc_card_' + (++currentAccCardId);
      addBotMessage(`
        <div class="acc-card" id="${cardId}">
          <div class="acc-card-header">
            <span class="acc-card-title">üõí Î∂ÄÏûêÏû¨ Ï∂îÍ∞Ä</span>
            <button class="acc-close-btn" onclick="this.closest('.bot-msg').remove()">‚úï</button>
          </div>
          <div class="acc-content">
            <div style="margin-bottom:12px;font-weight:700;font-size:15px;color:#34495e;">Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</div>
            <div class="acc-category-grid">
              ${[
          { key: 'screws', label: 'ÌîºÏä§', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png' },
          { key: 'hinges', label: 'Í≤ΩÏ≤©', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png' },
          { key: 'sandpaper', label: 'ÏÇ¨Ìè¨', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png' },
          { key: 'tape', label: 'Ïó£ÏßÄÌÖåÏù¥ÌîÑ', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge.png' }
        ].map(c => `
                <div class="acc-category" onclick="renderAccessoryItems('${cardId}', '${c.key}')">
                  <img src="${c.img}" alt="${c.label}">
                  <div>${c.label}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `, true);
    }

    function showSpecificAccessoryCategory(catKey) {
      const cardId = 'acc_card_' + (++currentAccCardId);
      addBotMessage(`
        <div class="acc-card" id="${cardId}">
          <div class="acc-card-header">
            <span class="acc-card-title">üõí Î∂ÄÏûêÏû¨ Ï∂îÍ∞Ä</span>
            <button class="acc-close-btn" onclick="this.closest('.bot-msg').remove()">‚úï</button>
          </div>
          <div class="acc-content"></div>
        </div>
      `, true);
      renderAccessoryItems(cardId, catKey);
    }

    function renderAccessoryItems(cardId, catKey) {
      const card = document.getElementById(cardId);
      if (!card) return;
      const content = card.querySelector('.acc-content');
      const cat = ACCESSORY_DATA[catKey];
      if (!cat) return;

      // Ïπ¥ÌÖåÍ≥†Î¶¨ Í≥†Ï†ïÌòï ÏÉÅÎã® Î∞î (ÏÑ†ÌÉù ÌëúÏãú Í∏∞Îä• Ìè¨Ìï®)
      const cats = [
        { key: 'screws', label: 'ÌîºÏä§', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png' },
        { key: 'hinges', label: 'Í≤ΩÏ≤©', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png' },
        { key: 'sandpaper', label: 'ÏÇ¨Ìè¨', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png' },
        { key: 'tape', label: 'Ïó£ÏßÄÌÖåÏù¥ÌîÑ', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge.png' }
      ];

      let h = `
        <div class="acc-category-grid" style="margin-bottom:15px;background:#f8f9fa;padding:8px;border-radius:12px;border:1px solid #eee;">
          ${cats.map(c => `
            <div class="acc-category ${c.key === catKey ? 'active' : ''}" onclick="renderAccessoryItems('${cardId}', '${c.key}')" style="padding:8px 4px; border:none; ${c.key === catKey ? '' : 'background:none;'}">
              <img src="${c.img}" style="width:24px;height:24px;margin-bottom:2px;">
              <div style="font-size:11px;">${c.label}</div>
            </div>
          `).join('')}
        </div>
        <div style="font-weight:800;font-size:17px;color:#2c3e50;margin-bottom:6px;">${cat.title}</div>
        <p style="font-size:12px;color:#7f8c8d;line-height:1.5;margin-bottom:15px;">${cat.desc}
          ${catKey === 'tape' ? `<a href="#" onclick="openVideoModal('https://www.youtube.com/embed/goC8S1Enjcg?si=7B93_Wk53lxoeqEj', 'Ïó£ÏßÄ ÌÖåÏù¥ÌîÑ ÏãúÍ≥µ Î∞©Î≤ï');return false;" style="color:#3498db;font-weight:600;text-decoration:none;margin-left:5px;">[ÏãúÍ≥µÏòÅÏÉÅ Î≥¥Í∏∞]</a>` : ''}
        </p>
        <div class="acc-item-list">
          ${cat.items.map((item, i) => {
        const uid = `${cardId}_${catKey}_${i}`;
        return `
              <div class="acc-item">
                <img src="${item.image}" alt="${item.name}" style="width:80px;height:80px;border-radius:8px;">
                <div class="acc-info">
                  <div class="acc-name">${item.name}</div>
                  <div class="acc-price">${item.price.toLocaleString()}Ïõê</div>
                </div>
                <div class="acc-controls">
                  <input type="number" id="accQty_${uid}" value="1" min="1" class="acc-qty">
                  <button class="acc-add-btn" onclick="addAccessoryToOrder('${catKey}', ${i}, '${uid}')">Îã¥Í∏∞</button>
                </div>
              </div>
            `;
      }).join('')}
        </div>
        <button class="acc-back-btn" style="margin-top:15px;" onclick="renderAccessoryCategories('${cardId}')">‚Üê Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
      `;
      content.innerHTML = h;
    }

    function renderAccessoryCategories(cardId) {
      const card = document.getElementById(cardId);
      if (!card) return;
      const content = card.querySelector('.acc-content');
      content.innerHTML = `
        <div style="margin-bottom:6px;font-weight:600;font-size:13px;">Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</div>
        <div class="acc-category-grid" style="grid-template-columns:repeat(4,1fr);">
          ${[
          { key: 'screws', label: 'ÌîºÏä§', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png' },
          { key: 'hinges', label: 'Í≤ΩÏ≤©', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png' },
          { key: 'sandpaper', label: 'ÏÇ¨Ìè¨', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png' },
          { key: 'tape', label: 'Ïó£ÏßÄÌÖåÏù¥ÌîÑ', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge.png' }
        ].map(c => `
            <div class="acc-category" onclick="renderAccessoryItems('${cardId}', '${c.key}')">
              <img src="${c.img}" alt="${c.label}">
              <div>${c.label}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function addAccessoryToOrder(catKey, itemIndex, qtyUid) {
      const cat = ACCESSORY_DATA[catKey];
      const item = cat.items[itemIndex];
      const qtyEl = document.getElementById('accQty_' + qtyUid);
      const qty = parseInt(qtyEl?.value) || 1;
      if (qty < 1) { addBotMessage('ÏàòÎüâÏùÑ 1Í∞ú Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
      orderList.push({ type: 'accessory', woodTypeValue: null, woodName: '[Î∂ÄÏûêÏû¨]', name: item.name, width: 0, length: 0, quantity: qty, processingSummary: '-', selectedProcs: [], procDetails: {}, basePrice: item.price, additionalCost: 0, originalTotal: item.price * qty, discount: 0, discountDetails: [], estimate: item.price * qty });
      saveOrders(); updateOrderBadge(); renderOrderPanel();
      addBotMessage(`<b>${item.name}</b> ${qty}Í∞úÎ•º Ï£ºÎ¨∏Î™©Î°ùÏóê Ï∂îÍ∞ÄÌñàÏäµÎãàÎã§. (${(item.price * qty).toLocaleString()}Ïõê)
      <div class="quick-buttons"><span class="quick-btn" onclick="clearChatAndStartNew()">Îã§Î•∏ Î™©Ïû¨ Ï∂îÍ∞Ä</span><span class="quick-btn" onclick="initiateOrder()">Ï£ºÎ¨∏ ÌôïÏù∏ÌïòÍ∏∞ (${orderList.length}Í±¥)</span></div>`);
    }

    // ============================================================
    // PROGRESS MODAL
    // ============================================================
    function showProgressModal() {
      document.getElementById('progressTitle').textContent = 'Ï†ÑÏÜ° Ï§ë...';
      document.getElementById('progressIcon').src = 'https://i.gifer.com/ZZ5H.gif';
      document.getElementById('progressModalCloseBtn').style.display = 'none';
      document.getElementById('progressBar').style.backgroundColor = '#007bff';
      document.getElementById('progressModalOverlay').style.display = 'flex';
      updateProgress(10, 'Ï†ÑÏÜ°ÏùÑ Ï§ÄÎπÑÌïòÍ≥† ÏûàÏäµÎãàÎã§...');
    }
    function updateProgress(pct, msg) {
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressStatusText').textContent = msg;
    }
    function showProgressSuccess(msg) {
      updateProgress(100, msg);
      document.getElementById('progressTitle').textContent = 'Ï†ÑÏÜ° ÏôÑÎ£å';
      document.getElementById('progressIcon').src = 'https://i.imgur.com/UDS2wje.png';
      document.getElementById('progressModalCloseBtn').style.display = 'block';
    }
    function showProgressError(msg) {
      updateProgress(100, msg);
      document.getElementById('progressBar').style.backgroundColor = '#dc3545';
      document.getElementById('progressTitle').textContent = 'Ï†ÑÏÜ° Ïã§Ìå®';
      document.getElementById('progressIcon').src = 'https://i.imgur.com/P4Q6r5A.png';
      document.getElementById('progressModalCloseBtn').style.display = 'block';
    }
    function hideProgressModal() { document.getElementById('progressModalOverlay').style.display = 'none'; }

    // ============================================================
    // VIDEO MODAL
    // ============================================================
    function openVideoModal(url, title) {
      document.getElementById('youtubeVideo').src = url;
      if (title) document.getElementById('videoModalTitle').textContent = title;
      document.getElementById('videoModal').style.display = 'flex';
    }
    function closeVideoModal() {
      document.getElementById('videoModal').style.display = 'none';
      document.getElementById('youtubeVideo').src = '';
    }

    // ============================================================
    // LOAD ORDER (JSONP)
    // ============================================================
    let jsonpTimeout;
    function openLoadModal() { document.getElementById('loadOrderModal').style.display = 'flex'; }
    function closeLoadModal() { document.getElementById('loadOrderModal').style.display = 'none'; }
    function formatPhoneNumber(input) {
      let val = input.value.replace(/\D/g, '');
      if (val.length > 3 && val.length <= 7) val = val.slice(0, 3) + '-' + val.slice(3);
      else if (val.length > 7) val = val.slice(0, 3) + '-' + val.slice(3, 7) + '-' + val.slice(7, 11);
      input.value = val;
    }
    function confirmLoadOrder() {
      const phone = document.getElementById('load-phone').value.trim();
      const orderNo = document.getElementById('load-orderNo').value.trim();
      if (!phone || !orderNo) { alert('Ìú¥ÎåÄÌè∞ Î≤àÌò∏ÏôÄ Ï£ºÎ¨∏Î≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
      const btn = document.getElementById('loadOrderConfirmBtn');
      btn.disabled = true; btn.textContent = 'Î∂àÎü¨Ïò§Îäî Ï§ë...';
      const old = document.getElementById('jsonp_script'); if (old) old.remove();
      jsonpTimeout = setTimeout(() => { if (btn.disabled) { alert('ÏöîÏ≤≠ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§.'); btn.disabled = false; btn.textContent = 'ÌôïÏù∏'; } }, 15000);
      const script = document.createElement('script');
      script.id = 'jsonp_script';
      script.src = `${API_URL}?callback=handleOrderDataResponse&phone=${encodeURIComponent(phone)}&orderNo=${encodeURIComponent(orderNo)}`;
      script.onerror = () => { clearTimeout(jsonpTimeout); alert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.'); btn.disabled = false; btn.textContent = 'ÌôïÏù∏'; };
      document.head.appendChild(script);
    }
    function handleOrderDataResponse(result) {
      clearTimeout(jsonpTimeout);
      const btn = document.getElementById('loadOrderConfirmBtn');
      btn.disabled = false; btn.textContent = 'ÌôïÏù∏';
      if (result.result === 'success' && result.data && result.data.length > 0) {
        orderList = [];
        result.data.forEach(row => {
          const summary = String(row['ÌíàÎ™Ö'] || row['Ï£ºÎ¨∏ÎÇ¥Ïó≠ ÏöîÏïΩ'] || '');
          const estimate = parseFloat(row['Ìï©Í≥Ñ']) || 0;
          const processing = row['Í∞ÄÍ≥µÏÉÅÏÑ∏'] || row['Í∞ÄÍ≥µ'] || '';
          if (summary === 'Ï¥ù Ìï©Í≥Ñ') return;
          let item = { isLoaded: true, estimate };
          if (summary === '[Ïù¥Î≤§Ìä∏ Ìï†Ïù∏]') { item.type = 'discount'; item.name = processing || 'Ïù¥Î≤§Ìä∏ Ìï†Ïù∏'; item.woodName = 'Ìï†Ïù∏'; }
          else if (summary === 'ÏòàÏÉÅ Î∞∞ÏÜ°ÎπÑ') { item.type = 'shipping'; item.name = processing || 'Î∞∞ÏÜ°ÎπÑ'; item.woodName = 'Î∞∞ÏÜ°'; item.quantity = row['ÏàòÎüâ']; }
          else if (summary.startsWith('[Î∂ÄÏûêÏû¨]')) { item.type = 'accessory'; item.name = summary.replace('[Î∂ÄÏûêÏû¨] ', ''); item.woodName = '[Î∂ÄÏûêÏû¨]'; item.quantity = row['ÏàòÎüâ']; }
          else {
            item.woodTypeValue = summary; item.woodName = summary;
            item.width = row['Ìè≠(mm)'] || row['Ìè≠'] || 0; item.length = row['Í∏∏Ïù¥(mm)'] || row['Í∏∏Ïù¥'] || 0;
            item.quantity = row['ÏàòÎüâ'] || 1;
            item.processingSummary = processing || 'Í∞ÄÍ≥µ ÏóÜÏùå';
            item.selectedProcs = []; item.procDetails = {}; item.discount = 0; item.discountDetails = [];
          }
          orderList.push(item);
        });
        saveOrders(); updateOrderBadge(); renderOrderPanel();
        closeLoadModal();
        addBotMessage('‚úÖ Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§. Î∂àÎü¨Ïò® Îç∞Ïù¥ÌÑ∞Îäî ÏàòÏ†ï Î∂àÍ∞ÄÏù¥Î©∞, Í≤¨Ï†ÅÏÑú Îã§Ïö¥Î°úÎìúÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.');
        document.getElementById('load-phone').value = ''; document.getElementById('load-orderNo').value = '';
      } else { alert('ÏùºÏπòÌïòÎäî Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'); }
    }


    // ============================================================
    // ENHANCED submitOrder with progress modal
    // ============================================================
    submitOrder = async function () {
      const name = document.getElementById('custName').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const email = document.getElementById('custEmail')?.value.trim() || '';

      if (!name || !phone) { addBotMessage('ÏÑ±Ìï®Í≥º Ïó∞ÎùΩÏ≤òÎäî ÌïÑÏàòÏûÖÎãàÎã§.'); return; }
      const phoneRegex = /^010-\d{4}-\d{4}$/;
      if (!phoneRegex.test(phone)) { addBotMessage('Ìú¥ÎåÄÌè∞ Î≤àÌò∏Î•º 010-0000-0000 ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }

      showProgressModal();
      updateStatus('Ï£ºÎ¨∏ Ï†úÏ∂ú Ï§ë...', '');

      try {
        updateProgress(40, 'Í≤¨Ï†Å Îç∞Ïù¥ÌÑ∞Î•º ÏÑúÎ≤ÑÏóê Ï†ÄÏû•ÌïòÍ≥† ÏûàÏäµÎãàÎã§...');

        // Î∞∞ÏÜ°ÎπÑ Í≥ÑÏÇ∞
        const shipItems = calculateShippingCost(orderList);
        let shipTotal = 0;
        shipItems.forEach(si => shipTotal += (si.cost * si.count));

        // ÏïÑÏù¥ÌÖú ÏÜåÍ≥Ñ
        let itemTotal = 0;
        orderList.forEach(i => { itemTotal += i.estimate; });

        const grandTotal = itemTotal + shipTotal;

        // ÏÑúÎ≤Ñ Ï†ÑÏÜ° Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
        const orderPayload = {
          type: 'order',
          data: {
            customer: { name, phone, email, memo: '' }, // memo ÌïÑÎìú ÎπÑÏõÄ
            orders: orderList, // 'items' ÎåÄÏã† 'orders' ÏÇ¨Ïö©
            shippingItems: shipItems,
            shippingCost: shipTotal,
            totalPrice: grandTotal,
            sessionId: SESSION_ID,
            timestamp: new Date().toISOString()
          }
        };

        const resp = await postToServer(orderPayload);

        if (resp.result === 'success' || resp.orderNumber || resp.orderNo) {
          const on = resp.orderNo || resp.orderNumber || resp.data?.orderNumber || 'IRN-' + Date.now();

          showProgressSuccess('Í≤¨Ï†ÅÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!');
          setTimeout(() => {
            hideProgressModal();
            updateSubmitOrderSuccess(on, grandTotal);
            openInstructionsModal(on, grandTotal);
          }, 2000);

          lastSubmittedOrders = [...orderList]; // Î∞±ÏóÖ Ï†ÄÏû•
          orderList = [];
          saveOrders();
          updateOrderBadge();
          renderOrderPanel();
          updateStatus('Ï£ºÎ¨∏ ÏôÑÎ£å', on);
        } else {
          showProgressError('ÏÑúÎ≤Ñ Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + (resp.message || ''));
          updateStatus('Ï£ºÎ¨∏ Ïã§Ìå®', '');
        }
      } catch (e) {
        showProgressError('Ï†ÑÏÜ° Ï§ë ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        updateStatus('Ïó∞Í≤∞ Ïò§Î•ò', '');
        console.error(e);
      }
    };

    // Modal dismiss on overlay click
    window.addEventListener('click', (e) => {
      if (e.target.id === 'loadOrderModal') closeLoadModal();
      if (e.target.id === 'videoModal') closeVideoModal();
    });
  </script>

  <!-- ORDER INSTRUCTIONS MODAL -->
  <div id="orderInstructionsModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeInstructionsModal()">&times;</span>
      <div class="modal-title">üì¶ Ï£ºÎ¨∏ ÏïàÎÇ¥</div>
      <div class="instruction-box">
        <div class="instruction-row"><span>ÏµúÏ¢Ö Í≤¨Ï†Å Í∏àÏï°</span><b id="finalQuoteAmount">-</b></div>
        <div class="instruction-row"><span>Í≤∞Ï†ú ÏàòÎüâ (1,000Ïõê Îã®ÏúÑ)</span><b id="paymentQuantity">-</b></div>
        <div class="instruction-row">
          <span>Ï£ºÎ¨∏ Î≤àÌò∏</span>
          <span style="display:flex;align-items:center;gap:8px;">
            <b id="finalOrderNumber">-</b>
            <button id="copyOrderBtn" onclick="copyOrderNumber()"
              style="padding:4px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:11px;">üìã
              Î≥µÏÇ¨</button>
          </span>
        </div>
      </div>
      <p style="font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 20px;">
        ÏúÑ Ï£ºÎ¨∏Î≤àÌò∏Î•º Î≥µÏÇ¨ÌïòÏã† ÌõÑ, ÏïÑÎûò Í≤∞Ï†ú ÎßÅÌÅ¨ÏóêÏÑú<br>
        <b>Í≤∞Ï†ú ÏàòÎüâ</b>ÎßåÌÅº Í∞úÏàòÎ•º ÏÑ§Ï†ïÌïòÏó¨ Í≤∞Ï†úÌï¥ Ï£ºÏÑ∏Ïöî.
      </p>
      <div class="payment-links">
        <a class="payment-link" style="background:#03c75a;" href="https://naver.me/GJ5OEouG" target="_blank">ÎÑ§Ïù¥Î≤Ñ Ïä§ÌÜ†Ïñ¥
          Í≤∞Ï†ú</a>
        <a class="payment-link" style="background:#1184ff;" href="https://link.coupang.com/a/cQ9keF" target="_blank">Ïø†Ìå°
          Í≤∞Ï†ú</a>
      </div>
      <div style="margin-top:15px;display:flex;gap:8px;justify-content:center;">
        <a href="https://talk.naver.com/profile/wc80z0" target="_blank"
          style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:#03c75a;color:#fff;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;">üí¨
          ÎÑ§Ïù¥Î≤Ñ ÌÜ°ÌÜ°</a>
        <a href="http://pf.kakao.com/_NKxaxcl/chat" target="_blank"
          style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:#FEE500;color:#3C1E1E;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;">üí¨
          Ïπ¥Ïπ¥Ïò§ÌÜ° ÏÉÅÎã¥</a>
      </div>
      <button class="btn-checkout" style="margin-top:15px; background:#7f8c8d;"
        onclick="closeInstructionsModal()">Îã´Í∏∞</button>
    </div>
  </div>

  <!-- PROGRESS MODAL -->
  <div id="progressModalOverlay" class="modal-overlay">
    <div class="modal-content" style="text-align: center;">
      <h3 id="progressTitle">Ï†ÑÏÜ° Ï§ë...</h3>
      <img id="progressIcon" src="https://i.gifer.com/ZZ5H.gif" alt="Î°úÎî© Ï§ë"
        style="width:80px;height:80px;margin-bottom:20px;">
      <p id="progressStatusText" style="margin-bottom:20px;font-size:1.1em;color:#333;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî...</p>
      <div style="background:#e0e0e0;border-radius:10px;padding:3px;overflow:hidden;">
        <div id="progressBar"
          style="width:0%;height:20px;background:#007bff;border-radius:7px;transition:width 0.5s ease-in-out;"></div>
      </div>
      <button id="progressModalCloseBtn" class="btn-checkout" style="display:none;margin-top:25px;background:#7f8c8d;"
        onclick="hideProgressModal()">Îã´Í∏∞</button>
    </div>
  </div>

  <!-- VIDEO MODAL -->
  <div id="videoModal" class="modal-overlay">
    <div class="modal-content" style="max-width:800px;text-align:left;">
      <span class="modal-close" onclick="closeVideoModal()">&times;</span>
      <h3 id="videoModalTitle" style="margin-bottom:10px;">ÏòÅÏÉÅ Î≥¥Í∏∞</h3>
      <div style="position:relative;width:100%;padding-bottom:56.25%;height:0;">
        <iframe id="youtubeVideo" style="position:absolute;top:0;left:0;width:100%;height:100%;" src="" frameborder="0"
          allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture"
          allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- LOAD ORDER MODAL -->
  <div id="loadOrderModal" class="modal-overlay">
    <div class="modal-content" style="text-align:left;">
      <span class="modal-close" onclick="closeLoadModal()">&times;</span>
      <div class="modal-title">Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î∂àÎü¨Ïò§Í∏∞</div>
      <div class="form-row"><label>Ìú¥ÎåÄÌè∞</label><input type="tel" id="load-phone" placeholder="010-1234-5678"></div>
      <div class="form-row"><label>Ï£ºÎ¨∏Î≤àÌò∏</label><input type="text" id="load-orderNo" placeholder="Ïòà: 20240718-001"></div>
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-checkout" style="background:linear-gradient(135deg,#3498db,#2980b9);"
          id="loadOrderConfirmBtn" onclick="confirmLoadOrder()">ÌôïÏù∏</button>
        <button class="btn-checkout" style="background:#7f8c8d;" onclick="closeLoadModal()">Ï∑®ÏÜå</button>
      </div>
    </div>
  </div>

  <div id="reportContainer"></div>
</body>

</html>
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì•„ì´ë¦°ê°€êµ¬ - AI ëª©ì¬ ê²¬ì  ì±„íŒ…</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .header .subtitle {
      font-size: 11px;
      opacity: .8;
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-panel {
      width: 420px;
      min-width: 300px;
      max-width: 70vw;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e0e0;
      background: #fdfdfd;
      flex-shrink: 0;
    }

    .splitter {
      width: 8px;
      background: #eee;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 100;
      flex-shrink: 0;
    }

    .splitter:hover,
    .splitter.active {
      background: #3498db;
    }

    .splitter::after {
      content: "";
      width: 2px;
      height: 30px;
      background: #ccc;
      border-radius: 1px;
    }

    .splitter:hover::after,
    .splitter.active::after {
      background: #fff;
    }

    .preview-panel {
      flex: 1;
      background: #1a1a2e;
      display: flex;
      flex-direction: column;
      min-width: 0;
      position: relative;
    }

    .preview-canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-height: 0;
    }

    #previewCanvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    .msg {
      max-width: 92%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 13.5px;
      line-height: 1.6;
      word-break: break-word;
      animation: fadeIn .3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .bot-msg {
      background: #f0f4ff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      color: #222;
    }

    .msg.full {
      max-width: 100%;
      padding: 0;
      background: none;
      box-shadow: none;
    }

    .user-msg {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .chat-input-area input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 13.5px;
      outline: none;
      transition: border .2s;
    }

    .chat-input-area input:focus {
      border-color: #3498db;
    }

    .chat-input-area button {
      padding: 10px 18px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 13.5px;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
    }

    .sns-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      text-decoration: none;
      font-size: 16px;
      font-weight: 800;
      flex-shrink: 0;
      transition: all .2s;
    }

    .sns-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
    }

    .sns-naver {
      background: #03c75a;
      color: #fff;
    }

    .sns-kakao {
      background: #FEE500;
      color: #3C1E1E;
    }

    /* 3D Interactive Tag */
    .proc-tag {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.98);
      border: 1.5px solid #3498db;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      pointer-events: auto !important;
      transition: all 0.2s;
      min-width: 60px;
      position: relative;
    }

    .proc-tag:hover {
      background: #fff;
      border-color: #2980b9;
      transform: translateY(-2px);
    }

    /* Accessory UI */
    .acc-card {
      position: relative;
      background: #fff;
      border: 2px solid #3498db;
      border-radius: 16px;
      padding: 20px;
      margin: 8px 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .acc-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 2px solid #f0f2f5;
      padding-bottom: 10px;
    }

    .acc-card-title {
      font-size: 18px;
      font-weight: 800;
      color: #2c3e50;
    }

    .acc-close-btn {
      background: #f0f2f5;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      color: #7f8c8d;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .acc-close-btn:hover {
      background: #e74c3c;
      color: #fff;
    }

    .acc-back-btn {
      background: #f0f2f5;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
      transition: all 0.2s;
    }

    .acc-back-btn:hover {
      background: #e0e0e0;
    }

    .acc-category-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .acc-category {
      background: #f8f9fa;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .acc-category:hover {
      border-color: #3498db;
      background: #eef7ff;
      transform: translateY(-2px);
    }

    .acc-category.active {
      border-color: #3498db;
      background: #3498db;
      color: #fff;
    }

    .acc-category img {
      width: 48px;
      height: 48px;
      margin-bottom: 8px;
    }

    .acc-category div {
      font-size: 13px;
      font-weight: 700;
    }

    .acc-item-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .acc-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border: 1px solid #f0f2f5;
      border-radius: 12px;
      background: #fff;
      transition: border-color 0.2s;
    }

    .acc-item:hover {
      border-color: #3498db;
    }

    .acc-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .acc-info {
      flex: 1;
      min-width: 0;
      /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
    }

    .acc-name {
      font-size: 15px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
      line-height: 1.4;
      word-break: keep-all;
      /* ë‹¨ì–´ ë‹¨ìœ„ ì¤„ë°”ê¿ˆ */
    }

    .acc-price {
      font-size: 14px;
      color: #e74c3c;
      font-weight: 700;
    }

    .acc-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
      /* ë²„íŠ¼ ì˜ì—­ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
    }

    .acc-qty {
      width: 50px;
      height: 38px;
      padding: 0;
      border: 2px solid #eee;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      box-sizing: border-box;
    }

    .acc-add-btn {
      height: 38px;
      padding: 0 16px;
      background: #2ecc71;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }

    .acc-add-btn:hover {
      background: #27ae60;
    }

    .proc-tag-name {
      font-size: 11px;
      font-weight: 700;
      color: #2c3e50;
      line-height: 1.3;
      text-align: center;
    }

    .proc-tag-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      color: #e74c3c;
      border: 1.5px solid #e74c3c;
      border-radius: 50%;
      font-size: 9px;
      font-weight: 800;
      transition: all 0.2s;
      z-index: 10;
    }

    .proc-tag-remove:hover {
      background: #e74c3c;
      color: #fff;
    }

    #proc-tag-overlay {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
      z-index: 100;
      pointer-events: none;
    }

    .quick-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .quick-btn {
      display: inline-block;
      padding: 6px 12px;
      background: #fff;
      border: 1.5px solid #3498db;
      color: #3498db;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
      font-weight: 500;
    }

    .quick-btn:hover {
      background: #3498db;
      color: #fff;
    }

    .estimate-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-radius: 16px;
      padding: 16px;
      margin-top: 8px;
    }

    .estimate-card h3 {
      font-size: 15px;
      margin-bottom: 10px;
    }

    .estimate-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, .15);
    }

    .estimate-row:last-child {
      border: none;
    }

    .estimate-total {
      font-size: 18px;
      font-weight: 700;
      text-align: right;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 2px solid rgba(255, 255, 255, .3);
    }

    .estimate-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .estimate-actions button {
      flex: 1;
      padding: 8px 0;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-add-order {
      background: #2ecc71;
      color: #fff;
    }

    .btn-add-order:hover {
      background: #27ae60;
    }

    .btn-new-est {
      background: rgba(255, 255, 255, .2);
      color: #fff;
    }

    .btn-new-est:hover {
      background: rgba(255, 255, 255, .35);
    }

    .preview-header {
      padding: 10px 16px;
      background: rgba(0, 0, 0, .3);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .preview-info {
      padding: 10px 16px;
      background: rgba(0, 0, 0, .2);
      color: #82b1ff;
      font-size: 12px;
      text-align: center;
      flex-shrink: 0;
    }

    .order-panel {
      background: #fff;
      width: 95%;
      max-width: 600px;
      max-height: 85vh;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .order-panel-header {
      padding: 14px 16px;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    /* ORDER TABLE STYLE */
    .order-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
      color: #333;
    }

    .order-table th {
      background: #f8f9fa;
      padding: 8px;
      border-bottom: 2px solid #ddd;
      font-weight: 600;
      text-align: left;
    }

    .order-table td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    .order-table tr:last-child td {
      border-bottom: none;
    }

    .order-table .shipping-row td {
      background: #fffdf0;
      color: #7f8c8d;
    }

    .order-table .discount-row td {
      background: #fff0f0;
      color: #c0392b;
    }

    .order-table .total-row td {
      background: #eaf2f8;
      font-weight: 700;
      border-top: 2px solid #3498db;
    }

    .oi-remove-btn {
      background: #ff6b6b;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 11px;
    }



    .order-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 12.5px;
      border-left: 4px solid #3498db;
    }

    .order-item .oi-title {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .order-item .oi-detail {
      color: #666;
    }

    .order-item .oi-price {
      font-weight: 700;
      color: #e74c3c;
      text-align: right;
      margin-top: 4px;
    }

    .order-item .oi-remove {
      float: right;
      background: none;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      line-height: 1;
    }

    .order-panel-footer {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: #fff;
    }

    .order-panel-footer .total-row {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .btn-checkout {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .status-bar {
      background: #2c3e50;
      color: #82b1ff;
      padding: 6px 20px;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .customer-form {
      background: #fff;
      border-radius: 12px;
      padding: 14px;
      margin-top: 8px;
      border: 1px solid #e0e0e0;
    }

    .customer-form h4 {
      margin-bottom: 10px;
      color: #2c3e50;
    }

    .form-row {
      margin-bottom: 8px;
    }

    .form-row label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 3px;
    }

    .form-row input,
    .form-row textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
    }

    .form-row input:focus,
    .form-row textarea:focus {
      border-color: #3498db;
    }

    .btn-submit-order {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }

    .payment-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .payment-link {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
    }

    /* ê°€ê³µ ì˜µì…˜ (ë³µìˆ˜ ì„ íƒ - ì›ë³¸ ìŠ¤íƒ€ì¼) */
    .proc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .proc-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 2px solid #ddd;
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all .2s;
      font-size: 11px;
      background: #fff;
    }

    .proc-item img {
      width: 100%;
      max-width: 60px;
      height: auto;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .proc-item.selected {
      border: 3px solid #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, .5);
      background: #f0f7ff;
    }

    .proc-item.disabled {
      opacity: .4;
      pointer-events: none;
    }

    /* ê°€ê³µ ì„œë¸Œì˜µì…˜ */
    .proc-sub {
      margin-top: 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      font-size: 12px;
    }

    .proc-sub .sub-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 6px;
    }

    .proc-sub select,
    .proc-sub input[type="number"] {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
    }

    .side-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .side-item {
      padding: 6px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all .2s;
      background: #fff;
    }

    .side-item:hover {
      border-color: #3498db;
    }

    .side-item.active {
      border-color: #e74c3c;
      background: #fff0f0;
      color: #e74c3c;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 14px;
      align-self: flex-start;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #aaa;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: .2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: .4s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0)
      }

      40% {
        transform: scale(1)
      }
    }

    /* ëª©ì¬ ì„ íƒ ë²„íŠ¼ */
    .wood-btn-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 4px 0;
    }

    .wood-card-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: #fff;
      transition: all .2s;
      color: #333;
    }

    .wood-card-item:hover {
      border-color: #3498db;
      background: #f0f7ff;
    }

    .wood-card-item .wood-thumb {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid rgba(0, 0, 0, .1);
    }

    .wood-card-item .wood-label {
      flex: 1;
      min-width: 0;
    }

    .wood-card-item .wood-label .wname {
      font-size: 13px;
      font-weight: 700;
    }

    .wood-card-item .wood-label .wdesc {
      font-size: 11px;
      color: #888;
      margin-top: 1px;
    }

    .wood-btn-group {
      display: flex;
      gap: 5px;
      flex-shrink: 0;
    }

    .wood-btn-group button {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }

    .wood-btn-select {
      background: #2ecc71;
      color: #fff;
    }

    .wood-btn-select:hover {
      background: #27ae60;
    }

    .wood-btn-desc {
      background: #3498db;
      color: #fff;
    }

    .wood-btn-desc:hover {
      background: #2980b9;
    }

    /* ì±„íŒ… ë‚´ YouTube ì„ë² ë“œ */
    .yt-embed-wrap {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      height: 0;
      border-radius: 12px;
      overflow: hidden;
      margin: 12px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid #eee;
    }

    .yt-embed-wrap iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .wood-detail-card {
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a2e;
      margin-top: 6px;
      animation: wdSlide .3s ease;
    }

    @keyframes wdSlide {
      from {
        opacity: 0;
        transform: translateY(-8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .wood-detail-card img {
      width: 100%;
      display: block;
      max-height: 180px;
      object-fit: cover;
    }

    .wood-detail-actions {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      background: #1a1a2e;
    }

    .wood-detail-actions button {
      flex: 1;
      padding: 9px 0;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-select-wood {
      background: #2ecc71;
      color: #fff;
    }

    .btn-select-wood:hover {
      background: #27ae60;
    }

    .btn-youtube {
      background: #ff0000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .btn-youtube:hover {
      background: #cc0000;
    }

    .btn-youtube svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }

    .event-tag {
      display: inline-block;
      background: #fff0f6;
      color: #e11d78;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      border: 1px solid #ffc2d8;
      margin-bottom: 4px;
    }

    @media(max-width:800px) {
      .main {
        flex-direction: column;
      }

      .chat-panel {
        width: 100%;
        max-width: 100%;
        height: 50vh;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }

      .preview-panel {
        height: 50vh;
      }

      .order-panel {
        width: 100%;
      }

      .proc-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #fff;
      width: 90%;
      max-width: 500px;
      border-radius: 20px;
      padding: 30px;
      position: relative;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    .instruction-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .instruction-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .instruction-row b {
      color: #e74c3c;
    }

    /* REPORT CONTAINER (HIDDEN) */
    #reportContainer {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 800px;
      background: #fff;
      padding: 40px;
      box-sizing: border-box;
      font-family: 'Pretendard', sans-serif;
    }
  </style>
</head>

<body>

  <div class="header">
    <div>
      <h1>ì•„ì´ë¦°ê°€êµ¬</h1>
      <div class="subtitle">AI ëª©ì¬ ê²¬ì  ì‹œìŠ¤í…œ</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button onclick="openLoadModal()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button onclick="confirmReset()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">ì´ˆê¸°í™”</button>
      <button onclick="generateReport()"
        style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:11px;cursor:pointer;">ê²¬ì ì„œ</button>
      <button onclick="toggleOrderPanel()"
        style="background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 14px;border-radius:20px;font-size:12px;cursor:pointer;">
        ì£¼ë¬¸ëª©ë¡ <span id="orderBadge"
          style="background:#e74c3c;border-radius:50%;padding:1px 6px;font-size:11px;margin-left:4px;display:none;">0</span>
      </button>
    </div>
  </div>

  <div class="main">
    <div class="chat-panel">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="ì˜ˆ: MDF 400x1000 2ì¥"
          onkeydown="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">ì „ì†¡</button>
        <a href="https://talk.naver.com/profile/wc80z0" target="_blank" class="sns-btn sns-naver"
          title="ë„¤ì´ë²„ í†¡í†¡ ìƒë‹´">N</a>
        <a href="http://pf.kakao.com/_NKxaxcl/chat" target="_blank" class="sns-btn sns-kakao" title="ì¹´ì¹´ì˜¤í†¡ ìƒë‹´">K</a>
      </div>
    </div>
    <div class="splitter" id="splitter"></div>
    <div class="preview-panel">
      <div class="preview-header"><span>3D ë¯¸ë¦¬ë³´ê¸°</span><span id="previewDim"
          style="font-size:11px;color:#82b1ff;">-</span></div>
      <div class="preview-canvas-wrap">
        <canvas id="previewCanvas"></canvas>
        <div id="labels-container"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden;">
        </div>
        <div id="proc-tag-overlay"></div>
      </div>
      <div class="preview-info" id="previewInfo"></div>
    </div>
  </div>

  <div id="orderPanelOverlay" class="modal-overlay">
    <div class="order-panel" id="orderPanel"></div>
  </div>

  <div class="status-bar"><span id="statusLeft">ëŒ€ê¸° ì¤‘</span><span id="statusRight"></span></div>
  <div id="reportContainer"
    style="position:absolute;left:-9999px;top:0;width:800px;background:#fff;padding:30px;font-family:'Noto Sans KR',sans-serif;">
  </div>

  <script>
    // ============================================================
    // CONFIG & URLs (ì›ë³¸ ê·¸ëŒ€ë¡œ)
    // ============================================================
    const PRICE_API_URL = 'https://script.google.com/macros/s/AKfycbzkTCXtkfn0zmQkXB3xFZEaczyHquAuGGZu_3KMiMHVz6SEGXvMbZV56EE8u7o-zEoLMw/exec';
    const API_URL = 'https://script.google.com/macros/s/AKfycbzXHDF31Hi_yZaDR_BG_GfDdcY7a8h_9wShpptcvfCOP-EEUgLQTalICjOtXGfZkpiFpw/exec';
    const SESSION_ID = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

    // ============================================================
    // WOOD DATA (ì›ë³¸ ì´ë¯¸ì§€/í…ìŠ¤ì²˜ URL ì‚¬ìš©)
    // ============================================================
    const WOOD_DATA = {
      mdf18T: { name: 'MDF 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/mdf.png', thickness: 18, desc: 'ê°€ì„±ë¹„ ì¢‹ì€ ê¸°ë³¸ í•©íŒ', canSand: false, canCoat: false },
      pvc18T: { name: 'PVCë³´ë“œ 18T+PET (ì™„ì „ë°©ìˆ˜)', image: 'https://gi.esmplus.com/irn2011/click/texture/pvc.png', thickness: 18, desc: 'ì™„ì „ë°©ìˆ˜ Â· ìš•ì‹¤/ì£¼ë°© ì¶”ì²œ', canSand: false, canCoat: false },
      misong18T: { name: 'ë¯¸ì†¡ì§‘ì„±ëª© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/misong.png', thickness: 18, desc: 'ë¶€ë“œëŸ¬ìš´ ì›ëª© ëŠë‚Œ', canSand: true, canCoat: true },
      pyeonbaek18T: { name: 'í¸ë°±ì§‘ì„±ëª© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/pyenon.png', thickness: 18, desc: 'í”¼í†¤ì¹˜ë“œ Â· í”„ë¦¬ë¯¸ì—„ ì›ëª©', canSand: true, canCoat: true },
      mulbau18T: { name: 'ë©€ë°”ìš° ì§‘ì„±ëª© 18T', image: 'https://gi.esmplus.com/irn2011/click/texture/mulbau.png', thickness: 18, desc: 'ê³ ê¸‰ í•˜ë“œìš°ë“œ Â· ê°•í•œ ë‚´êµ¬ì„±', canSand: true, canCoat: true }
    };

    const WOOD_YOUTUBE = {
      mdf18T: 'https://youtu.be/gb2ETOmWzAI',
      pvc18T: 'https://youtu.be/iKc5odpOETg',
      misong18T: 'https://youtu.be/vk0Pa0uXu1w',
      pyeonbaek18T: 'https://youtu.be/xdmOsSKHXQU',
      mulbau18T: 'https://youtu.be/zxTFCZ9oIdk'
    };

    const WOOD_KEYS = ['mdf18T', 'pvc18T', 'misong18T', 'pyeonbaek18T', 'mulbau18T'];

    // ê°€ê³µ ì˜µì…˜ (ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©, ë³µìˆ˜ ì„ íƒ)
    const PROC_OPTIONS = [
      { key: 'none', label: 'ê°€ê³µì—†ìŒ', image: 'https://gi.esmplus.com/irn2011/click/texture/null.png', group: 'none' },
      { key: 'sanding', label: 'ìƒŒë”©', image: 'https://gi.esmplus.com/irn2011/click/texture/sanding.png', group: 'base', event: 'í•œ ì¥ ë¬´ë£Œ ìƒŒë”©!' },
      { key: 'coating', label: 'íˆ¬ëª…ì½”íŒ…', image: 'https://gi.esmplus.com/irn2011/click/texture/coating.png', group: 'base' },
      { key: 'angled', label: 'ì‚¬ì„ ê°€ê³µ', image: 'https://gi.esmplus.com/irn2011/click/texture/45dgree.png', group: 'extra', event: 'í•œ ë©´ ë¬´ë£Œ!', needSides: true },
      { key: 'round', label: 'ëª¨ì„œë¦¬ ë¼ìš´ë“œ', image: 'https://gi.esmplus.com/irn2011/click/texture/round.png', group: 'extra', event: 'í•œ ê¼­ì§€ì  ë¬´ë£Œ!', needCorners: true },
      { key: 'circlecut', label: 'ì›í˜•íƒ€ê³µ', image: 'https://gi.esmplus.com/irn2011/click/texture/circle.png', group: 'extra', event: 'í•œ ê°œ ë¬´ë£Œ!' },
      { key: 'squarecut', label: 'ì‚¬ê°íƒ€ê³µ', image: 'https://gi.esmplus.com/irn2011/click/texture/sagak.png', group: 'extra', event: 'í•œ ê°œ ë¬´ë£Œ!' },
      { key: 'hinge', label: 'ì‹±í¬ê²½ì²©', image: 'https://gi.esmplus.com/irn2011/click/texture/hinge.png', group: 'extra', event: '2ê°œ ë¬´ë£Œ ì‹œê³µ!' }
    ];

    // ============================================================
    // STATE
    // ============================================================
    let currentWood = 'woodType1'; // ê¸°ë³¸ê°’ (ì¶”í›„ ì´ˆê¸°í™”)
    let currentWidth = 0, currentLength = 0, currentQty = 1;
    let selectedProcs = new Set(); // ë³µìˆ˜ ì„ íƒ í‚¤ ì§‘í•©
    let procDetails = {}; // {angled:{sides:['A','B']}, round:{corners:['1','3']}, ...}
    let lastFocusedOption = null;

    // --- ì´ˆê¸°í™” ---
    let orderList = [];
    let lastSubmittedOrders = []; // ì£¼ë¬¸ ì™„ë£Œ í›„ ê²¬ì ì„œ ì €ì¥ì„ ìœ„í•œ ë°±ì—…
    let priceTable = [], openWoodDetail = null;
    let scene, camera, renderer, controls, boardGroup, woodMesh, sceneObjects = [];

    // ============================================================
    // INIT
    // ============================================================
    window.addEventListener('DOMContentLoaded', async () => {
      init3D();
      loadPriceTable();
      showGreeting();
      initSplitter(); // ìŠ¤í”Œë¦¬í„° ì´ˆê¸°í™”
    });

    // ============================================================
    // SPLITTER (RESIZE)
    // ============================================================
    function initSplitter() {
      const splitter = document.getElementById('splitter');
      const chatPanel = document.querySelector('.chat-panel');
      const main = document.querySelector('.main');
      let isDragging = false;

      splitter.addEventListener('mousedown', (e) => {
        isDragging = true;
        splitter.classList.add('active');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none'; // ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        // ë©”ì¸ ì»¨í…Œì´ë„ˆì— ëŒ€í•œ ìƒëŒ€ì  X ì¢Œí‘œ ê³„ì‚°
        const mainRect = main.getBoundingClientRect();
        let newWidth = e.clientX - mainRect.left;

        // ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œí•œ
        if (newWidth < 300) newWidth = 300;
        if (newWidth > mainRect.width * 0.7) newWidth = mainRect.width * 0.7;

        chatPanel.style.width = newWidth + 'px';

        // 3D ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì¦ˆ (ì¦‰ì‹œ ë°˜ì˜)
        onWindowResize();
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          splitter.classList.remove('active');
          document.body.style.cursor = '';
          document.body.style.removeProperty('user-select');
          onWindowResize(); // ìµœì¢… ë¦¬ì‚¬ì´ì¦ˆ
        }
      });
    }

    function showGreeting() {
      // ì²« ì¸ì‚¬ ì‹œí€€ìŠ¤
      showTyping();
      setTimeout(() => {
        hideTyping();
        addBotMessage(`
          <div style="font-size: 1.1em; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”! ì•„ì´ë¦°ê°€êµ¬ AI ë¹„ì„œì…ë‹ˆë‹¤.</div>
          ì›í•˜ì‹œëŠ” ëª©ì¬ì˜ ì¢…ë¥˜ì™€ ì‚¬ì´ì¦ˆ(ê°€ë¡œxì„¸ë¡œ)ë¥¼ ë§ì”€í•´ì£¼ì‹œë©´, 
          <b>3D ë¯¸ë¦¬ë³´ê¸°</b>ì™€ í•¨ê»˜ <b>ì‹¤ì „ ê²¬ì </b>ì„ ì¦‰ì‹œ ê³„ì‚°í•´ ë“œë¦´ê²Œìš”.<br><br>
          ë¨¼ì € ì•„ë˜ì—ì„œ ì›í•˜ì‹œëŠ” ëª©ì¬ë¥¼ ì„ íƒí•˜ì‹œê±°ë‚˜, ì±„íŒ…ì°½ì— "MDF 400x600 2ì¥ ì¬ë‹¨í•´ì¤˜"ì™€ ê°™ì´ ì…ë ¥í•´ ë³´ì„¸ìš”!<br><br>
          í˜¹ì‹œ ì–´ë–¤ ëª©ì¬ë¥¼ ì„ íƒí• ì§€ ê³ ë¯¼ë˜ì‹œë‚˜ìš”? <b>ì‚¬ìš©í•˜ì‹¤ ìš©ë„</b>ë¥¼ ë§ì”€í•´ ì£¼ì‹œë©´ ë”± ë§ëŠ” ëª©ì¬ë¥¼ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”.
        `);

        // ëª©ì¬ ì¹´ë“œ í‘œì‹œ (ì•½ê°„ì˜ ì§€ì—° í›„)
        setTimeout(() => {
          showWoodCards();
        }, 600);
      }, 600);
    }

    // ============================================================
    // PRICE TABLE (ì›ë³¸ ê·¸ëŒ€ë¡œ)
    // ============================================================
    async function loadPriceTable() {
      try {
        const r = await fetch(PRICE_API_URL);
        priceTable = await r.json();
        updateStatus('ë‹¨ê°€í‘œ ë¡œë“œ ì™„ë£Œ', '');
      } catch (e) {
        console.warn('ë‹¨ê°€í‘œ ë¡œë“œ ì‹¤íŒ¨:', e);
        updateStatus('ë‹¨ê°€í‘œ ë¡œë“œ ì‹¤íŒ¨', '');
      }
    }

    // ì›ë³¸ getUnitPrice ê·¸ëŒ€ë¡œ
    function getUnitPrice(woodTypeId, area) {
      if (!priceTable.length || area <= 0) return 0;
      for (const tier of priceTable) {
        if (area <= tier.area) return tier[woodTypeId] || 0;
      }
      return 0;
    }

    // ì›ë³¸ ì½”íŒ… ê°€ê²© ê·¸ëŒ€ë¡œ
    function getCoatingPrices() {
      const length = currentLength || 0;
      let s = 0;
      if (length <= 600) s = 5000;
      else if (length <= 1200) s = 10000;
      else s = 15000;
      return { single: s, double: s * 2 };
    }

    // ì›ë³¸ ë°°ì†¡ë¹„ ê·¸ëŒ€ë¡œ
    function getBaseShippingCost(length) {
      if (length <= 600) return 5000;
      if (length <= 1200) return 8000;
      return 10000;
    }
    function calculateShippingCost(orders) {
      if (!orders || !orders.length) return [];
      const hasWood = orders.some(o => o.woodTypeValue);
      if (!hasWood) return [{ cost: 4000, sizeCategory: 'ë¶€ìì¬ ê¸°ë³¸ ë°°ì†¡ë¹„', count: 1 }];
      const pieces = [];
      orders.forEach(o => {
        if (o.woodTypeValue) {
          for (let i = 0; i < parseInt(o.quantity); i++) {
            const w = parseFloat(o.width), l = parseFloat(o.length);
            pieces.push({ width: Math.min(w, l), length: Math.max(w, l) });
          }
        }
      });
      if (!pieces.length) return [];
      pieces.sort((a, b) => (b.width * b.length) - (a.width * a.length));
      const packs = [];
      pieces.forEach(p => {
        let packed = false;
        for (const pk of packs) {
          if (pk.pieces.length < 5 && p.width <= pk.base.width && p.length <= pk.base.length) { pk.pieces.push(p); packed = true; break; }
        }
        if (!packed) packs.push({ base: p, pieces: [p] });
      });
      const grouped = {};
      packs.forEach(pk => {
        const cost = getBaseShippingCost(pk.base.length);
        if (!grouped[cost]) grouped[cost] = { cost, sizeCategory: pk.base.length <= 600 ? '600mm ì´í•˜' : pk.base.length <= 1200 ? '601~1200mm' : '1201~1800mm', count: 0 };
        grouped[cost].count++;
      });
      return Object.values(grouped);
    }

    // ============================================================
    // ê²¬ì  ê³„ì‚° (ì›ë³¸ calculate() ë¡œì§ ë°˜ì˜)
    // ============================================================
    function calculatePrice() {
      if (!currentWood || currentWidth <= 0 || currentLength <= 0) return null;
      const area = currentWidth * currentLength;
      const basePrice = getUnitPrice(currentWood, area);
      if (basePrice === 0 && area > 0) return null;

      let additionalCost = 0;
      let eventDiscount = 0;
      let discountDetails = [];

      selectedProcs.forEach(key => {
        const d = procDetails[key] || {};
        switch (key) {
          case 'sanding':
            additionalCost += 5000;
            eventDiscount += 5000;
            discountDetails.push('ìƒŒë”© ë¬´ë£Œ');
            break;
          case 'coating':
            const cp = getCoatingPrices();
            additionalCost += (d.type === 'ì–‘ë©´' ? cp.double : cp.single);
            break;
          case 'angled':
            const aSides = (d.sides || []).length;
            additionalCost += aSides * 1000;
            if (aSides > 0) { eventDiscount += 1000; discountDetails.push('ì‚¬ì„  1ë©´ ë¬´ë£Œ'); }
            break;
          case 'round':
            const rCorners = (d.corners || []).length;
            additionalCost += rCorners * 1000;
            if (rCorners > 0) { eventDiscount += 1000; discountDetails.push('ë¼ìš´ë“œ 1ê°œ ë¬´ë£Œ'); }
            break;
          case 'circlecut':
            const cCount = d.count || 1;
            additionalCost += cCount * 3000;
            if (cCount > 0) { eventDiscount += 3000; discountDetails.push('ì›í˜•íƒ€ê³µ 1ê°œ ë¬´ë£Œ'); }
            break;
          case 'squarecut':
            const sCount = d.count || 1;
            additionalCost += sCount * 4000;
            if (sCount > 0) { eventDiscount += 4000; discountDetails.push('ì‚¬ê°íƒ€ê³µ 1ê°œ ë¬´ë£Œ'); }
            break;
          case 'hinge':
            const hCount = d.count || 2;
            additionalCost += hCount * 1000;
            const hDisc = Math.min(hCount, 2);
            if (hDisc > 0) { eventDiscount += hDisc * 1000; discountDetails.push(`ê²½ì²© ${hDisc}ê°œ ë¬´ë£Œ`); }
            break;
        }
      });

      const origPerPiece = basePrice + additionalCost;
      const origTotal = origPerPiece * currentQty;
      const totalDiscount = eventDiscount * currentQty;
      const finalTotal = origTotal - totalDiscount;
      const shipping = calculateShippingFromCurrent(finalTotal);

      return {
        basePrice, additionalCost, origPerPiece, origTotal,
        eventDiscount, totalDiscount, discountDetails,
        finalTotal, shipping,
        grandTotal: finalTotal + shipping
      };
    }

    function calculateShippingFromCurrent(totalPrice) {
      // ê°„ì†Œí™”: í˜„ì¬ ê²¬ì  1ê±´ ê¸°ì¤€ ë°°ì†¡ë¹„
      if (currentLength <= 600) return 5000;
      if (currentLength <= 1200) return 8000;
      return 10000;
    }

    // ============================================================
    // CHAT HELPERS
    // ============================================================
    function addBotMessage(html, isFull = false) {
      const d = document.createElement('div');
      d.className = 'msg bot-msg' + (isFull ? ' full' : '');
      d.innerHTML = html;
      document.getElementById('chatMessages').appendChild(d);
      scrollChat();
    }
    function addUserMessage(text) { const d = document.createElement('div'); d.className = 'msg user-msg'; d.textContent = text; document.getElementById('chatMessages').appendChild(d); scrollChat(); }

    function clearChatAndStartNew() {
      document.getElementById('chatMessages').innerHTML = '';
      resetEstimate();
      showGreeting();
    }
    function scrollChat() { const c = document.getElementById('chatMessages'); setTimeout(() => { c.scrollTop = c.scrollHeight; }, 50); }
    function showTyping() { const d = document.createElement('div'); d.className = 'typing-indicator'; d.id = 'typingIndicator'; d.innerHTML = '<span></span><span></span><span></span>'; document.getElementById('chatMessages').appendChild(d); scrollChat(); }
    function hideTyping() { const e = document.getElementById('typingIndicator'); if (e) e.remove(); }
    function updateStatus(l, r) { document.getElementById('statusLeft').textContent = l || ''; document.getElementById('statusRight').textContent = r || ''; }

    async function postToServer(data) {
      const r = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, body: JSON.stringify(data) });
      return await r.json();
    }

    // ============================================================
    // SEND & PROCESS
    // ============================================================
    function sendMessage() {
      const inp = document.getElementById('chatInput'); const t = inp.value.trim(); if (!t) return;
      inp.value = ''; addUserMessage(t);
      // ë¡œì»¬ ì²˜ë¦¬ê°€ ì„±ê³µí•˜ë©´ AIì—ê²Œ ë³´ë‚´ì§€ ì•ŠìŒ
      if (processInput(t)) return;
      sendToAI(t);
    }

    function processInput(text) {
      const lo = text.toLowerCase().replace(/\s+/g, '');

      // 0) ê°€ê²© ë¹„êµ ìš”ì²­ ê°ì§€ (ì‚¬ì´ì¦ˆ + ì €ë ´/ì‹¼/ë¹„êµ/ì¶”ì²œ í‚¤ì›Œë“œ)
      const sizeMatch = text.match(/(\d{2,4})\s*[xXÃ—\*]\s*(\d{2,4})/);
      const isPriceQuery = lo.includes('ì €ë ´') || lo.includes('ì‹¼') || lo.includes('ë¹„êµ') || lo.includes('ê°€ê²©') || lo.includes('ì–¼ë§ˆ');
      if (sizeMatch && isPriceQuery) {
        const w = parseInt(sizeMatch[1]), l = parseInt(sizeMatch[2]);
        const qm = text.match(/(\d+)\s*ì¥/);
        const q = qm ? parseInt(qm[1]) : null;
        compareWoodPrices(w, l, q);
        return true;
      }

      // 1) ëª©ì¬ ì„ íƒ
      const isConsulting = lo.includes('ì¶”ì²œ') || lo.includes('ì–´ë•Œ') || lo.includes('ì–´ë–¤') || lo.includes('ìƒë‹´') || lo.includes('ì¢‹ì•„');
      const aliases = { mdf18T: ['mdf'], pvc18T: ['pvc', 'í”¼ë¸Œì´ì”¨'], misong18T: ['ë¯¸ì†¡'], pyeonbaek18T: ['í¸ë°±'], mulbau18T: ['ë©€ë°”ìš°'] };
      if (!isConsulting) {
        for (const key of WOOD_KEYS) {
          if (aliases[key].some(a => lo.includes(a))) {
            selectWood(key);
            const sm = text.match(/(\d{2,4})\s*[xXÃ—\*]\s*(\d{2,4})/);
            if (sm) {
              const w = parseInt(sm[1]), l = parseInt(sm[2]);
              const qm = text.match(/(\d+)\s*ì¥/);
              if (qm) {
                setSize(w, l, parseInt(qm[1]));
                parseProcessingsFromText(text);
                if (selectedProcs.size) showEstimate();
              } else {
                setSize(w, l, null); // ìˆ˜ëŸ‰ ì—†ìŒ -> setSizeë¡œ ë„˜ê²¨ì„œ ê²½ê³  ì²´í¬ í›„ ìˆ˜ëŸ‰ ì…ë ¥ ìš”ì²­
              }
            }
            return true;
          }
        }
      }

      // 2) ì‚¬ì´ì¦ˆë§Œ ë“¤ì–´ì˜¨ ê²½ìš°
      const sm = text.match(/(\d{2,4})\s*[xXÃ—\*]\s*(\d{2,4})/);
      if (sm && currentWood) {
        const w = parseInt(sm[1]), l = parseInt(sm[2]), qm = text.match(/(\d+)\s*ì¥/);
        if (qm) {
          setSize(w, l, parseInt(qm[1]));
          parseProcessingsFromText(text);
          if (selectedProcs.size) showEstimate();
        } else {
          setSize(w, l, null); // ìˆ˜ëŸ‰ ì—†ìŒ -> setSizeë¡œ ë„˜ê²¨ì„œ ê²½ê³  ì²´í¬ í›„ ìˆ˜ëŸ‰ ì…ë ¥ ìš”ì²­
        }
        return true;
      }

      // 3) ìˆ˜ëŸ‰ (ìˆ«ìë§Œ ìˆê±°ë‚˜ 'ì¥', 'ê°œ' ë“±ì´ ë¶™ì€ ê²½ìš°)
      // "2ì¥ì´ìš”", "2ê°œ", "2" ë“± ì²˜ë¦¬
      const qo = text.match(/(\d+)\s*(?:ì¥|ê°œ|ìš”|ì¥ì´ìš”|ê°œìš”)?/);
      // ë‹¨, ë¬¸ì¥ì— ë‹¤ë¥¸ ìˆ«ìê°€ ì„ì—¬ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ^...$ ë³´ë‹¤ëŠ” ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì²˜ë¦¬í•˜ë˜, 
      // ë§Œì•½ currentWidth/Lengthê°€ ì„¤ì •ëœ ìƒíƒœì—ì„œ ë“¤ì–´ì˜¨ ì§§ì€ ìˆ«ìë¼ë©´ ìˆ˜ëŸ‰ìœ¼ë¡œ ê°„ì£¼
      if (qo && currentWood && currentWidth > 0 && currentLength > 0 && (text.length < 10 || lo.includes('ì¥') || lo.includes('ê°œ'))) {
        currentQty = parseInt(qo[1]);
        addBotMessage(`ìˆ˜ëŸ‰: <b>${currentQty}ì¥</b> í™•ì¸í–ˆìŠµë‹ˆë‹¤.<br>ê°€ê³µ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)`);
        showProcessingOptions();
        updateWoodModel();
        updateStatus('ê°€ê³µ ì˜µì…˜ ëŒ€ê¸°', '');
        return true;
      }

      // 4) í‚¤ì›Œë“œ
      // 4) í‚¤ì›Œë“œ
      if (lo === 'ì£¼ë¬¸' || (lo.includes('ì£¼ë¬¸') && orderList.length > 0)) { initiateOrder(); return true; }
      if (lo === 'ì´ˆê¸°í™”' || lo === 'ë¦¬ì…‹') { resetAll(); return true; }
      if (lo === 'ëª©ì¬' || lo === 'ì¢…ë¥˜' || lo.includes('ëª©ì¬ì¢…ë¥˜')) { showWoodCards(); return true; }

      // 5) ë¶€ìì¬ ë° ê¸°íƒ€ ê¸°ëŠ¥ (í†µí•©ë¨)
      if (lo.includes('ë¶€ìì¬') || lo.includes('í”¼ìŠ¤') || lo.includes('ì‚¬í¬') || lo.includes('ì—£ì§€') || lo.includes('í…Œì´í”„')) {
        // ì§ˆë¬¸ í˜•íƒœ(ë­ì•¼, ë­”, ì–´ë–»ê²Œ, ì„¤ëª… ë“±)ì¸ ê²½ìš° ë¡œì»¬ì—ì„œ ê°€ë¡œì±„ì§€ ì•Šê³  AIì—ê²Œ ë„˜ê¹€
        const isQuestion = lo.includes('?') || lo.includes('ë­') || lo.includes('ë­”') || lo.includes('ë¬´ì—‡') || lo.includes('ì„¤ëª…') || lo.includes('ì–´ë–»ê²Œ') || lo.includes('ì–´ë–¤') || lo.includes('ì˜ë¯¸');
        if (!isQuestion) {
          if (lo.includes('í”¼ìŠ¤')) showSpecificAccessoryCategory('screws');
          else if (lo.includes('ì‚¬í¬')) showSpecificAccessoryCategory('sandpaper');
          else if (lo.includes('ì—£ì§€') || lo.includes('í…Œì´í”„')) showSpecificAccessoryCategory('tape');
          else showAccessoryCategories();
          return true;
        }
      }
      if (lo.includes('ë¶ˆëŸ¬ì˜¤ê¸°') || lo.includes('ì´ì „ì£¼ë¬¸')) { openLoadModal(); return true; }

      return false;
    }

    function parseProcessingsFromText(text) {
      const lo = text.toLowerCase();
      if (lo.includes('ì‚¬ì„ ') || lo.includes('êº½ê¸°')) {
        selectedProcs.add('angled');
        const sides = [];
        if (/[aAê°€]/.test(text)) sides.push('A'); if (/[bBë‚˜]/.test(text)) sides.push('B');
        if (/[cCë‹¤]/.test(text)) sides.push('C'); if (/[dDë¼]/.test(text)) sides.push('D');
        procDetails.angled = { sides: sides.length ? sides : ['A'] };
      }
      if (lo.includes('ë¼ìš´ë“œ') || lo.includes('ë‘¥ê¸€')) {
        selectedProcs.add('round'); procDetails.round = { corners: ['1'] };
      }
      if (lo.includes('ì›í˜•') || lo.includes('ì›ì»·')) { selectedProcs.add('circlecut'); procDetails.circlecut = { count: 1 }; }
      if (lo.includes('ì‚¬ê°ì»·') || lo.includes('ì‚¬ê°í™€')) { selectedProcs.add('squarecut'); procDetails.squarecut = { count: 1 }; }
      if (lo.includes('ê²½ì²©')) { const hm = text.match(/(\d+)\s*ê°œ/); selectedProcs.add('hinge'); procDetails.hinge = { count: hm ? parseInt(hm[1]) : 2 }; }
      if (lo.includes('ì½”íŒ…') && lo.includes('ì–‘')) { selectedProcs.add('coating'); procDetails.coating = { type: 'ì–‘ë©´' }; }
      else if (lo.includes('ì½”íŒ…')) { selectedProcs.add('coating'); procDetails.coating = { type: 'ë‹¨ë©´' }; }
      if (lo.includes('ì‚¬í¬') || lo.includes('ìƒŒë”©')) { selectedProcs.add('sanding'); procDetails.sanding = {}; }

      if (selectedProcs.size) {
        addBotMessage('ê°€ê³µ: <b>' + getProcSummary() + '</b>');
        updateWoodModel();
      }
    }

    function getProcSummary() {
      if (!selectedProcs.size) return 'ê°€ê³µì—†ìŒ';
      return Array.from(selectedProcs).map(key => {
        const opt = PROC_OPTIONS.find(o => o.key === key);
        let label = opt ? opt.label : key;
        const d = procDetails[key] || {};
        if (key === 'angled' && d.sides) label += '(' + d.sides.join(',') + ')';
        if (key === 'round' && d.corners) label += '(' + d.corners.join(',') + ')';
        if (key === 'hinge' && d.count) label += '(' + d.count + 'ê°œ)';
        if (key === 'coating' && d.type) label += '(' + d.type + ')';
        if (key === 'circlecut') {
          if (d.holes && d.holes.length > 0) {
            const hStr = d.holes.map((h, idx) => `[${idx + 1}]X:${h.x},Y:${h.y},R:${h.r}`).join(' ');
            label += ` (${hStr})`;
          } else if (d.count) {
            label += '(' + d.count + 'ê°œ)';
          }
        }
        if (key === 'squarecut') {
          if (d.holes && d.holes.length > 0) {
            const hStr = d.holes.map((h, idx) => `[${idx + 1}]X:${h.x},Y:${h.y},W:${h.w},H:${h.h}`).join(' ');
            label += ` (${hStr})`;
          } else if (d.count) {
            label += '(' + d.count + 'ê°œ)';
          }
        }
        return label;
      }).join(' + ');
    }

    // ============================================================
    // AI
    // ============================================================
    async function sendToAI(text) {
      showTyping(); updateStatus('AI ì‘ë‹µ ëŒ€ê¸° ì¤‘...', '');
      try {
        const resp = await postToServer({ type: 'chat', cid: SESSION_ID, message: text });
        hideTyping();
        if (resp.result === 'error') { addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); updateStatus('ì˜¤ë¥˜', ''); return; }

        // ë°ì´í„° êµ¬ì¡° ë³´ì • (resp ìì²´ì— reply/actionì´ ìˆê±°ë‚˜ resp.dataì— ìˆëŠ” ê²½ìš° ëª¨ë‘ ëŒ€ì‘)
        const d = (resp.reply || resp.action) ? resp : (resp.data || resp);
        addBotMessage(d.reply || d.message || d.text || 'ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        // show_processing: ëª©ì¬+ì‚¬ì´ì¦ˆ+ìˆ˜ëŸ‰ì´ ëª¨ë‘ í™•ì • â†’ ì¶”ê°€ê°€ê³µ ì˜µì…˜ ë²„íŠ¼ í‘œì‹œ
        if (d.action === 'show_processing' && d.data) {
          if (d.data.woodType) currentWood = d.data.woodType;
          if (d.data.width) currentWidth = Number(d.data.width);
          if (d.data.length) currentLength = Number(d.data.length);
          if (d.data.qty) currentQty = Number(d.data.qty);
          selectedProcs.clear(); procDetails = {};
          updateWoodModel();
          showProcessingOptions();
          const wd = WOOD_DATA[currentWood];
          updateStatus(wd ? wd.name + ' ì„ íƒë¨' : 'ëª©ì¬ ì„ íƒë¨', 'ê°€ê³µ ì˜µì…˜ ì„ íƒ ëŒ€ê¸°');
        }

        // estimate: ì´ì „ í˜¸í™˜ìš© (í˜¹ì‹œ estimateê°€ ì˜¤ë©´ ê²¬ì  í‘œì‹œ)
        if (d.action === 'estimate' && d.data) {
          if (d.data.woodType) currentWood = d.data.woodType;
          if (d.data.width) currentWidth = Number(d.data.width);
          if (d.data.length) currentLength = Number(d.data.length);
          if (d.data.qty) currentQty = Number(d.data.qty);
          updateWoodModel(); showEstimate();
        }

        if (d.action === 'show_woods') showWoodCards();
        if (!['show_processing', 'estimate', 'show_woods'].includes(d.action)) updateStatus('ëŒ€ê¸° ì¤‘', '');
      } catch (e) { hideTyping(); addBotMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'); updateStatus('ì—°ê²° ì˜¤ë¥˜', ''); console.error(e); }
    }

    // ============================================================
    // WOOD SELECTION (ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©)
    // ============================================================
    function showWoodCards() {
      let h = '<div class="wood-btn-list">';
      WOOD_KEYS.forEach(key => {
        const wd = WOOD_DATA[key];
        h += `<div class="wood-card-item">
        <img class="wood-thumb" src="${wd.image}" alt="${wd.name}" onerror="this.style.display='none'">
        <div class="wood-label">
          <div class="wname">${wd.name}</div>
          <div class="wdesc">${wd.desc}</div>
        </div>
        <div class="wood-btn-group">
          <button class="wood-btn-select" onclick="selectWoodFromCard('${key}')">ì„ íƒ</button>
          <button class="wood-btn-desc" onclick="showWoodExplanation('${key}')">ì„¤ëª…</button>
        </div>
      </div>`;
      });
      h += '</div>';
      addBotMessage(h);
    }

    function showWoodExplanation(key) {
      const wd = WOOD_DATA[key];
      const ytUrl = WOOD_YOUTUBE[key] || '';
      if (!wd) return;

      // YouTube ì¸ë„¤ì¼ + í´ë¦­í•˜ë©´ ìƒˆ íƒ­ì—ì„œ ì—´ê¸° (file:// í™˜ê²½ì—ì„œ iframe Error 153 ë°©ì§€)
      let videoHtml = '';
      if (ytUrl) {
        let videoId = '';
        const shortMatch = ytUrl.match(/youtu\.be\/([\w-]+)/);
        const longMatch = ytUrl.match(/[?&]v=([\w-]+)/);
        videoId = shortMatch ? shortMatch[1] : (longMatch ? longMatch[1] : '');
        if (videoId) {
          videoHtml = `
            <a href="${ytUrl}" target="_blank" style="display:block;position:relative;border-radius:12px;overflow:hidden;margin-top:12px;cursor:pointer;text-decoration:none;">
              <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" style="width:100%;display:block;border-radius:12px;">
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:42px;background:rgba(255,0,0,0.85);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                <div style="width:0;height:0;border-style:solid;border-width:10px 0 10px 18px;border-color:transparent transparent transparent #fff;margin-left:3px;"></div>
              </div>
              <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.7);color:#fff;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;">â–¶ ì˜ìƒ ë³´ê¸°</div>
            </a>`;
        }
      }

      const descriptions = {
        mdf18T: 'MDF 18TëŠ” ê°€ì„±ë¹„ê°€ ì •ë§ ì¢‹ì€ ì†Œì¬ì˜ˆìš” ğŸ˜Š\n\nëª©ì¬ ì„¬ìœ ë¥¼ ì••ì¶•í•´ì„œ ë§Œë“¤ì–´ì„œ í‘œë©´ì´ ì•„ì£¼ ë§¤ë„ëŸ½ë‹µë‹ˆë‹¤. ë•ë¶„ì— í˜ì¸íŠ¸ ì¹ í•˜ê¸°ì—ë„ ì¢‹ê³ , ì„ ë°˜ì´ë‚˜ ìˆ˜ë‚©ì¥ ë§Œë“¤ ë•Œ ê°€ì¥ ë§ì´ ì“°ì—¬ìš”.',
        pvc18T: 'PVCë³´ë“œëŠ” ì™„ì „ ë°©ìˆ˜ê°€ íŠ¹ì§•ì´ì—ìš”! ğŸš¿\n\në¬¼ì´ ë‹¿ì•„ë„ ì©ì§€ ì•Šì•„ì„œ ìš•ì‹¤ì´ë‚˜ ì£¼ë°© ì‹±í¬ëŒ€ ì£¼ë³€ì— ì“°ê¸° ë”± ì¢‹ë‹µë‹ˆë‹¤. PET ì½”íŒ…ì´ ë˜ì–´ ìˆì–´ì„œ ê¹”ë”í•˜ê³  ì„¸íƒì‹¤ì´ë‚˜ ë°œì½”ë‹ˆìš©ìœ¼ë¡œë„ ì¸ê¸°ê°€ ë§ì•„ìš”.',
        misong18T: 'ë¯¸ì†¡ì§‘ì„±ëª©ì€ ë‚˜ë¬´ ë³¸ì—°ì˜ ë”°ëœ»í•œ ëŠë‚Œì„ ì˜ ì‚´ë ¤ì¤˜ìš” ğŸŒ²\n\nê²°ì´ ë¶€ë“œëŸ¬ì›Œì„œ DIY í•˜ì‹œëŠ” ë¶„ë“¤ì´ ê°€ì¥ ì„ í˜¸í•˜ì‹œëŠ” ì›ëª© ì¤‘ í•˜ë‚˜ì£ . ìƒŒë”©ì´ë‘ ì½”íŒ…ì„ ê±°ì¹˜ë©´ í›¨ì”¬ ë” ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ëŠë‚Œì´ ë‚œë‹µë‹ˆë‹¤.',
        pyeonbaek18T: 'í¸ë°±ì§‘ì„±ëª©ì€ í–¥ê¸°ë¶€í„° ë‹¬ë¼ìš”! ğŸŒ¿\n\nëª¸ì— ì¢‹ì€ í”¼í†¤ì¹˜ë“œê°€ ë‚˜ì™€ì„œ ì•„ì´ë“¤ ë°©ì´ë‚˜ ì¹¨ì‹¤ ê°€êµ¬ì— ì •ë§ ì¶”ì²œë“œë ¤ìš”. í•­ê·  íš¨ê³¼ë„ ìˆì–´ì„œ ê±´ê°•ê¹Œì§€ ìƒê°í•œ í”„ë¦¬ë¯¸ì—„ ì›ëª©ì´ëë‹ˆë‹¤.',
        mulbau18T: 'ë©€ë°”ìš°ëŠ” ì•„ì£¼ ë‹¨ë‹¨í•˜ê³  ë¬µì§í•œ í•˜ë“œìš°ë“œì˜ˆìš” ğŸ’ª\n\níŠ¹ìœ ì˜ ì§™ì€ ìƒ‰ê°ì´ ì •ë§ ê³ ê¸‰ìŠ¤ëŸ½ì£ . ë‚´êµ¬ì„±ì´ ì›Œë‚™ ì¢‹ì•„ì„œ ë¬´ê±°ìš´ ê±¸ ì˜¬ë¦¬ëŠ” í…Œì´ë¸” ìƒíŒì´ë‚˜ ê³ í’ìŠ¤ëŸ¬ìš´ ì¸í…Œë¦¬ì–´ì— ë§ì´ ì‚¬ìš©ë¼ìš”.'
      };

      const detailText = (descriptions[key] || wd.desc).replace(/\n/g, '<br>');

      // íƒ€ì´í•‘ íš¨ê³¼: ì ì‹œ íƒ€ì´í•‘ í‘œì‹œ í›„ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤Œ
      showTyping();
      setTimeout(() => {
        hideTyping();
        addBotMessage(`
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <img src="${wd.image}" style="width:36px; height:36px; border-radius:8px; object-fit:cover; border:1px solid #eee;">
            <b style="color:#2c3e50; font-size:14px;">${wd.name}</b>
          </div>
          <div style="font-size:13px; line-height:1.7; color:#333;">${detailText}</div>
          <div style="display:flex; gap:6px; font-size:11px; color:#666; margin-top:10px; flex-wrap:wrap;">
            <span style="background:#f0f7ff; color:#3498db; padding:3px 8px; border-radius:12px; font-weight:600;">ë‘ê»˜ ${wd.thickness}mm</span>
            <span style="background:#f8f9fa; padding:3px 8px; border-radius:12px;">ìƒŒë”© ${wd.canSand ? 'ê°€ëŠ¥ âœ…' : 'ë¶ˆê°€ âŒ'}</span>
            <span style="background:#f8f9fa; padding:3px 8px; border-radius:12px;">ì½”íŒ… ${wd.canCoat ? 'ê°€ëŠ¥ âœ…' : 'ë¶ˆê°€ âŒ'}</span>
          </div>
          ${videoHtml}
          <div class="quick-buttons" style="margin-top:12px;">
            <span class="quick-btn" style="background:#2ecc71; color:#fff; border-color:#2ecc71; font-weight:700;" onclick="selectWoodFromCard('${key}')">âœ“ ì´ ëª©ì¬ë¡œ ì„ íƒí• ê²Œìš”</span>
            <span class="quick-btn" onclick="showWoodCards()">ë‹¤ë¥¸ ëª©ì¬ ë”ë³´ê¸°</span>
          </div>
        `);
      }, 800);
    }

    function selectWoodFromCard(key) {
      const c = document.getElementById('woodDetail_' + key); if (c) c.innerHTML = ''; openWoodDetail = null;
      selectWood(key);
    }

    function selectWood(key) {
      currentWood = key; currentWidth = 0; currentLength = 0; currentQty = 1;
      selectedProcs.clear(); procDetails = {};
      const wd = WOOD_DATA[key];
      addBotMessage(`<b>${wd.name}</b> ì„ íƒ!<br>ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ê°€ë¡œxì„¸ë¡œ mm)<br>(ex: 400x1000 ì‚¬ì´ì¦ˆ)`);
      updateWoodModel();
      updateStatus(wd.name + ' ì„ íƒë¨', 'ì‚¬ì´ì¦ˆ ì…ë ¥ ëŒ€ê¸°');
    }

    // ============================================================
    // SIZE
    // ============================================================
    // ============================================================
    // SIZE
    // ============================================================
    const LAMINATED_WOODS = ['misong18T', 'pyeonbaek18T', 'mulbau18T'];

    function setSize(w, l, qty) {
      if (w > 600) { addBotMessage('í­ì€ ìµœëŒ€ <b>600mm</b>ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      if (l > 1800) { addBotMessage('ê¸¸ì´ëŠ” ìµœëŒ€ <b>1800mm</b>ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      if (w < 10 || l < 10) { addBotMessage('ìµœì†Œ ì‚¬ì´ì¦ˆëŠ” <b>10mm</b>ì…ë‹ˆë‹¤.'); return; }

      // ì§‘ì„±ëª© ë‚˜ë­‡ê²° ë°©í–¥ ê²½ê³  (í­ > ê¸¸ì´)
      if (LAMINATED_WOODS.includes(currentWood) && w > l) {
        addBotMessage(`
          <div style="border:2px solid #e74c3c; padding:15px; border-radius:12px; background:#fff5f5; margin-bottom:10px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
               <span style="font-size:24px;">âš ï¸</span>
               <b style="color:#c0392b; font-size:16px;">íŒŒì† ì£¼ì˜ ì•ˆë‚´</b>
            </div>
            ê³ ê°ë‹˜, ì…ë ¥í•˜ì‹  ì‚¬ì´ì¦ˆ(<b>${w} x ${l}mm</b>)ëŠ” <span style="color:#e74c3c;font-weight:bold;">í­ì´ ê¸¸ì´ë³´ë‹¤ ë„“ìŠµë‹ˆë‹¤.</span><br><br>
            ì„ íƒí•˜ì‹  ì§‘ì„±ëª©(ë¯¸ì†¡, í¸ë°±, ë©€ë°”ìš°)ì€ ë‚˜ë­‡ê²° ë°©í–¥ì´ ìˆì–´, ì´ëŒ€ë¡œ ì œì‘ ì‹œ <b>ê²°ëŒ€ë¡œ ìª¼ê°œì§€ê±°ë‚˜ ë°°ì†¡ ì¤‘ íŒŒì†ë  ìœ„í—˜</b>ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.<br>
            (â€» MDF, PVCëŠ” í•´ë‹¹ë˜ì§€ ì•ŠìŒ)<br><br>
            <img src="./wood_grain_warning.png" style="width:100%; max-width:400px; border-radius:8px; display:block; margin:0 auto 10px auto; border:1px solid #ddd;">
            í˜¹ì‹œ <b>${l} x ${w}mm</b> (ë‚˜ë­‡ê²° ê¸¸ì´ ë°©í–¥)ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            <div class="quick-buttons" style="margin-top:15px; justify-content:center;">
               <span class="quick-btn" style="background:#27ae60; color:#fff;" onclick="applySize(${l}, ${w}, ${qty})">ğŸ”„ ${l}x${w}ë¡œ ë³€ê²½ (ê¶Œì¥)</span>
               <span class="quick-btn" style="background:#e74c3c; color:white; border-color:#c0392b;" onclick="applySize(${w}, ${l}, ${qty})">âš ï¸ ì•„ë‹ˆìš”, ì´ëŒ€ë¡œ ì§„í–‰ (íŒŒì†ê°ìˆ˜)</span>
            </div>
          </div>
        `);
        return;
      }

      applySize(w, l, qty);
    }

    function applySize(w, l, qty) {
      currentWidth = w; currentLength = l;

      if (qty) {
        currentQty = qty;
        let msg = `ì‚¬ì´ì¦ˆ: <b>${w} Ã— ${l}mm</b>, ìˆ˜ëŸ‰: <b>${currentQty}ì¥</b><br>`;
        if (LAMINATED_WOODS.includes(currentWood) && w > l) {
          msg += `<span style="color:#e74c3c; font-size:12px;">(â€» íŒŒì† ìœ„í—˜ ê°ìˆ˜í•˜ê³  ì§„í–‰)</span><br>`;
        }
        msg += `ê°€ê³µ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)`;
        addBotMessage(msg);
        showProcessingOptions();
        updateWoodModel();
        updateStatus('ê°€ê³µ ì˜µì…˜ ëŒ€ê¸°', '');
      } else {
        // ìˆ˜ëŸ‰ì´ ì—†ìœ¼ë©´ ìˆ˜ëŸ‰ ì…ë ¥ ìš”ì²­
        addBotMessage(`ì‚¬ì´ì¦ˆ: <b>${w} Ã— ${l}mm</b> ì„ íƒ!<br>ìˆ˜ëŸ‰ì€ ëª‡ ì¥ì´ í•„ìš”í•˜ì‹ ê°€ìš”?`);
        updateWoodModel();
        updateStatus('ìˆ˜ëŸ‰ ì…ë ¥ ëŒ€ê¸°', '');
      }
    }

    // ============================================================
    // PROCESSING OPTIONS (ë³µìˆ˜ ì„ íƒ, ì›ë³¸ ì´ë¯¸ì§€)
    // ============================================================
    function showProcessingOptions() {
      const wd = WOOD_DATA[currentWood] || {};
      let h = '<div class="proc-grid">';
      PROC_OPTIONS.forEach(p => {
        const isActive = selectedProcs.has(p.key) || (p.key === 'none' && !selectedProcs.size);
        let disabled = false;
        if (p.key === 'sanding' && !wd.canSand) disabled = true;
        if (p.key === 'coating' && !wd.canCoat) disabled = true;
        if (p.key === 'sanding' && selectedProcs.has('coating')) disabled = true;

        h += `<div class="proc-item${isActive ? ' selected' : ''}${disabled ? ' disabled' : ''}" onclick="toggleProc('${p.key}')" id="procItem_${p.key}">
      <img src="${p.image}" alt="${p.label}">
      <div>${p.label}</div>
      ${p.event ? '<div class="event-tag">' + p.event + '</div>' : ''}
    </div>`;
      });
      h += '</div>';
      h += '<div id="procSubArea"></div>';
      h += '<div style="margin-top:8px;"><span class="quick-btn" onclick="confirmProc()" style="background:#2ecc71;color:#fff;border-color:#2ecc71;">âœ“ ê°€ê³µ í™•ì • â†’ ê²¬ì  ë³´ê¸°</span></div>';
      addBotMessage(h);
      renderProcSub(); // í˜„ì¬ ì„ íƒëœ ê°€ê³µë“¤ì˜ ìƒì„¸ ì„¤ì • í‘œì‹œ
    }

    function toggleProc(key) {
      const wd = WOOD_DATA[currentWood] || {};

      if (key === 'none') {
        selectedProcs.clear(); procDetails = {};
      } else {
        selectedProcs.delete('none');// none í•´ì œ

        // coating ì„ íƒ ì‹œ sanding ìë™ í•´ì œ
        if (key === 'coating' && !selectedProcs.has('coating')) {
          if (selectedProcs.has('sanding')) { selectedProcs.delete('sanding'); delete procDetails.sanding; }
        }
        // ì œì•½ ì²´í¬
        if (key === 'sanding' && (!wd.canSand || selectedProcs.has('coating'))) return;
        if (key === 'coating' && !wd.canCoat) return;

        if (selectedProcs.has(key)) {
          selectedProcs.delete(key); delete procDetails[key];
          if (lastFocusedOption === key) lastFocusedOption = null;
        } else {
          selectedProcs.add(key);
          lastFocusedOption = key;
          // ê¸°ë³¸ê°’
          if (key === 'angled') procDetails.angled = { sides: [] };
          if (key === 'round') procDetails.round = { corners: [] };
          if (key === 'coating') procDetails.coating = { type: 'ë‹¨ë©´' };
          if (key === 'circlecut') procDetails.circlecut = { count: 1, holes: [{ x: 50, y: 50, r: 20 }] };
          if (key === 'squarecut') procDetails.squarecut = { count: 1, holes: [{ x: 50, y: 50, w: 50, h: 50 }] };
          if (key === 'hinge') procDetails.hinge = { count: 2, mode: 'Y_INPUT', positions: [{ x: 23, y: '' }, { x: 23, y: '' }] };
          if (key === 'sanding') procDetails.sanding = {};
        }
        if (!selectedProcs.size) { selectedProcs.clear(); }// ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ none ìƒíƒœ
      }

      // UI ì—…ë°ì´íŠ¸
      PROC_OPTIONS.forEach(p => {
        const el = document.getElementById('procItem_' + p.key);
        if (!el) return;
        const isActive = selectedProcs.has(p.key) || (p.key === 'none' && !selectedProcs.size);
        el.classList.toggle('selected', isActive);
        // disable ë¡œì§
        let dis = false;
        if (p.key === 'sanding' && (!wd.canSand || selectedProcs.has('coating'))) dis = true;
        if (p.key === 'coating' && !wd.canCoat) dis = true;
        el.classList.toggle('disabled', dis);
      });

      renderProcSub();
      updateWoodModel();
    }

    function renderProcSub() {
      const area = document.getElementById('procSubArea');
      if (!area) return;
      let h = '';

      if (selectedProcs.has('coating')) {
        const d = procDetails.coating || { type: 'ë‹¨ë©´' };
        const cp = getCoatingPrices();
        h += `<div class="proc-sub"><div class="sub-title">ì½”íŒ… ë°©ì‹</div>
      <select onchange="procDetails.coating.type=this.value;renderProcSub();updateWoodModel();">
        <option value="ë‹¨ë©´" ${d.type === 'ë‹¨ë©´' ? 'selected' : ''}>ë‹¨ë©´ ì½”íŒ… (+${cp.single.toLocaleString()}ì›)</option>
        <option value="ì–‘ë©´" ${d.type === 'ì–‘ë©´' ? 'selected' : ''}>ì–‘ë©´ ì½”íŒ… (+${cp.double.toLocaleString()}ì›)</option>
      </select>
      ${d.type === 'ë‹¨ë©´' ? `<div style="margin-top:8px; padding:8px; background:#fff0f0; border-radius:4px; font-size:11px; color:#d9534f; line-height:1.4;">
        âš ï¸ <strong>ë‹¨ë©´ ì½”íŒ… ì‹œ</strong> ë„ë£Œì˜ ìˆ˜ì¶•ë ¥ìœ¼ë¡œ ì¸í•´ íœ¨ì´ ìƒê¹ë‹ˆë‹¤. ì œí’ˆ ìˆ˜ë ¹ í›„ ì¦‰ì‹œ ê³ ì • ì„¤ì¹˜ë¥¼ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤.
      </div>` : ''}
      </div>`;
      }

      if (selectedProcs.has('angled')) {
        const d = procDetails.angled || { sides: [] };
        h += `<div class="proc-sub"><div class="sub-title">ì‚¬ì„ ê°€ê³µ ë©´ ì„ íƒ (ë³µìˆ˜ ê°€ëŠ¥, ì¶”ê°€ë©´ +1,000ì›)</div>
      <div class="side-grid">
        ${['A(ì¢Œì¸¡)', 'B(ìƒë‹¨)', 'C(ìš°ì¸¡)', 'D(í•˜ë‹¨)'].map((label, i) => {
          const val = ['A', 'B', 'C', 'D'][i];
          return `<div class="side-item${d.sides.includes(val) ? ' active' : ''}" onclick="toggleAngledSide('${val}')">${label}</div>`;
        }).join('')}
      </div></div>`;
      }

      if (selectedProcs.has('round')) {
        const d = procDetails.round || { corners: [] };
        h += `<div class="proc-sub"><div class="sub-title">ë¼ìš´ë“œ ëª¨ì„œë¦¬ ì„ íƒ (ë³µìˆ˜ ê°€ëŠ¥, ì¶”ê°€ëª¨ì„œë¦¬ +1,000ì›)</div>
      <div class="side-grid">
        ${['1(ì¢Œìƒ)', '2(ì¢Œí•˜)', '3(ìš°ìƒ)', '4(ìš°í•˜)'].map((label, i) => {
          const val = String(i + 1);
          return `<div class="side-item${d.corners.includes(val) ? ' active' : ''}" onclick="toggleRoundCorner('${val}')">${label}</div>`;
        }).join('')}
      </div></div>`;
      }

      if (selectedProcs.has('hinge')) {
        const d = procDetails.hinge || { count: 2, mode: 'Y_INPUT', positions: [] };
        if (!d.mode) d.mode = 'Y_INPUT';
        if (!d.positions) d.positions = [];
        while (d.positions.length < d.count) {
          if (d.mode === 'Y_INPUT') d.positions.push({ x: 23, y: '' });
          else d.positions.push({ x: '', y: 23 });
        }
        while (d.positions.length > d.count) d.positions.pop();

        let tableRows = '';
        d.positions.forEach((p, i) => {
          if (d.mode === 'Y_INPUT') {
            tableRows += `<tr>
            <td style="padding:4px;">${i + 1}</td>
            <td>23 mm (ê³ ì •)</td>
            <td><input type="number" value="${p.y}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateHingeData(${i},'y',this.value)" placeholder="Y ì¢Œí‘œ"></td>
            </tr>`;
          } else {
            tableRows += `<tr>
            <td style="padding:4px;">${i + 1}</td>
            <td><input type="number" value="${p.x}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateHingeData(${i},'x',this.value)" placeholder="X ì¢Œí‘œ"></td>
            <td>23 mm (ê³ ì •)</td>
            </tr>`;
          }
        });

        h += `<div class="proc-sub"><div class="sub-title">ì‹±í¬ê²½ì²© (2ê°œê¹Œì§€ ë¬´ë£Œ, ì¶”ê°€ +1,000ì›/ê°œ)<br><span style="font-weight:normal;color:#666;">â€»ê¸°ì¤€ì : ì¢Œì¸¡ìƒë‹¨ (mm)</span></div>
      <div style="margin-bottom:8px; text-align:center;">
        <img src="https://gi.esmplus.com/irn2011/click/texture/detail_hinge.png" alt="ì‹±í¬ê²½ì²© ê°€ì´ë“œ" style="max-width:100%; border-radius:4px; border:1px solid #eee;">
      </div>
      <p style="font-size:11px; color:#555; margin:4px 0;">ğŸ’¡ ì¢Œí‘œë¥¼ ë¹„ì›Œë‘ì‹œë©´, ëª©ìˆ˜ê°€ ëª©ì¬ ì‚¬ì´ì¦ˆì— ë§ì¶° ê· ë“±í•˜ê²Œ ê°€ê³µí•´ ë“œë¦½ë‹ˆë‹¤.</p>
      <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
        <span>ê°œìˆ˜:</span>
        <input type="number" value="${d.count}" min="1" max="10" style="width:60px;" onchange="updateHingeCount(this.value)">
        <button type="button" onclick="toggleHingeMode()" style="padding:4px 10px; font-size:11px; border:1px solid #ccc; border-radius:4px; cursor:pointer; background:#f0f0f0;">X/Y ì¶• ë³€ê²½</button>
      </div>
      <table style="width:100%; font-size:11px; text-align:center; border-collapse:collapse;">
        <thead><tr style="background:#eee;"><th style="padding:4px;">No</th><th>X ì¢Œí‘œ</th><th>Y ì¢Œí‘œ</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table></div>`;
      }

      if (selectedProcs.has('circlecut')) {
        const d = procDetails.circlecut || { count: 1, holes: [{ x: 50, y: 50, r: 20 }] };
        if (!d.holes) d.holes = [];
        // ë°°ì—´ í¬ê¸° ë§ì¶¤
        while (d.holes.length < d.count) d.holes.push({ x: 50, y: 50, r: 20 });
        while (d.holes.length > d.count) d.holes.pop();

        let tableRows = '';
        d.holes.forEach((hole, i) => {
          tableRows += `<tr>
          <td style="padding:4px;">${i + 1}</td>
          <td><input type="number" value="${hole.x}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateCircleCutData(${i},'x',this.value)"></td>
          <td><input type="number" value="${hole.y}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateCircleCutData(${i},'y',this.value)"></td>
          <td><input type="number" value="${hole.r}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateCircleCutData(${i},'r',this.value)"></td>
        </tr>`;
        });

        h += `<div class="proc-sub"><div class="sub-title">ì›í˜•íƒ€ê³µ (ê°œë‹¹ 3,000ì›, 1ê°œ ë¬´ë£Œ)<br><span style="font-weight:normal;color:#666;">â€»ê¸°ì¤€ì : ì¢Œì¸¡ìƒë‹¨ (mm)</span></div>
      <div style="margin-bottom:8px; text-align:center;">
        <img src="https://gi.esmplus.com/irn2011/click/texture/detail_circle.png" alt="ì›í˜•íƒ€ê³µ ê°€ì´ë“œ" style="max-width:100%; border-radius:4px; border:1px solid #eee;">
      </div>
      <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
        <span>ê°œìˆ˜:</span>
        <input type="number" value="${d.count}" min="1" max="10" style="width:60px;" onchange="updateCircleCutCount(this.value)">
      </div>
      <table style="width:100%; font-size:11px; text-align:center; border-collapse:collapse;">
        <thead><tr style="background:#eee;"><th style="padding:4px;">No</th><th>X(ê°€ë¡œ)</th><th>Y(ì„¸ë¡œ)</th><th>R(ë°˜ì§€ë¦„)</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table></div>`;
      }

      if (selectedProcs.has('squarecut')) {
        const d = procDetails.squarecut || { count: 1, holes: [{ x: 50, y: 50, w: 50, h: 50 }] };
        if (!d.holes) d.holes = [];
        while (d.holes.length < d.count) d.holes.push({ x: 50, y: 50, w: 50, h: 50 });
        while (d.holes.length > d.count) d.holes.pop();

        let tableRows = '';
        d.holes.forEach((h, i) => {
          tableRows += `<tr>
          <td style="padding:4px;">${i + 1}</td>
          <td><input type="number" value="${h.x}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'x',this.value)" placeholder="X1"></td>
          <td><input type="number" value="${h.y}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'y',this.value)" placeholder="Y1"></td>
          <td><input type="number" value="${h.w}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'w',this.value)" placeholder="X2(í­)"></td>
          <td><input type="number" value="${h.h}" style="width:100%;box-sizing:border-box;border:1px solid #ddd;text-align:center;" onchange="updateSquareCutData(${i},'h',this.value)" placeholder="Y2(ê¸¸ì´)"></td>
        </tr>`;
        });

        h += `<div class="proc-sub"><div class="sub-title">ì‚¬ê°íƒ€ê³µ (ê°œë‹¹ 4,000ì›, 1ê°œ ë¬´ë£Œ)<br><span style="font-weight:normal;color:#666;">â€»ê¸°ì¤€ì : ì¢Œì¸¡ìƒë‹¨ (mm)</span></div>
      <div style="margin-bottom:8px; text-align:center;">
        <img src="https://gi.esmplus.com/irn2011/click/texture/detail_square.png" alt="ì‚¬ê°íƒ€ê³µ ê°€ì´ë“œ" style="max-width:100%; border-radius:4px; border:1px solid #eee;">
      </div>
      <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
        <span>ê°œìˆ˜:</span>
        <input type="number" value="${d.count}" min="1" max="10" style="width:60px;" onchange="updateSquareCutCount(this.value)">
      </div>
      <table style="width:100%; font-size:11px; text-align:center; border-collapse:collapse;">
        <thead><tr style="background:#eee;"><th style="padding:4px;">No</th><th>X1</th><th>Y1</th><th>X2(í­)</th><th>Y2(ê¸¸ì´)</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table></div>`;
      }

      area.innerHTML = h;
    }



    function updateCircleCutCount(val) {
      const v = parseInt(val) || 1;
      let d = procDetails.circlecut;
      if (!d) d = procDetails.circlecut = { count: 1, holes: [] };
      d.count = v;
      if (!d.holes) d.holes = [];
      while (d.holes.length < v) d.holes.push({ x: 50, y: 50, r: 20 });
      while (d.holes.length > v) d.holes.pop();
      renderProcSub();
      updateWoodModel();
    }

    function updateCircleCutData(idx, key, val) {
      const v = parseFloat(val) || 0;
      if (procDetails.circlecut && procDetails.circlecut.holes && procDetails.circlecut.holes[idx]) {
        procDetails.circlecut.holes[idx][key] = v;
        updateWoodModel();
      }
    }

    function updateSquareCutCount(val) {
      const v = parseInt(val) || 1;
      let d = procDetails.squarecut;
      if (!d) d = procDetails.squarecut = { count: 1, holes: [] };
      d.count = v;
      if (!d.holes) d.holes = [];
      while (d.holes.length < v) d.holes.push({ x: 50, y: 50, w: 50, h: 50 });
      while (d.holes.length > v) d.holes.pop();
      renderProcSub();
      updateWoodModel();
    }

    function updateSquareCutData(idx, key, val) {
      const v = parseFloat(val) || 0;
      if (procDetails.squarecut && procDetails.squarecut.holes && procDetails.squarecut.holes[idx]) {
        procDetails.squarecut.holes[idx][key] = v;
        updateWoodModel();
      }
    }

    function updateHingeCount(val) {
      const v = parseInt(val) || 2;
      let d = procDetails.hinge;
      if (!d) d = procDetails.hinge = { count: 2, mode: 'Y_INPUT', positions: [] };
      d.count = v;
      if (!d.positions) d.positions = [];
      while (d.positions.length < v) {
        if (d.mode === 'Y_INPUT') d.positions.push({ x: 23, y: '' });
        else d.positions.push({ x: '', y: 23 });
      }
      while (d.positions.length > v) d.positions.pop();
      renderProcSub();
      updateWoodModel();
    }

    function toggleHingeMode() {
      let d = procDetails.hinge;
      if (!d) return;
      d.mode = (d.mode === 'Y_INPUT') ? 'X_INPUT' : 'Y_INPUT';
      // Reset positions for new mode
      d.positions = [];
      for (let i = 0; i < d.count; i++) {
        if (d.mode === 'Y_INPUT') d.positions.push({ x: 23, y: '' });
        else d.positions.push({ x: '', y: 23 });
      }
      renderProcSub();
      updateWoodModel();
    }

    function updateHingeData(idx, key, val) {
      const v = parseFloat(val) || 0;
      if (procDetails.hinge && procDetails.hinge.positions && procDetails.hinge.positions[idx]) {
        procDetails.hinge.positions[idx][key] = v;
        updateWoodModel();
      }
    }

    function toggleAngledSide(val) {
      const d = procDetails.angled || (procDetails.angled = { sides: [] });
      const i = d.sides.indexOf(val);
      if (i >= 0) d.sides.splice(i, 1); else d.sides.push(val);
      renderProcSub(); updateWoodModel();
    }

    function toggleRoundCorner(val) {
      const d = procDetails.round || (procDetails.round = { corners: [] });
      const i = d.corners.indexOf(val);
      if (i >= 0) d.corners.splice(i, 1); else d.corners.push(val);
      renderProcSub(); updateWoodModel();
    }

    function confirmProc() {
      addBotMessage('ê°€ê³µ í™•ì •: <b>' + getProcSummary() + '</b>');
      updateWoodModel();
      showEstimate();
    }

    // ============================================================
    // ESTIMATE
    // ============================================================
    function showEstimate() {
      if (!currentWood || currentWidth <= 0) return;
      const p = calculatePrice();
      if (!p) { addBotMessage('í•´ë‹¹ ì‚¬ì´ì¦ˆì˜ ë‹¨ê°€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const wd = WOOD_DATA[currentWood];

      let procDetailHtml = '';
      if (p.additionalCost > 0) {
        procDetailHtml += `<div class="estimate-row"><span>ê°€ê³µë¹„ ìƒì„¸</span><span>+${p.additionalCost.toLocaleString()}ì›</span></div>`;
      }
      if (p.totalDiscount > 0) {
        procDetailHtml += `<div class="estimate-row" style="color:#ffd700;"><span>ì´ë²¤íŠ¸ í• ì¸</span><span>-${p.totalDiscount.toLocaleString()}ì›</span></div>`;
        p.discountDetails.forEach(dd => {
          procDetailHtml += `<div class="estimate-row" style="font-size:11px;color:#ffd700;"><span style="padding-left:10px;">â”” ${dd}</span><span></span></div>`;
        });
      }

      // ì„ì‹œ ë°°ì†¡ë¹„ (ë¦¬ë·°ìš©)
      const tempShipping = getBaseShippingCost(currentLength);

      addBotMessage(`
    <div class="estimate-card">
      <h3>ğŸ“‹ ê²¬ì ì„œ</h3>
      <div class="estimate-row"><span>ëª©ì¬</span><span>${wd.name}</span></div>
      <div class="estimate-row"><span>ì‚¬ì´ì¦ˆ</span><span>${currentWidth} Ã— ${currentLength} mm</span></div>
      <div class="estimate-row"><span>ìˆ˜ëŸ‰</span><span>${currentQty}ì¥</span></div>
      <div class="estimate-row"><span>ê°€ê³µ</span><span>${getProcSummary()}</span></div>
      <div class="estimate-row"><span>íŒì¬ ë‹¨ê°€</span><span>${p.basePrice.toLocaleString()}ì›</span></div>
      ${procDetailHtml}
      <div class="estimate-row" style="font-weight:600;"><span>ì¥ë‹¹ (í• ì¸ í›„)</span><span>${Math.round(p.finalTotal / currentQty).toLocaleString()}ì›</span></div>
      <div class="estimate-row"><span>ì†Œê³„ (${currentQty}ì¥)</span><span>${p.finalTotal.toLocaleString()}ì›</span></div>
      <div class="estimate-row" style="opacity:0.7; font-size:11px;"><span>ì˜ˆìƒ ë°°ì†¡ë¹„ (ë°•ìŠ¤ í•˜ë‚˜ë‹¹)</span><span>${tempShipping.toLocaleString()}ì›</span></div>
      <div class="estimate-total">ì†Œê³„ í•©ê³„: ${p.finalTotal.toLocaleString()}ì›</div>
      <div class="estimate-actions">
        <button class="btn-add-order" onclick="addToOrder()">ì£¼ë¬¸ëª©ë¡ì— ì¶”ê°€</button>
    <button class="btn-new-est" onclick="clearChatAndStartNew()">ìƒˆ ê²¬ì </button>
  </div>
</div>`);

      document.getElementById('previewDim').textContent = `${currentWidth}Ã—${currentLength}mm ${wd.name}`;
      updateStatus('ê²¬ì  ì™„ë£Œ', p.finalTotal.toLocaleString() + 'ì›');
    }

    // ============================================================
    // ORDER
    // ============================================================
    function addToOrder() {
      const p = calculatePrice(); if (!p) return;
      const wd = WOOD_DATA[currentWood];
      orderList.push({
        woodTypeValue: currentWood,
        woodName: wd.name,
        width: currentWidth,
        length: currentLength,
        quantity: currentQty,
        processingSummary: getProcSummary(),
        selectedProcs: Array.from(selectedProcs),
        procDetails: JSON.parse(JSON.stringify(procDetails)),
        basePrice: p.basePrice,
        additionalCost: p.additionalCost,
        originalTotal: p.origTotal,
        discount: p.totalDiscount,
        discountDetails: p.discountDetails,
        estimate: p.finalTotal
      });

      addBotMessage(`<b>${wd.name} ${currentWidth}Ã—${currentLength}mm ${currentQty}ì¥</b> ì¶”ê°€!
<div class="quick-buttons">
  <span class="quick-btn" onclick="clearChatAndStartNew()">ë‹¤ë¥¸ ëª©ì¬ ì¶”ê°€</span>
  <span class="quick-btn" onclick="showAccessoryCategories()">ë¶€ìì¬ ì¶”ê°€</span>
  <span class="quick-btn" onclick="initiateOrder()">ì£¼ë¬¸í•˜ê¸° (${orderList.length}ê±´)</span>
</div>`);
      updateOrderBadge(); renderOrderPanel(); resetEstimate();
    }

    function removeOrderItem(idx) { orderList.splice(idx, 1); updateOrderBadge(); renderOrderPanel(); }

    function removeProc(key, e) {
      if (e) e.stopPropagation();
      selectedProcs.delete(key);
      delete procDetails[key];
      if (selectedProcs.size === 0) selectedProcs.add('none');
      updateWoodModel();
      showProcessingOptions(); // ì˜µì…˜ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
      renderOrderPanel();
      updateOrderBadge();
    }

    function editProc(key) {
      // ê°€ê³µ ì˜µì…˜ì°½ì„ ë‹¤ì‹œ ë„ì›Œ ìƒì„¸ ì„¤ì •ì„ í•  ìˆ˜ ìˆê²Œ í•¨
      showProcessingOptions();
      // íŠ¹ì • ê°€ê³µì— ëŒ€í•œ ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€ (ì„ íƒ ì‚¬í•­)
      const opt = PROC_OPTIONS.find(o => o.key === key);
      if (opt) {
        addBotMessage(`<b>${opt.label}</b> ì„¤ì •ì„ ìœ„ ì°½ì—ì„œ ë³€ê²½í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      }
    }

    function toggleOrderPanel(show) {
      const overlay = document.getElementById('orderPanelOverlay');
      if (show === undefined) {
        show = overlay.style.display === 'none' || overlay.style.display === '';
      }
      if (show) {
        overlay.style.display = 'flex';
        renderOrderPanel();
      } else {
        overlay.style.display = 'none';
      }
    }

    function renderOrderPanel() {
      const panel = document.getElementById('orderPanel');
      if (!orderList.length) {
        panel.innerHTML = `<div class="order-panel-header"><span>ì£¼ë¬¸ëª©ë¡</span><button onclick="toggleOrderPanel()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">âœ•</button></div>
      <div class="order-panel-body" style="display:flex;align-items:center;justify-content:center;color:#999;">ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>`; return;
      }

      let itemTotal = 0;
      let rows = '';

      orderList.forEach((item, idx) => {
        itemTotal += item.estimate;
        const details = item.type === 'accessory' ? (item.name || '-') : (item.processingSummary || 'ê°€ê³µ ì—†ìŒ');
        const sizeStr = item.width > 0 ? `${item.width}x${item.length}` : '-';

        rows += `<tr>
          <td>${item.type === 'accessory' ? '[ë¶€ìì¬]' : item.woodName}</td>
          <td>${details}</td>
          <td>${sizeStr}</td>
          <td>${item.quantity}</td>
          <td>${item.estimate.toLocaleString()}</td>
          <td><button class="oi-remove-btn" onclick="removeOrderItem(${idx})">ì‚­ì œ</button></td>
        </tr>`;

        if (item.discount > 0) {
          rows += `<tr class="discount-row">
             <td>ì´ë²¤íŠ¸ í• ì¸</td>
             <td>${(item.discountDetails || []).join(', ')}</td>
             <td colspan="2">-</td>
             <td>-${item.discount.toLocaleString()}</td>
             <td></td>
           </tr>`;
        }
      });

      // ë°°ì†¡ë¹„
      const shippingItems = calculateShippingCost(orderList);
      let totalShip = 0;
      shippingItems.forEach(si => {
        const sc = si.cost * si.count;
        totalShip += sc;
        rows += `<tr class="shipping-row">
          <td>ì˜ˆìƒ ë°°ì†¡ë¹„</td>
          <td>${si.sizeCategory}</td>
          <td>-</td>
          <td>${si.count}</td>
          <td>${sc.toLocaleString()}</td>
          <td></td>
        </tr>`;
      });

      const grandTotal = itemTotal + totalShip;

      panel.innerHTML = `
    <div class="order-panel-header"><span>ì£¼ë¬¸ëª©ë¡ (${orderList.length}ê±´)</span><button onclick="toggleOrderPanel()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">âœ•</button></div>
    <div class="order-panel-body">
      <table class="order-table">
        <thead>
          <tr>
            <th>í’ˆëª…</th>
            <th>ê°€ê³µìƒì„¸</th>
            <th>ì‚¬ì´ì¦ˆ</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>ê²¬ì </th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
           <tr class="total-row">
             <td colspan="4" style="text-align:right;">ì´ í•©ê³„</td>
             <td colspan="2" style="color:#e74c3c;">${grandTotal.toLocaleString()}ì›</td>
           </tr>
        </tfoot>
      </table>
    </div>
    <div class="order-panel-footer">
      <div class="total-row"><span>ì´ í•©ê³„</span><span style="color:#e74c3c;">${grandTotal.toLocaleString()}ì›</span></div>
      <button class="btn-checkout" onclick="toggleOrderPanel(false);showCustomerForm();">ì£¼ë¬¸ ì§„í–‰í•˜ê¸°</button>
    </div>`;
    }

    function removeOrderItem(idx) {
      if (orderList[idx]?.isLoaded) { alert('ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      orderList.splice(idx, 1);
      saveOrders(); updateOrderBadge(); renderOrderPanel();
      if (orderList.length === 0) {
        addBotMessage('ì£¼ë¬¸ ëª©ë¡ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëª©ì¬ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        showWoodCards();
      } else {
        addBotMessage('ì„ íƒí•œ í•­ëª©ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
        initiateOrder();
      }
    }

    function clearAllOrders() {
      if (orderList.some(i => i.isLoaded)) { alert('ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if (!confirm('ëª¨ë“  ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      orderList = []; saveOrders(); updateOrderBadge(); renderOrderPanel();
      addBotMessage('ì£¼ë¬¸ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      showWoodCards();
    }

    // ============================================================
    // CUSTOMER FORM
    // ============================================================
    // ============================================================
    // CUSTOMER FORM
    // ============================================================
    function initiateOrder() {
      if (!orderList.length) { addBotMessage('ì£¼ë¬¸ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }
      addBotMessage('ğŸ›’ íŒì—…ìœ¼ë¡œ ë‚˜íƒ€ë‚œ ì£¼ë¬¸ëª©ë¡ì„ í™•ì¸í•´ ì£¼ì„¸ìš”. (ê°€ë…ì„±ì„ ìœ„í•œ ê°œì„ ì…ë‹ˆë‹¤)');
      toggleOrderPanel(true);
    }

    function showCustomerForm() {
      if (!orderList.length) { addBotMessage('ì£¼ë¬¸ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }
      if (orderList.some(i => i.isLoaded)) { addBotMessage('ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ì€ ì „ì†¡ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.<div class="quick-buttons"><span class="quick-btn" onclick="generateReport()">ğŸ“¸ ê²¬ì ì„œ ì €ì¥</span></div>'); return; }
      let gt = 0; orderList.forEach(i => { gt += i.estimate; });
      const shipItems = calculateShippingCost(orderList); shipItems.forEach(si => { gt += si.cost * si.count; });
      addBotMessage(`
<div class="customer-form">
  <h4>ì£¼ë¬¸ì ì •ë³´</h4>
  <div class="form-row"><label>ì„±í•¨ *</label><input type="text" id="custName" placeholder="í™ê¸¸ë™"></div>
  <div class="form-row"><label>ì—°ë½ì²˜ *</label><input type="tel" id="custPhone" placeholder="010-1234-5678" oninput="formatPhoneNumber(this)" maxlength="13"></div>
  <div class="form-row"><label>ì´ë©”ì¼</label><input type="email" id="custEmail" placeholder="example@email.com (ì„ íƒ)"></div>
  <div style="text-align:right;font-size:14px;font-weight:700;color:#e74c3c;margin:8px 0;">ì´ ê²°ì œê¸ˆì•¡: ${gt.toLocaleString()}ì›</div>
  <button class="btn-submit-order" onclick="submitOrder()">ì£¼ë¬¸ ì œì¶œí•˜ê¸°</button>
</div>`);
    }

    function resetEstimate() { currentWidth = 0; currentLength = 0; currentQty = 1; selectedProcs.clear(); procDetails = {}; }

    function compareWoodPrices(w, l, q) {
      if (!priceTable.length) {
        addBotMessage('ë‹¨ê°€í‘œë¥¼ ì•„ì§ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      const area = w * l;
      const results = WOOD_KEYS.map(key => {
        const wd = WOOD_DATA[key];
        const unitPrice = getUnitPrice(key, area);
        return { key, name: wd.name, price: unitPrice, desc: wd.desc };
      }).filter(r => r.price > 0).sort((a, b) => a.price - b.price);

      if (!results.length) {
        addBotMessage(`${w}Ã—${l}mm ì‚¬ì´ì¦ˆì— ëŒ€í•œ ê°€ê²© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }

      const cheapest = results[0];
      let rows = results.map((r, i) => {
        const tag = i === 0 ? ' <span style="color:#2ecc71;font-weight:800;">âœ… ìµœì €ê°€</span>' : '';
        const selectAction = q
          ? `selectWood('${r.key}');setSize(${w},${l},${q});`
          : `selectWood('${r.key}');currentWidth=${w};currentLength=${l};addBotMessage('<b>${r.name}</b> ${w}Ã—${l}mm ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.<br>ìˆ˜ëŸ‰ì€ ëª‡ ì¥ì´ í•„ìš”í•˜ì‹ ê°€ìš”?');updateWoodModel();updateStatus('ìˆ˜ëŸ‰ ì…ë ¥ ëŒ€ê¸°','');`;

        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #f0f2f5;${i === 0 ? 'background:#f0fff4;border-radius:8px;' : ''}">
          <div style="flex:1;min-width:0;margin-right:8px;">
            <span style="font-weight:700;color:#2c3e50;">${i + 1}. ${r.name}</span>${tag}
            <div style="font-size:11px;color:#7f8c8d;margin-top:2px;">${r.desc}</div>
          </div>
          <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
            <span style="font-weight:800;color:${i === 0 ? '#e74c3c' : '#555'};font-size:15px;white-space:nowrap;">${r.price.toLocaleString()}ì›</span>
            <button onclick="${selectAction}" style="border:1px solid #3498db;background:#fff;color:#3498db;border-radius:4px;padding:2px 8px;font-size:11px;font-weight:600;cursor:pointer;">ì„ íƒ</button>
          </div>
        </div>`;
      }).join('');

      const footerBtns = q
        ? `<span class="quick-btn" onclick="selectWood('${cheapest.key}');setSize(${w},${l},${q});">${cheapest.name}ìœ¼ë¡œ ì§„í–‰í•˜ê¸°</span>`
        : `<span class="quick-btn" onclick="selectWood('${cheapest.key}');currentWidth=${w};currentLength=${l};addBotMessage('<b>${cheapest.name}</b> ${w}Ã—${l}mm ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.<br>ìˆ˜ëŸ‰ì€ ëª‡ ì¥ì´ í•„ìš”í•˜ì‹ ê°€ìš”?');updateWoodModel();updateStatus('ìˆ˜ëŸ‰ ì…ë ¥ ëŒ€ê¸°','');">${cheapest.name} ê²¬ì  ë³´ê¸°</span>`;

      addBotMessage(`
        <div style="border:2px solid #3498db;border-radius:16px;overflow:hidden;">
          <div style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:14px 16px;">
            <div style="font-size:16px;font-weight:800;">ğŸ“Š ${w}Ã—${l}mm ëª©ì¬ ê°€ê²© ë¹„êµ</div>
            <div style="font-size:12px;opacity:.8;margin-top:4px;">ë©´ì : ${area.toLocaleString()}mmÂ² ê¸°ì¤€${q ? ` (ìˆ˜ëŸ‰: ${q}ì¥)` : ' (1ì¥, ê°€ê³µ ì „)'}</div>
          </div>
          <div style="padding:4px 0;">${rows}</div>
          <div style="padding:12px 16px;background:#f8f9fa;border-top:1px solid #eee;">
            <div style="font-size:13px;color:#2c3e50;margin-bottom:8px;">ğŸ’¡ <b>${cheapest.name}</b>ì´(ê°€) ê°€ì¥ ì €ë ´í•©ë‹ˆë‹¤!</div>
            <div class="quick-buttons">
              ${footerBtns}
              <span class="quick-btn" onclick="showWoodCards()">ëª©ì¬ ì§ì ‘ ì„ íƒ</span>
            </div>
          </div>
        </div>
      `);
    }

    function confirmReset() {
      if (confirm('ì£¼ë¬¸ ëª©ë¡ê³¼ ì±„íŒ… ë‚´ìš©ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        resetAll();
      }
    }

    function resetAll() {
      currentWood = null;
      resetEstimate();
      orderList = [];
      updateOrderBadge();
      renderOrderPanel();
      document.getElementById('chatMessages').innerHTML = '';
      showGreeting();
    }

    // ============================================================
    // THREE.JS 3D (ì›ë³¸ í…ìŠ¤ì²˜ + ë¡œì§)
    // ============================================================
    function init3D() {
      const wrap = document.querySelector('.preview-canvas-wrap');
      const canvas = document.getElementById('previewCanvas');
      const w = wrap.clientWidth || 600, h = wrap.clientHeight || 400;
      scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f0f0);
      camera = new THREE.PerspectiveCamera(50, w / h, 0.1, 1000);
      camera.position.set(3, 3, 5);
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(w, h); renderer.setPixelRatio(window.devicePixelRatio);
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.08;
      scene.add(new THREE.AmbientLight(0xdddddd));
      const dl = new THREE.DirectionalLight(0xffffff, 1); dl.position.set(5, 10, 7.5); scene.add(dl);
      boardGroup = new THREE.Group(); scene.add(boardGroup);
      sceneObjects = [];
      activeLabels = [];
      animate3D();
      new ResizeObserver(() => {
        const ww = wrap.clientWidth, hh = wrap.clientHeight;
        if (ww > 0 && hh > 0) { camera.aspect = ww / hh; camera.updateProjectionMatrix(); renderer.setSize(ww, hh); }
      }).observe(wrap);
    }

    function animate3D() {
      requestAnimationFrame(animate3D);
      if (controls) controls.update();
      if (renderer && scene && camera) renderer.render(scene, camera);

      // ë¼ë²¨ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      activeLabels.forEach(label => {
        const screenPosition = label.position.clone().project(camera);
        if (screenPosition.z > 1.0) {
          label.element.style.display = 'none';
        } else {
          label.element.style.display = 'block';
          const canvas = renderer.domElement;
          const x = (screenPosition.x * 0.5 + 0.5) * canvas.clientWidth;
          const y = (-screenPosition.y * 0.5 + 0.5) * canvas.clientHeight;
          label.element.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
        }
      });
    }

    // ============================================================
    // DIMENSION HELPERS
    // ============================================================
    let activeLabels = [];
    const labelsContainer = document.getElementById('labels-container');

    function createLabel(text, positionVector, color) {
      if (!labelsContainer) return;
      const div = document.createElement('div');
      div.innerHTML = text; // HTML ì§€ì›
      div.style.position = 'absolute';
      div.style.color = color;
      div.style.fontWeight = 'bold';
      div.style.backgroundColor = 'rgba(255, 255, 255, 0.8)'; // ë°°ê²½ íˆ¬ëª…ë„ ì¡°ì •
      div.style.padding = '2px 5px';
      div.style.borderRadius = '3px';
      div.style.fontSize = '12px';
      div.style.whiteSpace = 'nowrap'; // ì¤„ë°”ê¿ˆ ë°©ì§€ (br íƒœê·¸ëŠ” ì‘ë™)
      div.style.textAlign = 'center'; // ì¤‘ì•™ ì •ë ¬
      div.style.userSelect = 'none';
      div.style.pointerEvents = 'auto';
      div.style.top = '0'; div.style.left = '0'; // ì´ˆê¸° ìœ„ì¹˜
      labelsContainer.appendChild(div);
      activeLabels.push({ element: div, position: positionVector });
    }

    function clearLabels() {
      if (!labelsContainer) return;
      activeLabels.forEach(label => { if (label.element.parentNode) label.element.parentNode.removeChild(label.element); });
      activeLabels = [];
    }

    function createDimensionLine(start, end, labelText, color) {
      const lineMaterial = new THREE.LineBasicMaterial({ color: 0xff0000 });
      const offset = 0.2;
      let p1, p2;

      // ë” ê¸´ ì¶•ì„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤í”„ì…‹ ë°©í–¥ ê²°ì •
      if (Math.abs(start.x - end.x) > Math.abs(start.z - end.z)) {
        const zOffset = start.z > 0 ? offset : -offset;
        p1 = new THREE.Vector3(start.x, start.y, start.z + zOffset);
        p2 = new THREE.Vector3(end.x, end.y, end.z + zOffset);
      } else {
        const xOffset = start.x > 0 ? offset : -offset;
        p1 = new THREE.Vector3(start.x + xOffset, start.y, start.z);
        p2 = new THREE.Vector3(end.x + xOffset, end.y, end.z);
      }

      const line1 = new THREE.Line(new THREE.BufferGeometry().setFromPoints([start, p1]), lineMaterial);
      const line2 = new THREE.Line(new THREE.BufferGeometry().setFromPoints([end, p2]), lineMaterial);
      const mainLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints([p1, p2]), lineMaterial);

      scene.add(line1, line2, mainLine);
      sceneObjects.push(line1, line2, mainLine);

      const labelPos = p1.clone().lerp(p2, 0.5);
      createLabel(labelText, labelPos, color);
    }

    function createCornerLabel(text, position, color) {
      const offset = 0.3;
      let labelPos = position.clone();
      labelPos.x += Math.sign(position.x || 0.1) * offset;
      labelPos.y += offset;
      labelPos.z += Math.sign(position.z || 0.1) * offset;
      createLabel(text, labelPos, color);
    }

    function updateWoodModel() {
      // Clear
      if (woodMesh) { scene.remove(woodMesh); woodMesh = null; }
      sceneObjects.forEach(o => scene.remove(o)); sceneObjects = [];

      if (!currentWood || currentWidth <= 0 || currentLength <= 0) return;

      const width = currentWidth, length = currentLength, height = 18;
      const w = width / 100, h = height / 100, l = length / 100;

      // ì›ë³¸ í…ìŠ¤ì²˜
      const texture = new THREE.TextureLoader().load('https://gi.esmplus.com/irn2011/click/texture/line_texture.jpg');
      texture.repeat.set(width / 300, length / 1200);
      texture.wrapS = THREE.RepeatWrapping; texture.wrapT = THREE.RepeatWrapping;
      const woodMat = new THREE.MeshPhongMaterial({ map: texture });
      const pinkMat = new THREE.MeshPhongMaterial({ color: 0xff69b4 });
      const blueMat = new THREE.MeshPhongMaterial({ color: 0x007bff, transparent: true, opacity: 0.7 });
      const purpleMat = new THREE.MeshBasicMaterial({ color: 0x800080, side: THREE.DoubleSide });

      const materials = Array(6).fill(null).map(() => woodMat.clone());

      // ì½”íŒ… í‘œì‹œ
      if (selectedProcs.has('coating')) {
        const type = (procDetails.coating || {}).type;
        if (type === 'ë‹¨ë©´') materials[2] = pinkMat;
        else if (type === 'ì–‘ë©´') { materials[2] = pinkMat; materials[3] = pinkMat; }
      }
      // ì‚¬ì„  í‘œì‹œ
      if (selectedProcs.has('angled')) {
        const sides = (procDetails.angled || {}).sides || [];
        sides.forEach(s => {
          if (s === 'A') materials[1] = blueMat;
          if (s === 'B') materials[4] = blueMat;
          if (s === 'C') materials[0] = blueMat;
          if (s === 'D') materials[5] = blueMat;
        });
      }

      const geo = new THREE.BoxGeometry(w, h, l);
      woodMesh = new THREE.Mesh(geo, materials);
      scene.add(woodMesh);

      // ì—£ì§€
      const edges = new THREE.EdgesGeometry(geo);
      woodMesh.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 })));

      const topY = h / 2, hw = w / 2, hl = l / 2;

      // ë¼ìš´ë“œ ë§ˆì»¤
      if (selectedProcs.has('round')) {
        const corners = (procDetails.round || {}).corners || [];
        const posMap = { '1': [-hw, topY, hl], '2': [-hw, topY, -hl], '3': [hw, topY, hl], '4': [hw, topY, -hl] };
        corners.forEach(c => {
          if (posMap[c]) {
            const sp = new THREE.Mesh(new THREE.SphereGeometry(0.12, 16, 16), purpleMat);
            sp.position.fromArray(posMap[c]); scene.add(sp); sceneObjects.push(sp);
          }
        });
      }

      // ê²½ì²© ë§ˆì»¤
      if (selectedProcs.has('hinge')) {
        const d = procDetails.hinge || {};
        const positions = d.positions || [];
        const count = d.count || 2;

        if (positions.length > 0) {
          positions.forEach((p, i) => {
            let px = parseFloat(p.x) || 0;
            let py = parseFloat(p.y) || 0;

            // ì¢Œí‘œê°€ ë¹„ì–´ìˆìœ¼ë©´ ê· ë“± ë°°ì¹˜
            if (d.mode === 'Y_INPUT' && !p.y && p.y !== 0) {
              py = ((i + 1) / (count + 1)) * length;
              px = 23;
            } else if (d.mode === 'X_INPUT' && !p.x && p.x !== 0) {
              px = ((i + 1) / (count + 1)) * width;
              py = 23;
            }

            if (px > 0 || py > 0) {
              const hole = new THREE.Mesh(new THREE.CircleGeometry(17.5 / 100, 32), purpleMat);
              hole.position.set((px / 100) - hw, topY + 0.001, hl - (py / 100));
              hole.rotation.x = -Math.PI / 2;
              scene.add(hole); sceneObjects.push(hole);

              const labelHtml = `<div style="line-height:1.2;">No.${i + 1}<br><span style="font-size:10px; font-weight:normal;">X:${px}, Y:${py}</span></div>`;
              createLabel(labelHtml, hole.position.clone().add(new THREE.Vector3(0, 0.2, 0)), 'black');
            }
          });
        } else {
          // fallback: ê· ë“± ë°°ì¹˜
          for (let i = 0; i < count; i++) {
            const t = (i + 1) / (count + 1);
            const hole = new THREE.Mesh(new THREE.CircleGeometry(17.5 / 100, 32), purpleMat);
            hole.position.set(23 / 100 - hw, topY + 0.001, hl - t * l);
            hole.rotation.x = -Math.PI / 2;
            scene.add(hole); sceneObjects.push(hole);
          }
        }
      }

      // ì›í˜•íƒ€ê³µ ë§ˆì»¤
      if (selectedProcs.has('circlecut')) {
        const d = procDetails.circlecut || {};
        const holes = d.holes || [];
        // í•˜ìœ„ í˜¸í™˜ì„± (holesê°€ ì—†ëŠ” ê²½ìš°)
        if (!d.holes && d.count) {
          for (let i = 0; i < d.count; i++) {
            const hole = new THREE.Mesh(new THREE.CircleGeometry(0.15, 32), purpleMat);
            hole.position.set(0, topY + 0.001, (i * 0.4) - hl / 2);
            hole.rotation.x = -Math.PI / 2;
            scene.add(hole); sceneObjects.push(hole);
          }
        } else {
          holes.forEach((hInfo, i) => {
            if (hInfo.r > 0) {
              const rUnit = hInfo.r / 100;
              const xUnit = hInfo.x / 100;
              const yUnit = hInfo.y / 100;
              // X: ì¢Œì¸¡( -hw )ì—ì„œ +xUnit
              // Y: ìƒë‹¨( -hl ?? ì•„ë‹ˆ, ì´ì „ ë¡œì§ 'B(ìƒë‹¨)'ì€ +Z ë°©í–¥ì´ì—ˆë‚˜? í™•ì¸ í•„ìš”.
              // angled ë¡œì§: B(ìƒë‹¨) = [0, topY, l_half] -> +Zê°€ ìƒë‹¨.
              // D(í•˜ë‹¨) = [0, topY, -l_half] -> -Zê°€ í•˜ë‹¨.
              // A(ì¢Œì¸¡) = [-w_half, topY, 0] -> -Xê°€ ì¢Œì¸¡.
              // C(ìš°ì¸¡) = [w_half, topY, 0] -> +Xê°€ ìš°ì¸¡.

              // ë”°ë¼ì„œ ìƒë‹¨(Top)ì€ +Z. ì¢Œì¸¡(Left)ëŠ” -X.
              // User Input X (from Left): -hw + xUnit
              // User Input Y (from Top): hl - yUnit

              const hole = new THREE.Mesh(new THREE.CircleGeometry(rUnit, 32), purpleMat);
              hole.position.set(-hw + xUnit, topY + 0.001, hl - yUnit);
              hole.rotation.x = -Math.PI / 2;
              scene.add(hole); sceneObjects.push(hole);

              // ë¼ë²¨: X, Y, R ê°’ í‘œì‹œ
              const labelHtml = `<div style="line-height:1.2;">No.${i + 1}<br><span style="font-size:10px; font-weight:normal;">X:${hInfo.x}, Y:${hInfo.y}<br>R:${hInfo.r}</span></div>`;
              createLabel(labelHtml, hole.position.clone().add(new THREE.Vector3(0, 0.2, 0)), 'black');
            }
          });
        }
      }

      // ì‚¬ê°íƒ€ê³µ ë§ˆì»¤
      if (selectedProcs.has('squarecut')) {
        const d = procDetails.squarecut || {};
        const holes = d.holes || [];
        if (!d.holes && d.count) {
          for (let i = 0; i < d.count; i++) {
            const hole = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 0.3), purpleMat);
            hole.position.set(0, topY + 0.001, (i * 0.4) - hl / 2);
            hole.rotation.x = -Math.PI / 2;
            scene.add(hole); sceneObjects.push(hole);
          }
        } else {
          holes.forEach((hInfo, i) => {
            const x = hInfo.x || 0, y = hInfo.y || 0;
            const w = hInfo.w || 0, h = hInfo.h || 0;

            if (w > 0 && h > 0) {
              const cutW_unit = w / 100;
              const cutH_unit = h / 100;
              const cutX_unit = x / 100;
              const cutY_unit = y / 100;

              const centerX = -hw + cutX_unit + (cutW_unit / 2);
              const centerZ = hl - cutY_unit - (cutH_unit / 2);

              const hole = new THREE.Mesh(new THREE.PlaneGeometry(cutW_unit, cutH_unit), purpleMat);
              hole.position.set(centerX, topY + 0.001, centerZ);
              hole.rotation.x = -Math.PI / 2;
              scene.add(hole); sceneObjects.push(hole);

              const labelHtml = `<div style="line-height:1.2;">No.${i + 1}<br><span style="font-size:10px; font-weight:normal;">X:${x}, Y:${y}<br>W:${w}, H:${h}</span></div>`;
              createLabel(labelHtml, hole.position.clone().add(new THREE.Vector3(0, 0.2, 0)), 'black');
            }
          });
        }
      }

      // ì¹˜ìˆ˜ì„  (ê¸°ì¡´ ë‹¨ìˆœ ì„  ì œê±° í›„ í•¨ìˆ˜ ì´ìš©)
      clearLabels();


      // ê¸°ë³¸ ì¹˜ìˆ˜ì„ 
      if (lastFocusedOption !== 'angled') {
        createDimensionLine(new THREE.Vector3(-hw, topY, hl), new THREE.Vector3(hw, topY, hl), `í­: ${width} mm`, 'black');
        createDimensionLine(new THREE.Vector3(-hw, topY, -hl), new THREE.Vector3(-hw, topY, hl), `ê¸¸ì´: ${length} mm`, 'black');
      }

      // ë¼ìš´ë“œ/ì‚¬ì„  ì½”ë„ˆ ë¼ë²¨
      if (lastFocusedOption === 'angled') {
        createCornerLabel('A', new THREE.Vector3(-hw, topY, 0), 'blue');
        createCornerLabel('B', new THREE.Vector3(0, topY, hl), 'blue');
        createCornerLabel('C', new THREE.Vector3(hw, topY, 0), 'blue');
        createCornerLabel('D', new THREE.Vector3(0, topY, -hl), 'blue');
      }
      if (lastFocusedOption === 'round') {
        createCornerLabel('1', new THREE.Vector3(-hw, topY, hl), 'blue');
        createCornerLabel('2', new THREE.Vector3(-hw, topY, -hl), 'blue');
        createCornerLabel('3', new THREE.Vector3(hw, topY, hl), 'blue');
        createCornerLabel('4', new THREE.Vector3(hw, topY, -hl), 'blue');
      }

      // ì¹´ë©”ë¼ Update
      // ì¶”ê°€ ê°€ê³µ íƒœê·¸ (UI Overlay - ìš°ì¸¡ ìƒë‹¨ ê³ ì •)
      const overlay = document.getElementById('proc-tag-overlay');
      if (overlay) {
        overlay.innerHTML = ''; // ì´ˆê¸°í™”
        Array.from(selectedProcs).forEach(key => {
          if (key === 'none') return;
          const opt = PROC_OPTIONS.find(o => o.key === key);
          if (!opt) return;

          const tagDiv = document.createElement('div');
          tagDiv.className = 'proc-tag';
          tagDiv.style.pointerEvents = 'auto'; // í´ë¦­ ê°€ëŠ¥í•˜ê²Œ
          tagDiv.onclick = () => editProc(key);
          tagDiv.innerHTML = `
            <span class="proc-tag-name">${getProcTagLabel(key)}</span>
            <span class="proc-tag-remove" onclick="removeProc('${key}', event)">âœ•</span>
          `;
          overlay.appendChild(tagDiv);
        });
      }

      const maxDim = Math.max(w, l, h);
      camera.position.set(maxDim * 0.7, maxDim * 0.7, maxDim * 1.2);
      camera.lookAt(0, 0, 0); controls.target.set(0, 0, 0); controls.update();

      document.getElementById('previewInfo').innerHTML = ''; // í•˜ë‹¨ ê²€ì • ë¶€ë¶„ ì œê±° (í…ìŠ¤íŠ¸ ë¹„ì›€)
      document.getElementById('previewDim').textContent = `${width}Ã—${length} mm`;
    }

    function getProcTagLabel(key) {
      const opt = PROC_OPTIONS.find(o => o.key === key);
      if (!opt) return key;
      let label = opt.label;
      const d = procDetails[key] || {};
      if (key === 'coating' && d.type) label += `<br><span style="font-size:10px;font-weight:normal;">(${d.type}ì½”íŒ…)</span>`;
      if (key === 'angled' && d.sides && d.sides.length) label += `<br><span style="font-size:10px;font-weight:normal;">(${d.sides.join(',')})</span>`;
      if (key === 'round' && d.corners && d.corners.length) label += `<br><span style="font-size:10px;font-weight:normal;">(${d.corners.join(',')})</span>`;

      if (key === 'hinge' && d.count) {
        label += `<br><span style="font-size:10px;font-weight:normal;">(${d.count}ê°œ)`;
        if (d.positions && d.positions.length) {
          d.positions.forEach((p, i) => {
            const xVal = (p.x === '' || p.x === undefined) ? '?' : p.x;
            const yVal = (p.y === '' || p.y === undefined) ? '?' : p.y;
            label += `<br>#${i + 1}: X${xVal}, Y${yVal}`;
          });
        }
        label += `</span>`;
      }
      if (key === 'circlecut' && d.holes && d.holes.length) {
        label += `<br><span style="font-size:10px;font-weight:normal;">(${d.holes.length}ê°œ)`;
        d.holes.forEach((h, i) => {
          label += `<br>#${i + 1}: X${h.x}, Y${h.y} (R${h.r})`;
        });
        label += `</span>`;
      }
      if (key === 'squarecut' && d.holes && d.holes.length) {
        label += `<br><span style="font-size:10px;font-weight:normal;">(${d.holes.length}ê°œ)`;
        d.holes.forEach((h, i) => {
          label += `<br>#${i + 1}: X${h.x}, Y${h.y} (${h.w}x${h.h})`;
        });
        label += `</span>`;
      }
      return label;
    }

    // ============================================================
    // MODALS & HELPERS
    // ============================================================
    function openInstructionsModal(orderNumber, totalAmount) {
      const m = document.getElementById('orderInstructionsModal');
      const paymentQty = Math.ceil(totalAmount / 1000);
      document.getElementById('finalQuoteAmount').textContent = totalAmount.toLocaleString() + 'ì›';
      document.getElementById('paymentQuantity').textContent = paymentQty + 'ê°œ';
      document.getElementById('finalOrderNumber').textContent = orderNumber;
      m.style.display = 'flex';
    }
    function closeInstructionsModal() { document.getElementById('orderInstructionsModal').style.display = 'none'; }
    function copyOrderNumber() {
      const orderNumber = document.getElementById('finalOrderNumber').innerText;
      const btn = document.getElementById('copyOrderBtn');
      if (orderNumber && orderNumber !== '-') {
        navigator.clipboard.writeText(orderNumber).then(() => {
          const orig = btn.innerText; btn.innerText = 'ë³µì‚¬ë¨!'; btn.disabled = true;
          setTimeout(() => { btn.innerText = orig; btn.disabled = false; }, 2000);
        }).catch(() => { alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.'); });
      }
    }

    function showCustomerStoreLinks() {
      addBotMessage(`
        < div style = "padding:10px;" >
          <h4 style="margin-bottom:10px;">ğŸ›’ êµ¬ë§¤ ë§í¬ ì•ˆë‚´</h4>
          <div class="payment-links">
            <a class="payment-link" style="background:#03c75a;" href="https://smartstore.naver.com/irun2011" target="_blank">ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</a>
            <a class="payment-link" style="background:#1184ff;" href="https://link.coupang.com/a/cQ9keF" target="_blank">ì¿ íŒ¡ ë¸Œëœë“œìƒµ</a>
          </div>
          <p style="font-size:12px;color:#666;margin-top:10px;">ë¶€ìì¬ ë° ê¸°ì„±í’ˆì€ ìœ„ ë§í¬ì—ì„œ ë°”ë¡œ êµ¬ë§¤ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div > `);
    }

    // ============================================================
    // REPORT (PNG DOWNLOAD)
    // ============================================================
    async function generateReport() {
      const items = orderList.length ? orderList : lastSubmittedOrders;
      if (!items.length) { addBotMessage('ì£¼ë¬¸ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }
      const c = document.getElementById('reportContainer');
      let itemTotal = 0, rows = '';

      items.forEach((item) => {
        itemTotal += item.estimate;
        let discRow = '';
        if (item.discount > 0) {
          discRow = `<tr style="color:#d9534f; background:#fff8f8;"><td style="border:1px solid #ddd;padding:8px;">ì´ë²¤íŠ¸ í• ì¸</td><td style="border:1px solid #ddd;padding:8px;" colspan="2">${item.discountDetails.join(', ')}</td><td style="border:1px solid #ddd;padding:8px;text-align:right;">-${item.discount.toLocaleString()}ì›</td></tr>`;
        }
        const itemName = item.type === 'accessory' ? '[ë¶€ìì¬]' : item.woodName;
        const itemDetails = item.type === 'accessory' ? (item.name || '-') : (item.processingSummary || 'ê°€ê³µ ì—†ìŒ');
        const itemSize = item.type === 'accessory' ? `ìˆ˜ëŸ‰: ${item.quantity}ê°œ` : `${item.width}Ã—${item.length}mm / ${item.quantity}ì¥`;

        rows += `<tr>
          <td style="border:1px solid #ddd;padding:12px;"><b>${itemName}</b></td>
          <td style="border:1px solid #ddd;padding:12px;">${itemDetails}</td>
          <td style="border:1px solid #ddd;padding:12px;">${itemSize}</td>
          <td style="border:1px solid #ddd;padding:12px;text-align:right;">${item.estimate.toLocaleString()}ì›</td>
        </tr>${discRow}`;
      });

      const shipItems = calculateShippingCost(items);
      let totalShip = 0;
      shipItems.forEach(si => {
        const sc = si.cost * si.count; totalShip += sc;
        rows += `<tr style="background:#fcfcfc;"><td style="border:1px solid #ddd;padding:10px;"><b>ì˜ˆìƒ ë°°ì†¡ë¹„</b></td><td style="border:1px solid #ddd;padding:10px;">${si.sizeCategory}</td><td style="border:1px solid #ddd;padding:10px;">ìˆ˜ëŸ‰: ${si.count}ê°œ</td><td style="border:1px solid #ddd;padding:10px;text-align:right;">${sc.toLocaleString()}ì›</td></tr>`;
      });

      const finalGT = itemTotal + totalShip;

      c.innerHTML = `
        <div style="border:2px solid #2c3e50; padding:20px;">
          <div style="text-align:center;margin-bottom:30px;">
            <h1 style="color:#2c3e50; margin:0; font-size:28px;">ì•„ì´ë¦°ê°€êµ¬ ëª©ì¬ ê²¬ì  ë‚´ì—­ì„œ</h1>
            <p style="color:#7f8c8d; font-size:14px;">ë°œí–‰ì¼: ${new Date().toLocaleString('ko-KR')}</p>
          </div>
          <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
            <thead><tr style="background:#2c3e50; color:#fff;"><th style="padding:12px; border:1px solid #2c3e50;">í•­ëª©</th><th style="padding:12px; border:1px solid #2c3e50;">ê°€ê³µì •ë³´</th><th style="padding:12px; border:1px solid #2c3e50;">ê·œê²©/ìˆ˜ëŸ‰</th><th style="padding:12px; border:1px solid #2c3e50;">ê¸ˆì•¡</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <div style="text-align:right; border-top:2px solid #2c3e50; padding:20px 0;">
            <span style="font-size:18px; color:#7f8c8d;">ì´ ê²¬ì  í•©ê³„ (ë°°ì†¡ë¹„ í¬í•¨):</span>
            <span style="font-size:32px; font-weight:800; color:#e74c3c; margin-left:20px;">${finalGT.toLocaleString()} ì›</span>
          </div>
          <div style="background:#f8f9fa; padding:15px; margin-top:20px; font-size:12px; color:#666; line-height:1.6;">
            â€» ë³¸ ê²¬ì ì„œëŠ” ìì¬ ë° ê°€ê³µë¹„ ì˜ˆì‚° ì‚°ì¶œì„ ìœ„í•œ ì°¸ê³ ìš©ì…ë‹ˆë‹¤.<br>
            â€» ì‹¤ì œ ê²°ì œ ì „ ìƒì„¸ ê°€ê° ë‚´ì—­ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>`;

      try {
        const canvas = await html2canvas(c, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `ì•„ì´ë¦°ê°€êµ¬_ê²¬ì ë‚´ì—­ì„œ_${Date.now()}.png`;
        link.href = imgData;
        link.click();
        addBotMessage('ê²¬ì  ë‚´ì—­ì„œê°€ ì´ë¯¸ì§€(PNG)ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error(e);
        addBotMessage('ë‚´ì—­ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // sync with submitOrder to show instructions modal
    // and add download button to the chat
    function updateSubmitOrderSuccess(on, gt) {
      addBotMessage(`
        <div style="text-align:center;padding:16px;">
          <div style="font-size:40px;margin-bottom:8px;">âœ…</div>
          <div style="font-size:18px;font-weight:700;color:#2c3e50;">ì£¼ë¬¸ ìš”ì²­ ì™„ë£Œ!</div>
          <p style="font-size:13px;color:#666;">ì£¼ë¬¸ë²ˆí˜¸: <b>${on}</b><br>ì´ ê²°ì œê¸ˆì•¡: <b>${gt.toLocaleString()}ì›</b></p>
          <div class="quick-buttons" style="justify-content:center;margin-top:12px;">
            <span class="quick-btn" style="background:#34495e;" onclick="generateReport()">ğŸ“¸ ê²¬ì ë‚´ì—­ì„œ ì €ì¥</span>
            <span class="quick-btn" onclick="openInstructionsModal('${on}', ${gt})">ğŸ’° ê²°ì œë°©ë²• ì•ˆë‚´</span>
          </div>
          <div class="quick-buttons" style="justify-content:center;margin-top:8px;">
            <span class="quick-btn" onclick="resetAll();showWoodCards();">ìƒˆ ê²¬ì  ì‹œì‘</span>
          </div>
        </div>`);
    }

    // ============================================================
    // updateOrderBadge
    // ============================================================
    function updateOrderBadge() {
      const badge = document.getElementById('orderBadge');
      if (!badge) return;
      if (orderList.length > 0) { badge.style.display = 'inline'; badge.textContent = orderList.length; }
      else { badge.style.display = 'none'; }
    }



    // ============================================================
    // localStorage PERSISTENCE
    // ============================================================
    function saveOrders() { localStorage.setItem('chatOrderData', JSON.stringify(orderList)); }
    function loadOrders() {
      try {
        const saved = localStorage.getItem('chatOrderData');
        if (saved) { orderList = JSON.parse(saved); updateOrderBadge(); }
      } catch (e) { console.warn('ì£¼ë¬¸ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', e); localStorage.removeItem('chatOrderData'); }
    }

    // Hook into addToOrder to persist
    const _origAddToOrder = addToOrder;
    addToOrder = function () { _origAddToOrder(); saveOrders(); };
    const _origRemoveOrderItem = removeOrderItem;
    removeOrderItem = function (idx) { _origRemoveOrderItem(idx); saveOrders(); };

    // Load on init
    window.addEventListener('DOMContentLoaded', () => { loadOrders(); });

    // ============================================================
    // ACCESSORY DATA & CHAT CARDS
    // ============================================================
    const ACCESSORY_DATA = {
      screws: {
        title: 'í”¼ìŠ¤',
        desc: 'êµ¬ë¦¬ ì²œì—° ëª©ê³µìš© í”¼ìŠ¤ë¡œ, ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” í”¼ìŠ¤ ì…ë‹ˆë‹¤.',
        items: [{ name: 'ëª©ê³µìš© í”¼ìŠ¤ (20ê°œ)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt2.png' }]
      },
      hinges: {
        title: 'ê²½ì²©',
        desc: 'ê°€êµ¬ ë¬¸ì§ ë“±ì— ì‚¬ìš©í•˜ëŠ” ê¸°ë³¸ ê²½ì²©ê³¼, ë¬¸ì´ ë¶€ë“œëŸ½ê²Œ ë‹«íˆë„ë¡ ë„ì™€ì£¼ëŠ” ìŠ¤ë¬´ë¸Œ ì˜µì…˜ì…ë‹ˆë‹¤.',
        items: [
          { name: '110ë„ ì‹±í¬ ê²½ì²© (1ì„¸íŠ¸=2ea)', price: 2000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge2.png' },
          { name: 'ê²½ì²© ìŠ¤ë¬´ë¸Œ (1ì„¸íŠ¸=2ea)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge3.png' }
        ]
      },
      sandpaper: {
        title: 'ì‚¬í¬',
        desc: 'ìˆ«ìê°€ ë‚®ì„ìˆ˜ë¡ ê±°ì¹ ê³ , ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ½ìŠµë‹ˆë‹¤.',
        items: [
          { name: 'ì‚¬í¬ #80 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_80.png' },
          { name: 'ì‚¬í¬ #150 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_150.png' },
          { name: 'ì‚¬í¬ #220 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_220.png' },
          { name: 'ì‚¬í¬ #320 (2ì¥)', price: 1000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo_320.png' }
        ]
      },
      tape: {
        title: 'ì—£ì§€í…Œì´í”„',
        desc: 'ëª©ì¬ì˜ ì ˆë‹¨ë©´ì„ ë§ˆê°í•˜ì—¬ ê¹”ë”í•˜ê²Œ ë§Œë“¤ê³  ìŠµê¸°ë¡œë¶€í„° ë³´í˜¸í•˜ëŠ” ë§ˆê°ì¬ì…ë‹ˆë‹¤.',
        items: [
          { name: 'PVC ì—£ì§€ í…Œì´í”„ (10m)', price: 8000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge_2.png' },
          { name: 'ì¢…ì´ ì—£ì§€ í…Œì´í”„ (10m)', price: 12000, image: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge_1.png' }
        ]
      }
    };

    let currentAccCardId = 0;
    function showAccessoryCategories() {
      const cardId = 'acc_card_' + (++currentAccCardId);
      addBotMessage(`
        <div class="acc-card" id="${cardId}">
          <div class="acc-card-header">
            <span class="acc-card-title">ğŸ›’ ë¶€ìì¬ ì¶”ê°€</span>
            <button class="acc-close-btn" onclick="this.closest('.bot-msg').remove()">âœ•</button>
          </div>
          <div class="acc-content">
            <div style="margin-bottom:12px;font-weight:700;font-size:15px;color:#34495e;">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:</div>
            <div class="acc-category-grid">
              ${[
          { key: 'screws', label: 'í”¼ìŠ¤', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png' },
          { key: 'hinges', label: 'ê²½ì²©', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png' },
          { key: 'sandpaper', label: 'ì‚¬í¬', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png' },
          { key: 'tape', label: 'ì—£ì§€í…Œì´í”„', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge.png' }
        ].map(c => `
                <div class="acc-category" onclick="renderAccessoryItems('${cardId}', '${c.key}')">
                  <img src="${c.img}" alt="${c.label}">
                  <div>${c.label}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `, true);
    }

    function showSpecificAccessoryCategory(catKey) {
      const cardId = 'acc_card_' + (++currentAccCardId);
      addBotMessage(`
        <div class="acc-card" id="${cardId}">
          <div class="acc-card-header">
            <span class="acc-card-title">ğŸ›’ ë¶€ìì¬ ì¶”ê°€</span>
            <button class="acc-close-btn" onclick="this.closest('.bot-msg').remove()">âœ•</button>
          </div>
          <div class="acc-content"></div>
        </div>
      `, true);
      renderAccessoryItems(cardId, catKey);
    }

    function renderAccessoryItems(cardId, catKey) {
      const card = document.getElementById(cardId);
      if (!card) return;
      const content = card.querySelector('.acc-content');
      const cat = ACCESSORY_DATA[catKey];
      if (!cat) return;

      // ì¹´í…Œê³ ë¦¬ ê³ ì •í˜• ìƒë‹¨ ë°” (ì„ íƒ í‘œì‹œ ê¸°ëŠ¥ í¬í•¨)
      const cats = [
        { key: 'screws', label: 'í”¼ìŠ¤', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png' },
        { key: 'hinges', label: 'ê²½ì²©', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png' },
        { key: 'sandpaper', label: 'ì‚¬í¬', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png' },
        { key: 'tape', label: 'ì—£ì§€í…Œì´í”„', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge.png' }
      ];

      let h = `
        <div class="acc-category-grid" style="margin-bottom:15px;background:#f8f9fa;padding:8px;border-radius:12px;border:1px solid #eee;">
          ${cats.map(c => `
            <div class="acc-category ${c.key === catKey ? 'active' : ''}" onclick="renderAccessoryItems('${cardId}', '${c.key}')" style="padding:8px 4px; border:none; ${c.key === catKey ? '' : 'background:none;'}">
              <img src="${c.img}" style="width:24px;height:24px;margin-bottom:2px;">
              <div style="font-size:11px;">${c.label}</div>
            </div>
          `).join('')}
        </div>
        <div style="font-weight:800;font-size:17px;color:#2c3e50;margin-bottom:6px;">${cat.title}</div>
        <p style="font-size:12px;color:#7f8c8d;line-height:1.5;margin-bottom:15px;">${cat.desc}
          ${catKey === 'tape' ? `<a href="#" onclick="openVideoModal('https://www.youtube.com/embed/goC8S1Enjcg?si=7B93_Wk53lxoeqEj');return false;" style="color:#3498db;font-weight:600;text-decoration:none;margin-left:5px;">[ì‹œê³µì˜ìƒ ë³´ê¸°]</a>` : ''}
        </p>
        <div class="acc-item-list">
          ${cat.items.map((item, i) => {
        const uid = `${cardId}_${catKey}_${i}`;
        return `
              <div class="acc-item">
                <img src="${item.image}" alt="${item.name}" style="width:80px;height:80px;border-radius:8px;">
                <div class="acc-info">
                  <div class="acc-name">${item.name}</div>
                  <div class="acc-price">${item.price.toLocaleString()}ì›</div>
                </div>
                <div class="acc-controls">
                  <input type="number" id="accQty_${uid}" value="1" min="1" class="acc-qty">
                  <button class="acc-add-btn" onclick="addAccessoryToOrder('${catKey}', ${i}, '${uid}')">ë‹´ê¸°</button>
                </div>
              </div>
            `;
      }).join('')}
        </div>
        <button class="acc-back-btn" style="margin-top:15px;" onclick="renderAccessoryCategories('${cardId}')">â† ì¹´í…Œê³ ë¦¬ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      `;
      content.innerHTML = h;
    }

    function renderAccessoryCategories(cardId) {
      const card = document.getElementById(cardId);
      if (!card) return;
      const content = card.querySelector('.acc-content');
      content.innerHTML = `
        <div style="margin-bottom:6px;font-weight:600;font-size:13px;">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:</div>
        <div class="acc-category-grid" style="grid-template-columns:repeat(4,1fr);">
          ${[
          { key: 'screws', label: 'í”¼ìŠ¤', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_bolt.png' },
          { key: 'hinges', label: 'ê²½ì²©', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_hinge.png' },
          { key: 'sandpaper', label: 'ì‚¬í¬', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_sapo.png' },
          { key: 'tape', label: 'ì—£ì§€í…Œì´í”„', img: 'https://gi.esmplus.com/irn2011/click/texture/sub_edge.png' }
        ].map(c => `
            <div class="acc-category" onclick="renderAccessoryItems('${cardId}', '${c.key}')">
              <img src="${c.img}" alt="${c.label}">
              <div>${c.label}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function addAccessoryToOrder(catKey, itemIndex, qtyUid) {
      const cat = ACCESSORY_DATA[catKey];
      const item = cat.items[itemIndex];
      const qtyEl = document.getElementById('accQty_' + qtyUid);
      const qty = parseInt(qtyEl?.value) || 1;
      if (qty < 1) { addBotMessage('ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      orderList.push({ type: 'accessory', woodTypeValue: null, woodName: '[ë¶€ìì¬]', name: item.name, width: 0, length: 0, quantity: qty, processingSummary: '-', selectedProcs: [], procDetails: {}, basePrice: item.price, additionalCost: 0, originalTotal: item.price * qty, discount: 0, discountDetails: [], estimate: item.price * qty });
      saveOrders(); updateOrderBadge(); renderOrderPanel();
      addBotMessage(`<b>${item.name}</b> ${qty}ê°œë¥¼ ì£¼ë¬¸ëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (${(item.price * qty).toLocaleString()}ì›)
      <div class="quick-buttons"><span class="quick-btn" onclick="clearChatAndStartNew()">ë‹¤ë¥¸ ëª©ì¬ ì¶”ê°€</span><span class="quick-btn" onclick="initiateOrder()">ì£¼ë¬¸ í™•ì¸í•˜ê¸° (${orderList.length}ê±´)</span></div>`);
    }

    // ============================================================
    // PROGRESS MODAL
    // ============================================================
    function showProgressModal() {
      document.getElementById('progressTitle').textContent = 'ì „ì†¡ ì¤‘...';
      document.getElementById('progressIcon').src = 'https://i.gifer.com/ZZ5H.gif';
      document.getElementById('progressModalCloseBtn').style.display = 'none';
      document.getElementById('progressBar').style.backgroundColor = '#007bff';
      document.getElementById('progressModalOverlay').style.display = 'flex';
      updateProgress(10, 'ì „ì†¡ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    }
    function updateProgress(pct, msg) {
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressStatusText').textContent = msg;
    }
    function showProgressSuccess(msg) {
      updateProgress(100, msg);
      document.getElementById('progressTitle').textContent = 'ì „ì†¡ ì™„ë£Œ';
      document.getElementById('progressIcon').src = 'https://i.imgur.com/UDS2wje.png';
      document.getElementById('progressModalCloseBtn').style.display = 'block';
    }
    function showProgressError(msg) {
      updateProgress(100, msg);
      document.getElementById('progressBar').style.backgroundColor = '#dc3545';
      document.getElementById('progressTitle').textContent = 'ì „ì†¡ ì‹¤íŒ¨';
      document.getElementById('progressIcon').src = 'https://i.imgur.com/P4Q6r5A.png';
      document.getElementById('progressModalCloseBtn').style.display = 'block';
    }
    function hideProgressModal() { document.getElementById('progressModalOverlay').style.display = 'none'; }

    // ============================================================
    // VIDEO MODAL
    // ============================================================
    function openVideoModal(url) { document.getElementById('youtubeVideo').src = url; document.getElementById('videoModal').style.display = 'flex'; }
    function closeVideoModal() { document.getElementById('videoModal').style.display = 'none'; document.getElementById('youtubeVideo').src = ''; }

    // ============================================================
    // LOAD ORDER (JSONP)
    // ============================================================
    let jsonpTimeout;
    function openLoadModal() { document.getElementById('loadOrderModal').style.display = 'flex'; }
    function closeLoadModal() { document.getElementById('loadOrderModal').style.display = 'none'; }
    function formatPhoneNumber(input) {
      let val = input.value.replace(/\D/g, '');
      if (val.length > 3 && val.length <= 7) val = val.slice(0, 3) + '-' + val.slice(3);
      else if (val.length > 7) val = val.slice(0, 3) + '-' + val.slice(3, 7) + '-' + val.slice(7, 11);
      input.value = val;
    }
    function confirmLoadOrder() {
      const phone = document.getElementById('load-phone').value.trim();
      const orderNo = document.getElementById('load-orderNo').value.trim();
      if (!phone || !orderNo) { alert('íœ´ëŒ€í° ë²ˆí˜¸ì™€ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const btn = document.getElementById('loadOrderConfirmBtn');
      btn.disabled = true; btn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      const old = document.getElementById('jsonp_script'); if (old) old.remove();
      jsonpTimeout = setTimeout(() => { if (btn.disabled) { alert('ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.'); btn.disabled = false; btn.textContent = 'í™•ì¸'; } }, 15000);
      const script = document.createElement('script');
      script.id = 'jsonp_script';
      script.src = `${API_URL}?callback=handleOrderDataResponse&phone=${encodeURIComponent(phone)}&orderNo=${encodeURIComponent(orderNo)}`;
      script.onerror = () => { clearTimeout(jsonpTimeout); alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); btn.disabled = false; btn.textContent = 'í™•ì¸'; };
      document.head.appendChild(script);
    }
    function handleOrderDataResponse(result) {
      clearTimeout(jsonpTimeout);
      const btn = document.getElementById('loadOrderConfirmBtn');
      btn.disabled = false; btn.textContent = 'í™•ì¸';
      if (result.result === 'success' && result.data && result.data.length > 0) {
        orderList = [];
        result.data.forEach(row => {
          const summary = String(row['í’ˆëª…'] || row['ì£¼ë¬¸ë‚´ì—­ ìš”ì•½'] || '');
          const estimate = parseFloat(row['í•©ê³„']) || 0;
          const processing = row['ê°€ê³µìƒì„¸'] || row['ê°€ê³µ'] || '';
          if (summary === 'ì´ í•©ê³„') return;
          let item = { isLoaded: true, estimate };
          if (summary === '[ì´ë²¤íŠ¸ í• ì¸]') { item.type = 'discount'; item.name = processing || 'ì´ë²¤íŠ¸ í• ì¸'; item.woodName = 'í• ì¸'; }
          else if (summary === 'ì˜ˆìƒ ë°°ì†¡ë¹„') { item.type = 'shipping'; item.name = processing || 'ë°°ì†¡ë¹„'; item.woodName = 'ë°°ì†¡'; item.quantity = row['ìˆ˜ëŸ‰']; }
          else if (summary.startsWith('[ë¶€ìì¬]')) { item.type = 'accessory'; item.name = summary.replace('[ë¶€ìì¬] ', ''); item.woodName = '[ë¶€ìì¬]'; item.quantity = row['ìˆ˜ëŸ‰']; }
          else {
            item.woodTypeValue = summary; item.woodName = summary;
            item.width = row['í­(mm)'] || row['í­'] || 0; item.length = row['ê¸¸ì´(mm)'] || row['ê¸¸ì´'] || 0;
            item.quantity = row['ìˆ˜ëŸ‰'] || 1;
            item.processingSummary = processing || 'ê°€ê³µ ì—†ìŒ';
            item.selectedProcs = []; item.procDetails = {}; item.discount = 0; item.discountDetails = [];
          }
          orderList.push(item);
        });
        saveOrders(); updateOrderBadge(); renderOrderPanel();
        closeLoadModal();
        addBotMessage('âœ… ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ëŠ” ìˆ˜ì • ë¶ˆê°€ì´ë©°, ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        document.getElementById('load-phone').value = ''; document.getElementById('load-orderNo').value = '';
      } else { alert('ì¼ì¹˜í•˜ëŠ” ì£¼ë¬¸ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
    }


    // ============================================================
    // ENHANCED submitOrder with progress modal
    // ============================================================
    submitOrder = async function () {
      const name = document.getElementById('custName').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const email = document.getElementById('custEmail')?.value.trim() || '';

      if (!name || !phone) { addBotMessage('ì„±í•¨ê³¼ ì—°ë½ì²˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      const phoneRegex = /^010-\d{4}-\d{4}$/;
      if (!phoneRegex.test(phone)) { addBotMessage('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ 010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      showProgressModal();
      updateStatus('ì£¼ë¬¸ ì œì¶œ ì¤‘...', '');

      try {
        updateProgress(40, 'ê²¬ì  ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

        // ë°°ì†¡ë¹„ ê³„ì‚°
        const shipItems = calculateShippingCost(orderList);
        let shipTotal = 0;
        shipItems.forEach(si => shipTotal += (si.cost * si.count));

        // ì•„ì´í…œ ì†Œê³„
        let itemTotal = 0;
        orderList.forEach(i => { itemTotal += i.estimate; });

        const grandTotal = itemTotal + shipTotal;

        // ì„œë²„ ì „ì†¡ ë°ì´í„° êµ¬ì„±
        const orderPayload = {
          type: 'order',
          data: {
            customer: { name, phone, email, memo: '' }, // memo í•„ë“œ ë¹„ì›€
            orders: orderList, // 'items' ëŒ€ì‹  'orders' ì‚¬ìš©
            shippingItems: shipItems,
            shippingCost: shipTotal,
            totalPrice: grandTotal,
            sessionId: SESSION_ID,
            timestamp: new Date().toISOString()
          }
        };

        const resp = await postToServer(orderPayload);

        if (resp.result === 'success' || resp.orderNumber || resp.orderNo) {
          const on = resp.orderNo || resp.orderNumber || resp.data?.orderNumber || 'IRN-' + Date.now();

          showProgressSuccess('ê²¬ì ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
          setTimeout(() => {
            hideProgressModal();
            updateSubmitOrderSuccess(on, grandTotal);
            openInstructionsModal(on, grandTotal);
          }, 2000);

          lastSubmittedOrders = [...orderList]; // ë°±ì—… ì €ì¥
          orderList = [];
          saveOrders();
          updateOrderBadge();
          renderOrderPanel();
          updateStatus('ì£¼ë¬¸ ì™„ë£Œ', on);
        } else {
          showProgressError('ì„œë²„ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (resp.message || ''));
          updateStatus('ì£¼ë¬¸ ì‹¤íŒ¨', '');
        }
      } catch (e) {
        showProgressError('ì „ì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        updateStatus('ì—°ê²° ì˜¤ë¥˜', '');
        console.error(e);
      }
    };

    // Modal dismiss on overlay click
    window.addEventListener('click', (e) => {
      if (e.target.id === 'loadOrderModal') closeLoadModal();
      if (e.target.id === 'videoModal') closeVideoModal();
    });
  </script>

  <!-- ORDER INSTRUCTIONS MODAL -->
  <div id="orderInstructionsModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeInstructionsModal()">&times;</span>
      <div class="modal-title">ğŸ“¦ ì£¼ë¬¸ ì•ˆë‚´</div>
      <div class="instruction-box">
        <div class="instruction-row"><span>ìµœì¢… ê²¬ì  ê¸ˆì•¡</span><b id="finalQuoteAmount">-</b></div>
        <div class="instruction-row"><span>ê²°ì œ ìˆ˜ëŸ‰ (1,000ì› ë‹¨ìœ„)</span><b id="paymentQuantity">-</b></div>
        <div class="instruction-row">
          <span>ì£¼ë¬¸ ë²ˆí˜¸</span>
          <span style="display:flex;align-items:center;gap:8px;">
            <b id="finalOrderNumber">-</b>
            <button id="copyOrderBtn" onclick="copyOrderNumber()"
              style="padding:4px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:11px;">ğŸ“‹
              ë³µì‚¬</button>
          </span>
        </div>
      </div>
      <p style="font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 20px;">
        ìœ„ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ë³µì‚¬í•˜ì‹  í›„, ì•„ë˜ ê²°ì œ ë§í¬ì—ì„œ<br>
        <b>ê²°ì œ ìˆ˜ëŸ‰</b>ë§Œí¼ ê°œìˆ˜ë¥¼ ì„¤ì •í•˜ì—¬ ê²°ì œí•´ ì£¼ì„¸ìš”.
      </p>
      <div class="payment-links">
        <a class="payment-link" style="background:#03c75a;" href="https://naver.me/GJ5OEouG" target="_blank">ë„¤ì´ë²„ ìŠ¤í† ì–´
          ê²°ì œ</a>
        <a class="payment-link" style="background:#1184ff;" href="https://link.coupang.com/a/cQ9keF" target="_blank">ì¿ íŒ¡
          ê²°ì œ</a>
      </div>
      <div style="margin-top:15px;display:flex;gap:8px;justify-content:center;">
        <a href="https://talk.naver.com/profile/wc80z0" target="_blank"
          style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:#03c75a;color:#fff;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;">ğŸ’¬
          ë„¤ì´ë²„ í†¡í†¡</a>
        <a href="http://pf.kakao.com/_NKxaxcl/chat" target="_blank"
          style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:#FEE500;color:#3C1E1E;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;">ğŸ’¬
          ì¹´ì¹´ì˜¤í†¡ ìƒë‹´</a>
      </div>
      <button class="btn-checkout" style="margin-top:15px; background:#7f8c8d;"
        onclick="closeInstructionsModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- PROGRESS MODAL -->
  <div id="progressModalOverlay" class="modal-overlay">
    <div class="modal-content" style="text-align: center;">
      <h3 id="progressTitle">ì „ì†¡ ì¤‘...</h3>
      <img id="progressIcon" src="https://i.gifer.com/ZZ5H.gif" alt="ë¡œë”© ì¤‘"
        style="width:80px;height:80px;margin-bottom:20px;">
      <p id="progressStatusText" style="margin-bottom:20px;font-size:1.1em;color:#333;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
      <div style="background:#e0e0e0;border-radius:10px;padding:3px;overflow:hidden;">
        <div id="progressBar"
          style="width:0%;height:20px;background:#007bff;border-radius:7px;transition:width 0.5s ease-in-out;"></div>
      </div>
      <button id="progressModalCloseBtn" class="btn-checkout" style="display:none;margin-top:25px;background:#7f8c8d;"
        onclick="hideProgressModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- VIDEO MODAL -->
  <div id="videoModal" class="modal-overlay">
    <div class="modal-content" style="max-width:800px;text-align:left;">
      <span class="modal-close" onclick="closeVideoModal()">&times;</span>
      <h3 style="margin-bottom:10px;">ì—£ì§€ í…Œì´í”„ ì‹œê³µ ë°©ë²•</h3>
      <div style="position:relative;width:100%;padding-bottom:56.25%;height:0;">
        <iframe id="youtubeVideo" style="position:absolute;top:0;left:0;width:100%;height:100%;" src="" frameborder="0"
          allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture"
          allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- LOAD ORDER MODAL -->
  <div id="loadOrderModal" class="modal-overlay">
    <div class="modal-content" style="text-align:left;">
      <span class="modal-close" onclick="closeLoadModal()">&times;</span>
      <div class="modal-title">ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°</div>
      <div class="form-row"><label>íœ´ëŒ€í°</label><input type="tel" id="load-phone" placeholder="010-1234-5678"></div>
      <div class="form-row"><label>ì£¼ë¬¸ë²ˆí˜¸</label><input type="text" id="load-orderNo" placeholder="ì˜ˆ: 20240718-001"></div>
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-checkout" style="background:linear-gradient(135deg,#3498db,#2980b9);"
          id="loadOrderConfirmBtn" onclick="confirmLoadOrder()">í™•ì¸</button>
        <button class="btn-checkout" style="background:#7f8c8d;" onclick="closeLoadModal()">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <div id="reportContainer"></div>
</body>

</html>